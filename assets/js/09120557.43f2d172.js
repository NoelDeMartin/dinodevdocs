"use strict";(self.webpackChunkdevdocs=self.webpackChunkdevdocs||[]).push([[9314],{30554:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>r,default:()=>h,frontMatter:()=>l,metadata:()=>o,toc:()=>c});var a=t(74848),i=t(28453),s=t(78924);const l={title:"Inplace editable",tags:["AJAX","Javascript"],documentationDraft:!0},r=void 0,o={id:"apis/subsystems/output/inplace",title:"Inplace editable",description:"The inplace_editable element is a mini-API which allows developers to easily support editing of a value on any page. The interface is used in places such as the course section and activity name editing.",source:"@site/versioned_docs/version-4.3/apis/subsystems/output/inplace.md",sourceDirName:"apis/subsystems/output",slug:"/apis/subsystems/output/inplace",permalink:"/moodledevdocs/docs/4.3/apis/subsystems/output/inplace",draft:!1,unlisted:!1,editUrl:"https://github.com/moodle/devdocs/edit/main/versioned_docs/version-4.3/apis/subsystems/output/inplace.md",tags:[{label:"AJAX",permalink:"/moodledevdocs/docs/4.3/tags/ajax"},{label:"Javascript",permalink:"/moodledevdocs/docs/4.3/tags/javascript"}],version:"4.3",lastUpdatedBy:"Peter Mayer",lastUpdatedAt:1713243198e3,frontMatter:{title:"Inplace editable",tags:["AJAX","Javascript"],documentationDraft:!0},sidebar:"docs",previous:{title:"Output API",permalink:"/moodledevdocs/docs/4.3/apis/subsystems/output/"},next:{title:"Plagiarism API",permalink:"/moodledevdocs/docs/4.3/apis/subsystems/plagiarism"}},d={},c=[{value:"Implementing inplace_editable in a plugin",id:"implementing-inplace_editable-in-a-plugin",level:2},{value:"Toggles and dropdowns",id:"toggles-and-dropdowns",level:2},{value:"How does it work",id:"how-does-it-work",level:2},{value:"Events",id:"events",level:2}];function p(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components},{Details:r}=n;return r||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(s.A,{frontMatter:l,metadata:o}),"\n",(0,a.jsxs)(n.p,{children:["The ",(0,a.jsx)(n.code,{children:"inplace_editable"})," element is a mini-API which allows developers to easily support editing of a value on any page. The interface is used in places such as the course section and activity name editing."]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{alt:"inplace editable example.png",src:t(189).A+"",width:"858",height:"157"})}),"\n",(0,a.jsx)(n.h2,{id:"implementing-inplace_editable-in-a-plugin",children:"Implementing inplace_editable in a plugin"}),"\n",(0,a.jsxs)(n.p,{children:["The best way is to explain the usage on a simple example. Imagine we have plugin ",(0,a.jsx)(n.code,{children:"tool_mytest"})," that needs to implement in-place editing of a field 'name' from db table ",(0,a.jsx)(n.code,{children:"tool_mytest_mytable"}),". We are going to call this itemtype ",(0,a.jsx)(n.code,{children:"mytestname"}),". Each plugin (or core component) may use as many item types as it needs."]}),"\n",(0,a.jsxs)(n.p,{children:["Define a callback in ",(0,a.jsx)(n.code,{children:"/admin/tool/mytest/lib.php"})," that starts with the plugin name and ends with ",(0,a.jsx)(n.code,{children:"_inplace_editable"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",metastring:'title="admin/tool/mytest/lib.php"',children:"function tool_mytest_inplace_editable($itemtype, $itemid, $newvalue) {\n    global $DB;\n\n    if ($itemtype === 'mytestname') {\n        $record = $DB->get_record('tool_mytest_mytable', ['id' => $itemid], '*', MUST_EXIST);\n\n        // Must call validate_context for either system, or course or course module context.\n        // This will both check access and set current context.\n        \\external_api::validate_context(context_system::instance());\n\n        // Check permission of the user to update this item.\n        require_capability('tool/mytest:update', context_system::instance());\n\n        // Clean input and update the record.\n        $newvalue = clean_param($newvalue, PARAM_NOTAGS);\n\n        $DB->update_record('tool_mytest_mytable', ['id' => $itemid, 'name' => $newvalue));\n\n        // Prepare the element for the output:\n        $record->name = $newvalue;\n\n        return new \\core\\output\\inplace_editable(\n            'tool_mytest',\n            'mytestname',\n            $record->id,\n            true,\n            format_string($record->name),\n            $record->name,\n            get_string('editmytestnamefield', 'tool_mytest'),\n            get_string('newvaluestring', 'tool_mytest', format_string($record->name))\n        );\n    }\n}\n"})}),"\n",(0,a.jsxs)(n.p,{children:["In your renderer or wherever you actually display the name, use the same ",(0,a.jsx)(n.code,{children:"inplace_editable"})," template:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"$tmpl = new \\core\\output\\inplace_editable(\n    'tool_mytest',\n    'mytestname',\n    $record->id,\n    has_capability('tool/mytest:update', context_system::instance()),\n    format_string($record->name),\n    $record->name,\n    new lang_string('editmytestnamefield', 'tool_mytest'),\n    new lang_string('newvaluestring', 'tool_mytest', format_string($record->name))\n);\necho $OUTPUT->render($tmpl);\n"})}),"\n",(0,a.jsx)(n.p,{children:"This was a very simplified example, in the real life you will probably want to:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["Create a function (or class extending ",(0,a.jsx)(n.code,{children:"core\\output\\inplace_editable"}),") to form the instance of templatable object so you don't need to duplicate code;"]}),"\n",(0,a.jsx)(n.li,{children:"Use an existing function to update a record (which hopefully also validates input value and triggers events)"}),"\n",(0,a.jsx)(n.li,{children:"Add unit tests and behat tests"}),"\n"]}),"\n",(0,a.jsxs)(r,{children:[(0,a.jsx)("summary",{children:"View example"}),(0,a.jsx)("div",{children:(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",metastring:'title="admin/tool/mytest/classes/local/inplace_edit_text.php"',children:"\nclass inplace_edit_text extends \\core\\output\\inplace_editable {\n    /**\n     * Constructor.\n     *\n     * @param object $record\n     */\n    public function __construct($record) {\n        parent::__construct(\n            component: 'tool_mytest',\n            // The item type as managed your plugin.\n            itemtype: 'mytesttext',\n            // An ID that relates to this instance of this item type.\n            itemid: $record->id,\n            // Whether this user can makes changes.\n            // Perhaps based upon a capability check.\n            editable: has_capability(\n                'capname',\n                \\context_system::instance(),\n            ),\n            // The display value of this item.\n            displayvalue: format_string($record->name),\n            // The machine-readable value.\n            value: $record->name,\n            // Hints and labels.\n            edithint: get_string('edithint', 'tool_mytest'),\n            editlabel: get_string('editlabel', 'tool_mytest'),\n        );\n        $this->set_type_select($answeroptionstemp);\n    }\n\n    /**\n     * Updates the value in database and returns itself.\n     *\n     * Called from inplace_editable callback\n     *\n     * @param int $itemid\n     * @param mixed $newvalue\n     * @return \\self\n     */\n    public static function update($itemid, $newvalue) {\n        // Clean the new value.\n        $newvalue = clean_param($newvalue, PARAM_INT);\n\n        // {{ Do some mighty things here}}\n\n        $record = $DB->get_record('xxx', ['id' => 'xxx']);\n\n        // Finally return itself.\n        return new self($record);\n    }\n}\n"})})})]}),"\n",(0,a.jsx)(n.h2,{id:"toggles-and-dropdowns",children:"Toggles and dropdowns"}),"\n",(0,a.jsx)(n.p,{children:"You may choose to set the UI for your inplace editable element to be a string value (default), toggle or dropdown."}),"\n",(0,a.jsxs)(n.p,{children:["Examples of dropdown setup (see also ",(0,a.jsx)(n.a,{href:"https://github.com/moodle/moodle/blob/master/tag/classes/output/tagareacollection.php",children:"example by overriding class"}),"):"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"$tagcollections = \\core_tag_collection::get_collections_menu(true);\n$tmpl = new \\core\\output\\inplace_editable(\n    'core_tag',\n    'tagareacollection',\n    $tagarea->id,\n    $editable,\n\n    // Note that $displayvalue is not needed (null was passed in the example above).\n    // It will be automatically taken from options.\n    null,\n\n    // $value must be an existing index from the $tagcollections array,\n    // otherwise exception will be thrown.\n    $value,\n    $edithint,\n    $editlabel\n);\n$tmpl->set_type_select($tagcollections);\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Example of toggle setup (see also ",(0,a.jsx)(n.a,{href:"https://github.com/moodle/moodle/blob/master/tag/classes/output/tagareaenabled.php",children:"example by overriding class"}),"):"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"$tmpl = new \\core\\output\\inplace_editable(\n    'core_tag',\n\n    'tagflag',\n\n    $tag->id,\n\n    $editable,\n\n    // $displayvalue usually toggles an image, for example closed/open eye.\n    // It is easier to implement by overriding the class.\n    // In this case $displayvalue can be generated from $value during exporting.\n    $displayvalue,\n\n    // $value must be an existing element of the array\n    // passed to set_type_toggle(), otherwise exception will be thrown.\n    $value,\n\n    $hint,\n);\n$tmpl->set_type_toggle([0, 1]);\n"})}),"\n",(0,a.jsxs)(r,{children:[(0,a.jsx)("summary",{children:"View example"}),(0,a.jsx)("div",{children:(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",metastring:'title="admin/tool/mytest/classes/local/inplace_edit_select.php"',children:"class inplace_edit_select extends \\core\\output\\inplace_editable {\n    /**\n     * Constructor.\n     *\n     * @param \\stdClass $record\n     */\n    public function __construct($record) {\n        // Get the options for inplace_edit select box.\n        // The array needs the format:\n        //     $options = [\n        //         'value1' => 'text1',\n        //         'value2' => 'text2',\n        //     ];\n        $options = \\tool_mytest\\classes\\helper::get_options();\n\n        parent::__construct(\n            component: 'tool_mytest',\n            // The item type as managed your plugin.\n            itemtype: 'mytestselect',\n            // An ID that relates to this instance of this item type.\n            itemid: $record->id,\n            // Whether this user can makes changes.\n            // Perhaps based upon a capability check.\n            editable: has_capability(\n                'capname',\n                \\context_system::instance(),\n            ),\n            // The display value of this item.\n            displayvalue: $options[$optionkey],\n            // The machine-readable value.\n            value: $optionkey,\n            // Hints and labels.\n            edithint: get_string('edithint', 'tool_mytest'),\n            editlabel: get_string('editlabel', 'tool_mytest'),\n        );\n        $this->set_type_select($options);\n    }\n\n    /**\n     * Updates the value in database and returns itself.\n     *\n     * Called from inplace_editable callback\n     *\n     * @param int $itemid\n     * @param mixed $newvalue\n     * @return \\self\n     */\n    public static function update($itemid, $newvalue) {\n        // Clean the new value.\n        $newvalue = clean_param($newvalue, PARAM_INT);\n\n        // {{ Do some mighty things here}}\n\n        $record = $DB->get_record('xxx', ['id' => 'xxx']);\n\n        // Finally return itself.\n        return new self($record);\n    }\n}\n"})})})]}),"\n",(0,a.jsxs)(r,{children:[(0,a.jsx)("summary",{children:"View example rendering with PHP"}),(0,a.jsx)("div",{children:(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"$renderer = $PAGE->get_renderer('core');\n$inplaceedit = new tool_mytest\\local\\inplace_edit_text($record);\n$params = $inplaceedit->export_for_template($renderer);\necho $OUTPUT->render_from_template('core/inplace_edit', $params);\n"})})})]}),"\n",(0,a.jsxs)(r,{children:[(0,a.jsx)("summary",{children:"View example rendering with JavaScript"}),(0,a.jsxs)("div",{children:[(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",metastring:'title="Render inplace_edit with JavaScript"',children:"$itemid = 153 // Id of the element to be modified inplace.\n$renderer = $PAGE->get_renderer('core');\n$inplaceedit = new tool_mytest\\local\\inplace_edit_text($record);\n$params = $inplaceedit->export_for_template($renderer);\n"})}),(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-js",metastring:'title="The params are transferred via webservice and are then processed by JavaScript"',children:"Templates.renderForPromise('core/inplace_edit', params)\n    .then(({html, js}) => {\n        Templates.replaceNodeContents('nodeid', html, js);\n        return true;\n    })\n    .catch((error) => displayException(error));\n"})})]})]}),"\n",(0,a.jsx)(n.admonition,{type:"note",children:(0,a.jsxs)(n.p,{children:["In the examples above, ",(0,a.jsx)(n.code,{children:"core/inplace_edit"})," can also be used as a partial in another template."]})}),"\n",(0,a.jsx)(n.h2,{id:"how-does-it-work",children:"How does it work"}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"inplace_editable"})," consists of"]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["Templatable/renderable ",(0,a.jsx)(n.strong,{children:"class core\\output\\inplace_editable"})]}),"\n",(0,a.jsxs)(n.li,{children:["Template ",(0,a.jsx)(n.strong,{children:"core/inplace_editable"})]}),"\n",(0,a.jsxs)(n.li,{children:["JavaScript module ",(0,a.jsx)(n.strong,{children:"core/inplace_editable"})]}),"\n",(0,a.jsxs)(n.li,{children:["Web service ",(0,a.jsx)(n.strong,{children:"core_update_inplace_editable"})," available from AJAX"]}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"All four call each other so it's hard to decide where we start explaining this circle of friends but let's start with web service."}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"Web service"})," receives arguments (",(0,a.jsx)(n.code,{children:"$component"}),", ",(0,a.jsx)(n.code,{children:"$itemtype"}),", ",(0,a.jsx)(n.code,{children:"$itemid"}),", ",(0,a.jsx)(n.code,{children:"$newvalue"}),") - it searches for the inplace_editable callback in the component. Then web service calls this callback as ",(0,a.jsx)(n.code,{children:"{component}_inplace_editable($itemtype, $itemid, $newvalue)"}),", this must return templatable element which is sent back to the web service caller. Web service requires user to be logged in. ",(0,a.jsxs)(n.strong,{children:["Any other ",(0,a.jsx)(n.code,{children:"capability/access"})," checks must be performed inside the callback."]})]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"Templatable element"})," contains such properties as component, ",(0,a.jsx)(n.code,{children:"itemtype"}),", ",(0,a.jsx)(n.code,{children:"itemid"}),", ",(0,a.jsx)(n.code,{children:"displayvalue"}),", ",(0,a.jsx)(n.code,{children:"value"}),", ",(0,a.jsx)(n.code,{children:"editlabel"})," and ",(0,a.jsx)(n.code,{children:"edithint"}),". When used in a ",(0,a.jsx)(n.strong,{children:"template"})," It only renders the display value and the edit link (with ",(0,a.jsx)(n.code,{children:"title=edithint"}),"). All other properties are rendered as ",(0,a.jsx)(n.code,{children:"data-xxx"})," attributes. Template also ensures that JavaScript module is loaded."]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"JavaScript module"}),' registers a listener to when the edit link is clicked and then it replaces the display value with the text input box that allows to edit value. When user presses "Enter" the AJAX request is called to the web service and code from the component is executed. If web service throws an exception it is displayed for user as a popup.']}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"events",children:"Events"}),"\n",(0,a.jsx)(n.p,{children:"Plugin page can listen to JQuery events that are triggered on successful update or when update failed. Example of the listeners (as inline JS code):"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"$PAGE->requires->js_amd_inline(\"\nrequire(['jquery'], function(\\$) {\n    $('body').on('updatefailed', '[data-inplaceeditable]', (e) => {\n        // The exception object returned by the callback.\n        const exception = e.exception;\n\n        // The value that user tried to udpated the element to.\n        const newvalue = e.newvalue;\n\n        // This will prevent default error dialogue.\n        e.preventDefault();\n\n        // Do your own error processing here.\n    });\n    $('body').on('updated', '[data-inplaceeditable]', (e) => {\n        // Everything that web service returned.\n        const ajaxreturn = e.ajaxreturn;\n\n        // Element value before editing (note, this is raw value and not display value).\n        const oldvalue = e.oldvalue;\n\n        // Do your own stuff, for example update all other occurences of this element on the page.\n    });\n});\n\");\n"})}),"\n",(0,a.jsx)(n.admonition,{type:"note",children:(0,a.jsx)(n.p,{children:"The above examples are not recommended and just give an example of how these APIs work."})})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(p,{...e})}):p(e)}},189:(e,n,t)=>{t.d(n,{A:()=>a});const a=t.p+"assets/images/inplace_editable_example-4c04e1dc88f0488bb8798b34e131b69b.png"}}]);
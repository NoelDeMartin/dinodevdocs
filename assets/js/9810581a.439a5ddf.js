"use strict";(self.webpackChunkdevdocs=self.webpackChunkdevdocs||[]).push([[14002],{33673:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>d,default:()=>p,frontMatter:()=>o,metadata:()=>r,toc:()=>c});var i=t(74848),a=t(28453),s=t(78924);const o={title:"Deprecation",tags:["Processes","Core development","Deprecation"]},d=void 0,r={id:"development/policies/deprecation/index",title:"Deprecation",description:"Deprecation, in its programming sense, is the process of taking older code and marking it as no longer being useful within the codebase, usually because it has been superseded by newer code. The deprecated code is not immediately removed from the codebase because doing so may cause regression errors.",source:"@site/general/development/policies/deprecation/index.md",sourceDirName:"development/policies/deprecation",slug:"/development/policies/deprecation/",permalink:"/moodledevdocs/general/development/policies/deprecation/",draft:!1,unlisted:!1,editUrl:"https://github.com/moodle/devdocs/edit/main/general/development/policies/deprecation/index.md",tags:[{label:"Processes",permalink:"/moodledevdocs/general/tags/processes"},{label:"Core development",permalink:"/moodledevdocs/general/tags/core-development"},{label:"Deprecation",permalink:"/moodledevdocs/general/tags/deprecation"}],version:"current",lastUpdatedBy:"Andrew Nicols",lastUpdatedAt:1713332374e3,frontMatter:{title:"Deprecation",tags:["Processes","Core development","Deprecation"]},sidebar:"coding",previous:{title:"Component Communication",permalink:"/moodledevdocs/general/development/policies/component-communication/"},next:{title:"SCSS Deprecation",permalink:"/moodledevdocs/general/development/policies/deprecation/scss-deprecation"}},l={},c=[{value:"Why is deprecation needed?",id:"why-is-deprecation-needed",level:2},{value:"What is Moodle&#39;s deprecation policy?",id:"what-is-moodles-deprecation-policy",level:2},{value:"Moodle Core deprecation process",id:"moodle-core-deprecation-process",level:2},{value:"Step 1. Immediate action",id:"step-1-immediate-action",level:3},{value:"Step 2. Final deprecation",id:"step-2-final-deprecation",level:3},{value:"Parameters deprecation",id:"parameters-deprecation",level:2},{value:"See also",id:"see-also",level:2}];function h(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components},{TabItem:t,Tabs:d,ValidExample:l}=n;return t||u("TabItem",!0),d||u("Tabs",!0),l||u("ValidExample",!0),(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(s.A,{frontMatter:o,metadata:r}),"\n",(0,i.jsx)(n.admonition,{title:"What is deprecation?",type:"info",children:(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.a,{href:"http://en.wikipedia.org/wiki/Deprecation",children:"Deprecation"}),", in its programming sense, is the process of taking older code and marking it as no longer being useful within the codebase, usually because it has been superseded by newer code. The deprecated code is not immediately removed from the codebase because doing so may cause regression errors."]})}),"\n",(0,i.jsx)(n.h2,{id:"why-is-deprecation-needed",children:"Why is deprecation needed?"}),"\n",(0,i.jsx)(n.p,{children:"In an open source project, the end use of the codebase varies. People may have customisations and plugins that depend on a function that has been targeted for deprecation. Rather than simply removing a function, we must gracefully deprecate the function over a period covered by a number of released versions."}),"\n",(0,i.jsx)(n.h2,{id:"what-is-moodles-deprecation-policy",children:"What is Moodle's deprecation policy?"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Deprecations should only be on master, not on stables (exceptions may be made for some external service integrations)"}),"\n",(0,i.jsx)(n.li,{children:"Deprecations apply to all public APIs, classes, and files."}),"\n",(0,i.jsx)(n.li,{children:"Removal of a function, class, or file may only be considered after a minimum of 4 major releases since the deprecation. Example: anything deprecated in 3.2 means that it will be removed in 3.6"}),"\n",(0,i.jsx)(n.li,{children:"All deprecations should emit debugging notices where possible"}),"\n",(0,i.jsx)(n.li,{children:"All deprecations should be noted in the relevant upgrade.txt"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"moodle-core-deprecation-process",children:"Moodle Core deprecation process"}),"\n",(0,i.jsx)(n.p,{children:"Once it is decided that a function should be deprecated, a two-step process should be followed."}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsxs)(n.p,{children:["Both steps should always happen as earlier as possible in the 6-months period between major releases, so all developers will have time to adjust their code and ensure it will work in the next release. Obviously, ",(0,i.jsx)(n.strong,{children:"no changes will be allowed after code freeze"})," (the APIs must remain 100% unmodified after it)."]})}),"\n",(0,i.jsx)(n.h3,{id:"step-1-immediate-action",children:"Step 1. Immediate action"}),"\n",(0,i.jsxs)(n.p,{children:["Deprecation affects only the current master version, in other words, the deprecation only becomes effective after the next ",(0,i.jsx)(n.a,{href:"/moodledevdocs/general/releases",children:"major release"}),"."]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["If the function is not a member of a class (in other words, it is an independent function), it should be moved, with its PHPDoc and all comments, to ",(0,i.jsx)(n.code,{children:"lib/deprecatedlib.php"}),", which is included everywhere. If the function is a class member, it will need to be deprecated in its current location.","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Deprecated behat step definitions should be moved to ",(0,i.jsx)(n.code,{children:"lib/tests/behat/behat_deprecated.php"}),". Steps that are part of a component should be moved to ",(0,i.jsx)(n.code,{children:"$COMPONENT_DIRECTORY/tests/behat/behat_<COMPONENT>_deprecated.php"})," instead. Deprecated function should call to ",(0,i.jsx)(n.code,{children:"behat_deprecated::deprecated_message()"})," proposing an alternative to the deprecated method."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["If an entire class is being deprecated, the following actions should be done:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Add @deprecated tag on class level PHPDoc block"}),"\n",(0,i.jsx)(n.li,{children:"Add @deprecated tag on the PHPDoc block of all public methods"}),"\n",(0,i.jsx)(n.li,{children:"Add debugging on all of the public methods"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["Besides, if the entire class is being moved (for example, moving multiple class definitions from a monolithic file in to individual files), follow the process for ",(0,i.jsx)(n.a,{href:"/docs/4.4/apis/commonfiles#dbrenamedclassesphp",children:"renaming classes"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["A debugging message should be added to the function so that, when ",(0,i.jsx)(n.a,{href:"https://docs.moodle.org/en/Debugging",children:"developer debugging mode"})," is on, attention is drawn to the deprecation. The message should state that the function being called has been deprecated. The message should help a developer whose code currently calls the function that has gone. Tell them what they should do instead."]}),"\n"]}),"\n",(0,i.jsxs)(d,{children:[(0,i.jsx)(t,{value:"debugging",label:"Deprecations using debugging",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"debugging('foobar() is deprecated. Please use foobar::blah() instead.', DEBUG_DEVELOPER);\n"})})}),(0,i.jsx)(t,{value:"core_deprecation",label:"Using the \\core\\deprecation API from Moodle 4.4",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"#[\\core\\attribute\\deprecated('foobar::blahv()', since: '4.4', mdl: 'MDL-XXXXX')]\npublic function foobar(): void {\n    \\core\\deprecation::emit_deprecation_if_present([$this, __FUNCTION__]);\n}\n"})})})]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Unit tests that call the function should have ",(0,i.jsx)(n.code,{children:"assertDebuggingCalled()"})," added to allow them to continue running."]}),"\n",(0,i.jsx)(n.li,{children:"If the deprecated function has been replaced with a new function, ideally the new function should be called from the deprecated function, so that the new functionality is used. This will make maintenance easier moving forward."}),"\n",(0,i.jsxs)(n.li,{children:["A ",(0,i.jsx)(n.code,{children:"@deprecated"})," tag should be added to the PHPDoc for the function description so that IDEs describing the function will note that it is deprecated, documenting which version it was deprecated in and the MDL issue associated with it. See the guidelines in ",(0,i.jsx)(n.a,{href:"/moodledevdocs/general/development/policies/codingstyle/#deprecated-and-todo",children:"Coding style"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["If the function is an external function, then an additional deprecation-specific method needs to be created and set to return true. See the ",(0,i.jsx)(n.a,{href:"/docs/4.4/apis/subsystems/external/writing-a-service#deprecation",children:"adding a web service to a plugin"})," docs on that process. You should continue to add the ",(0,i.jsx)(n.code,{children:"@deprecated since x.x"})," tag to the docs of all three of the relevant external methods (parameters, main method, returns) to make it clear to IDEs that the function is deprecated."]}),"\n",(0,i.jsxs)(n.li,{children:["There will need to be an issue associated with the initial part of the deprecation. A second issue needs to be created to finish the job. The first issue will be linked to second issue. The second issue needs to be a sub-task of an appropriate ",(0,i.jsx)(n.a,{href:"https://tracker.moodle.org/issues/?jql=%28summary%20~%20%22meta%22%20or%20type%20%3D%20Epic%29%20AND%20summary%20~%20%22together%20deprecated%22%20order%20by%20created&runQuery=true&clear=true",children:"deprecation META"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.admonition,{title:"Example",type:"note",children:(0,i.jsxs)(n.p,{children:["If the current version is 3.1.2, the function will be marked as deprecated in 3.2 and should normally be removed for 3.6, so the second issue should be an issue in a deprecation epic for the 3.6 version (",(0,i.jsx)(n.a,{href:"https://tracker.moodle.org/browse/MDL-54740",children:"MDL-54740"}),"). This second issue should include instructions on how to remove the function so that when it comes time to do so, the task is trivial for any developer."]})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Check the body of the function being deprecated and look for additional function calls which have no other non-deprecated uses and may also be considered for deprecation. If they belong to the same code area they can be deprecated in the same issue."}),"\n",(0,i.jsxs)(n.li,{children:["Last but not least, every deprecation should be documented in the corresponding ",(0,i.jsx)(n.code,{children:"upgrade.txt"})," files ",(0,i.jsx)(n.strong,{children:"at least"})," once but, ",(0,i.jsx)(n.strong,{children:"ideally"}),", both on this initial/immediate deprecation and also on the final deprecation/removal."]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Apart from the previous points, there are a few more optional but highly recommended steps:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["A ",(0,i.jsx)(n.code,{children:"@todo"})," tag can be added linking to the issues created for further action."]}),"\n",(0,i.jsxs)(n.li,{children:["A ",(0,i.jsx)(n.code,{children:"@see"})," tag can be added to point to the new apis that can be used."]}),"\n"]}),"\n",(0,i.jsx)(n.admonition,{type:"caution",children:(0,i.jsx)(n.p,{children:"Longer deprecation periods can be considered for functions that are widely used."})}),"\n",(0,i.jsx)(n.h3,{id:"step-2-final-deprecation",children:"Step 2. Final deprecation"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["If a function has been marked as deprecated for ",(0,i.jsx)(n.code,{children:"3.[x]"})," (eg. 3.1) and set for removal at ",(0,i.jsx)(n.code,{children:"3.[x + 4]"})," (eg. 3.5), soon after the release of ",(0,i.jsx)(n.code,{children:"3.[x + 3].1"})," (eg. 3.4.1), the ",(0,i.jsx)(n.code,{children:"3.[x + 4]"})," deprecation META will be processed. This means that the deprecated function will undergo final deprecation before ",(0,i.jsx)(n.code,{children:"3.[x + 4]"}),", but only in the master version. This allows any potential regressions caused by the final deprecation of the function to be exposed as soon as possible."]}),"\n",(0,i.jsx)(n.li,{children:"When a function undergoes final deprecation, all content of the function should be removed. In the skeleton that remains, an error statement should be included that indicates that the function cannot be used anymore. You can also direct developers to the new function(s) in this message."}),"\n"]}),"\n",(0,i.jsxs)(d,{children:[(0,i.jsx)(t,{value:"debugging",label:"Deprecations using debugging",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"throw new coding_exception(\n    'foobar() can not be used any more, please use foobar::blah'\n);\n"})})}),(0,i.jsx)(t,{value:"core_deprecation",label:"Using the \\core\\deprecation API from Moodle 4.4",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"#[\\core\\attribute\\deprecated('foobar::blah()', since: '4.4', mdl: 'MDL-XXXXX', final: true)]\npublic function foobar(): void {\n    \\core\\deprecation::emit_deprecation_if_present([self::class, __FUNCTION__]);\n}\n"})})})]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"All function parameters should be removed."}),"\n",(0,i.jsx)(n.li,{children:"Deprecated classes must be completely removed."}),"\n",(0,i.jsxs)(n.li,{children:["The content of the PHPDoc should be removed, leaving only the ",(0,i.jsx)(n.code,{children:"@deprecated"})," tag with the notice and, optionally, the replacement information. This includes all ",(0,i.jsx)(n.code,{children:"@param"}),", ",(0,i.jsx)(n.code,{children:"@return"}),", and other tags, as well as the description."]}),"\n",(0,i.jsx)(n.li,{children:"External functions deprecation process is different from the standard deprecation and functions should be completely removed."}),"\n",(0,i.jsxs)(n.li,{children:["Last but not least, every deprecation should be documented in the corresponding ",(0,i.jsx)(n.code,{children:"upgrade.txt"})," files ",(0,i.jsx)(n.strong,{children:"at least"})," once but, ",(0,i.jsx)(n.strong,{children:"ideally"}),", both on the initial/immediate deprecation and also on this final deprecation/removal."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"parameters-deprecation",children:"Parameters deprecation"}),"\n",(0,i.jsx)(n.p,{children:"Whilst it is possible to deprecate individual method parameters, care must be taken in doing so."}),"\n",(0,i.jsx)(n.p,{children:"If a method is overridden then it is often not possible to change parameters. This includes changing any type hint, or adding a new default value. Additionally, adding a default value to any argument is only possible if all remaining arguments are optional too."}),"\n",(0,i.jsx)(n.admonition,{type:"tip",children:(0,i.jsx)(n.p,{children:"It is strongly advised to deprecate an entire method, rather than deprecating a single parameter."})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Deprecated parameters ",(0,i.jsx)(n.strong,{children:"MUST"})," be retained, and ",(0,i.jsx)(n.strong,{children:"MUST NOT"})," be renamed"]}),"\n",(0,i.jsx)(n.li,{children:"The respective parameter phpDoc should be updated stating the parameter has been deprecated since version X.X and should not be used any more"}),"\n",(0,i.jsxs)(n.li,{children:["Update all calls to the affected function and either:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"converting to use named parameters, removing the deprecated parameter; or"}),"\n",(0,i.jsx)(n.li,{children:"removing if at the end of a list of optional parameters."}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["Add a mention to the corresponding ",(0,i.jsx)(n.code,{children:"upgrade.txt"})," file, documenting that the deprecated parameter should not be used any more"]}),"\n",(0,i.jsxs)(n.li,{children:["Add a mention to the ",(0,i.jsx)(n.a,{href:"https://github.com/moodle/devdocs/blob/main/docs/devupdate.md",children:"Developer Update notes"}),", documenting that the deprecated parameter should not be used any more"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.em,{children:"Where possible"}),":","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"If a type was previously specified it should be altered to be made nullable"}),"\n",(0,i.jsxs)(n.li,{children:["If the default value is not already ",(0,i.jsx)(n.code,{children:"null"}),", then it should be updated to ",(0,i.jsx)(n.code,{children:"null"})]}),"\n",(0,i.jsxs)(n.li,{children:["If the default value was not already ",(0,i.jsx)(n.code,{children:"null"}),", and a non-null value is provided, a debugging notice should be emitted"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.li,{children:"Where it is not possible to make the the type nullable, consider deprecating the method and creating a new one with the updated parameters"}),"\n"]}),"\n",(0,i.jsxs)(n.admonition,{title:"Changes to default values and types",type:"caution",children:[(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.a,{href:"https://www.php.net/manual/en/language.oop5.variance.php",children:"Covariance and Contravariance rules for PHP"})," prevent changes to argument types and defaults when a class is extended and that method overridden."]}),(0,i.jsxs)(n.p,{children:["When deprecating a method which is ",(0,i.jsx)(n.em,{children:"likely"})," to be extended, you should strongly consider deprecating the entire method and creating a replacement method with the updated arguments instead. This includes all renderer methods."]})]}),"\n",(0,i.jsx)(l,{children:(0,i.jsxs)(d,{children:[(0,i.jsx)(t,{value:"original",label:"Original",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:'/**\n * Greet a user and their pets. Remind them how old they are.\n *\n * @param string $name The name of the individual\n * @param int $age The age of the individaul\n * @param string[] $pets A list of pets that the individual has\n * @return The greeting\n */\npublic function greet_person(\n    string $name,\n    int $age,\n    array $pets = [],\n}: string {\n    return sprintf(\n        "A big, warm, welcome to %s who, at the grand old age of %d, has %d pets!",\n        $name,\n        $age,\n        count($pets),\n    );\n}\n'})})}),(0,i.jsx)(t,{value:"param-deprecation",label:"Deprecate a parameter",default:!0,children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"/**\n * Greet a user and their pets.\n *\n * @param string $name The name of the individual\n * @param null|int $age This parameter has been deprecated since 4.0 and should not be used anymore.\n * @param string[] $pets A list of pets that the individual has\n */\npublic function greet_person(\n    string $name,\n    null|int $age = null,\n    array $pets = [],\n}: void {\n    if ($age !== null) {\n        debugging(\n            'The age argument has been deprecated. Please remove it from your method calls.',\n            DEBUG_DEVELOPER,\n        );\n    }\n\n    return sprintf(\n        \"A big, warm, welcome to %s who has %d pets!\",\n        $name,\n        count($pets),\n    );\n}\n"})})}),(0,i.jsx)(t,{value:"method-deprecation",label:"Deprecating the method instead",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"/**\n * Greet a user and their pets.\n *\n * @param string $name The name of the individual\n * @param null|int $age This parameter has been deprecated since 4.0 and should not be used anymore.\n * @param string[] $pets A list of pets that the individual has\n */\npublic function greet_person(\n    string $name,\n    int $age,\n    array $pets = [],\n}: void {\n    debugging(\n        'The `greet_person` method has been deprecated and replaced with `greet_person_with_pets`. ' .\n            'Please update your method calls accordingly.',\n        DEBUG_DEVELOPER,\n    );\n\n    return $this->greet_person_with_pets(\n        name: $name,\n        pets: $pets,\n    );\n}\n"})})})]})}),"\n",(0,i.jsxs)(n.admonition,{title:"Deprecations for core methods in Moodle 4.1 and earlier",type:"note",children:[(0,i.jsxs)(n.p,{children:["Prior to support for PHP 8.0 in Moodle 4.2, the policy for parameter argument deprecation stated that deprecated parameters must be renamed to ",(0,i.jsx)(n.code,{children:"$unused"})," or a similar name."]}),(0,i.jsx)(n.p,{children:"This has been changed to no longer allow renaming of arguments because it can lead to fatal errors if the calling code makes use of named parameter arguments."}),(0,i.jsx)(n.p,{children:"Named parameter arguments are available from PHP 8.0 onwards."})]}),"\n",(0,i.jsx)(n.h2,{id:"see-also",children:"See also"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/moodledevdocs/general/projects/api/string-deprecation",children:"String deprecation"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/docs/4.4/apis/core/deprecation/",children:"Deprecation attributes"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/docs/4.4/apis/subsystems/external/writing-a-service#deprecation",children:"External functions deprecation"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/docs/4.4/apis/subsystems/access#deprecating-a-capability",children:"Capabilities deprecation"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/moodledevdocs/general/development/policies/deprecation/scss-deprecation",children:"SCSS deprecation"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/moodledevdocs/general/development/process",children:"Process"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/moodledevdocs/general/development/process/release/",children:"Release process"})}),"\n"]})]})}function p(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(h,{...e})}):h(e)}function u(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}}}]);
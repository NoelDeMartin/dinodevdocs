"use strict";(self.webpackChunkdevdocs=self.webpackChunkdevdocs||[]).push([[68996],{54638:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>a,default:()=>u,frontMatter:()=>t,metadata:()=>c,toc:()=>o});var r=s(74848),l=s(28453),i=s(78924);const t={title:"Data manipulation API",tags:["DB","XMLDB","API","core","core_dml"]},a=void 0,c={id:"apis/core/dml/index",title:"Data manipulation API",description:"This page describes the functions available to access data in the Moodle database. You should exclusively use these functions in order to retrieve or modify database content because these functions provide a high level of abstraction and guarantee that your database manipulation will work against different RDBMSes.",source:"@site/versioned_docs/version-4.2/apis/core/dml/index.md",sourceDirName:"apis/core/dml",slug:"/apis/core/dml/",permalink:"/moodledevdocs/docs/4.2/apis/core/dml/",draft:!1,unlisted:!1,editUrl:"https://github.com/moodle/devdocs/edit/main/versioned_docs/version-4.2/apis/core/dml/index.md",tags:[{label:"DB",permalink:"/moodledevdocs/docs/4.2/tags/db"},{label:"XMLDB",permalink:"/moodledevdocs/docs/4.2/tags/xmldb"},{label:"API",permalink:"/moodledevdocs/docs/4.2/tags/api"},{label:"core",permalink:"/moodledevdocs/docs/4.2/tags/core"},{label:"core_dml",permalink:"/moodledevdocs/docs/4.2/tags/core-dml"}],version:"4.2",lastUpdatedBy:"Andrew Nicols",lastUpdatedAt:1713332374e3,frontMatter:{title:"Data manipulation API",tags:["DB","XMLDB","API","core","core_dml"]},sidebar:"docs",previous:{title:"Conditional activities API",permalink:"/moodledevdocs/docs/4.2/apis/core/conditionalactivities/"},next:{title:"Database schema",permalink:"/moodledevdocs/docs/4.2/apis/core/dml/database-schema"}},d={},o=[{value:"General concepts",id:"general-concepts",level:2},{value:"DB object",id:"db-object",level:3},{value:"Table prefix",id:"table-prefix",level:3},{value:"Conditions",id:"conditions",level:3},{value:"Placeholders",id:"placeholders",level:3},{value:"Strictness",id:"strictness",level:3},{value:"Getting a single record",id:"getting-a-single-record",level:2},{value:"get_record",id:"get_record",level:3},{value:"get_record_select",id:"get_record_select",level:3},{value:"get_record_sql",id:"get_record_sql",level:3},{value:"Getting a hashed array of records",id:"getting-a-hashed-array-of-records",level:2},{value:"get_records",id:"get_records",level:3},{value:"get_records_select",id:"get_records_select",level:3},{value:"get_records_sql",id:"get_records_sql",level:3},{value:"get_records_list",id:"get_records_list",level:3},{value:"Getting data as key/value pairs in an associative array",id:"getting-data-as-keyvalue-pairs-in-an-associative-array",level:2},{value:"get_records_menu",id:"get_records_menu",level:3},{value:"get_records_select_menu",id:"get_records_select_menu",level:3},{value:"get_records_sql_menu",id:"get_records_sql_menu",level:3},{value:"Counting records that match the given criteria",id:"counting-records-that-match-the-given-criteria",level:2},{value:"count_records",id:"count_records",level:3},{value:"count_records_select",id:"count_records_select",level:3},{value:"count_records_sql",id:"count_records_sql",level:3},{value:"Checking if a given record exists",id:"checking-if-a-given-record-exists",level:2},{value:"record_exists",id:"record_exists",level:3},{value:"record_exists_select",id:"record_exists_select",level:3},{value:"record_exists_sql",id:"record_exists_sql",level:3},{value:"Getting a particular field value from one record",id:"getting-a-particular-field-value-from-one-record",level:2},{value:"get_field",id:"get_field",level:3},{value:"get_field_select",id:"get_field_select",level:3},{value:"get_field_sql",id:"get_field_sql",level:3},{value:"Getting field values from multiple records",id:"getting-field-values-from-multiple-records",level:2},{value:"get_fieldset_select",id:"get_fieldset_select",level:3},{value:"get_fieldset_sql",id:"get_fieldset_sql",level:3},{value:"Setting a field value",id:"setting-a-field-value",level:2},{value:"set_field",id:"set_field",level:3},{value:"set_field_select",id:"set_field_select",level:3},{value:"Deleting records",id:"deleting-records",level:2},{value:"delete_records",id:"delete_records",level:3},{value:"delete_records_select",id:"delete_records_select",level:3},{value:"Inserting records",id:"inserting-records",level:2},{value:"insert_record",id:"insert_record",level:3},{value:"insert_records",id:"insert_records",level:3},{value:"insert_record_raw",id:"insert_record_raw",level:3},{value:"Updating records",id:"updating-records",level:2},{value:"update_record",id:"update_record",level:3},{value:"Executing a custom query",id:"executing-a-custom-query",level:2},{value:"execute",id:"execute",level:3},{value:"Using recordsets",id:"using-recordsets",level:2},{value:"get_recordset",id:"get_recordset",level:3},{value:"get_recordset_select",id:"get_recordset_select",level:3},{value:"get_recordset_sql",id:"get_recordset_sql",level:3},{value:"get_recordset_list",id:"get_recordset_list",level:3},{value:"Delegated transactions",id:"delegated-transactions",level:2},{value:"Example",id:"example",level:3},{value:"Cross-DB compatibility",id:"cross-db-compatibility",level:2},{value:"sql_bitand",id:"sql_bitand",level:3},{value:"sql_bitnot",id:"sql_bitnot",level:3},{value:"sql_bitor",id:"sql_bitor",level:3},{value:"sql_bitxor",id:"sql_bitxor",level:3},{value:"sql_null_from_clause",id:"sql_null_from_clause",level:3},{value:"sql_ceil",id:"sql_ceil",level:3},{value:"sql_equal",id:"sql_equal",level:3},{value:"sql_like",id:"sql_like",level:3},{value:"sql_like_escape",id:"sql_like_escape",level:3},{value:"sql_length",id:"sql_length",level:3},{value:"sql_modulo",id:"sql_modulo",level:3},{value:"sql_position",id:"sql_position",level:3},{value:"sql_substr",id:"sql_substr",level:3},{value:"sql_cast_char2int",id:"sql_cast_char2int",level:3},{value:"sql_cast_char2real",id:"sql_cast_char2real",level:3},{value:"sql_cast_to_char",id:"sql_cast_to_char",level:3},{value:"sql_compare_text",id:"sql_compare_text",level:3},{value:"sql_order_by_text",id:"sql_order_by_text",level:3},{value:"sql_order_by_null",id:"sql_order_by_null",level:3},{value:"sql_concat",id:"sql_concat",level:3},{value:"sql_group_concat",id:"sql_group_concat",level:3},{value:"sql_concat_join",id:"sql_concat_join",level:3},{value:"sql_fullname",id:"sql_fullname",level:3},{value:"sql_isempty",id:"sql_isempty",level:3},{value:"sql_isnotempty",id:"sql_isnotempty",level:3},{value:"get_in_or_equal",id:"get_in_or_equal",level:3},{value:"sql_regex_supported",id:"sql_regex_supported",level:3},{value:"sql_regex",id:"sql_regex",level:3},{value:"sql_regex_get_word_beginning_boundary_marker",id:"sql_regex_get_word_beginning_boundary_marker",level:3},{value:"sql_regex_get_word_end_boundary_marker",id:"sql_regex_get_word_end_boundary_marker",level:3},{value:"sql_intersect",id:"sql_intersect",level:3},{value:"Debugging",id:"debugging",level:2},{value:"set_debug",id:"set_debug",level:3},{value:"Special cases",id:"special-cases",level:2},{value:"get_course",id:"get_course",level:3},{value:"get_courses",id:"get_courses",level:3},{value:"See also",id:"see-also",level:2}];function h(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,l.R)(),...e.components},{InvalidExample:s,Since:a,ValidExample:d}=n;return s||p("InvalidExample",!0),a||p("Since",!0),d||p("ValidExample",!0),(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(i.A,{frontMatter:t,metadata:c}),"\n",(0,r.jsxs)(n.p,{children:["This page describes the functions available to access data in the Moodle database. You should ",(0,r.jsx)(n.strong,{children:"exclusively"})," use these functions in order to retrieve or modify database content because these functions provide a high level of abstraction and guarantee that your database manipulation will work against different RDBMSes."]}),"\n",(0,r.jsx)(n.p,{children:"Where possible, tricks and examples will be documented here in order to make developers' lives a bit easier. Of course, feel free to clarify, complete and add more information to this documentation. It will be welcome, absolutely!"}),"\n",(0,r.jsx)(n.h2,{id:"general-concepts",children:"General concepts"}),"\n",(0,r.jsx)(n.h3,{id:"db-object",children:"DB object"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["The data manipulation API is exposed via public methods of the ",(0,r.jsx)("tt",{children:"$DB"})," object."]}),"\n",(0,r.jsx)(n.li,{children:"Moodle core takes care of setting up the connection to the database according to values specified in the main config.php file."}),"\n",(0,r.jsxs)(n.li,{children:["The $DB global object is an instance of the ",(0,r.jsx)("tt",{children:"moodle_database"})," class. It is instantiated automatically during the bootstrap setup, i.e. as a part of including the main config.php file."]}),"\n",(0,r.jsx)(n.li,{children:"The DB object is available in the global scope right after including the config.php file:"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",metastring:'title="example.php"',children:"<?php\nrequire(__DIR__ . '/config.php');\n\n// You can access the database via the $DB method calls here.\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"To make the DB object available in your local scope, such as within a function:"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",metastring:'title="example.php"',children:"<?php\n\nfunction my_function_making_use_of_database() {\n    global $DB;\n\n    // You can access the database via the $DB method calls here.\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"table-prefix",children:"Table prefix"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Most Moodle installations use a prefix for all the database tables, such as ",(0,r.jsx)("tt",{children:"mdl_"}),". This prefix is NOT to be used in the code itself."]}),"\n",(0,r.jsxs)(n.li,{children:["All the ",(0,r.jsx)(n.code,{children:"$table"})," parameters in the functions are meant to be the table name without prefixes:"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"$user = $DB->get_record('user', ['id' => '1']);\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["In custom SQL queries, table names must be enclosed between curly braces. They will be then automatically converted to the real prefixed table name. There is no need to access ",(0,r.jsx)("tt",{children:"$CFG->prefix"})]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"$user = $DB->get_record_sql('SELECT COUNT(*) FROM {user} WHERE deleted = 1 OR suspended = 1;');\n"})}),"\n",(0,r.jsx)(n.h3,{id:"conditions",children:"Conditions"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["All the ",(0,r.jsx)(n.code,{children:"$conditions"})," parameters in the functions are arrays of ",(0,r.jsx)(n.code,{children:"fieldname => fieldvalue"})," elements."]}),"\n",(0,r.jsxs)(n.li,{children:["They all must be fulfilled - that is the logical ",(0,r.jsx)("tt",{children:"AND"})," is used to populate the actual ",(0,r.jsx)("tt",{children:"WHERE"})," statement"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"$user = $DB->get_record('user', ['firstname'  => 'Martin', 'lastname'  => 'Dougiamas']);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"placeholders",children:"Placeholders"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["All the ",(0,r.jsx)(n.code,{children:"$params"})," parameters in the functions are arrays of values used to fill placeholders in SQL statements."]}),"\n",(0,r.jsx)(n.li,{children:"Placeholders help to avoid problems with SQL-injection and/or invalid quotes in SQL queries. They facilitate secure and cross-db compatible code."}),"\n",(0,r.jsxs)(n.li,{children:["Two types of placeholders are supported - question marks (",(0,r.jsx)("tt",{children:"SQL_PARAMS_QM"}),") and named placeholders (",(0,r.jsx)("tt",{children:"SQL_PARAMS_NAMED"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:["Named params ",(0,r.jsx)(n.strong,{children:"must be unique"})," even if the value passed is the same. If you need to pass the same value multiple times, you need to have multiple distinct named parameters."]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",metastring:'title="Example of using question-mark placeholders"',children:"$DB->get_record_sql(\n    'SELECT * FROM {user} WHERE firstname = ? AND lastname = ?',\n    [\n        'Martin',\n        'Dougiamas',\n    ]\n);\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",metastring:'title="Example of using named placeholders"',children:"$DB->get_record_sql(\n    'SELECT * FROM {user} WHERE firstname = :firstname AND lastname = :lastname',\n    [\n        'firstname'  => 'Martin',\n        'lastname'  => 'Dougiamas',\n    ]\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"strictness",children:"Strictness"}),"\n",(0,r.jsxs)(n.p,{children:["Some methods accept the ",(0,r.jsx)("tt",{children:"$strictness"})," parameter affecting the method behaviour. Supported modes are specified using the constants:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)("tt",{children:"MUST_EXIST"})," - In this mode, the requested record must exist and must be unique. An exception will be thrown if no record is found or multiple matching records are found."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)("tt",{children:"IGNORE_MISSING"})," - In this mode, a missing record is not an error. False boolean is returned if the requested record is not found. If more records are found, a debugging message is displayed."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)("tt",{children:"IGNORE_MULTIPLE"})," - This is not a recommended mode. The function will silently ignore multiple records found and will return just the first one of them."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"getting-a-single-record",children:"Getting a single record"}),"\n",(0,r.jsx)(n.h3,{id:"get_record",children:"get_record"}),"\n",(0,r.jsx)(n.p,{children:"Return a single database record as an object where all the given conditions are met."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function get_record(\n    $table,\n    array $conditions,\n    $fields = '*',\n    $strictness = IGNORE_MISSING\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"get_record_select",children:"get_record_select"}),"\n",(0,r.jsx)(n.p,{children:"Return a single database record as an object where the given conditions are used in the WHERE clause."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function get_record_select(\n    $table,\n    $select,\n    array $params = null,\n    $fields = '*',\n    $strictness = IGNORE_MISSING\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"get_record_sql",children:"get_record_sql"}),"\n",(0,r.jsx)(n.p,{children:"Return a single database record as an object using a custom SELECT query."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function get_record_sql(\n    $sql,\n    array $params = null,\n    $strictness = IGNORE_MISSING\n);\n"})}),"\n",(0,r.jsx)(n.h2,{id:"getting-a-hashed-array-of-records",children:"Getting a hashed array of records"}),"\n",(0,r.jsxs)(n.p,{children:['Each of the following methods return an array of objects. The array is indexed by the first column of the fields returned by the query. To assure consistency, it is a good practice to ensure that your query include an "id column" as the first field. When designing custom tables, make ',(0,r.jsx)("tt",{children:"id"})," their first column and primary key."]}),"\n",(0,r.jsx)(n.h3,{id:"get_records",children:"get_records"}),"\n",(0,r.jsx)(n.p,{children:"Return a list of records as an array of objects where all the given conditions are met."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function get_records(\n    $table,\n    array $conditions = null,\n    $sort = '',\n    $fields = '*',\n    $limitfrom = 0,\n    $limitnum = 0\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"get_records_select",children:"get_records_select"}),"\n",(0,r.jsx)(n.p,{children:"Return a list of records as an array of objects where the given conditions are used in the WHERE clause."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function get_records_select(\n    $table,\n    $select,\n    array $params = null,\n    $sort = '',\n    $fields = '*',\n    $limitfrom = 0,\n    $limitnum = 0\n);\n"})}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"$fields"})," parameter is a comma separated list of fields to return (optional, by default all fields are returned)."]}),"\n",(0,r.jsx)(n.h3,{id:"get_records_sql",children:"get_records_sql"}),"\n",(0,r.jsx)(n.p,{children:"Return a list of records as an array of objects using a custom SELECT query."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function get_records_sql(\n    $sql,\n    array $params = null,\n    $limitfrom = 0,\n    $limitnum = 0\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"get_records_list",children:"get_records_list"}),"\n",(0,r.jsx)(n.p,{children:"Return a list of records as an array of objects where the given field matches one of the possible values."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function get_records_list(\n    $table,\n    $field,\n    array $values,\n    $sort = *,\n    $fields = '*',\n    $limitfrom = *,\n    $limitnum = ''\n)\n"})}),"\n",(0,r.jsx)(n.h2,{id:"getting-data-as-keyvalue-pairs-in-an-associative-array",children:"Getting data as key/value pairs in an associative array"}),"\n",(0,r.jsx)(n.h3,{id:"get_records_menu",children:"get_records_menu"}),"\n",(0,r.jsx)(n.p,{children:"Return the first two columns from a list of records as an associative array where all the given conditions are met."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function get_records_menu(\n    $table,\n    array $conditions = null,\n    $sort = '',\n    $fields = '*',\n    $limitfrom = 0,\n    $limitnum = 0\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"get_records_select_menu",children:"get_records_select_menu"}),"\n",(0,r.jsx)(n.p,{children:"Return the first two columns from a list of records as an associative array where the given conditions are used in the WHERE clause."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function get_records_select_menu(\n    $table,\n    $select,\n    array $params = null,\n    $sort = '',\n    $fields = '*',\n    $limitfrom = 0,\n    $limitnum = 0\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"get_records_sql_menu",children:"get_records_sql_menu"}),"\n",(0,r.jsx)(n.p,{children:"Return the first two columns from a number of records as an associative array using a custom SELECT query."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function get_records_sql_menu(\n    $sql,\n    array $params = null,\n    $limitfrom = 0,\n    $limitnum = 0\n);\n"})}),"\n",(0,r.jsx)(n.h2,{id:"counting-records-that-match-the-given-criteria",children:"Counting records that match the given criteria"}),"\n",(0,r.jsx)(n.h3,{id:"count_records",children:"count_records"}),"\n",(0,r.jsx)(n.p,{children:"Count the records in a table where all the given conditions are met."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function count_records(\n    $table,\n    array $conditions = null\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"count_records_select",children:"count_records_select"}),"\n",(0,r.jsx)(n.p,{children:"Count the records in a table where the given conditions are used in the WHERE clause."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function count_records_select(\n    $table,\n    $select,\n    array $params = null,\n    $countitem = \"COUNT('x')\"\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"count_records_sql",children:"count_records_sql"}),"\n",(0,r.jsx)(n.p,{children:"Counting the records using a custom SELECT COUNT(...) query."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function count_records_sql(\n    $sql,\n    array $params = null\n);\n"})}),"\n",(0,r.jsx)(n.h2,{id:"checking-if-a-given-record-exists",children:"Checking if a given record exists"}),"\n",(0,r.jsx)(n.h3,{id:"record_exists",children:"record_exists"}),"\n",(0,r.jsx)(n.p,{children:"Test whether a record exists in a table where all the given conditions are met."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function record_exists(\n    $table,\n    array $conditions = null\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"record_exists_select",children:"record_exists_select"}),"\n",(0,r.jsx)(n.p,{children:"Test whether any records exists in a table where the given conditions are used in the WHERE clause."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function record_exists_select(\n    $table,\n    $select,\n    array $params = null\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"record_exists_sql",children:"record_exists_sql"}),"\n",(0,r.jsx)(n.p,{children:"Test whether the given SELECT query would return any record."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function record_exists_sql(\n    $sql,\n    array $params = null\n);\n"})}),"\n",(0,r.jsx)(n.h2,{id:"getting-a-particular-field-value-from-one-record",children:"Getting a particular field value from one record"}),"\n",(0,r.jsx)(n.h3,{id:"get_field",children:"get_field"}),"\n",(0,r.jsx)(n.p,{children:"Get a single field value from a table record where all the given conditions are met."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function get_field(\n    $table,\n    $return,\n    array $conditions,\n    $strictness = IGNORE_MISSING\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"get_field_select",children:"get_field_select"}),"\n",(0,r.jsx)(n.p,{children:"Get a single field value from a table record where the given conditions are used in the WHERE clause."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function get_field_select(\n    $table,\n    $return,\n    $select,\n    array $params = null,\n    $strictness = IGNORE_MISSING\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"get_field_sql",children:"get_field_sql"}),"\n",(0,r.jsx)(n.p,{children:"Get a single field value (first field) using a custom SELECT query."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function get_field_sql(\n    $sql,\n    array $params = null,\n    $strictness = IGNORE_MISSING\n);\n"})}),"\n",(0,r.jsx)(n.h2,{id:"getting-field-values-from-multiple-records",children:"Getting field values from multiple records"}),"\n",(0,r.jsx)(n.h3,{id:"get_fieldset_select",children:"get_fieldset_select"}),"\n",(0,r.jsx)(n.p,{children:"Return values of the given field as an array where the given conditions are used in the WHERE clause."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function get_fieldset_select(\n    $table,\n    $return,\n    $select,\n    array $params = null\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"get_fieldset_sql",children:"get_fieldset_sql"}),"\n",(0,r.jsx)(n.p,{children:"Return values of the first column as an array using a custom SELECT field FROM ... query."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function get_fieldset_sql(\n    $sql,\n    array $params = null\n);\n"})}),"\n",(0,r.jsx)(n.h2,{id:"setting-a-field-value",children:"Setting a field value"}),"\n",(0,r.jsx)(n.h3,{id:"set_field",children:"set_field"}),"\n",(0,r.jsx)(n.p,{children:"Set a single field in every record where all the given conditions are met."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function set_field(\n    $table,\n    $newfield,\n    $newvalue,\n    array $conditions = null\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"set_field_select",children:"set_field_select"}),"\n",(0,r.jsx)(n.p,{children:"Set a single field in every table record where the given conditions are used in the WHERE clause."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function set_field_select(\n    $table,\n    $newfield,\n    $newvalue,\n    $select,\n    array $params = null\n);\n"})}),"\n",(0,r.jsx)(n.h2,{id:"deleting-records",children:"Deleting records"}),"\n",(0,r.jsx)(n.h3,{id:"delete_records",children:"delete_records"}),"\n",(0,r.jsx)(n.p,{children:"Delete records from the table where all the given conditions are met."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function delete_records(\n    $table,\n    array $conditions = null\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"delete_records_select",children:"delete_records_select"}),"\n",(0,r.jsx)(n.p,{children:"Delete records from the table where the given conditions are used in the WHERE clause."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function delete_records_select(\n    $table,\n    $select,\n    array $params = null\n);\n"})}),"\n",(0,r.jsx)(n.h2,{id:"inserting-records",children:"Inserting records"}),"\n",(0,r.jsx)(n.h3,{id:"insert_record",children:"insert_record"}),"\n",(0,r.jsx)(n.p,{children:'Insert the given data object into the table and return the "id" of the newly created record.'}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function insert_record(\n    $table,\n    $dataobject,\n    $returnid = true,\n    $bulk = false\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"insert_records",children:"insert_records"}),"\n",(0,r.jsx)(n.p,{children:"Insert multiple records into the table as fast as possible. Records are inserted in the given order, but the operation is not atomic. Use transactions if necessary."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function insert_records(\n    $table,\n    $dataobjects\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"insert_record_raw",children:"insert_record_raw"}),"\n",(0,r.jsx)(n.p,{children:"For rare cases when you also need to specify the ID of the record to be inserted."}),"\n",(0,r.jsx)(n.h2,{id:"updating-records",children:"Updating records"}),"\n",(0,r.jsx)(n.h3,{id:"update_record",children:"update_record"}),"\n",(0,r.jsx)(n.p,{children:'Update a record in the table. The data object must have the property "id" set.'}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function update_record(\n    $table,\n    $dataobject,\n    $bulk = false\n);\n"})}),"\n",(0,r.jsx)(n.h2,{id:"executing-a-custom-query",children:"Executing a custom query"}),"\n",(0,r.jsx)(n.h3,{id:"execute",children:"execute"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:'If you need to perform a complex update using arbitrary SQL, you can use the low level "execute" method. Only use this when no specialised method exists.'}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function execute(\n    $sql,\n    array $params = null\n);\n"})}),"\n",(0,r.jsx)(n.admonition,{type:"danger",children:(0,r.jsxs)(n.p,{children:["Do NOT use this to make changes in database structure, use the ",(0,r.jsx)(n.code,{children:"database_manager"})," methods instead."]})}),"\n",(0,r.jsx)(n.h2,{id:"using-recordsets",children:"Using recordsets"}),"\n",(0,r.jsxs)(n.p,{children:["If the number of records to be retrieved from DB is high, the 'get_records_xxx() functions above are far from optimal, because they load all the records into the memory via the returned array. Under those circumstances, it is highly recommended to use these ",(0,r.jsx)(n.code,{children:"get_recordset_xxx()"})," functions instead. They return an iterator to iterate over all the found records and save a lot of memory."]}),"\n",(0,r.jsxs)(n.p,{children:["It is ",(0,r.jsx)(n.strong,{children:"absolutely important"})," to not forget to close the returned recordset iterator after using it. This is to free up a lot of resources in the RDBMS."]}),"\n",(0,r.jsxs)(n.p,{children:["A general way to iterate over records using the ",(0,r.jsx)(n.code,{children:"get_recordset_xxx()"})," functions:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"$rs = $DB->get_recordset(....);\nforeach ($rs as $record) {\n    // Do whatever you want with this record\n}\n$rs->close();\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Unlike get_record functions, you cannot check if ",(0,r.jsx)("tt",{children:"$rs  = = true"})," or ",(0,r.jsx)("tt",{children:"!empty($rs)"})," to determine if any records were found. Instead, if you need to, you can use:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"if ($rs->valid()) {\n    // The recordset contains some records.\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"get_recordset",children:"get_recordset"}),"\n",(0,r.jsx)(n.p,{children:"Return a list of records as a moodle_recordset where all the given conditions are met."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function get_recordset(\n    $table,\n    array $conditions = null,\n    $sort = '',\n    $fields = '*',\n    $limitfrom = 0,\n    $limitnum = 0\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"get_recordset_select",children:"get_recordset_select"}),"\n",(0,r.jsx)(n.p,{children:"Return a list of records as a moodle_recordset where the given conditions are used in the WHERE clause."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function get_recordset_select(\n    $table,\n    $select,\n    array $params = null,\n    $sort = '',\n    $fields = '*',\n    $limitfrom = 0,\n    $limitnum = 0\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"get_recordset_sql",children:"get_recordset_sql"}),"\n",(0,r.jsx)(n.p,{children:"Return a list of records as a moodle_recordset using a custom SELECT query."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function get_recordset_sql(\n    $sql,\n    array $params = null,\n    $limitfrom = 0,\n    $limitnum = 0\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"get_recordset_list",children:"get_recordset_list"}),"\n",(0,r.jsx)(n.p,{children:"Return a list of records as a moodle_recordset where the given field matches one of the possible values."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function get_recordset_list(\n    $table,\n    $field,\n    array $values,\n    $sort = *,\n    $fields = '*',\n    $limitfrom = *,\n    $limitnum = ''\n);\n"})}),"\n",(0,r.jsx)(n.h2,{id:"delegated-transactions",children:"Delegated transactions"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Please note some databases do not support transactions (such as the MyISAM MySQL database engine), however all server administrators are strongly encouraged to migrate to databases that support transactions (such as the InnoDB MySQL database engine)."}),"\n",(0,r.jsx)(n.li,{children:"Previous versions supported only one level of transaction. Since Moodle 2.0, the DML layer emulates delegated transactions that allow nesting of transactions."}),"\n",(0,r.jsx)(n.li,{children:"Some subsystems (such as messaging) do not support transactions because it is not possible to rollback in external systems.\nA transaction is started by:"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"$transaction = $DB->start_delegated_transaction();\n"})}),"\n",(0,r.jsx)(n.p,{children:"and finished by:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"$transaction->allow_commit();\n"})}),"\n",(0,r.jsx)(n.p,{children:"Usually a transaction is rolled back when an exception is thrown:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"$transaction->rollback($ex);\n"})}),"\n",(0,r.jsx)(n.p,{children:"which must be used very carefully because it might break compatibility with databases that do not support transactions. Transactions cannot be used as part of expected code flow; they can be used only as an emergency protection of data consistency."}),"\n",(0,r.jsx)(n.p,{children:"::: More information"}),"\n",(0,r.jsxs)(n.p,{children:["For more information see ",(0,r.jsx)(n.a,{href:"https://docs.moodle.org/dev/DB_layer_2.0_delegated_transactions",children:"DB layer 2.0 delegated transactions"})," or ",(0,r.jsx)(n.a,{href:"https://tracker.moodle.org/browse/MDL-20625",children:"MDL-20625"}),"."]}),"\n",(0,r.jsx)(n.p,{children:":::"}),"\n",(0,r.jsx)(n.h3,{id:"example",children:"Example"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"global $DB;\ntry {\n     $transaction = $DB->start_delegated_transaction();\n     $DB->insert_record('foo', $object);\n     $DB->insert_record('bar', $otherobject);\n\n     // Assuming the both inserts work, we get to the following line.\n     $transaction->allow_commit();\n\n} catch(Exception $e) {\n     $transaction->rollback($e);\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"cross-db-compatibility",children:"Cross-DB compatibility"}),"\n",(0,r.jsx)(n.p,{children:"Moodle supports several SQL servers, including MySQL, MariaDB, PostgreSQL, MS-SQL and Oracle. These may have specific syntax in certain cases. In order to achieve cross-db compatibility of the code, the following functions must be used to generate the fragments of the query valid for the actual SQL server."}),"\n",(0,r.jsx)(n.h3,{id:"sql_bitand",children:"sql_bitand"}),"\n",(0,r.jsx)(n.p,{children:"Return the SQL text to be used in order to perform a bitwise AND operation between 2 integers."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function sql_bitand(\n    $int1,\n    $int2\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"sql_bitnot",children:"sql_bitnot"}),"\n",(0,r.jsx)(n.p,{children:"Return the SQL text to be used in order to perform a bitwise NOT operation on the given integer."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function sql_bitnot(\n    $int1\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"sql_bitor",children:"sql_bitor"}),"\n",(0,r.jsx)(n.p,{children:"Return the SQL text to be used in order to perform a bitwise OR operation between 2 integers."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function sql_bitor(\n    $int1,\n    $int2\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"sql_bitxor",children:"sql_bitxor"}),"\n",(0,r.jsx)(n.p,{children:"Return the SQL text to be used in order to perform a bitwise XOR operation between 2 integers."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function sql_bitxor(\n    $int1,\n    $int2\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"sql_null_from_clause",children:"sql_null_from_clause"}),"\n",(0,r.jsx)(n.p,{children:"Return an empty FROM clause required by some DBs in all SELECT statements."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function sql_null_from_clause()\n"})}),"\n",(0,r.jsx)(n.h3,{id:"sql_ceil",children:"sql_ceil"}),"\n",(0,r.jsx)(n.p,{children:"Return the correct CEIL expression applied to the given fieldname."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function sql_ceil(\n    $fieldname\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"sql_equal",children:"sql_equal"}),"\n",(0,r.jsx)(a,{version:"3.2"}),"\n",(0,r.jsx)(n.p,{children:"Return the query fragment to perform cross-db varchar comparisons when case-sensitiveness is important."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function sql_equal(\n    $fieldname,\n    $param,\n    $casesensitive = true,\n    $accentsensitive = true,\n    $notequal = false\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"sql_like",children:"sql_like"}),"\n",(0,r.jsx)(n.p,{children:"Return the query fragment to perform the LIKE comparison."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"$DB->sql_like(\n    $fieldname,\n    $param,\n    $casesensitive = true,\n    $accentsensitive = true,\n    $notlike = false,\n    $escapechar = ' \\\\ '\n);\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",metastring:"title='Example: Searching for records partially matching the given hard-coded literal'",children:"$likeidnumber = $DB->sql_like('idnumber', ':idnum');\n$DB->get_records_sql(\n    \"SELECT id, fullname FROM {course} WHERE {$likeidnumber}\",\n    [\n        'idnum' => 'DEMO-%',\n    ]\n);\n"})}),"\n",(0,r.jsx)(n.p,{children:"See below if you need to compare with a value submitted by the user."}),"\n",(0,r.jsx)(n.h3,{id:"sql_like_escape",children:"sql_like_escape"}),"\n",(0,r.jsx)(n.p,{children:"Escape the value submitted by the user so that it can be used for partial comparison and the special characters like '_' or '%' behave as literal characters, not wildcards."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"$DB->sql_like_escape(\n    $text,\n    $escapechar = '\\\\'\n);\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",metastring:'title="Example: If you need to perform a partial comparison with a value that has been submitted by the user"',children:"$search = required_param('search', PARAM_RAW);\n\n$likefullname = $DB->sql_like('fullname', ':fullname');\n$DB->get_records_sql(\n    \"SELECT id, fullname FROM {course} WHERE {$likefullname}\",\n    [\n        'fullname'  => '%' . $DB->sql_like_escape($search) . '%',\n    ]\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"sql_length",children:"sql_length"}),"\n",(0,r.jsx)(n.p,{children:"Return the query fragment to be used to calculate the length of the expression in characters."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function sql_length(\n    $fieldname\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"sql_modulo",children:"sql_modulo"}),"\n",(0,r.jsx)(n.p,{children:"Return the query fragment to be used to calculate the remainder after division."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function sql_modulo(\n    $int1,\n    $int2\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"sql_position",children:"sql_position"}),"\n",(0,r.jsx)(n.p,{children:"Return the query fragment for searching a string for the location of a substring. If both needle and haystack use placeholders, you must use named placeholders."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function sql_position(\n    $needle,\n    $haystack\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"sql_substr",children:"sql_substr"}),"\n",(0,r.jsx)(n.p,{children:"Return the query fragment for extracting a substring from the given expression."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function sql_substr(\n    $expr,\n    $start,\n    $length = false\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"sql_cast_char2int",children:"sql_cast_char2int"}),"\n",(0,r.jsx)(n.p,{children:"Return the query fragment to cast a CHAR column to INTEGER"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function sql_cast_char2int(\n    $fieldname,\n    $text = false\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"sql_cast_char2real",children:"sql_cast_char2real"}),"\n",(0,r.jsx)(n.p,{children:"Return the query fragment to cast a CHAR column to REAL (float) number"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function sql_cast_char2real(\n    $fieldname,\n    $text = false\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"sql_cast_to_char",children:"sql_cast_to_char"}),"\n",(0,r.jsx)(a,{version:"4.1"}),"\n",(0,r.jsx)(n.p,{children:"Return SQL for casting to char of given field/expression."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function sql_cast_to_char(string $field);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"sql_compare_text",children:"sql_compare_text"}),"\n",(0,r.jsx)(n.p,{children:"Return the query fragment to be used when comparing a TEXT (clob) column with a given string or a VARCHAR field (some RDBMs do not allow for direct comparison)."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function sql_compare_text(\n    $fieldname,\n    $numchars = 32\n);\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",metastring:'title="Example"',children:"$comparedescription = $DB->sql_compare_text('description');\n$comparedescription = $DB->sql_compare_text(':description');\n$todogroups = $DB->get_records_sql(\n    \"SELECT id FROM {group} WHERE {$comparedescription} = {$comparedescriptionplaceholder}\",\n    [\n        'description' => 'TODO',\n    ]\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"sql_order_by_text",children:"sql_order_by_text"}),"\n",(0,r.jsx)(n.p,{children:"Return the query fragment to be used to get records ordered by a TEXT (clob) column. Note this affects the performance badly and should be avoided if possible."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function sql_order_by_text(\n    $fieldname,\n    $numchars = 32\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"sql_order_by_null",children:"sql_order_by_null"}),"\n",(0,r.jsx)(a,{version:"4.1"}),"\n",(0,r.jsx)(n.p,{children:"Return the query fragment to be used to get records with a standardised return pattern of null values across database types to sort nulls first when ascending and last when descending."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function sql_order_by_null(\n    string $fieldname,\n    int $sort = SORT_ASC\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"sql_concat",children:"sql_concat"}),"\n",(0,r.jsx)(n.p,{children:"Return the query fragment to concatenate all given parameters into one string."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function sql_concat(...)\n"})}),"\n",(0,r.jsx)(n.p,{children:"There is a gotcha if you are trying to concat fields which may be null which result in the entire result being null:"}),"\n",(0,r.jsx)(s,{children:(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function sql_concat('requiredfield', 'optionalfield');\n"})})}),"\n",(0,r.jsx)(n.p,{children:"You must cast or coalesce every nullable argument, for example:"}),"\n",(0,r.jsx)(d,{children:(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function sql_concat('requiredfield', \"COALESCE(optionalfield, '')\");\n"})})}),"\n",(0,r.jsx)(n.h3,{id:"sql_group_concat",children:"sql_group_concat"}),"\n",(0,r.jsx)(a,{version:"3.11"}),"\n",(0,r.jsx)(n.p,{children:"Return SQL for performing group concatenation on given field/expression."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function sql_group_concat(string $field, string $separator = ', ', string $sort = '')\n"})}),"\n",(0,r.jsx)(n.h3,{id:"sql_concat_join",children:"sql_concat_join"}),"\n",(0,r.jsx)(n.p,{children:"Return the query fragment to concatenate all given elements into one string using the given separator."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function sql_concat_join(\n    $separator = \"' '\",\n    $elements = []]\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"sql_fullname",children:"sql_fullname"}),"\n",(0,r.jsx)(n.p,{children:"Return the query fragment to concatenate the given $firstname and $lastname"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function sql_fullname(\n    $first = 'firstname',\n    $last = 'lastname'\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"sql_isempty",children:"sql_isempty"}),"\n",(0,r.jsx)(n.p,{children:"Return the query fragment to check if the field is empty"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function sql_isempty(\n    $tablename,\n    $fieldname,\n    $nullablefield,\n    $textfield\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"sql_isnotempty",children:"sql_isnotempty"}),"\n",(0,r.jsx)(n.p,{children:"Return the query fragment to check if the field is not empty"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function sql_isnotempty(\n    $tablename,\n    $fieldname,\n    $nullablefield,\n    $textfield\n);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"get_in_or_equal",children:"get_in_or_equal"}),"\n",(0,r.jsx)(n.p,{children:"Return the query fragment to check if a value is IN the given list of items (with a fallback to plain equal comparison if there is just one item)"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function get_in_or_equal(\n    $items,\n    $type = SQL_PARAMS_QM,\n    $prefix = 'param',\n    $equal = true,\n    $onemptyitems = false\n);\n"})}),"\n",(0,r.jsx)(n.p,{children:"Example:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"$statuses = ['todo', 'open', 'inprogress', 'intesting'];\n[$insql, $inparams] = $DB->get_in_or_equal($statuses);\n$sql = \"SELECT * FROM {bugtracker_issues} WHERE status $insql\";\n$bugs = $DB->get_records_sql($sql, $inparams);\n"})}),"\n",(0,r.jsx)(n.p,{children:"An example using named params:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"[$insql, $params] = $DB->get_in_or_equal($contexts, SQL_PARAMS_NAMED, 'ctx');\n$contextsql = \"AND rc.contextid {$insql}\";\n"})}),"\n",(0,r.jsx)(n.h3,{id:"sql_regex_supported",children:"sql_regex_supported"}),"\n",(0,r.jsx)(n.p,{children:"Does the current database driver support regex syntax when searching?"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function sql_regex_supported()\n"})}),"\n",(0,r.jsx)(n.h3,{id:"sql_regex",children:"sql_regex"}),"\n",(0,r.jsx)(n.p,{children:"Return the query fragment to perform a regex search."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function sql_regex(\n    $positivematch = true,\n    $casesensitive = false\n);\n"})}),"\n",(0,r.jsx)(n.p,{children:"Example: Searching for Page module instances containing links."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",metastring:'title="Example: Searching for Page module instances containing links."',children:"if ($DB->sql_regex_supported()) {\n    $select = 'content ' . $DB->sql_regex() . ' :pattern';\n    $params = ['pattern'  => \"(src|data)\\ * = \\ *[\\\\\\\"\\']https?://\"]\n} else {\n    $select = $DB->sql_like('content', ':pattern', false);\n    $params = ['pattern'  => '% = %http%://%'];\n}\n\n$pages = $DB->get_records_select('page', $select, $params, 'course', 'id, course, name');\n"})}),"\n",(0,r.jsx)(n.h3,{id:"sql_regex_get_word_beginning_boundary_marker",children:"sql_regex_get_word_beginning_boundary_marker"}),"\n",(0,r.jsx)(a,{versions:["3.11.11","4.0.5","4.1"],issueNumber:"MDL-74912"}),"\n",(0,r.jsx)(n.p,{children:"Return the word-beginning boundary marker if the current database driver supports regex syntax when searching."}),"\n",(0,r.jsxs)(n.p,{children:["Defaults to ",(0,r.jsx)(n.code,{children:"[[:<:]]"}),". On MySQL ",(0,r.jsx)(n.code,{children:"v8.0.4+"}),", it returns ",(0,r.jsx)(n.code,{children:"\\\\b"}),"."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function sql_regex_get_word_beginning_boundary_marker()\n"})}),"\n",(0,r.jsx)(n.h3,{id:"sql_regex_get_word_end_boundary_marker",children:"sql_regex_get_word_end_boundary_marker"}),"\n",(0,r.jsx)(a,{versions:["3.11.11","4.0.5","4.1"],issueNumber:"MDL-74912"}),"\n",(0,r.jsx)(n.p,{children:"Return the word-end boundary marker if the current database driver supports regex syntax when searching."}),"\n",(0,r.jsxs)(n.p,{children:["Defaults to ",(0,r.jsx)(n.code,{children:"[[:>:]]"}),". On MySQL ",(0,r.jsx)(n.code,{children:"v8.0.4+"}),", it returns ",(0,r.jsx)(n.code,{children:"\\\\b"}),"."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function sql_regex_get_word_end_boundary_marker()\n"})}),"\n",(0,r.jsx)(n.h3,{id:"sql_intersect",children:"sql_intersect"}),"\n",(0,r.jsx)(a,{version:"2.8"}),"\n",(0,r.jsx)(n.p,{children:"Return the query fragment that allows to find intersection of two or more queries"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function sql_intersect(\n    $selects,\n    $fields\n);\n"})}),"\n",(0,r.jsx)(n.h2,{id:"debugging",children:"Debugging"}),"\n",(0,r.jsx)(n.h3,{id:"set_debug",children:"set_debug"}),"\n",(0,r.jsx)(n.p,{children:"You can enable a debugging mode to make $DB output the SQL of every executed query, along with some timing information. This can be useful when debugging your code. Obviously, all such calls should be removed before code is submitted for integration."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"public function set_debug(bool $state)\n"})}),"\n",(0,r.jsx)(n.h2,{id:"special-cases",children:"Special cases"}),"\n",(0,r.jsx)(n.h3,{id:"get_course",children:"get_course"}),"\n",(0,r.jsxs)(n.p,{children:["From Moodle 2.5.1 onwards, you should use the ",(0,r.jsx)(n.code,{children:"get_course"})," function instead of using ",(0,r.jsx)(n.code,{children:"get_record('course', ...)"})," if you want to get a course record based on its ID, especially if there is a significant possibility that the course being retrieved is either the current course for the page, or the site course. Those two course records have probably already been loaded, and using this function will save a database query."]}),"\n",(0,r.jsx)(n.p,{children:"Additionally, the code is shorter and easier to read."}),"\n",(0,r.jsx)(n.h3,{id:"get_courses",children:"get_courses"}),"\n",(0,r.jsx)(n.p,{children:"If you want to get all the current courses in your Moodle, use get_courses() without parameter:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"$courses = get_courses();\n"})}),"\n",(0,r.jsx)(n.h2,{id:"see-also",children:"See also"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/general/development/policies/codingstyle/sql",children:"SQL coding style"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/moodledevdocs/docs/4.2/apis/core/",children:"Core APIs"})}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"/moodledevdocs/docs/4.2/apis/core/dml/exceptions",children:"DML exceptions"}),": New DML code is throwing exceptions instead of returning false if anything goes wrong"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"/moodledevdocs/docs/4.2/apis/core/dml/drivers",children:"DML drivers"}),": Database drivers for new DML layer"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"/moodledevdocs/docs/4.2/apis/core/dml/ddl",children:"DDL functions"}),": Where all the functions used to handle DB objects (",(0,r.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Data_Definition_Language",children:"DDL"}),") are defined."]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(h,{...e})}):h(e)}function p(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}}}]);
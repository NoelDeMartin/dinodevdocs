"use strict";(self.webpackChunkdevdocs=self.webpackChunkdevdocs||[]).push([[63427],{720:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>d,contentTitle:()=>r,default:()=>g,frontMatter:()=>i,metadata:()=>l,toc:()=>c});var o=n(74848),a=n(28453),t=n(78924);const i={title:"Message API",tags:["API","Tutorial","Plugins","Messaging"]},r=void 0,l={id:"apis/core/message/index",title:"Message API",description:"What is this document?",source:"@site/docs/apis/core/message/index.md",sourceDirName:"apis/core/message",slug:"/apis/core/message/",permalink:"/moodledevdocs/docs/4.4/apis/core/message/",draft:!1,unlisted:!1,editUrl:"https://github.com/moodle/devdocs/edit/main/docs/apis/core/message/index.md",tags:[{label:"API",permalink:"/moodledevdocs/docs/4.4/tags/api"},{label:"Tutorial",permalink:"/moodledevdocs/docs/4.4/tags/tutorial"},{label:"Plugins",permalink:"/moodledevdocs/docs/4.4/tags/plugins"},{label:"Messaging",permalink:"/moodledevdocs/docs/4.4/tags/messaging"}],version:"current",lastUpdatedBy:"Andrew Nicols",lastUpdatedAt:1713332374e3,frontMatter:{title:"Message API",tags:["API","Tutorial","Plugins","Messaging"]},sidebar:"docs",previous:{title:"Lock API",permalink:"/moodledevdocs/docs/4.4/apis/core/lock/"},next:{title:"Navigation API",permalink:"/moodledevdocs/docs/4.4/apis/core/navigation/"}},d={},c=[{value:"What is this document?",id:"what-is-this-document",level:2},{value:"Overview",id:"overview",level:2},{value:"File locations",id:"file-locations",level:2},{value:"Functions",id:"functions",level:2},{value:"Message pop-up",id:"message-pop-up",level:2},{value:"Examples",id:"examples",level:2},{value:"How to register as a message producer",id:"how-to-register-as-a-message-producer",level:3},{value:"Setting defaults",id:"setting-defaults",level:3},{value:"How to send a message",id:"how-to-send-a-message",level:3},{value:"How to set-up the message pop-up",id:"how-to-set-up-the-message-pop-up",level:3},{value:"Changes in Moodle 3.5",id:"changes-in-moodle-35",level:2}];function m(e){const s={a:"a",code:"code",h2:"h2",h3:"h3",p:"p",pre:"pre",...(0,a.R)(),...e.components},{Since:n}=s;return n||function(e,s){throw new Error("Expected "+(s?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Since",!0),(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(t.A,{frontMatter:i,metadata:l}),"\n",(0,o.jsx)(s.h2,{id:"what-is-this-document",children:"What is this document?"}),"\n",(0,o.jsx)(s.p,{children:"This document describes how to make use of the Moodle Messaging API to send messages to Moodle users."}),"\n",(0,o.jsxs)(s.p,{children:["If you are after a general introduction on using the Moodle Messaging system go to ",(0,o.jsx)(s.a,{href:"https://docs.moodle.org/en/Messaging",children:"messaging user documentation"}),"."]}),"\n",(0,o.jsxs)(s.p,{children:["If you are looking for details of how the Messaging system's internal structure was implemented, go to ",(0,o.jsx)(s.a,{href:"https://docs.moodle.org/dev/Messaging_2.0",children:"Messaging 2.0"}),"."]}),"\n",(0,o.jsxs)(s.p,{children:["If you are looking for instructions on the implementation of a custom message processor (a component that receives messages sent to a user), go to ",(0,o.jsx)(s.a,{href:"https://docs.moodle.org/dev/Messaging_custom_components",children:"Messaging custom components"}),"."]}),"\n",(0,o.jsx)(s.p,{children:"If you are looking for instructions on sending messages programmatically within Moodle then read on..."}),"\n",(0,o.jsx)(s.h2,{id:"overview",children:"Overview"}),"\n",(0,o.jsx)(s.p,{children:"Moodle components have the ability to send messages to users via the Moodle messaging system. Any type of component, for example a plugin or block, can register as a message producer then send messages to users."}),"\n",(0,o.jsx)(s.h2,{id:"file-locations",children:"File locations"}),"\n",(0,o.jsxs)(s.p,{children:["The Message API code is contained within ",(0,o.jsx)(s.code,{children:"lib/messagelib.php"})," and is automatically included for you during page setup."]}),"\n",(0,o.jsx)(s.h2,{id:"functions",children:"Functions"}),"\n",(0,o.jsxs)(s.p,{children:[(0,o.jsx)(s.code,{children:"message_send()"})," is the primary point of contact for the message API. Call it to send a message to a user. See the php documentation for a full description of the arguments that must be supplied. There is also an example below."]}),"\n",(0,o.jsx)(s.h2,{id:"message-pop-up",children:"Message pop-up"}),"\n",(0,o.jsx)(n,{versions:["2.9"]}),"\n",(0,o.jsxs)(s.p,{children:["A JavaScript pop-up can be displayed through a link to invite a user to message another. In order to use this feature, you need to require the JavaScript libraries using ",(0,o.jsx)(s.code,{children:"message_messenger_requirejs()"})," and create a link with the attributes returned by ",(0,o.jsx)(s.code,{children:"message_messenger_sendmessage_link_params()"}),". More in the examples."]}),"\n",(0,o.jsx)(s.h2,{id:"examples",children:"Examples"}),"\n",(0,o.jsx)(s.h3,{id:"how-to-register-as-a-message-producer",children:"How to register as a message producer"}),"\n",(0,o.jsxs)(s.p,{children:["The messages produced by a message provider is defined in the ",(0,o.jsx)(s.code,{children:"/db/messages.php"})," file of a component. Below is code from the quiz module's ",(0,o.jsx)(s.code,{children:"messages.php"})," file, shown as an example."]}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-php",metastring:'title="mod/quiz/db/messages.php"',children:"defined('MOODLE_INTERNAL') || die();\n$messageproviders = [\n    // Notify teacher that a student has submitted a quiz attempt\n    'submission' => [\n        'capability' => 'mod/quiz:emailnotifysubmission'\n    ],\n    // Confirm a student's quiz attempt\n    'confirmation' => [\n        'capability' => 'mod/quiz:emailconfirmsubmission'\n    ],\n];\n"})}),"\n",(0,o.jsx)(s.p,{children:'The quiz can send two kinds of messages, quiz "submission" and "confirmation" notifications. Each message type is only available to users with the appropriate capability. Please note that the capability is checked at the system level context. Users who have this capability will have this message listed in their messaging preferences. You can omit the capability section if your message should be visible for all users. For example forum post notifications are available to all users.'}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-php",children:"$messageproviders = [\n    // Ordinary single forum posts\n    'posts' => [],\n];\n"})}),"\n",(0,o.jsxs)(s.p,{children:["When displaying your message types in a user's messaging preferences it will use a string from your component's language file called ",(0,o.jsx)(s.code,{children:"messageprovider:messagename"}),". For example here are the relevant strings from the quiz's language file."]}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-php",children:"$string['messageprovider:confirmation'] = 'Confirmation of your own quiz submissions';\n$string['messageprovider:submission'] = 'Notification of quiz submissions';\n"})}),"\n",(0,o.jsxs)(s.p,{children:["Once your ",(0,o.jsx)(s.code,{children:"messages.php"})," is complete you need to increase the version number of your component in its ",(0,o.jsx)(s.code,{children:"version.php"}),". That will cause Moodle to check ",(0,o.jsx)(s.code,{children:"messages.php"})," looking for new or changed message definitions. Log in as an admin and go to ",(0,o.jsx)(s.code,{children:"/admin/index.php"})," (the Notifications page) to start the upgrade process."]}),"\n",(0,o.jsx)(s.h3,{id:"setting-defaults",children:"Setting defaults"}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-php",metastring:'title="The default processor can be set using an element of the array"',children:"'mynotification' => [\n    'defaults' => [\n        'pop-up' => MESSAGE_PERMITTED + MESSAGE_DEFAULT_LOGGEDIN + MESSAGE_DEFAULT_LOGGEDOFF,\n        'email' => MESSAGE_PERMITTED,\n    ],\n],\n"})}),"\n",(0,o.jsxs)(s.p,{children:["With that setting email will be permitted but disabled for each user by default. It  can be turned on by each user through the ",(0,o.jsx)(s.code,{children:"preferences/notification"})," preferences options (",(0,o.jsx)(s.code,{children:"/message/notificationpreferences.php?userid=X"}),")\nThe possible values are recorded in the lib.php file of messaging"]}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-php",children:"/**\n * Define contants for messaging default settings population. For unambiguity of\n * plugin developer intentions we use 4-bit value (LSB numbering):\n * bit 0 - whether to send message when user is loggedin (MESSAGE_DEFAULT_LOGGEDIN)\n * bit 1 - whether to send message when user is loggedoff (MESSAGE_DEFAULT_LOGGEDOFF)\n * bit 2..3 - messaging permission (MESSAGE_DISALLOWED|MESSAGE_PERMITTED|MESSAGE_FORCED)\n *\n * MESSAGE_PERMITTED_MASK contains the mask we use to distinguish permission setting\n */\n"})}),"\n",(0,o.jsxs)(s.p,{children:["Note that if you change the values in message.php and then upgrade the plugin the values will not automatically be changed in the ",(0,o.jsx)(s.code,{children:"config_plugins"})," table where they are stored."]}),"\n",(0,o.jsx)(s.h3,{id:"how-to-send-a-message",children:"How to send a message"}),"\n",(0,o.jsx)(n,{versions:["2.9"]}),"\n",(0,o.jsxs)(s.p,{children:["Here is example code showing you how to actually send a notification message. The example shows the construction of a object with specific properties, which is then passed to the ",(0,o.jsx)(s.code,{children:"message_send()"})," function that uses the information to send a message."]}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-php",metastring:'title="Sending a message"',children:"$message = new \\core\\message\\message();\n$message->component = 'mod_yourmodule'; // Your plugin's name\n$message->name = 'mynotification'; // Your notification name from message.php\n$message->userfrom = core_user::get_noreply_user(); // If the message is 'from' a specific user you can set them here\n$message->userto = $user;\n$message->subject = 'message subject 1';\n$message->fullmessage = 'message body';\n$message->fullmessageformat = FORMAT_MARKDOWN;\n$message->fullmessagehtml = '<p>message body</p>';\n$message->smallmessage = 'small message';\n$message->notification = 1; // Because this is a notification generated from Moodle, not a user-to-user message\n$message->contexturl = (new \\moodle_url('/course/'))->out(false); // A relevant URL for the notification\n$message->contexturlname = 'Course list'; // Link title explaining where users get to for the contexturl\n// Extra content for specific processor\n$content = [\n    '*' => [\n        'header' => ' test ',\n        'footer' => ' test ',\n    ],\n];\n$message->set_additional_content('email', $content);\n\n// You probably don't need attachments but if you do, here is how to add one\n$usercontext = context_user::instance($user->id);\n$file = new stdClass();\n$file->contextid = $usercontext->id;\n$file->component = 'user';\n$file->filearea = 'private';\n$file->itemid = 0;\n$file->filepath = '/';\n$file->filename = '1.txt';\n$file->source = 'test';\n\n$fs = get_file_storage();\n$file = $fs->create_file_from_string($file, 'file1 content');\n$message->attachment = $file;\n\n// Actually send the message\n$messageid = message_send($message);\n"})}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-php",metastring:'title="Before 2.9 message data used to be a stdClass object as shown below (This formation of a message will no longer work as of Moodle 3.6. Only a message object will be accepted):"',children:"\n$message = new stdClass();\n$message->component = 'mod_quiz'; //your component name\n$message->name = 'submission'; //this is the message name from messages.php\n$message->userfrom = $USER;\n$message->userto = $touser;\n$message->subject = $subject;\n$message->fullmessage = $message;\n$message->fullmessageformat = FORMAT_PLAIN;\n$message->fullmessagehtml = '';\n$message->smallmessage = '';\n$message->notification = 1; //this is only set to 0 for personal messages between users\nmessage_send($message);\n"})}),"\n",(0,o.jsx)(s.h3,{id:"how-to-set-up-the-message-pop-up",children:"How to set-up the message pop-up"}),"\n",(0,o.jsx)(s.p,{children:"Here is example code showing you how to set-up the JavaScript pop-up link."}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-php",children:"require_once('message/lib.php');\n$userid = 2;\n$userto = $DB->get_record('user', ['id' => $userid]);\n\nmessage_messenger_requirejs();\n$url = new moodle_url('message/index.php', ['id' => $userto->id]);\n$attributes = message_messenger_sendmessage_link_params($userto);\necho html_writer::link($url, 'Send a message', $attributes);\n"})}),"\n",(0,o.jsx)(s.h2,{id:"changes-in-moodle-35",children:"Changes in Moodle 3.5"}),"\n",(0,o.jsx)(n,{versions:["3.5"]}),"\n",(0,o.jsxs)(s.p,{children:["In Moodle 3.5, there were some moderately big changes. The only docs I have been able to find about them are in ",(0,o.jsx)(s.a,{href:"https://github.com/moodle/moodle/blob/33a388eff737c049786ee42d7430db549568471c/message/upgrade.txt#L56",children:"upgrade.txt"})," file. However, that is the details, here is an overview:"]}),"\n",(0,o.jsxs)(s.p,{children:["The main ",(0,o.jsx)(s.code,{children:"message_send()"})," API to send a message has not changed, so if your code is just sending messages, you don't need to do anything."]}),"\n",(0,o.jsx)(s.p,{children:"Similarly, message_output plugins don't need to change, so no worries there."}),"\n",(0,o.jsx)(s.p,{children:"If you are doing things with messages, then you need to understand how the internals have changed."}),"\n",(0,o.jsxs)(s.p,{children:["The database tables have changed. Messages from Moodle components to a user (e.g. mod_quiz), telling them that something has happened (e.g. an attempt was submitted) have always been 'Notifications'. In the past, this was just a column in the ",(0,o.jsx)(s.code,{children:"mdl_message"})," table. Now, messages and notifications are stored in completely separate tables. Notifications are in ",(0,o.jsx)(s.code,{children:"mdl_notifications"}),". The structure of this table is very similar to the old ",(0,o.jsx)(s.code,{children:"mdl_message"})," table which is now not used at all. Messages are in ",(0,o.jsx)(s.code,{children:"mdl_messages"}),", and related tables, that now exist to support group messaging. Those tables join together like this:"]}),"\n",(0,o.jsx)(s.pre,{children:(0,o.jsx)(s.code,{className:"language-sql",children:"   SELECT *\n     FROM mdl_messages m\n     JOIN mdl_message_conversations con ON con.id = m.conversationid\n     JOIN mdl_message_conversation_members mem ON mem.conversationid = con.id\nLEFT JOIN mdl_message_user_actions act ON act.userid = mem.userid AND act.messageid = m.id\n ORDER BY m.timecreated, m.id, mem.userid, act.id\n"})})]})}function g(e={}){const{wrapper:s}={...(0,a.R)(),...e.components};return s?(0,o.jsx)(s,{...e,children:(0,o.jsx)(m,{...e})}):m(e)}}}]);
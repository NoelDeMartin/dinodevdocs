"use strict";(self.webpackChunkdevdocs=self.webpackChunkdevdocs||[]).push([[78700],{88531:(e,i,t)=>{t.r(i),t.d(i,{assets:()=>r,contentTitle:()=>o,default:()=>u,frontMatter:()=>l,metadata:()=>c,toc:()=>d});var a=t(74848),s=t(28453),n=t(78924);const l={title:"Availability API",tags:["Availability","core_availability"]},o=void 0,c={id:"apis/subsystems/availability/index",title:"Availability API",description:"The availability API controls access to activities and sections. For example, a teacher could restrict access so that an activity cannot be accessed until a certain date, or so that a section cannot be accessed unless users have a certain grade in a quiz.",source:"@site/docs/apis/subsystems/availability/index.md",sourceDirName:"apis/subsystems/availability",slug:"/apis/subsystems/availability/",permalink:"/moodledevdocs/docs/4.4/apis/subsystems/availability/",draft:!1,unlisted:!1,editUrl:"https://github.com/moodle/devdocs/edit/main/docs/apis/subsystems/availability/index.md",tags:[{label:"Availability",permalink:"/moodledevdocs/docs/4.4/tags/availability"},{label:"core_availability",permalink:"/moodledevdocs/docs/4.4/tags/core-availability"}],version:"current",lastUpdatedBy:"marcus.green@tituslearning.com",lastUpdatedAt:1669283296e3,frontMatter:{title:"Availability API",tags:["Availability","core_availability"]},sidebar:"docs",previous:{title:"Analytics API",permalink:"/moodledevdocs/docs/4.4/apis/subsystems/analytics/"},next:{title:"Backup API",permalink:"/moodledevdocs/docs/4.4/apis/subsystems/backup/"}},r={},d=[{value:"Using the API",id:"using-the-api",level:2},{value:"Check access for a user",id:"check-access-for-a-user",level:3},{value:"Activities",id:"activities",level:4},{value:"Course sections",id:"course-sections",level:4},{value:"Accessing information for a different user",id:"accessing-information-for-a-different-user",level:4},{value:"Display a list of users who may be able to access the current activity",id:"display-a-list-of-users-who-may-be-able-to-access-the-current-activity",level:3},{value:"Using availability conditions in other areas",id:"using-availability-conditions-in-other-areas",level:2},{value:"Programmatically setting availability conditions",id:"programmatically-setting-availability-conditions",level:2},{value:"See also",id:"see-also",level:2}];function h(e){const i={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.A,{frontMatter:l,metadata:c}),"\n",(0,a.jsx)(i.p,{children:"The availability API controls access to activities and sections. For example, a teacher could restrict access so that an activity cannot be accessed until a certain date, or so that a section cannot be accessed unless users have a certain grade in a quiz."}),"\n",(0,a.jsxs)(i.admonition,{type:"note",children:[(0,a.jsx)(i.p,{children:"In older versions of Moodle, the conditional availability system defaulted to off; and users could enable it from the advanced features page in site administration. It is enabled by default for new installs of Moodle since Moodle 3.1, but sites which have been upgraded may still have to manually enable it."}),(0,a.jsx)(i.p,{children:"You can still call the API functions even if the system is turned off."})]}),"\n",(0,a.jsx)(i.h2,{id:"using-the-api",children:"Using the API"}),"\n",(0,a.jsx)(i.p,{children:"In most cases you do not need to use the API directly because the course and activity API already handles it for you. For example, if you are writing a module:"}),"\n",(0,a.jsxs)(i.ul,{children:["\n",(0,a.jsxs)(i.li,{children:["Moodle will automatically prevent users from accessing your module if they do not meet the availability conditions (unless they have the ability to access hidden activities). This is calculated when you call ",(0,a.jsx)(i.code,{children:"require_login"})," and pass your activity's information."]}),"\n",(0,a.jsx)(i.li,{children:"Your activity's form will automatically include controls for setting availability restriction, as part of the standard form controls."}),"\n"]}),"\n",(0,a.jsx)(i.p,{children:"There are two special cases in which you may need to use the API directly."}),"\n",(0,a.jsxs)(i.ul,{children:["\n",(0,a.jsx)(i.li,{children:"Checking whether the current user can access an activity"}),"\n",(0,a.jsx)(i.li,{children:"Displaying a list of users who may be able to access the current activity"}),"\n"]}),"\n",(0,a.jsx)(i.h3,{id:"check-access-for-a-user",children:"Check access for a user"}),"\n",(0,a.jsx)(i.h4,{id:"activities",children:"Activities"}),"\n",(0,a.jsxs)(i.p,{children:["Some availability information can be accessed from an instance of the ",(0,a.jsx)(i.code,{children:"cm_info"})," class, specifically in the ",(0,a.jsx)(i.code,{children:"uservisible"})," property."]}),"\n",(0,a.jsx)(i.p,{children:"This property considers a range of factors to indicate whether the activity should be visible to that user, including:"}),"\n",(0,a.jsxs)(i.ul,{children:["\n",(0,a.jsx)(i.li,{children:"whether the activity was hidden by a teacher"}),"\n",(0,a.jsx)(i.li,{children:"whether the activity is available based on the availability API"}),"\n"]}),"\n",(0,a.jsxs)(i.p,{children:["The ",(0,a.jsx)(i.code,{children:"cm_info"})," object also includes an ",(0,a.jsx)(i.code,{children:"availableinfo"})," property which provides HTML-formatted information to explain to the user why they cannot access the activity."]}),"\n",(0,a.jsx)(i.pre,{children:(0,a.jsx)(i.code,{className:"language-php",metastring:'title="Checking and displaying availability information"',children:"$modinfo = get_fast_modinfo($course);\n$cm = $modinfo->get_cm($cmid);\nif ($cm->uservisible) {\n    // User can access the activity.\n} else if ($cm->availableinfo) {\n    // User cannot access the activity, but on the course page they will\n    // see a link to it, greyed-out, with information (HTML format) from\n    // $cm->availableinfo about why they can't access it.\n} else {\n    // User cannot access the activity and they will not see it at all.\n}\n"})}),"\n",(0,a.jsx)(i.h4,{id:"course-sections",children:"Course sections"}),"\n",(0,a.jsxs)(i.p,{children:["Some availability information can be accessed from an instance of the ",(0,a.jsx)(i.code,{children:"section_info"})," class, specifically in the ",(0,a.jsx)(i.code,{children:"uservisible"})," property."]}),"\n",(0,a.jsx)(i.p,{children:"This property considers a range of factors to indicate whether the activity should be visible to that user, including:"}),"\n",(0,a.jsxs)(i.ul,{children:["\n",(0,a.jsx)(i.li,{children:"whether the activity was hidden by a teacher"}),"\n",(0,a.jsx)(i.li,{children:"whether the activity is available based on the availability API"}),"\n"]}),"\n",(0,a.jsxs)(i.p,{children:["The ",(0,a.jsx)(i.code,{children:"section_info"})," object also includes an ",(0,a.jsx)(i.code,{children:"availableinfo"})," property which provides HTML-formatted information to explain to the user why they cannot access the activity."]}),"\n",(0,a.jsxs)(i.admonition,{title:"Checking sections and activities",type:"warning",children:[(0,a.jsxs)(i.p,{children:["The ",(0,a.jsx)(i.code,{children:"uservisible"})," check for an ",(0,a.jsx)(i.em,{children:"activity"})," automatically includes all relevant checks for the section that the activity is placed in."]}),(0,a.jsxs)(i.p,{children:["You ",(0,a.jsx)(i.strong,{children:"do not"})," need to check visibility and availability for ",(0,a.jsx)(i.em,{children:"both"})," the section and the activity."]})]}),"\n",(0,a.jsx)(i.h4,{id:"accessing-information-for-a-different-user",children:"Accessing information for a different user"}),"\n",(0,a.jsxs)(i.p,{children:["The availability information in both the ",(0,a.jsx)(i.code,{children:"cm_info"})," and ",(0,a.jsx)(i.code,{children:"section_info"})," classes is calculated  for the current user. You can also obtain them for a different user by passing a user ID to ",(0,a.jsx)(i.code,{children:"get_fast_modinfo"}),", although be aware that doing this repeatedly for different users will be slow."]}),"\n",(0,a.jsx)(i.h3,{id:"display-a-list-of-users-who-may-be-able-to-access-the-current-activity",children:"Display a list of users who may be able to access the current activity"}),"\n",(0,a.jsx)(i.p,{children:"Sometimes you need to display a list of users who may be able to access the current activity."}),"\n",(0,a.jsx)(i.p,{children:"While you could use the above approach for each user, this would be slow and also is generally not what you require. For example, if you have an activity such as an assignment which is set to be available to students until a certain date, and if you want to display a list of potential users within that activity, you probably don't want to make the list blank immediately the date occurs."}),"\n",(0,a.jsx)(i.p,{children:"The system divides availability conditions into two types:"}),"\n",(0,a.jsxs)(i.ul,{children:["\n",(0,a.jsxs)(i.li,{children:["Applied to user lists, including:","\n",(0,a.jsxs)(i.ul,{children:["\n",(0,a.jsx)(i.li,{children:"User group"}),"\n",(0,a.jsx)(i.li,{children:"User grouping"}),"\n",(0,a.jsx)(i.li,{children:"User profile conditions"}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(i.li,{children:["Not applied to user lists, including:","\n",(0,a.jsxs)(i.ul,{children:["\n",(0,a.jsx)(i.li,{children:"The current date"}),"\n",(0,a.jsx)(i.li,{children:"completion"}),"\n",(0,a.jsx)(i.li,{children:"grade"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(i.p,{children:"In general, the conditions which we expect are likely to change over time (such as dates) or as a result of user actions (such as grades) are not applied to user lists."}),"\n",(0,a.jsx)(i.p,{children:"If you have a list of users (for example you could obtain this using one of the 'get enrolled users' functions), you can filter it to include only those users who are allowed to see an activity with this code:"}),"\n",(0,a.jsx)(i.pre,{children:(0,a.jsx)(i.code,{className:"language-php",children:"$info = new \\core_availability\\info_module($cm);\n$filtered = $info->filter_user_list($users);\n"})}),"\n",(0,a.jsx)(i.admonition,{type:"note",children:(0,a.jsxs)(i.p,{children:["The above example does not include the ",(0,a.jsx)(i.code,{children:"$cm->visible"})," setting, nor does it take into account the ",(0,a.jsx)(i.code,{children:"viewhiddenactivities"})," setting."]})}),"\n",(0,a.jsx)(i.h2,{id:"using-availability-conditions-in-other-areas",children:"Using availability conditions in other areas"}),"\n",(0,a.jsxs)(i.p,{children:["The availability API is provided for activities (course-modules) and sections. It is also possible to use it in other areas such as ",(0,a.jsx)(i.em,{children:"within"})," a module. See ",(0,a.jsx)(i.a,{href:"https://docs.moodle.org/dev/Availability_API_for_items_within_a_module",children:"Availability API for items within a module"}),"."]}),"\n",(0,a.jsx)(i.h2,{id:"programmatically-setting-availability-conditions",children:"Programmatically setting availability conditions"}),"\n",(0,a.jsxs)(i.p,{children:["In some situations you may need to ",(0,a.jsx)(i.em,{children:"programmatically"})," configure the availability conditions for an activity - for example you may have a custom enrolment plugin which creates assessable activities according to a student information system."]}),"\n",(0,a.jsxs)(i.p,{children:["To configure the availability, you can generate a JSON structure using an instance of the ",(0,a.jsx)(i.code,{children:"core_availability\\tree"})," class, and setting it against the activity or section record in the database, for example:"]}),"\n",(0,a.jsx)(i.pre,{children:(0,a.jsx)(i.code,{className:"language-php",children:"$restriction = \\core_availability\\tree::get_root_json([\n    \\availability_group\\condition::get_json($group->id),\n]);\n$DB->set_field(\n    'course_modules',\n    'availability',\n    json_encode($restriction),\n    [\n        'id' => $cmid,\n    ]\n);\nrebuild_course_cache($course->id, true);\n"})}),"\n",(0,a.jsx)(i.p,{children:"The following code can be used to programmatically set start and end date restrictions."}),"\n",(0,a.jsx)(i.pre,{children:(0,a.jsx)(i.code,{className:"language-php",children:"use \\core_availability\\tree;\n\n$dates = [];\n$dates[] = \\availability_date\\condition::get_json(\">=\", $availability['start']);\n$dates[] = \\availability_date\\condition::get_json(\"<\", $availability['end']);\n\n$showc = [true, true];\n$restrictions = tree::get_root_json($dates, tree::OP_AND, $showc);\n\n$DB->set_field(\n    'course_modules',\n    'availability',\n    json_encode($restrictions),\n    [\n        'id' => $cmid,\n    ]\n);\nrebuild_course_cache($course->id, true);\n"})}),"\n",(0,a.jsxs)(i.p,{children:["The ",(0,a.jsx)(i.code,{children:"$showc"})," array determines if the course modules will be shown or invisible when not available."]}),"\n",(0,a.jsx)(i.h2,{id:"see-also",children:"See also"}),"\n",(0,a.jsxs)(i.ul,{children:["\n",(0,a.jsxs)(i.li,{children:["Writing ",(0,a.jsx)(i.a,{href:"/moodledevdocs/docs/4.4/apis/plugintypes/availability/",children:"Availability condition"})," plugins"]}),"\n"]})]})}function u(e={}){const{wrapper:i}={...(0,s.R)(),...e.components};return i?(0,a.jsx)(i,{...e,children:(0,a.jsx)(h,{...e})}):h(e)}}}]);
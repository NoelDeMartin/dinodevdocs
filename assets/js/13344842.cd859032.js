"use strict";(self.webpackChunkdevdocs=self.webpackChunkdevdocs||[]).push([[22820],{64876:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>o,default:()=>x,frontMatter:()=>r,metadata:()=>l,toc:()=>d});var s=n(74848),i=n(28453),a=n(78924);const r={title:"xAPI (Experience API)",tags:["API","core_xapi"]},o=void 0,l={id:"apis/subsystems/xapi/index",title:"xAPI (Experience API)",description:"Overview",source:"@site/docs/apis/subsystems/xapi/index.md",sourceDirName:"apis/subsystems/xapi",slug:"/apis/subsystems/xapi/",permalink:"/moodledevdocs/docs/4.4/apis/subsystems/xapi/",draft:!1,unlisted:!1,editUrl:"https://github.com/moodle/devdocs/edit/main/docs/apis/subsystems/xapi/index.md",tags:[{label:"API",permalink:"/moodledevdocs/docs/4.4/tags/api"},{label:"core_xapi",permalink:"/moodledevdocs/docs/4.4/tags/core-xapi"}],version:"current",lastUpdatedBy:"Sara Arjona",lastUpdatedAt:1680519044e3,frontMatter:{title:"xAPI (Experience API)",tags:["API","core_xapi"]},sidebar:"docs",previous:{title:"Time API",permalink:"/moodledevdocs/docs/4.4/apis/subsystems/time/"},next:{title:"Moodle 4.4 developer update",permalink:"/moodledevdocs/docs/4.4/devupdate"}},c={},d=[{value:"Overview",id:"overview",level:2},{value:"Moodle xAPI functionalities",id:"moodle-xapi-functionalities",level:2},{value:"Statement API",id:"statement-api",level:2},{value:"Statement processing",id:"statement-processing",level:3},{value:"Statement data validation",id:"statement-data-validation",level:3},{value:"Generating statements in PHP",id:"generating-statements-in-php",level:3},{value:"xAPI statements attributes implementation",id:"xapi-statements-attributes-implementation",level:3},{value:"Adapting a plugin to use xAPI statement functions",id:"adapting-a-plugin-to-use-xapi-statement-functions",level:3},{value:"Step 1. Implement a xAPI handle class",id:"step-1-implement-a-xapi-handle-class",level:4},{value:"Step 2. Implement events",id:"step-2-implement-events",level:4},{value:"Useful methods to handle xAPI statements inside plugins",id:"useful-methods-to-handle-xapi-statements-inside-plugins",level:3},{value:"Using Ajax lib to send a statement to Moodle",id:"using-ajax-lib-to-send-a-statement-to-moodle",level:3},{value:"State API",id:"state-api",level:2},{value:"State processing",id:"state-processing",level:3},{value:"Generating states in PHP",id:"generating-states-in-php",level:3},{value:"Adapting a plugin to use xAPI state functions",id:"adapting-a-plugin-to-use-xapi-state-functions",level:3},{value:"Implement a xAPI handle class",id:"implement-a-xapi-handle-class",level:4},{value:"Useful methods to handle xAPI states inside plugins",id:"useful-methods-to-handle-xapi-states-inside-plugins",level:3},{value:"Using Ajax lib to send a state to Moodle",id:"using-ajax-lib-to-send-a-state-to-moodle",level:3}];function h(e){const t={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(a.A,{frontMatter:r,metadata:l}),"\n",(0,s.jsx)(t.h2,{id:"overview",children:"Overview"}),"\n",(0,s.jsx)(t.p,{children:"This document contains a technical explanation on how the xAPI Moodle integration library works."}),"\n",(0,s.jsxs)(t.p,{children:["The ",(0,s.jsx)(t.strong,{children:"Experience API (xAPI)"})," is an e-learning software specification that allows learning content and learning systems to speak to each other in a manner that records and tracks all types of learning experiences."]}),"\n",(0,s.jsx)(t.p,{children:"xAPI defines web services that can be used by any plugin or application to connect to the LMS in a standard way. The main actors in xAPI communication are:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Client"}),": any plugin or application that wants to use xAPI webservices"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"xAPI LRS"})," (server site): responsible for storing and serving the data emitted by the clients"]}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"The xAPI LRS specification implements six endpoints:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["The ",(0,s.jsx)(t.code,{children:"Statement Endpoint"})," is used for all xAPI statements. One good aspect about xAPI is that the amount of messages that can be shared between the clients and the LRS is quite limited. The main message type is called ",(0,s.jsx)(t.strong,{children:"Statement"}),' and all statements can be summarized as "',(0,s.jsx)(t.em,{children:"An actor XX executes action YY on object ZZ"}),'".']}),"\n"]}),"\n",(0,s.jsxs)(t.admonition,{type:"note",children:[(0,s.jsx)(t.p,{children:"The typical statement object is a JSON element containing:"}),(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Actor"}),": the person or group that do something"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Verb"}),": the action the Actor do"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Object"}),': the object on the Verb is executed. There are more than one type of objects that can be defined here but, for now, you can think about it as a specific "Quiz Attempt" for example.']}),"\n",(0,s.jsx)(t.li,{children:"Other fields: for now, the rest of xAPI fields have a basic data validation so every plugin is responsible for implementing it's own checks if they need them."}),"\n"]})]}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["The ",(0,s.jsx)(t.code,{children:"About Resource Endpoint"})," returns metadata about the LRS (for instance, the xAPI version or LRS configuration details)."]}),"\n",(0,s.jsxs)(t.li,{children:["The ",(0,s.jsx)(t.code,{children:"Activities Endpoint"}),' returns metadata about a particular, unique activity. "Unique activities" may be, for example, different online courses, and their metadata might include their titles, descriptions, and usage instructions.']}),"\n",(0,s.jsxs)(t.li,{children:["The ",(0,s.jsx)(t.code,{children:"Agents Endpoint"}),' returns metadata about a particular agent. An "agent" may be a learner or class cohort, for example.']}),"\n",(0,s.jsxs)(t.li,{children:["Three endpoints fall under the ",(0,s.jsx)(t.code,{children:"Document Endpoints"})," category; these endpoints all involve user-defined key-value pairs, which are typically unique to a given system. The Document Endpoints are primarily used by (local) Learning Activity Providers. The data stored in these endpoints represent the current situation at a given time, and those data can be updated (replacing old data) if/when the current situation changes.","\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["The ",(0,s.jsx)(t.code,{children:"Agent Profile Endpoint"})," allows the storage and return of universal data about a particular user (for instance, the learner's preferred language, accessibility preferences such as closed captioning)."]}),"\n",(0,s.jsxs)(t.li,{children:["The ",(0,s.jsx)(t.code,{children:"Activity Profile"})," allows the storage and return of universal data about a particular activity (for instance, minimum required score, time limit, what happens if the time limit is exceeded)."]}),"\n",(0,s.jsxs)(t.li,{children:["The ",(0,s.jsx)(t.code,{children:"State Endpoint"})," allows the storage and return of data about the current state of an activity for a particular learner (for instance, bookmark, state of play of the simulation, other state variables). In other words, the State Endpoint stores data about an activity/agent combination."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(t.admonition,{title:"xAPI specification",type:"tip",children:(0,s.jsxs)(t.p,{children:["The xAPI specification can be consulted in the xAPI specs page: ",(0,s.jsx)(t.a,{href:"https://github.com/adlnet/xAPI-Spec",children:"https://github.com/adlnet/xAPI-Spec"}),"."]})}),"\n",(0,s.jsx)(t.h2,{id:"moodle-xapi-functionalities",children:"Moodle xAPI functionalities"}),"\n",(0,s.jsx)(t.p,{children:"The final objective of Moodle xAPI library is NOT to implement a full LRS inside Moodle but to provide an easy way to handle xAPI statements and xAPI states within any plugin that needs it."}),"\n",(0,s.jsxs)(t.p,{children:['Moodle supports the main xAPI request which is called "',(0,s.jsx)(t.strong,{children:"statement"}),'" and, from Moodle 4.2 onwards, also supports ',(0,s.jsx)(t.strong,{children:"state"}),":"]}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"A statement must be seen as a tracking message that can be used by any plugin to store user activity directly in Moodle without programming any additional web service."}),"\n",(0,s.jsx)(t.li,{children:"A state should be used to store the user progressing in the play."}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"The current library implements:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["New webservices:","\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"core_xapi_statement_post"})," to process xAPI statements and generate standard Moodle events."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"core_xapi_post_state"})," to store a xAPI state."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"core_xapi_get_state"})," to get an xAPI state data."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"core_xapi_delete_state"})," to remove a xAPI state."]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["A class ",(0,s.jsx)(t.strong,{children:"\\core_xapi\\handler"})," that any plugin can extend in order to use xAPI and generate specific plugin contexts. This way, any plugin could use xAPI without implementing any new web service."]}),"\n",(0,s.jsxs)(t.li,{children:["A class ",(0,s.jsx)(t.strong,{children:"\\core_xapi\\iri"})," to easily translate random information into valid ",(0,s.jsx)(t.a,{href:"https://github.com/adlnet/xAPI-Spec/blob/master/xAPI-Data.md#43-iris",children:"IRI (Internationalized Resource Identifiers)"})," values (needed for xAPI objects and verbs)"]}),"\n",(0,s.jsxs)(t.li,{children:["A class ",(0,s.jsx)(t.strong,{children:"\\core_xapi\\local\\statement"})," to create and extract information from statement data."]}),"\n",(0,s.jsxs)(t.li,{children:["A class ",(0,s.jsx)(t.strong,{children:"\\core_xapi\\local\\state"})," to create and extract information from state data."]}),"\n",(0,s.jsxs)(t.li,{children:["A bunch of predefined classes in ",(0,s.jsx)(t.strong,{children:"\\core_xapi\\local\\statement\\item_XXX"})," to generate xAPI statement items from the plugins (example provided in ",(0,s.jsx)(t.a,{href:"#generating-statements-in-php",children:"Generating statements in PHP"}),")."]}),"\n"]}),"\n",(0,s.jsx)(t.h2,{id:"statement-api",children:"Statement API"}),"\n",(0,s.jsx)(t.h3,{id:"statement-processing",children:"Statement processing"}),"\n",(0,s.jsxs)(t.p,{children:["The ",(0,s.jsx)(t.code,{children:"core_xapi_statement_post"})," webservice receives a JSON encoded statement (could be an array or a single one) and a component frankenstyle name."]}),"\n",(0,s.jsx)(t.p,{children:"The processing sequence is:"}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsx)(t.li,{children:"The core xAPI library checks if the specified component has a xAPI handling class implementation. Otherwise it returns an error."}),"\n",(0,s.jsxs)(t.li,{children:["xAPI checks the statement structure, if any check fails, it returns an error. The main validations for now are:","\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsxs)(t.li,{children:["Check that only supported xAPI attributes are used. If the statement array has some format error all statements will be rejected (see ",(0,s.jsx)(t.a,{href:"#statement-data-validation",children:"Statement data validation"})," for more information)."]}),"\n",(0,s.jsx)(t.li,{children:"Check all users and groups are created in the LMS."}),"\n",(0,s.jsx)(t.li,{children:"Check the current user ($USER) is an actor of the statement (actors can be a single agent or a group)."}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["For every statement:","\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsxs)(t.li,{children:["xAPI asks the component handler to convert the statement into a standard event (function ",(0,s.jsx)(t.code,{children:"statement_to_event()"}),'). In case the plugin could not convert some statement into an event, this statement will be marked as "not processed" and will continue to the next statement.']}),"\n",(0,s.jsx)(t.li,{children:"xAPI triggers the generated events."}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["Once all statements are processed:","\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsx)(t.li,{children:'If ALL statements are marked as "not processed" it returns an error.'}),"\n",(0,s.jsx)(t.li,{children:'If some statement could be processed, returns an array containing "true" if the statement is processed and "false" otherwise.'}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(t.admonition,{type:"note",children:[(0,s.jsxs)(t.p,{children:["The function ",(0,s.jsx)(t.code,{children:"statement_to_event()"})," is responsible for:"]}),(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"Asserting that the specified user has permission to execute that statement."}),"\n",(0,s.jsx)(t.li,{children:"Providing a valid Moodle event to trigger"}),"\n",(0,s.jsx)(t.li,{children:"Processing any result attached to the statement"}),"\n"]})]}),"\n",(0,s.jsx)(t.h3,{id:"statement-data-validation",children:"Statement data validation"}),"\n",(0,s.jsxs)(t.p,{children:["The ",(0,s.jsx)(t.code,{children:"core_xapi_statement_post"})," webservice will reject any statements batch that does not comply with the below xAPI data validation:"]}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"actor"}),': this is a mandatory field. Actor objectType attribute must be "Agent" or "Group"',"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"agent"}),": agent can be only real Moodle users and must be identified by ",(0,s.jsx)(t.code,{children:"account"})," (user id as name and wwwroot as homepage) or ",(0,s.jsx)(t.code,{children:"mbox"})," (user email). The other agent identifiers are not supported (",(0,s.jsx)(t.code,{children:"mbox_sha1sum"})," and ",(0,s.jsx)(t.code,{children:"openid"}),")."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"group"}),": all groups must be real Moodle groups identified by ",(0,s.jsx)(t.code,{children:"account"})," (group id as name and wwwroot as homepage). Anonymous groups are not supported."]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"verb"}),": this is a mandatory field. Verb id must be provided in a valid IRI format."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"object"}),': this is a mandatory field. The objectType attribute can be "Agent", "Group" ar "Activity":',"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"agent"})," or ",(0,s.jsx)(t.strong,{children:"group"}),": both have the same restrictions as when they act as actors."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"activity"}),": activity id must be provided as a valid IRI format.","\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"definition"}),": in case a definition is provided, the only accepted interaction types are: ",(0,s.jsx)(t.code,{children:"choice"}),", ",(0,s.jsx)(t.code,{children:"fill-in"}),", ",(0,s.jsx)(t.code,{children:"long-fill-in"}),", ",(0,s.jsx)(t.code,{children:"true-false"}),", ",(0,s.jsx)(t.code,{children:"matching"}),", ",(0,s.jsx)(t.code,{children:"performance"}),", ",(0,s.jsx)(t.code,{children:"sequencing"}),", ",(0,s.jsx)(t.code,{children:"likert"}),", ",(0,s.jsx)(t.code,{children:"numeric"}),", ",(0,s.jsx)(t.code,{children:"compound"})," and ",(0,s.jsx)(t.code,{children:"other"}),"."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"result"}),": in case it is provided the duration must be provided in a valid ",(0,s.jsx)(t.code,{children:"ISO 8601"})," compatible with the PHP ",(0,s.jsx)(t.code,{children:"DateInterval"})," class (More info: ",(0,s.jsx)(t.a,{href:"https://bugs.php.net/bug.php?id=53831",children:"https://bugs.php.net/bug.php?id=53831"}),").","\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"score"}),": all score fields are optional and do not have any particular data validation."]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"context"}),": it has no specific validation."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"attachments"}),": if present must be an array of elements and every element must have: usageType, display, contentType, a valid usageType IRI, a numeric length and a sha2."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"authority"}),": must be a valid xAPI actor."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"timestamp"}),", ",(0,s.jsx)(t.strong,{children:"stored"})," and ",(0,s.jsx)(t.strong,{children:"version"}),": those optional fields are just strings with no particular validation or usage for now."]}),"\n"]}),"\n",(0,s.jsx)(t.h3,{id:"generating-statements-in-php",children:"Generating statements in PHP"}),"\n",(0,s.jsxs)(t.p,{children:["The xAPI library provides classes to translate Moodle elements into xAPI structures. Those statements could be sent to JS via the ",(0,s.jsx)(t.code,{children:"$PAGE->requires->data_for_js"})," method."]}),"\n",(0,s.jsx)(t.p,{children:"The next example shows how to generate a basic statement:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-php",metastring:'title="Generate a basic statement"',children:" use core_xapi\\local\\statement;\n use core_xapi\\local\\statement\\item_actor;\n use core_xapi\\local\\statement\\item_verb;\n use core_xapi\\local\\statement\\item_activity;\n\n (...)\n // Generate statement.\n $statement = new statement();\n $statement->set_actor(item_agent::create_from_user($USER));\n $statement->set_verb(item_verb::create_from_id('bake'));\n $statement->set_object(item_activity::create_from_id('cake'));\n"})}),"\n",(0,s.jsxs)(t.p,{children:["As can be seen in the example, the class ",(0,s.jsx)(t.code,{children:"item_agent"})," has a static method to generate a valid xAPI actor from a user record. The result object of executing that code will be something like:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-json",children:' {\n    "actor": {\n        "objectType": "Agent",\n        "account": {\n            "homePage": "http:\\/\\/localhost\\/m\\/H5P",\n            "name": "2"\n        }\n    },\n    "verb": {\n        "id": "http:\\/\\/localhost\\/m\\/H5P\\/xapi\\/verb\\/bake"\n    },\n    "object": {\n        "objectType": "Activity",\n        "id": "http:\\/\\/localhost\\/m\\/H5P\\/xapi\\/object\\/cake"\n    }\n }\n'})}),"\n",(0,s.jsx)(t.p,{children:"For the object and verbs, xAPI uses a standard IRI format. The xAPI library will convert any string into a valid IRI but it can also use real IRI identifiers to generate standard verbs and object structures."}),"\n",(0,s.jsx)(t.p,{children:"The next example is more a less the same but using valid IRI values for verbs and objects:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-php",metastring:'title="Example using valid IRI values for verbs and objects"',children:" use core_xapi\\local\\statement;\n use core_xapi\\local\\statement\\item_actor;\n use core_xapi\\local\\statement\\item_verb;\n use core_xapi\\local\\statement\\item_activity;\n\n (...)\n // Generate statement.\n $statement = new statement();\n $statement->set_actor(item_agent::create_from_user($USER));\n $statement->set_verb(item_verb::create_from_id('http://adlnet.gov/xapi/verbs/bake'));\n $statement->set_object(item_activity::create_from_id('http://adlnet.gov/xapi/activities/cake'));\n"})}),"\n",(0,s.jsx)(t.p,{children:"The resulting structure will be:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-json",children:' {\n    "actor": {\n        "objectType": "Agent",\n        "account": {\n            "homePage": "http:\\/\\/localhost\\/m\\/H5P",\n            "name": "2"\n        }\n    },\n    "verb": {\n        "id": "http:\\/\\/adlnet.gov\\/xapi\\/verbs\\/bake"\n    },\n    "object": {\n        "objectType": "Activity",\n        "id": "http:\\/\\/adlnet.gov\\/xapi\\/activities\\/cake"\n    }\n }\n'})}),"\n",(0,s.jsx)(t.p,{children:"The xAPI library also provides classes to convert Moodle groups into valid xAPI group actors. To generate one the code is as following:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-php",metastring:'title="Conver Moodle groups into valid xAPI group actors"',children:" use core_xapi\\local\\statement;\n use core_xapi\\local\\statement\\item_actor;\n use core_xapi\\local\\statement\\item_verb;\n use core_xapi\\local\\statement\\item_activity;\n\n (...)\n // Generate statement.\n $group = groups_get_group($groupid);\n $statement = new statement();\n $statement->set_actor(item_group::create_from_group($group));\n $statement->set_verb(item_verb::create_from_id('bake'));\n $statement->set_object(item_activity::create_from_id('cake'));\n"})}),"\n",(0,s.jsx)(t.p,{children:"The result will be:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-json",children:' {\n    "actor": {\n        "objectType": "Group",\n        "name": "Group A",\n        "account": {\n            "homePage": "http:\\/\\/localhost\\/m\\/H5P",\n            "name": "1"\n        }\n    },\n    "verb": {\n        "id": "http:\\/\\/localhost\\/m\\/H5P\\/xapi\\/verb\\/bake"\n    },\n    "object": {\n        "objectType": "Activity",\n        "id": "http:\\/\\/localhost\\/m\\/H5P\\/xapi\\/object\\/cake"\n    }\n }\n'})}),"\n",(0,s.jsx)(t.h3,{id:"xapi-statements-attributes-implementation",children:"xAPI statements attributes implementation"}),"\n",(0,s.jsxs)(t.p,{children:["All xAPI statement attributes have its own implementation in case any plugin needs them. All classes are implemented in the namespace ",(0,s.jsx)(t.code,{children:"core_xapi\\local\\statement"}),", Those are the classes implemented:"]}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Item"}),": all xAPI attributes derived from this class. This class provides a method to generate a valid item from a xAPI data structure (",(0,s.jsx)(t.code,{children:"create_from_data"}),"), implements JSON serialization and provides the basic ",(0,s.jsx)(t.code,{children:"get_data"})," method to access the raw element data structure.","\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Item_actor"}),": this is an abstract class extended by both two xAPI valid actors:","\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Item_agent"}),": an individual user. The class has a static method called ",(0,s.jsx)(t.code,{children:"create_from_user"})," to generate a valid xAPI actor from a moodle user record."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Item_group"}),": a group statement. Moodle xAPI implementation only accepts named groups (it will reject any anonymous group). To generate a valid xAPI group from a Moodle group the class has a static method called ",(0,s.jsx)(t.code,{children:"create_from_group"}),". It also provides methods to get all Moodle users from that group (",(0,s.jsx)(t.code,{children:"get_all_users"}),") and the group record itself (",(0,s.jsx)(t.code,{children:"get_group"}),")."]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Item_verb"}),": represents the statement verb. The class has a static method ",(0,s.jsx)(t.code,{children:"create_from_id"})," which accepts both valid IRI values or any random string to create a valid xAPI verb structure. It also has a method to get back the verb value (",(0,s.jsx)(t.code,{children:"get_id"}),")."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Item_object"}),": this is an abstract class extended by all possible xAPI valid objects:","\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Item_agent"})," or ",(0,s.jsx)(t.strong,{children:"Item_group"}),": both can be statements actor or objects as well"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Item_activity"}),": activity can be any kind of string value which the plugin decides. It has the same methods as item_verb to create and get this value (",(0,s.jsx)(t.code,{children:"create_from_id"})," and ",(0,s.jsx)(t.code,{children:"get_id"}),"). The xAPI activity could have also an attribute called ",(0,s.jsx)(t.code,{children:"definition"})," that contains a SCORM like data defining the user interaction.","\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Item_definition"}),": contains all the specific interaction details such as the interaction type (in SCORM format), the user answer or the correct answer pattern."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Item_result"}),": this optional attribute represents any kind of results and score derived from the user interaction. It has no strict data validation and it has to be created directly from a valid xAPI data structure using the method ",(0,s.jsx)(t.code,{children:"create_from_data"}),". It provides two methods to get the result score if present (",(0,s.jsx)(t.code,{children:"get_score"}),") and one to convert the result duration into seconds (",(0,s.jsx)(t.code,{children:"get_duration"}),"). It uses also one subclass to handle score:"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Item_score"}),": the class representing the xAPI score data. It has no validation and no specific methods."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Item_context"}),": the class representing the xAPI context data. It has no validation and no specific methods."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Item_attachment"}),": validate the xAPI attachment structure"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(t.h3,{id:"adapting-a-plugin-to-use-xapi-statement-functions",children:"Adapting a plugin to use xAPI statement functions"}),"\n",(0,s.jsx)(t.p,{children:"All the plugins could use the new xAPI functionalities to send xAPI statements, interact with them, trigger events and generate log store entries."}),"\n",(0,s.jsx)(t.h4,{id:"step-1-implement-a-xapi-handle-class",children:"Step 1. Implement a xAPI handle class"}),"\n",(0,s.jsxs)(t.p,{children:["Implement a class ",(0,s.jsx)(t.code,{children:"\\PLUGINNAME\\classes\\xapi\\handler"})," which extends ",(0,s.jsx)(t.code,{children:"\\core_xapi\\handler"})," and override these methods:"]}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"statement_to_event(statement $statement): core\\event\\base"}),": to convert a statement into a valid Moodle event"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"supports_group_actors(): bool"}),": in case that the plugin wants to accept also Group statements (by default any Group statement will be rejected) it can override this method."]}),"\n"]}),"\n",(0,s.jsx)(t.h4,{id:"step-2-implement-events",children:"Step 2. Implement events"}),"\n",(0,s.jsxs)(t.p,{children:["All xAPI statements MUST be converted into a valid Moodle event. So the plugin needs to ",(0,s.jsx)(t.strong,{children:"code all the necessary events"})," for this."]}),"\n",(0,s.jsx)(t.h3,{id:"useful-methods-to-handle-xapi-statements-inside-plugins",children:"Useful methods to handle xAPI statements inside plugins"}),"\n",(0,s.jsxs)(t.p,{children:["The ",(0,s.jsx)(t.code,{children:"core_xapi\\local\\statement"})," provides several methods to extract information from a statement object."]}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.code,{children:"get_user (): stdClass"})}),"\n",(0,s.jsx)(t.p,{children:"Return the Moodle user represented by the statement actor. In the case of a group actor, this function will throw an xapi_exception."}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.code,{children:"get_all_users(): array"})}),"\n",(0,s.jsx)(t.p,{children:"Will return an array with all Moodle users represented in the xAPI actor object. This can be used in both single agent and group statements."}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.code,{children:"get_group(): stdClass"})}),"\n",(0,s.jsx)(t.p,{children:"Return the Moodle group record represented in the xAPI actor. In the case of a single agent actor, this function will throw an xapi_exception."}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.code,{children:"get_verb_id (): string"})}),"\n",(0,s.jsx)(t.p,{children:"Return the current verb ID value from a statement."}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.code,{children:"get_activity_id(): string"})}),"\n",(0,s.jsxs)(t.p,{children:["Return the current activity ID. If the statement object is not an activity (could be also an agent or a group) the method will throw an ",(0,s.jsx)(t.code,{children:"xapi_exception"}),"."]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.code,{children:"minify (): ?array"})}),"\n",(0,s.jsx)(t.p,{children:'Return a minified version of the statement suitable for using as a "other" field of a Moodle event.'}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.code,{children:"get_actor(): item_actor"})}),"\n",(0,s.jsx)(t.p,{children:"Return the statement actor."}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.code,{children:"get_verb(): item_verb"})}),"\n",(0,s.jsx)(t.p,{children:"Return the statement verb."}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.code,{children:"get_object(): item_object"})}),"\n",(0,s.jsx)(t.p,{children:"Return the statement object."}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.code,{children:"get_context(): item_context"})}),"\n",(0,s.jsx)(t.p,{children:"Return the statement context attribute."}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.code,{children:"get_result(): item_result"})}),"\n",(0,s.jsx)(t.p,{children:"Return the statement result attribute."}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.code,{children:"get_timestamp(): string"})}),"\n",(0,s.jsx)(t.p,{children:"Return the statement timestamp attribute."}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.code,{children:"get_stored(): string"})}),"\n",(0,s.jsx)(t.p,{children:"Return the statement stored attribute."}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.code,{children:"get_authority(): item_actor"})}),"\n",(0,s.jsx)(t.p,{children:"Return the statement authority attribute."}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.code,{children:"get_version(): string"})}),"\n",(0,s.jsx)(t.p,{children:"Return the statement version attribute."}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.code,{children:"get_attachments(): item_attachment"})}),"\n",(0,s.jsx)(t.p,{children:"Return the statement attachments attribute."}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(t.h3,{id:"using-ajax-lib-to-send-a-statement-to-moodle",children:"Using Ajax lib to send a statement to Moodle"}),"\n",(0,s.jsx)(t.p,{children:"The webservices have a different behaviour depending if it is processing a single statement or an array of them."}),"\n",(0,s.jsx)(t.p,{children:"This code could be an example of a single xAPI statement post JavaScript code:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-javascript",metastring:'title="Post single xAPI statement with JavaScript"',children:" require([]('core/ajax'), function(ajax) {\n    var data = {\n        component: 'mod_h5p',\n        requestjson: JSON.stringify(statement)\n    };\n    var promises = ajax.call([\n       {\n           methodname: 'core_xapi_statement_post',\n           args: data\n       }\n    ]);\n    promises[](0).done(function(response) {\n       // Put some success messages...\n    }).fail(function(ex) {\n       // Do some failure message handling...\n    });\n });\n"})}),"\n",(0,s.jsx)(t.p,{children:"On the other hand, if you send more than one statement, the webservice will return an array of booleans indicating which statements are successfully stored and which not. Only in the case of none of the statements could be processed (usually because of an invalid statement structure) the webservice will return an error."}),"\n",(0,s.jsx)(t.p,{children:"This could be an example of sending more than one statement to Moodle:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-javascript",metastring:'title="Post more than one xAPI statements with JavaScript"',children:" require([]('core/ajax'), function(ajax) {\n    var data = {\n        component: 'mod_h5p',\n        requestjson: JSON.stringify(statements)\n    };\n    var promises = ajax.call([\n        {\n            methodname: 'core_xapi_statement_post',\n            args: data\n        }\n    ]);\n    promises[](0).done(function(response) {\n        // Check if it's a success or not.\n        for (var i = 0; i < response.length; i++) {\n            if (response[](i)) {\n               // Do some success handling.\n            } else {\n               // Do some failure handling.\n            }\n        }\n    }).fail(function(ex) {\n        // None of the statements are processed.\n    });\n });\n"})}),"\n",(0,s.jsx)(t.h2,{id:"state-api",children:"State API"}),"\n",(0,s.jsx)(t.h3,{id:"state-processing",children:"State processing"}),"\n",(0,s.jsx)(t.p,{children:"There are three webservices to process xAPI states:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"core_xapi_post_state"})," receives a activityId, agent, stateId, registration, stateData (JSON encoded state) and a component frankenstyle name."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"core_xapi_get_state"})," returns the JSON encoded state associated to the given activityId, agent, stateId, registration and component."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"core_xapi_delete_state"})," removes the state with the given activityId, agent, stateId, registration and component."]}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"The processing sequence is:"}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsx)(t.li,{children:"The core xAPI library checks if the specified component has a xAPI handling class implementation. Otherwise it returns an error."}),"\n",(0,s.jsxs)(t.li,{children:["xAPI checks the state structure, if any check fails, it returns an error. The main validations for now are:","\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsxs)(t.li,{children:["Check the current user ($USER) is an actor of the state. If it's not, a ",(0,s.jsx)(t.code,{children:"xapi_exception"})," is thrown."]}),"\n",(0,s.jsxs)(t.li,{children:["xAPI asks the component handler to validate state (function ",(0,s.jsx)(t.code,{children:"validate_state()"}),"). In case the plugin returns false, a ",(0,s.jsx)(t.code,{children:"xapi_exception"})," is thrown."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(t.admonition,{type:"note",children:(0,s.jsxs)(t.p,{children:["The function ",(0,s.jsx)(t.code,{children:"validate_state()"})," is responsible for asserting that the specified user has permission to execute that state."]})}),"\n",(0,s.jsx)(t.h3,{id:"generating-states-in-php",children:"Generating states in PHP"}),"\n",(0,s.jsxs)(t.p,{children:["The xAPI library provides classes to translate Moodle elements into xAPI states. They could be sent to JS via the ",(0,s.jsx)(t.code,{children:"$PAGE->requires->data_for_js"})," method."]}),"\n",(0,s.jsx)(t.p,{children:"The next example shows how to generate a basic state:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-php",metastring:'title="Generate a basic state"',children:" use core_xapi\\local\\state;\n use core_xapi\\local\\statement\\item_agent;\n use core_xapi\\local\\statement\\item_activity;\n\n (...)\n // Generate state.\n $state = new state(\n    item_agent::create_from_user($USER),\n    item_activity::create_from_id('cake'),\n    $stateid,\n    $statedata,\n    $registration\n);\n"})}),"\n",(0,s.jsx)(t.h3,{id:"adapting-a-plugin-to-use-xapi-state-functions",children:"Adapting a plugin to use xAPI state functions"}),"\n",(0,s.jsx)(t.p,{children:"All the plugins could use the new xAPI functionalities to send/get/remove xAPI states."}),"\n",(0,s.jsx)(t.h4,{id:"implement-a-xapi-handle-class",children:"Implement a xAPI handle class"}),"\n",(0,s.jsxs)(t.p,{children:["Implement a class ",(0,s.jsx)(t.code,{children:"\\PLUGINNAME\\classes\\xapi\\handler"})," which extends ",(0,s.jsx)(t.code,{children:"\\core_xapi\\handler"})," and override this method:"]}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"validate_state(state $state): bool"}),": to check if the state is valid for this handler. It must be implemented by the plugins which want to use xAPI states."]}),"\n"]}),"\n",(0,s.jsxs)(t.p,{children:["Apart from this, a ",(0,s.jsx)(t.code,{children:"core_xapi\\state_store"})," class has been added to let plugins override where the states are saved. By default, they are stored in the ",(0,s.jsx)(t.code,{children:"xapi_states"})," table."]}),"\n",(0,s.jsx)(t.h3,{id:"useful-methods-to-handle-xapi-states-inside-plugins",children:"Useful methods to handle xAPI states inside plugins"}),"\n",(0,s.jsxs)(t.p,{children:["The ",(0,s.jsx)(t.code,{children:"core_xapi\\local\\state"})," provides several methods to extract information from a state object."]}),"\n",(0,s.jsxs)(t.p,{children:["Apart from this, ",(0,s.jsx)(t.code,{children:"core_xapi\\api"})," also implements several helper methods to be called from the plugins:"]}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"remove_states_from_component(string $component): void"}),", to delete all states associated with a component."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"execute_state_cleanup(): void"}),", to remove all the states for all the compatible components."]}),"\n"]}),"\n",(0,s.jsx)(t.h3,{id:"using-ajax-lib-to-send-a-state-to-moodle",children:"Using Ajax lib to send a state to Moodle"}),"\n",(0,s.jsx)(t.p,{children:"This code could be an example of a single xAPI state post JavaScript code:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-javascript",metastring:'title="Post single xAPI state with JavaScript"',children:"    /**\n     * Send a xAPI state to LMS.\n     *\n     * @param {string} component\n     * @param {string} activityId\n     * @param {Object} agent\n     * @param {string} stateId\n     * @param {string} stateData\n     * @returns {void}\n     */\n    self.postState = (\n        component,\n        activityId,\n        agent,\n        stateId,\n        stateData,\n    ) => repositoryPromise.then((Repository) => Repository.postState(\n        component,\n        activityId,\n        agent,\n        stateId,\n        stateData,\n    ));\n"})}),"\n",(0,s.jsx)(t.admonition,{type:"info",children:(0,s.jsxs)(t.p,{children:["Please note that ",(0,s.jsx)(t.code,{children:"core_h5p/repository"})," module in ",(0,s.jsx)(t.code,{children:"h5p/amd/src/repository.js"})," has been created to handle AJAX interactions."]})})]})}function x(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}}}]);
"use strict";(self.webpackChunkdevdocs=self.webpackChunkdevdocs||[]).push([[78680],{71424:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>h,contentTitle:()=>r,default:()=>u,frontMatter:()=>a,metadata:()=>l,toc:()=>d});var i=n(74848),s=n(28453),o=n(78924);const a={title:"Writing acceptance tests",sidebar_position:2,tags:["Quality Assurance","Testing","Behaviour testing","Behat"]},r=void 0,l={id:"development/tools/behat/writing",title:"Writing acceptance tests",description:"This documentation gives some hints on writing behat tests for Moodle core, and for plugins. The focus of the documentation is on behat tests for plugins. Behat Features and Scenarios are written in a natural language, and should",source:"@site/general/development/tools/behat/writing.md",sourceDirName:"development/tools/behat",slug:"/development/tools/behat/writing",permalink:"/moodledevdocs/general/development/tools/behat/writing",draft:!1,unlisted:!1,editUrl:"https://github.com/moodle/devdocs/edit/main/general/development/tools/behat/writing.md",tags:[{label:"Quality Assurance",permalink:"/moodledevdocs/general/tags/quality-assurance"},{label:"Testing",permalink:"/moodledevdocs/general/tags/testing"},{label:"Behaviour testing",permalink:"/moodledevdocs/general/tags/behaviour-testing"},{label:"Behat",permalink:"/moodledevdocs/general/tags/behat"}],version:"current",lastUpdatedBy:"Philipp Imhof",lastUpdatedAt:1697039309e3,sidebarPosition:2,frontMatter:{title:"Writing acceptance tests",sidebar_position:2,tags:["Quality Assurance","Testing","Behaviour testing","Behat"]},sidebar:"coding",previous:{title:"Running acceptance tests",permalink:"/moodledevdocs/general/development/tools/behat/running"},next:{title:"Browsers",permalink:"/moodledevdocs/general/development/tools/behat/browsers/"}},h={},d=[{value:"Create your own tests",id:"create-your-own-tests",level:2},{value:"Multiple Scenarios",id:"multiple-scenarios",level:3},{value:"Use existing steps",id:"use-existing-steps",level:3},{value:"Moodle Administration",id:"moodle-administration",level:4},{value:"IDE integration",id:"ide-integration",level:4},{value:"Providing values to steps",id:"providing-values-to-steps",level:3},{value:"Checking table values",id:"checking-table-values",level:4},{value:"Advanced use cases",id:"advanced-use-cases",level:3},{value:"Uploading files",id:"uploading-files",level:4},{value:"Field groups",id:"field-groups",level:4},{value:"Human-readable and relative dates",id:"human-readable-and-relative-dates",level:4},{value:"Writing your own steps",id:"writing-your-own-steps",level:3},{value:"Custom selectors (<tt>... in the &quot;...&quot; &quot;...&quot;</tt>)",id:"custom-selectors--in-the--",level:4},{value:"Custom navigation targets (<tt>And I am on the &quot;...&quot; &quot;...&quot; page</tt>)",id:"custom-navigation-targets-and-i-am-on-the---page",level:4},{value:"Custom entity generators (<tt>And the following &quot;...&quot; exist:</tt>)",id:"custom-entity-generators-and-the-following--exist",level:4},{value:"Writing new acceptance test step definitions",id:"writing-new-acceptance-test-step-definitions",level:3},{value:"Override behat core context for theme suite",id:"override-behat-core-context-for-theme-suite",level:3},{value:"Disable behat context or features to run in theme suite",id:"disable-behat-context-or-features-to-run-in-theme-suite",level:3},{value:"Override core behat selectors",id:"override-core-behat-selectors",level:3},{value:"Good practice",id:"good-practice",level:2},{value:"Test one thing per scenario",id:"test-one-thing-per-scenario",level:3},{value:"Set-up (Given) should not use the UI",id:"set-up-given-should-not-use-the-ui",level:3},{value:"Don&#39;t use XPath or CSS selectors - fix your Accessibility bugs",id:"dont-use-xpath-or-css-selectors---fix-your-accessibility-bugs",level:3},{value:"When you define more steps in your plugin, make it clear they come from your plugin",id:"when-you-define-more-steps-in-your-plugin-make-it-clear-they-come-from-your-plugin",level:3},{value:"PHPDoc comments to map scenario steps",id:"phpdoc-comments-to-map-scenario-steps",level:3}];function c(e){const t={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(o.A,{frontMatter:a,metadata:l}),"\n",(0,i.jsx)(t.p,{children:"This documentation gives some hints on writing behat tests for Moodle core, and for plugins. The focus of the documentation is on behat tests for plugins. Behat Features and Scenarios are written in a natural language, and should\ndescribe how a user would interact with Moodle."}),"\n",(0,i.jsxs)(t.p,{children:["Each test consists of several stages which are categorised by the terms ",(0,i.jsx)(t.strong,{children:"Given"}),", ",(0,i.jsx)(t.strong,{children:"When"}),", and ",(0,i.jsx)(t.strong,{children:"Then"}),":"]}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"Given"}),": These steps allow you to perform a test set-up. Typically Given steps are used to set configuration, create users, courses and plugin instances, and generally prepare the site for testing"]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"When"}),": When steps are used to get the test environment to the point at which you wish to test the conditions. This may include logging in, and then performing a range of actions like submitting an assignment and grading it for example"]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"Then"}),": Then steps are used to check that your plugin behaved as expected. They typically check very simple things like if certain elements or text are visible or not. For example after submitting an assignment in the When stage, you may have a step which checks that a notice was shown to state that the submission was successful.\nThese three stages match the standard ",(0,i.jsx)(t.a,{href:"http://xunitpatterns.com/Four%20Phase%20Test.html",children:"Four-phase test pattern"}),". The fourth phase is 'tear-down' which is performed by Moodle between each test and does not need to be explicitly defined in your test."]}),"\n"]}),"\n",(0,i.jsx)(t.admonition,{type:"warning",children:(0,i.jsxs)(t.p,{children:["Each test should have only one use of ",(0,i.jsx)(t.strong,{children:"Given"}),", ",(0,i.jsx)(t.strong,{children:"When"}),", and ",(0,i.jsx)(t.strong,{children:"Then"}),".\nSee ",(0,i.jsx)(t.a,{href:"https://tracker.moodle.org/browse/MDLSITE-3778",children:"MDLSITE-3778"})," for information and the policy decision on why you should not have multiple Given, When, and Then steps."]})}),"\n",(0,i.jsxs)(t.p,{children:["Where you have several Given, When, and Then steps you should use the words ",(0,i.jsx)(t.strong,{children:"And"}),", and ",(0,i.jsx)(t.strong,{children:"But"}),", for example:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-gherkin",children:'Given the following user exists:\n  | username   | ccolon             |\n  | First name | Colin              |\n  | Last name  | Colon              |\n  | email      | ccolon@example.com |\nAnd the following course exists:\n  | Name      | Jump Judging (Level 1) |\n  | Shortname | sjea1                  |\nWhen I log in as "ccolon"\nAnd I navigate to "Site home > Jump Judging (Level 1)"\nThen I should see "You are not enrolled in this course"\nBut I should see "Enrol now"\n'})}),"\n",(0,i.jsx)(t.admonition,{type:"tip",children:(0,i.jsxs)(t.p,{children:["To initialize and run your tests, please follow the instructions of ",(0,i.jsx)(t.a,{href:"/moodledevdocs/general/development/tools/behat/running",children:"Running acceptance test"}),"."]})}),"\n",(0,i.jsx)(t.h2,{id:"create-your-own-tests",children:"Create your own tests"}),"\n",(0,i.jsxs)(t.p,{children:["Behat tests are located within the directory tests/behat of your plugin.\nThe different tests are defined in files with the ending ",(0,i.jsx)(t.code,{children:"*.feature"}),".\nFirst, you have to define the header of your test:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-gherkin",children:"@mod @mod_yourplugin @javascript\nFeature: Here comes a description of your user story.\n"})}),"\n",(0,i.jsxs)(t.p,{children:["The tags on top of the feature description can be used to select specific test cases when running the tests.\nThe ",(0,i.jsx)(t.code,{children:"@javascript"})," tag should only be used, if JavaScript is needed to execute your test. This is dependent on the step you will use in your definition.\nJavaScript tests are usually much slower than tests executed without JavaScript."]}),"\n",(0,i.jsx)(t.p,{children:"Afterwards you can specify a scenario:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-gherkin",children:'Scenario: Description of your scenario, which you want to test.\n    When I log in as "student1"\n    And I am on "Course 1" course homepage\n'})}),"\n",(0,i.jsx)(t.p,{children:"Again you can define specific tags. Afterwards you write the steps, which should be executed during your test."}),"\n",(0,i.jsx)(t.admonition,{type:"tip",children:(0,i.jsxs)(t.p,{children:["Tags that are specified in your feature's header automatically apply to all scenarios defined in that feature, so it is not necessary to repeat them. In the above example, the scenario will use JavaScript, although it does not have the ",(0,i.jsx)(t.code,{children:"@javascript"})," tag."]})}),"\n",(0,i.jsx)(t.h3,{id:"multiple-scenarios",children:"Multiple Scenarios"}),"\n",(0,i.jsx)(t.p,{children:"You can have an arbitrary amount of scenarios within a test. Please make sure they all belong to the same feature.\nIf you have certain steps, which should be executed for every scenario of a feature, you can define them using a background:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-gherkin",children:'Background:\n    Given the following "courses" exist:\n      | fullname | shortname | category | groupmode |\n      | Course 1 | C1        | 0        | 1         |\n    And the following "users" exist:\n      | username | firstname | lastname | email |\n      | teacher1 | Theo | Teacher | teacher1@example.com |\n'})}),"\n",(0,i.jsxs)(t.p,{children:["This is usually used, to define the different ",(0,i.jsx)(t.code,{children:"Given"})," steps."]}),"\n",(0,i.jsx)(t.h3,{id:"use-existing-steps",children:"Use existing steps"}),"\n",(0,i.jsx)(t.p,{children:"There are different ways how to effectively browse the available existing steps:"}),"\n",(0,i.jsx)(t.h4,{id:"moodle-administration",children:"Moodle Administration"}),"\n",(0,i.jsx)(t.p,{children:"Moodle offers within its administration menu under Site Administration > Development > Acceptance Testing a complete and searchable list of all available step definitions.\nHowever, make sure you installed the behat test site first!"}),"\n",(0,i.jsx)(t.h4,{id:"ide-integration",children:"IDE integration"}),"\n",(0,i.jsx)(t.p,{children:"In PhpStorm or IntelliJ you can install the behat extension. Then you get auto completions within feature files, which helps a lot during behat test development."}),"\n",(0,i.jsx)(t.h3,{id:"providing-values-to-steps",children:"Providing values to steps"}),"\n",(0,i.jsx)(t.p,{children:"Most of the steps requires values, there are methods to provide values to steps, the method depends on the step specification."}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"A string/text"})," is the most common case, the texts are wrapped between double quotes (",(0,i.jsx)(t.code,{children:'"'})," character) you have to replace the info about the expected value for your value; for example something like ",(0,i.jsx)(t.strong,{children:'I press "BUTTON_STRING"'})," should become ",(0,i.jsx)(t.strong,{children:'I press "Save and return to course"'}),'. If you want to add a string which contains a " character, you can escape it with ", for example ',(0,i.jsx)(t.strong,{children:'I fill the "Name" field with "Alan alias "the legend""'}),". You can identify this steps because they ends with ",(0,i.jsx)(t.strong,{children:"_STRING"})]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"A number"})," some steps requires numbers as values, to be more specific an undetermined number of digits from 0 to 9 (Natural numbers + 0) you can identify them because the expected value info string ends with ",(0,i.jsx)(t.strong,{children:"_NUMBER"})]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"A table"}),"; is a relation between values, the most common use of it is to fill forms. The steps which requires tables are easily identifiable because they finish with ",(0,i.jsx)(t.strong,{children:":"})," The steps description gives info about what the table columns must contain, for example ",(0,i.jsx)(t.strong,{children:"Fills a moodle form with field/value data"}),". Here you don't need to escape the double quotes if you want to include them as part of the value."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"A PyString"}),' is a multiline string, most commonly used to fill out forms when a newline is required. Like steps with tables, steps which require PyStrings will end with ":"']}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"A field value"})," There are many different field types, if an argument requires a field value the expected value will depend on the field type:","\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"Text-based fields: It expects the text. This includes textareas, input type text, input type password..."}),"\n",(0,i.jsx)(t.li,{children:'Checkbox: It expects 1 to check and for checked and "" to uncheck or for unchecked'}),"\n",(0,i.jsxs)(t.li,{children:["Select: It expects the option text or the option value. In case you interact with a multi-select you should specify the options separating them with commas. For example: ",(0,i.jsx)(t.strong,{children:"option1, option2, option3"})]}),"\n",(0,i.jsx)(t.li,{children:"Radio: The text of the radio option"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"A selector"})," there are steps that can be used with different kinds of elements, for example ",(0,i.jsx)(t.strong,{children:'I click on "User Name" "link"'})," or ",(0,i.jsx)(t.strong,{children:'I click on "User Name" "button"'})," this is a closed list of elements, they always works together with another argument, where you specify the locator (eg. the link text in a link) In the 'Acceptance testing' interface you can see a drop-down menu to select one of these options:","\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"field - for searching a field by its id, name, value or label"}),"\n",(0,i.jsx)(t.li,{children:"link - for searching a link by its href, id, title, img alt or value"}),"\n",(0,i.jsx)(t.li,{children:"button - for searching a button by its name, id, value, img alt or title"}),"\n",(0,i.jsx)(t.li,{children:"link_or_button - for searching for both, links and buttons"}),"\n",(0,i.jsx)(t.li,{children:"select - for searching a select field by its id, name or label"}),"\n",(0,i.jsx)(t.li,{children:"checkbox - for searching a checkbox by its id, name, or label"}),"\n",(0,i.jsx)(t.li,{children:"radio - for searching a radio button by its id, name, or label"}),"\n",(0,i.jsx)(t.li,{children:"file - for searching a file input by its id, name, or label"}),"\n",(0,i.jsx)(t.li,{children:"optgroup - for searching optgroup by its label"}),"\n",(0,i.jsx)(t.li,{children:"option - for searching an option by its content"}),"\n",(0,i.jsx)(t.li,{children:"dialogue - for searching a dialogue with the specified header text"}),"\n",(0,i.jsx)(t.li,{children:"filemanager - for searching a filemanager by it's id or label"}),"\n",(0,i.jsx)(t.li,{children:"block - for searching a Moodle block by it's English name or it's frankenstyle name"}),"\n",(0,i.jsx)(t.li,{children:'section - for searching for a section on a course page by it\'s title or its written out date (e.g. "1 January - 7 January"). Use "frontpage" "section" for the frontpage section if it has no title (default)'}),"\n",(0,i.jsx)(t.li,{children:"activity - for searching for an activity module in a course list by it's title"}),"\n",(0,i.jsxs)(t.li,{children:["region - for searching a Moodle page region with that id, in fact it works with all ids for ",(0,i.jsx)("tt",{children:"div"}),", ",(0,i.jsx)("tt",{children:"section"}),", ",(0,i.jsx)("tt",{children:"aside"}),", ",(0,i.jsx)("tt",{children:"header"})," or ",(0,i.jsx)("tt",{children:"footer"})," elements."]}),"\n",(0,i.jsx)(t.li,{children:"table_row - for searching a table row which contains the specified text"}),"\n",(0,i.jsx)(t.li,{children:"table - for searching a table by its id or caption"}),"\n",(0,i.jsx)(t.li,{children:"icon - for searching an icon by its title"}),"\n",(0,i.jsx)(t.li,{children:"fieldset - for searching a fieldset by it's id or legend"}),"\n",(0,i.jsx)(t.li,{children:"css_element - for searching an element by its CSS selector"}),"\n",(0,i.jsx)(t.li,{children:"xpath_element - for searching an element by its XPath"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"A text selector"})," similar to a selector but those are the elements that returns an area of the DOM, they are useful in steps following the format ",(0,i.jsx)(t.strong,{children:'... in the "Community finder" "block"'})," where you are clicking or looking for some text inside a specific area. In the 'Acceptance testing' interface you can see a drop-down menu to select one of these options:","\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"dialogue - for searching a dialogue with the specified header text"}),"\n",(0,i.jsx)(t.li,{children:"block - for searching a Moodle block by it's English name or it's frankenstyle name"}),"\n",(0,i.jsx)(t.li,{children:'section - for searching for a section on a course page by it\'s title or its written out date (e.g. "1 January - 7 January"). Use "frontpage" "section" for the frontpage section if it has no title (default)'}),"\n",(0,i.jsx)(t.li,{children:"activity - for searching for an activity module in a course list by it's title"}),"\n",(0,i.jsxs)(t.li,{children:["region - for searching a Moodle page region with that id, in fact it works with all ids for ",(0,i.jsx)("tt",{children:"div"}),", ",(0,i.jsx)("tt",{children:"section"}),", ",(0,i.jsx)("tt",{children:"aside"}),", ",(0,i.jsx)("tt",{children:"header"})," or ",(0,i.jsx)("tt",{children:"footer"})," elements."]}),"\n",(0,i.jsx)(t.li,{children:"table_row - for searching a table row which contains the specified text"}),"\n",(0,i.jsx)(t.li,{children:"table - for searching a table by its id or caption"}),"\n",(0,i.jsx)(t.li,{children:"fieldset - for searching a fieldset by it's id or legend"}),"\n",(0,i.jsx)(t.li,{children:"list_item - for searching a list item which contains the specified text"}),"\n",(0,i.jsx)(t.li,{children:"css_element - for searching an element by its CSS selector"}),"\n",(0,i.jsx)(t.li,{children:"xpath_element - for searching an element by its XPath"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(t.h4,{id:"checking-table-values",children:"Checking table values"}),"\n",(0,i.jsx)(t.p,{children:"You can check if specific value exists or not in a table row/column by using:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-gherkin",children:'Then "STRING_IN_ROW" row "COLUMN_HEADER" column of "TABLE_ID" table should contain "VALUE_TO_CHECK"\n'})}),"\n",(0,i.jsx)(t.p,{children:"or"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-gherkin",children:'Then the following should exist in the "TABLE_ID" table:\n    | COLUMN_HEADER1 | COLUMN_HEADER2 |\n    | VALUE_IN_ROW_1 | VALUE_IN_ROW_1 |\n    | VALUE_IN_ROW_2 | VALUE_IN_ROW_2 |\n'})}),"\n",(0,i.jsx)(t.h3,{id:"advanced-use-cases",children:"Advanced use cases"}),"\n",(0,i.jsx)(t.p,{children:"Most of the time the usage of existing step definitions is straight forward. However, there are some exceptions were it might get complicated. Some of them are listed here:"}),"\n",(0,i.jsx)(t.h4,{id:"uploading-files",children:"Uploading files"}),"\n",(0,i.jsx)(t.p,{children:"Note than some tests requires files to be uploaded, in this case"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["The ",(0,i.jsx)(t.strong,{children:'I upload "FILEPATH_STRING" file to "FILEPICKER_FIELD_STRING" filepicker'})," step can be used when located in the form page"]}),"\n",(0,i.jsxs)(t.li,{children:["The file to upload should be included along with the Moodle codebase in ",(0,i.jsx)(t.code,{children:"COMPONENTNAME/tests/fixtures/*"})]}),"\n",(0,i.jsxs)(t.li,{children:["The file to upload is specified by it's path, which should be relative to the codebase root (",(0,i.jsx)(t.code,{children:"lib/tests/fixtures/users.csv"})," for example)"]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"/"})," should be used as directory separator and the file names can not include this ",(0,i.jsx)(t.strong,{children:"/"})," character as all of them would be converted to the OS-dependant directory separator to maintain the compatibility with Windows systems."]}),"\n",(0,i.jsxs)(t.li,{children:["The scenarios that includes files uploading should be tagged using the ",(0,i.jsx)(t.strong,{children:"@_file_upload"})," tag"]}),"\n"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-gherkin",children:'@editor @editor_atto @atto @atto_media @_file_upload\nFeature: Add media to Atto\n  To write rich text - I need to add media.\n\n  Background:\n    Given I log in as "admin"\n    And I follow "Manage private files..."\n    And I upload "lib/editor/atto/tests/fixtures/moodle-logo.webm" file to "Files" filemanager\n    And I upload "lib/editor/atto/tests/fixtures/moodle-logo.mp4" file to "Files" filemanager\n    And I upload "lib/editor/atto/tests/fixtures/moodle-logo.png" file to "Files" filemanager\n    And I upload "lib/editor/atto/tests/fixtures/pretty-good-en.vtt" file to "Files" filemanager\n    And I upload "lib/editor/atto/tests/fixtures/pretty-good-sv.vtt" file to "Files" filemanager\n    And I click on "Save changes" "button"\n...\n'})}),"\n",(0,i.jsx)(t.h4,{id:"field-groups",children:"Field groups"}),"\n",(0,i.jsx)(t.p,{children:"This section describes how you can use the step definitions"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-gherkin",children:'When I set the following fields to these values:\n...\nWhen I set the field "([^"]|\\"*)" to "([^"]|\\"*)"\n'})}),"\n",(0,i.jsx)(t.p,{children:"for field groups. Examples for such field groups are the duration field or the date_time_selector. These are not displayed as one single input field within the front-end but consist of multiple input fields within one row.\nYou can access each single input field of a group using"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-gherkin",children:"identifierOfYourField[keyOfTheSpecificInput]\n"})}),"\n",(0,i.jsx)(t.p,{children:"Examples would be:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-gherkin",children:"When I set the following fields to these values:\n  | myDate[day]             |   21   |\n  | myDate[month]           |   12   |\n  | myDate[hour]            |   14   |\n  | myDuration[number]      |   10   |\n  | myDuration[unit]        | days   |\n"})}),"\n",(0,i.jsx)(t.h4,{id:"human-readable-and-relative-dates",children:"Human-readable and relative dates"}),"\n",(0,i.jsx)(t.p,{children:"When testing plugins with deadlines, for instance for submissions, it is often necessary to set certain time values to dates relative to today.\nYou can specify a relative time enclosed within two ## blocks. For example:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.code,{children:"## yesterday ##"})}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"## 2 days ago ##"}),"\nYou can use everything according to ",(0,i.jsx)(t.a,{href:"http://php.net/manual/en/datetime.formats.php",children:"http://php.net/manual/en/datetime.formats.php"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(t.p,{children:["Especially useful are the relative formats from: ",(0,i.jsx)(t.a,{href:"http://php.net/manual/en/datetime.formats.relative.php",children:"http://php.net/manual/en/datetime.formats.relative.php"})]}),"\n",(0,i.jsx)(t.p,{children:"Additionally, you can specify a format you want the date to be returned into:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"## yesterday ## myformat ##"}),"\nThese formats can be used as outlined in ",(0,i.jsx)(t.a,{href:"http://php.net/manual/en/function.date.php",children:"http://php.net/manual/en/function.date.php"}),".\nThis can be combined with the field groups:"]}),"\n"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-gherkin",children:"When I set the following fields to these values:\n  | myDate[day]   | ##yesterday##d## |\n  | myDate[month] | ##yesterday##F## |\n  | myDate[year]  | ##yesterday##Y## |\n"})}),"\n",(0,i.jsx)(t.h3,{id:"writing-your-own-steps",children:"Writing your own steps"}),"\n",(0,i.jsxs)(t.p,{children:["Sometimes, you will need to set up data that is specific to your plugin, or perform steps that are specific to your plugin's UI. In this case it may be necessary to ",(0,i.jsx)(t.a,{href:"/moodledevdocs/general/development/tools/behat/writing#writing-new-acceptance-test-step-definitions",children:"write new step definitions"}),", but the short version is that you define new steps as PHP methods with a special annotation inside a class called ",(0,i.jsx)(t.code,{children:"behat_plugintype_plugingname"})," inside ",(0,i.jsx)(t.code,{children:"tests/behat/behat_plugintype_plugingname.php"})," in your plugin."]}),"\n",(0,i.jsx)(t.p,{children:"As well as creating completely new steps, you can also extend some of the standard steps:"}),"\n",(0,i.jsxs)(t.h4,{id:"custom-selectors--in-the--",children:["Custom selectors (",(0,i.jsx)("tt",{children:'... in the "..." "..."'}),")"]}),"\n",(0,i.jsx)(t.p,{children:"There are a load of different steps which can refer to specific items on-screen, for example"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-gherkin",children:'And I click on "Submit all and finish" "button" in the "Confirmation" "dialogue"\n'})}),"\n",(0,i.jsx)(t.p,{children:"Here, 'button' and 'dialogue' are examples of selectors, and 'Submit all and finish' and 'Confirmation' are the locators which say which button or dialogue it is. When the test runs, this gets converted to an XPath expression, which is what the Behat system actually uses to locate the right element on the page."}),"\n",(0,i.jsxs)(t.p,{children:["You can define new types of selector (for example ",(0,i.jsx)(t.code,{children:"core_message > Message"}),") by implementing functions like ",(0,i.jsx)(t.code,{children:"behat_component_named_selector"})," in your plugin's ",(0,i.jsx)(t.code,{children:"behat_plugintype_plugingname"})," class. The detailed instructions for how to do this are in ",(0,i.jsx)(t.a,{href:"https://github.com/moodle/moodle/blob/33da028c27607354981cd8e62ecabb7b973c6637/lib/behat/behat_base.php#L1111",children:"the PHPdoc comments on the base class"}),"."]}),"\n",(0,i.jsx)(t.p,{children:"The reasons you might want to do this are:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"It makes your tests easier to read, which makes it easier to be sure that the test is testing the right thing, and being able to read the tests helps people understand your features."}),"\n",(0,i.jsx)(t.li,{children:"If the HTML structure you output changes, then you only need to update the selector definition in one place."}),"\n"]}),"\n",(0,i.jsxs)(t.h4,{id:"custom-navigation-targets-and-i-am-on-the---page",children:["Custom navigation targets (",(0,i.jsx)("tt",{children:'And I am on the "..." "..." page'}),")"]}),"\n",(0,i.jsx)(t.p,{children:"There are two related steps:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-gherkin",children:'Given I am on the "Quiz 1" "mod_quiz > View" page logged in as "manager"\nGiven I am on the "C1" "Course" page\n'})}),"\n",(0,i.jsxs)(t.p,{children:["To make this work, in your plugin's ",(0,i.jsx)(t.code,{children:"behat_plugintype_plugingname"})," class, you need to implement the functions ",(0,i.jsx)(t.code,{children:"resolve_page_url"})," and ",(0,i.jsx)(t.code,{children:"resolve_page_instance_url"})," methods. Once again, the detailed instructions about how this works are given in ",(0,i.jsx)(t.a,{href:"https://github.com/moodle/moodle/blob/a0fc902eb184cd4097c8ab453ddc57964cd2dbd4/lib/behat/behat_base.php#L1093",children:"the PHPdoc comments on the base class"}),"."]}),"\n",(0,i.jsx)(t.p,{children:"There are two reasons why it is good to use these steps:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"You are trying to test that your feature works, not Moodle navigation. In the pase we have had many occasions when Moodle navigation changed, and lots of tests failed and had to be fixed. It is better for your tests to start on your feature. (Except, perhaps, it might be appropriate to have one test for the expected method for users to navigate to your feature.)"}),"\n",(0,i.jsxs)(t.li,{children:["It is much faster because you load fewer irrelevant pages, and in particular the normal log in step leaves you on the Dashboard page, which is ",(0,i.jsx)(t.strong,{children:"very"})," slow to load."]}),"\n"]}),"\n",(0,i.jsxs)(t.h4,{id:"custom-entity-generators-and-the-following--exist",children:["Custom entity generators (",(0,i.jsx)("tt",{children:'And the following "..." exist:'}),")"]}),"\n",(0,i.jsxs)(t.p,{children:["It is possible to extend the ",(0,i.jsx)(t.code,{children:'Given the following "entities" exist'})," step to support your plugin's data generators. This avoids having to write new whole\nnew behat step definitions for your plugin, and allows you to re-use data generators between PHPUnit and Behat tests."]}),"\n",(0,i.jsxs)(t.p,{children:["Full documentation of this process and all available options can be found in the ",(0,i.jsx)(t.a,{href:"https://github.com/moodle/moodle/blob/1d4fdb0d1c60448104bc9eac79b5123863c67cbd/lib/behat/classes/behat_generator_base.php#L33",children:"PHPDoc for behat_generator_base"}),". A core example of this can be found in ",(0,i.jsx)(t.a,{href:"https://github.com/moodle/moodle/tree/master/mod/quiz/tests/generator",children:"/mod/quiz/tests/generator"})," and ",(0,i.jsx)(t.a,{href:"https://github.com/moodle/moodle/blob/1d4fdb0d1c60448104bc9eac79b5123863c67cbd/mod/quiz/tests/behat/quiz_reset.feature#L51",children:"quiz_reset.feature"}),". What follows is a simple example."]}),"\n",(0,i.jsxs)(t.p,{children:["To begin, you need a ",(0,i.jsx)(t.a,{href:"https://docs.moodle.org/dev/Writing_PHPUnit_tests#Generators",children:"generator"})," in ",(0,i.jsx)(t.code,{children:"/*your*/*plugin*/tests/generator/lib.php"}),'. If you are generating a type of entity called "thing", your generator will need a method called create_thing, which accepts an object:']}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-php",children:"class local_myplugin_generator extends component_generator_base {\n    public function create_thing($thing) {\n        global $DB;\n        $DB->insert_record('local_myplugin_things', $thing);\n    }\n}\n"})}),"\n",(0,i.jsxs)(t.p,{children:["Next, you will need to define your behat generator in ",(0,i.jsx)(t.code,{children:"/*your*/*plugin*/tests/generator/behat_*your_plugin*_generator.php"}),", with the ",(0,i.jsx)(t.code,{children:"method get_createable_entitites()"})," method:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-php",children:"class behat_local_myplugin_generator extends behat_generator_base {\n\n    protected function get_creatable_entities(): array {\n        return [\n            'things' => [\n                'datagenerator' => 'thing',\n                'required' => ['name']\n            ],\n        ];\n    }\n}\n"})}),"\n",(0,i.jsxs)(t.p,{children:["The ",(0,i.jsx)(t.code,{children:"datagenerator"})," value refers to the method in the generator class that we are calling, in this case ",(0,i.jsx)(t.code,{children:"create_thing()"}),". The outer array key is the entity name we will use in the behat step, in this case ",(0,i.jsx)(t.code,{children:'Given the following "local_myplugin > things" exist'}),"."]}),"\n",(0,i.jsxs)(t.p,{children:["Now, in your behat test, you can have a step like this, which will generate ",(0,i.jsx)(t.strong,{children:"2 things"}),', the first with the name "thing1" and the second with the name "thing2".']}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-gherkin",children:'Given the following "local_myplugin > things" exist:\n  | name   |\n  | thing1 |\n  | thing2 |\n'})}),"\n",(0,i.jsx)(t.h3,{id:"writing-new-acceptance-test-step-definitions",children:"Writing new acceptance test step definitions"}),"\n",(0,i.jsx)(t.p,{children:"As well as using the already existing steps , you can also define new steps."}),"\n",(0,i.jsxs)(t.p,{children:["This is most easily learned by looking at the examples that are already in the code. In any plugin, for example ",(0,i.jsx)(t.code,{children:"qtype_ddwtos"}),", look at the file ",(0,i.jsx)(t.code,{children:"tests/behat/behat_qtype_ddwtos.php"})," inside that plugin. Steps are defined by a function that has a special ",(0,i.jsx)(t.code,{children:"@Given"}),", ",(0,i.jsx)(t.code,{children:"@When"})," or ",(0,i.jsx)(t.code,{children:"@Then"})," annotation in the PHPdoc comment. This gives a regular expression. Any step in a ",(0,i.jsx)(t.code,{children:"*.feature"})," file which matches that regular expression will be translated into a call to that function."]}),"\n",(0,i.jsxs)(t.p,{children:["In terms of making the Behat test work, it does not matter whether you use ",(0,i.jsx)(t.code,{children:"@Given"}),", ",(0,i.jsx)(t.code,{children:"@When"})," or ",(0,i.jsx)(t.code,{children:"@Then"}),". However, to make your step understandable to people using your step, it is important to use the right word. Use ",(0,i.jsx)(t.code,{children:"@Given"})," for steps that set things up, ",(0,i.jsx)(t.code,{children:"@When"})," for steps that perform actions, and ",(0,i.jsx)(t.code,{children:"@Then"})," for steps that verify what happened."]}),"\n",(0,i.jsxs)(t.p,{children:["When defining new Step definitions in your plugin, try to make sure the step name identifies it as belonging to your plugin. So, don't make a step called ",(0,i.jsx)(t.code,{children:"I disable UI plugins"}),". Call it something like ",(0,i.jsx)(t.code,{children:"I disable UI plugins in the CodeRunner question type"}),"."]}),"\n",(0,i.jsx)(t.h3,{id:"override-behat-core-context-for-theme-suite",children:"Override behat core context for theme suite"}),"\n",(0,i.jsxs)(t.p,{children:["To override behat step definitions so as to run behat with specified theme, you should create a contexts within ",(0,i.jsx)(t.code,{children:"/theme/{MYTHEME}/tests/behat/"})," with prefix ",(0,i.jsx)(t.code,{children:"behat_theme_{MYTHEME}_"})," and suffixed with the context being overridden. For example, if you want to override ",(0,i.jsx)(t.code,{children:"behat_mod_forum"})," context, then you should create a class ",(0,i.jsx)(t.code,{children:"/theme/{MYTHEME}/tests/behat/mod_forum/behat_theme_{MYTHEME}_behat_mod_forum.php"})]}),"\n",(0,i.jsx)(t.h3,{id:"disable-behat-context-or-features-to-run-in-theme-suite",children:"Disable behat context or features to run in theme suite"}),"\n",(0,i.jsxs)(t.p,{children:["To disable specific contexts and features from being executed by a specific theme/suite you can create a ",(0,i.jsx)(t.code,{children:"/theme/{MYTHEME}/tests/behat/blacklist.json"})," file with following format."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-php",children:'{\n  "contexts": [\n    "behat_grade",\n    "behat_navigation",\n  ],\n  "features": [\n    "auth/tests/behat/login.feature",\n    "grade/tests/behat/grade_hidden_items.feature",\n   ]\n}\n'})}),"\n",(0,i.jsx)(t.p,{children:"The above will:"}),"\n",(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsxs)(t.li,{children:["disable the use of step_definitions from ",(0,i.jsx)(t.code,{children:"behat_grade"})," and ",(0,i.jsx)(t.code,{children:"behat_navigation"})," while running theme suite"]}),"\n",(0,i.jsxs)(t.li,{children:["disable running of scenarios in ",(0,i.jsx)(t.code,{children:"auth/tests/behat/login.feature"})," and ",(0,i.jsx)(t.code,{children:"grade/tests/behat/grade_hidden_items.feature"}),"."]}),"\n"]}),"\n",(0,i.jsx)(t.h3,{id:"override-core-behat-selectors",children:"Override core behat selectors"}),"\n",(0,i.jsxs)(t.p,{children:["To override behat selectors in specific theme, you should create a class ",(0,i.jsx)(t.code,{children:"behat_theme_{MYTHEME}_behat_selectors"})," in ",(0,i.jsx)(t.code,{children:"/theme/{MYTHEME}/tests/behat/behat_theme_{MYTHEME}_behat_selectors.php"})," extending behat_selectors."]}),"\n",(0,i.jsx)(t.h2,{id:"good-practice",children:"Good practice"}),"\n",(0,i.jsx)(t.h3,{id:"test-one-thing-per-scenario",children:"Test one thing per scenario"}),"\n",(0,i.jsx)(t.p,{children:"The ideal that you should strive for, is that each scenario tests just one specific bit of functionality. Therefore, if one test fails, the scenario name should tell you exactly what the bug is. Also, any bug should cause just one scenario to fail, not lots of unrelated ones. If you can achieve this, then the idea is that it minimises the time from seeing a test fail to having fixed the bug that was detected. Of course, this ideal is not always achievable, but in my experience it is worth striving for."}),"\n",(0,i.jsx)(t.admonition,{type:"tip",children:(0,i.jsx)(t.p,{children:"Note that this also implies that the Given, When and Then keywords should be used only once per scenario."})}),"\n",(0,i.jsx)(t.h3,{id:"set-up-given-should-not-use-the-ui",children:"Set-up (Given) should not use the UI"}),"\n",(0,i.jsxs)(t.p,{children:["The setup is not what you are really testing here. Therefore, it should be as quick and reliable as possible. The way to achieve this is with steps like ",(0,i.jsx)(t.code,{children:'And the following "Thing" exist:'})," which directly insert the data into the database. If necessary, write extra steps for your plugin to setup the things you need."]}),"\n",(0,i.jsx)(t.h3,{id:"dont-use-xpath-or-css-selectors---fix-your-accessibility-bugs",children:"Don't use XPath or CSS selectors - fix your Accessibility bugs"}),"\n",(0,i.jsxs)(t.p,{children:["If, the only way you can identify something in the page that you want to manipulate is with a step like ",(0,i.jsx)(t.code,{children:'I set the field with xpath "//textarea[\'answer\')](contains(@name,)" to "frog"'}),", then this is probably the sign that you have an Accessibility bug, because Behat accesses the page very like a screen-reader user would."]}),"\n",(0,i.jsxs)(t.p,{children:["You should be able to refer to things with steps like ",(0,i.jsx)(t.code,{children:'I set the field "Answer" to "frog"\''})," or ",(0,i.jsx)(t.code,{children:'I click on "True" "radio" in the "First question" "question"'}),". If not, you should probably think about fixing the accessibility bug, rather than resorting to unreadable selectors in your Behat test."]}),"\n",(0,i.jsx)(t.h3,{id:"when-you-define-more-steps-in-your-plugin-make-it-clear-they-come-from-your-plugin",children:"When you define more steps in your plugin, make it clear they come from your plugin"}),"\n",(0,i.jsxs)(t.p,{children:["When defining new Step definitions in your plugin, try to make sure the step name identifies it as belonging to your plugin. So, don't make a step called ",(0,i.jsx)(t.code,{children:"I disable UI plugins"}),". Call it something like ",(0,i.jsx)(t.code,{children:"I disable UI plugins in the CodeRunner question type"}),"."]}),"\n",(0,i.jsx)(t.h3,{id:"phpdoc-comments-to-map-scenario-steps",children:"PHPDoc comments to map scenario steps"}),"\n",(0,i.jsxs)(t.p,{children:["PHPDoc style comments before functions can be used to map to your .scenario files. Read more about this here ",(0,i.jsx)(t.a,{href:"https://behat.org/en/latest/user_guide/context/definitions.html",children:"https://behat.org/en/latest/user_guide/context/definitions.html"})]})]})}function u(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}}}]);
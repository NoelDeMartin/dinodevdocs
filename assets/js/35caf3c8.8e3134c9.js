"use strict";(self.webpackChunkdevdocs=self.webpackChunkdevdocs||[]).push([[29771],{63322:(e,s,t)=>{t.r(s),t.d(s,{assets:()=>a,contentTitle:()=>d,default:()=>u,frontMatter:()=>o,metadata:()=>n,toc:()=>c});var i=t(74848),r=t(28453),l=t(78924);const o={title:"User-related APIs",tags:["User"],documentationDraft:!0},d=void 0,n={id:"apis/core/user/index",title:"User-related APIs",description:"This is a collection of miscellaneous APIs that can help with doing things with lists of users.",source:"@site/docs/apis/core/user/index.md",sourceDirName:"apis/core/user",slug:"/apis/core/user/",permalink:"/moodledevdocs/docs/4.4/apis/core/user/",draft:!1,unlisted:!1,editUrl:"https://github.com/moodle/devdocs/edit/main/docs/apis/core/user/index.md",tags:[{label:"User",permalink:"/moodledevdocs/docs/4.4/tags/user"}],version:"current",lastUpdatedBy:"Andrew Nicols",lastUpdatedAt:1713332374e3,frontMatter:{title:"User-related APIs",tags:["User"],documentationDraft:!0},sidebar:"docs",previous:{title:"Report builder API",permalink:"/moodledevdocs/docs/4.4/apis/core/reportbuilder/"},next:{title:"Plugin types",permalink:"/moodledevdocs/docs/4.4/apis/plugintypes/"}},a={},c=[{value:"User field display",id:"user-field-display",level:2},{value:"<code>core_user::get_profile_picture</code>",id:"core_userget_profile_picture",level:3},{value:"<code>core_user::get_profile_url</code>",id:"core_userget_profile_url",level:3},{value:"<code>core_user::get_fullname</code>",id:"core_userget_fullname",level:3},{value:"User fields definition",id:"user-fields-definition",level:2},{value:"<code>$propertiescache</code>",id:"propertiescache",level:3},{value:"<code>fill_properties_cache()</code>",id:"fill_properties_cache",level:3},{value:"<code>validate()</code>",id:"validate",level:3},{value:"<code>clean_data()</code>",id:"clean_data",level:3},{value:"<code>clean_field()</code>",id:"clean_field",level:3},{value:"<code>get_property_type()</code>",id:"get_property_type",level:3},{value:"<code>get_property_null()</code>",id:"get_property_null",level:3},{value:"<code>get_property_choices()</code>",id:"get_property_choices",level:3},{value:"<code>get_property_default()</code>",id:"get_property_default",level:3},{value:"User selector",id:"user-selector",level:2},{value:"Sorting lists of users",id:"sorting-lists-of-users",level:2},{value:"See also",id:"see-also",level:2}];function h(e){const s={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",strong:"strong",ul:"ul",...(0,r.R)(),...e.components},{Since:t}=s;return t||function(e,s){throw new Error("Expected "+(s?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Since",!0),(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(l.A,{frontMatter:o,metadata:n}),"\n",(0,i.jsx)(s.p,{children:"This is a collection of miscellaneous APIs that can help with doing things with lists of users."}),"\n",(0,i.jsxs)(s.admonition,{type:"note",children:[(0,i.jsx)(s.p,{children:"Please note that, in many cases, more specific APIs may be more appropriate, for example:"}),(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"/moodledevdocs/docs/4.4/apis/subsystems/access",children:"Access API"})}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"/moodledevdocs/docs/4.4/apis/subsystems/group/",children:"Groups API"})}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"/moodledevdocs/docs/4.4/apis/subsystems/enrol",children:"Enrolment API"})}),"\n"]})]}),"\n",(0,i.jsx)(s.h2,{id:"user-field-display",children:"User field display"}),"\n",(0,i.jsxs)(s.p,{children:["The ",(0,i.jsx)(s.a,{href:"https://docs.moodle.org/dev/User_fields",children:"User fields"})," class is mainly used when displaying tables of data about users. It indicates which extra fields (e.g. email) should be displayed in the current context based on the permissions of the current user. It also provides ways to get the necessary data from a query, and to obtain other generally-useful fields for user names and pictures."]}),"\n",(0,i.jsx)(t,{version:"4.3",issueNumber:"MDL-77353"}),"\n",(0,i.jsx)(s.h3,{id:"core_userget_profile_picture",children:(0,i.jsx)(s.code,{children:"core_user::get_profile_picture"})}),"\n",(0,i.jsx)(s.p,{children:"Generate user picture."}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:(0,i.jsx)(s.code,{children:"user"})})," - The person to get details of."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:(0,i.jsx)(s.code,{children:"context"})})," - The context will be used to determine the visibility of the user's picture."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:(0,i.jsx)(s.code,{children:"options"})})," - Display options to be overridden:","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"courseid"}),": course id of user profile in link"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"size"}),": 35 (size of image)"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"link"}),": true (make image clickable - the link leads to user profile)"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"popup"}),": false (open in popup)"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"alttext"}),": true (add image alt attribute)"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"class"}),": image class attribute (default ",(0,i.jsx)(s.code,{children:"userpicture"}),")"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"visibletoscreenreaders"})," true (whether to be visible to screen readers)"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"includefullname"}),": false (whether to include the user's full name together with the user picture)"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"includetoken"}),": false (whether to use a token for authentication. True for current user, int value for other user id)"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(t,{version:"4.3",issueNumber:"MDL-77353"}),"\n",(0,i.jsx)(s.h3,{id:"core_userget_profile_url",children:(0,i.jsx)(s.code,{children:"core_user::get_profile_url"})}),"\n",(0,i.jsx)(s.p,{children:"Generate profile url."}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:(0,i.jsx)(s.code,{children:"user"})})," - The person to get details of."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:(0,i.jsx)(s.code,{children:"context"})})," - The context will be used to determine the visibility of the user's full name."]}),"\n"]}),"\n",(0,i.jsx)(t,{version:"4.3",issueNumber:"MDL-77353"}),"\n",(0,i.jsx)(s.h3,{id:"core_userget_fullname",children:(0,i.jsx)(s.code,{children:"core_user::get_fullname"})}),"\n",(0,i.jsx)(s.p,{children:"Generate user full name."}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:(0,i.jsx)(s.code,{children:"user"})})," - The person to get details of."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:(0,i.jsx)(s.code,{children:"context"})})," - The context will be used to determine the visibility of the user's profile url."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:(0,i.jsx)(s.code,{children:"options"})})," - Can include: override - if true, will not use forced firstname/lastname settings"]}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"user-fields-definition",children:"User fields definition"}),"\n",(0,i.jsx)(s.p,{children:"To guarantee the sanity of the data inserted into Moodle and avoid security bugs, new user fields definition methods have been created for use in Moodle 3.1 onwards. The purpose of these new methods is to create a central point of user fields data validation and guarantee all data inserted into Moodle will be cleaned against the correct parameter type. Another goal of  this new API is to create consistency across Moodle core and avoid different parameter validations for the same user fields. For now on, user data must validate against the user field, not using clean_param() directly."}),"\n",(0,i.jsx)(s.h3,{id:"propertiescache",children:(0,i.jsx)(s.code,{children:"$propertiescache"})}),"\n",(0,i.jsx)(s.p,{children:"Cached information of each user field and its attributes filled by the fill_properties_cache."}),"\n",(0,i.jsx)(s.h3,{id:"fill_properties_cache",children:(0,i.jsx)(s.code,{children:"fill_properties_cache()"})}),"\n",(0,i.jsxs)(s.p,{children:["The main method of the user definition is to keep the definition of each user field and its properties. It verifies if the ",(0,i.jsx)(s.strong,{children:(0,i.jsx)(s.code,{children:"core_user::$propertiescache"})})," is already filled and caches all user fields attributes into this same attribute.\nEach field matches the exact field name on the user table. That said, every new field added to the user table should be added to fill_properties_cache $fields array, otherwise it won't be validated or cleaned.\nEach field has four possible properties, being choices and default optional:"]}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:(0,i.jsx)(s.code,{children:"null"})})," - Whether the field is NULL or NOT_NULL, it SHOULD NOT be used as form validation, as many fields in the user table have NOT_NULL property but have the default value as (``)."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:(0,i.jsx)(s.code,{children:"type"})})," - The expected parameter type (PARAM_*) to be used as validation and sanitizing."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:(0,i.jsx)(s.code,{children:"choices"})})," - A list of accepted values of that field. For example the list of the available countries, timezones, calendar type etc."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:(0,i.jsx)(s.code,{children:"default"})})," - The default value in case the user field didn't pass the validation or cleaned and we must set the default value. For example if the user country is invalid and it is not in the list of choices, set $CFG->country."]}),"\n"]}),"\n",(0,i.jsx)(s.h3,{id:"validate",children:(0,i.jsx)(s.code,{children:"validate()"})}),"\n",(0,i.jsx)(s.p,{children:"A static method to validate user fields, accepts an array or the user object as parameter, validate each parameter individually and can return true if all user data is correct or an array of validation errors. The purpose of this method is to just validate the user data, it won't do any cleaning of the data."}),"\n",(0,i.jsx)(s.h3,{id:"clean_data",children:(0,i.jsx)(s.code,{children:"clean_data()"})}),"\n",(0,i.jsx)(s.p,{children:"A static method that has the purpose of clean the user data and return the same user array/object. It receives an array with user data or a user object as parameter and it checks if the data is in the list of choices and if the property has a default value and clean the data if the user object doesn't have a choices property.\nIt will display a debugging message if one the operations above has problems."}),"\n",(0,i.jsx)(s.h3,{id:"clean_field",children:(0,i.jsx)(s.code,{children:"clean_field()"})}),"\n",(0,i.jsx)(s.p,{children:"A static method to clean a single user field. It has two parameters, the data to be cleaned and its user field. The behaviour of the method is similar to the clean_data. It will do the validations and cleaning and can display a debug message if an error has been found. It returns the cleaned data."}),"\n",(0,i.jsx)(s.h3,{id:"get_property_type",children:(0,i.jsx)(s.code,{children:"get_property_type()"})}),"\n",(0,i.jsx)(s.p,{children:"A helper method to get the type of the property. It receives the user field name as parameter and if it doesn't exist will throw an exception. If the property has been found, it will return its type."}),"\n",(0,i.jsx)(s.h3,{id:"get_property_null",children:(0,i.jsx)(s.code,{children:"get_property_null()"})}),"\n",(0,i.jsx)(s.p,{children:"A helper method to get the null property of the user field. It receives the user field name as parameter and if it doesn't exist it throws an exception. If the property has been found, it will return the null value."}),"\n",(0,i.jsx)(s.h3,{id:"get_property_choices",children:(0,i.jsx)(s.code,{children:"get_property_choices()"})}),"\n",(0,i.jsx)(s.p,{children:"A helper method to get the list of choices of a user field. It receives the user field name as parameter and if it doesn't exist will throw an exception. If the property has been found, it will return the list of accepted values."}),"\n",(0,i.jsx)(s.h3,{id:"get_property_default",children:(0,i.jsx)(s.code,{children:"get_property_default()"})}),"\n",(0,i.jsx)(s.p,{children:"A helper method to get the default value of a property. It receives the user field name as parameter and if it doesn't exist or if it doesn't have a default attribute will throw an exception. If the property has been found, it will return its default value."}),"\n",(0,i.jsx)(s.h2,{id:"user-selector",children:"User selector"}),"\n",(0,i.jsxs)(s.p,{children:["The base class ",(0,i.jsx)(s.code,{children:"user_selector_base"})," defined in ",(0,i.jsx)(s.code,{children:"user/selector/lib.php"}),", which you can subclass to make a widget that lets you select users in an AJAX-y way. It is used, for example, on the Add group members page. The best way to learn how to use it is to search the code for other users, and see how they work. The base class also has good PHPdoc comments."]}),"\n",(0,i.jsx)(s.h2,{id:"sorting-lists-of-users",children:"Sorting lists of users"}),"\n",(0,i.jsxs)(s.p,{children:["When you fetch a list of users from the database, they should always be sorted consistently, by using the ",(0,i.jsx)(s.code,{children:"users_order_by_sql"})," function to generate the order-by clause. Again, the best way to see how that works is to search the code for existing uses."]}),"\n",(0,i.jsx)(s.h2,{id:"see-also",children:"See also"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"/moodledevdocs/docs/4.4/apis",children:"Core APIs"})}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"/moodledevdocs/docs/4.4/apis/subsystems/access",children:"Access API"})}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"/moodledevdocs/docs/4.4/apis/subsystems/group/",children:"Groups API"})}),"\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"/moodledevdocs/docs/4.4/apis/subsystems/enrol",children:"Enrolment API"})}),"\n"]})]})}function u(e={}){const{wrapper:s}={...(0,r.R)(),...e.components};return s?(0,i.jsx)(s,{...e,children:(0,i.jsx)(h,{...e})}):h(e)}}}]);
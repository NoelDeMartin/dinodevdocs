"use strict";(self.webpackChunkdevdocs=self.webpackChunkdevdocs||[]).push([[22567],{68092:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>r,default:()=>u,frontMatter:()=>l,metadata:()=>o,toc:()=>c});var a=s(74848),t=s(28453),i=s(78924);const l={title:"Analytics API",description:"The Analytics API allows managers to use predictions to detect trends and predict student behaviour",tags:["Analytics","API"]},r=void 0,o={id:"apis/subsystems/analytics/index",title:"Analytics API",description:"The Analytics API allows managers to use predictions to detect trends and predict student behaviour",source:"@site/docs/apis/subsystems/analytics/index.md",sourceDirName:"apis/subsystems/analytics",slug:"/apis/subsystems/analytics/",permalink:"/moodledevdocs/docs/4.4/apis/subsystems/analytics/",draft:!1,unlisted:!1,editUrl:"https://github.com/moodle/devdocs/edit/main/docs/apis/subsystems/analytics/index.md",tags:[{label:"Analytics",permalink:"/moodledevdocs/docs/4.4/tags/analytics"},{label:"API",permalink:"/moodledevdocs/docs/4.4/tags/api"}],version:"current",lastUpdatedBy:"Andrew Nicols",lastUpdatedAt:1713332374e3,frontMatter:{title:"Analytics API",description:"The Analytics API allows managers to use predictions to detect trends and predict student behaviour",tags:["Analytics","API"]},sidebar:"docs",previous:{title:"Admin settings",permalink:"/moodledevdocs/docs/4.4/apis/subsystems/admin/"},next:{title:"Availability API",permalink:"/moodledevdocs/docs/4.4/apis/subsystems/availability/"}},d={},c=[{value:"Summary",id:"summary",level:2},{value:"API components",id:"api-components",level:3},{value:"Data flow",id:"data-flow",level:3},{value:"API classes diagram",id:"api-classes-diagram",level:3},{value:"Built-in models",id:"built-in-models",level:2},{value:"Concepts",id:"concepts",level:2},{value:"Training",id:"training",level:3},{value:"Samples",id:"samples",level:3},{value:"Prediction model",id:"prediction-model",level:3},{value:"Static models",id:"static-models",level:4},{value:"Analyser",id:"analyser",level:3},{value:"Target",id:"target",level:3},{value:"Insights",id:"insights",level:4},{value:"Indicator",id:"indicator",level:3},{value:"Analysis intervals",id:"analysis-intervals",level:3},{value:"Machine learning backends",id:"machine-learning-backends",level:3},{value:"Design",id:"design",level:2},{value:"Interfaces",id:"interfaces",level:3},{value:"Analysable (core_analytics\\analysable)",id:"analysable-core_analyticsanalysable",level:4},{value:"Analyser (core_analytics\\local\\analyser\\base)",id:"analyser-core_analyticslocalanalyserbase",level:4},{value:"Indicator (core_analytics\\local\\indicator\\base)",id:"indicator-core_analyticslocalindicatorbase",level:4},{value:"Target (core_analytics\\local\\target\\base)",id:"target-core_analyticslocaltargetbase",level:4},{value:"Analysis interval (core_analytics\\local\\time_splitting\\base)",id:"analysis-interval-core_analyticslocaltime_splittingbase",level:4},{value:"Calculable (core_analytics\\calculable)",id:"calculable-core_analyticscalculable",level:4},{value:"How to create a model",id:"how-to-create-a-model",level:2},{value:"Define the problem",id:"define-the-problem",level:3},{value:"How many predictions for each sample?",id:"how-many-predictions-for-each-sample",level:3},{value:"Create the target",id:"create-the-target",level:3},{value:"Create the model",id:"create-the-model",level:3},{value:"Indicators",id:"indicators",level:3},{value:"API usage examples",id:"api-usage-examples",level:2},{value:"Clustered environments",id:"clustered-environments",level:2}];function h(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components},{Since:r}=n;return r||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Since",!0),(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(i.A,{frontMatter:l,metadata:o}),"\n",(0,a.jsxs)(n.p,{children:["The Moodle Analytics API allows Moodle site managers to define ",(0,a.jsx)(n.em,{children:"prediction models"})," that combine ",(0,a.jsx)(n.em,{children:"indicators"})," and a ",(0,a.jsx)(n.em,{children:"target"}),"."]}),"\n",(0,a.jsxs)(n.p,{children:["The ",(0,a.jsx)(n.em,{children:"target"})," is the event we want to predict. The ",(0,a.jsx)(n.em,{children:"indicators"})," are what we think will lead to an accurate prediction of the target."]}),"\n",(0,a.jsx)(n.p,{children:"Moodle is able to evaluate these models and, if the prediction accuracy is high enough, Moodle internally trains a machine learning algorithm by using calculations based on the defined indicators within the site data. Once new data that matches the criteria defined by the model is available, Moodle starts predicting the probability that the target event will occur. Targets are free to define what actions will be performed for each prediction, from sending messages or feeding reports to building new adaptive learning activities."}),"\n",(0,a.jsxs)(n.admonition,{title:"Example",type:"note",children:[(0,a.jsxs)(n.p,{children:["An example of a model you may be interested in is the detection of ",(0,a.jsx)(n.a,{href:"https://docs.moodle.org/en/Students_at_risk_of_dropping_out",children:"students who are at risk of dropping out"}),"."]}),(0,a.jsxs)(n.p,{children:["Possible ",(0,a.jsx)(n.em,{children:"indicators"})," for this include:"]}),(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"a lack of participation in previous activities"}),"\n",(0,a.jsx)(n.li,{children:"poor grades in previous activities"}),"\n"]}),(0,a.jsxs)(n.p,{children:["The ",(0,a.jsx)(n.em,{children:"target"})," would be whether the student is able to complete the course or not."]}),(0,a.jsx)(n.p,{children:"Moodle uses these indicators and the target for each student in a finished course to predict which students are at risk of dropping out in ongoing courses."})]}),"\n",(0,a.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,a.jsx)(n.h3,{id:"api-components",children:"API components"}),"\n",(0,a.jsx)(n.p,{children:"This diagram shows the main components of the analytics API and the interactions between them."}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{alt:"Analytics API components and their interactions",src:s(18489).A+"",width:"960",height:"720"})}),"\n",(0,a.jsx)(n.h3,{id:"data-flow",children:"Data flow"}),"\n",(0,a.jsx)(n.p,{children:"The diagram below shows the different stages data goes through, from the data a Moodle site contains to actionable insights."}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{alt:"Data flow at different stages",src:s(89335).A+"",width:"960",height:"720"})}),"\n",(0,a.jsx)(n.h3,{id:"api-classes-diagram",children:"API classes diagram"}),"\n",(0,a.jsx)(n.p,{children:"This is a summary of the API classes and their relationships. It groups the different parts of the framework that can be extended by 3rd parties to create your own prediction models."}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{alt:"API Class Structure",src:s(40486).A+"",width:"960",height:"720"})}),"\n",(0,a.jsx)(n.h2,{id:"built-in-models",children:"Built-in models"}),"\n",(0,a.jsx)(n.p,{children:"People use Moodle in very different ways and even courses on the same site can vary significantly. Moodle core only includes models that have been proven to be good at predicting in a wide range of sites and courses. Moodle provides two built-in models:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://docs.moodle.org/en/Students_at_risk_of_dropping_out",children:"Students at risk of dropping out"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://docs.moodle.org/en/Analytics#No_teaching",children:"No teaching"})}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"To diversify the samples and to cover a wider range of cases, the Moodle HQ research team is collecting anonymised Moodle site datasets from collaborating institutions and partners to train the machine learning algorithms with them. The models that Moodle is shipped with will be likely better at predicting on the sites of participating institutions, although some other datasets are used as test data for the machine learning algorithm to ensure that the models are good enough to predict accurately in any Moodle site."}),"\n",(0,a.jsx)(n.p,{children:"Even if the models included in Moodle core are already trained by Moodle HQ, each different site will continue training that site machine learning algorithms with its own data, which will lead to better prediction accuracy over time."}),"\n",(0,a.jsx)(n.h2,{id:"concepts",children:"Concepts"}),"\n",(0,a.jsx)(n.p,{children:"The following definitions are included for people not familiar with machine learning concepts:"}),"\n",(0,a.jsx)(n.h3,{id:"training",children:"Training"}),"\n",(0,a.jsx)(n.p,{children:"This is the process to be run on a Moodle site before being able to predict anything. This process records the relationships found in site data from the past so the analytics system can predict what is likely to happen under the same circumstances in the future. What we train are machine learning algorithms."}),"\n",(0,a.jsx)(n.h3,{id:"samples",children:"Samples"}),"\n",(0,a.jsxs)(n.p,{children:["The machine learning backends we use to make predictions need to know what sort of patterns to look for, and where in the Moodle data to look. A sample is a set of calculations we make using a collection of Moodle site data. These samples are unrelated to testing data or phpunit data, and they are identified by an id matching the data element on which the calculations are based. The id of a sample can be any Moodle entity id: a course, a user, an enrolment, a quiz attempt, etc. and the calculations the sample contains depend on that element. Each type of Moodle entity used as a sample helps develop the predictions that involve that kind of entity. For example, samples based on Quiz attempts will help develop the potential insights that the analytics might offer that are related to the Quiz attempts by a particular group of students. See the ",(0,a.jsx)(n.a,{href:"#analyser",children:"Analyser"})," documentation for more information on how to use analyser classes to define what is a sample."]}),"\n",(0,a.jsx)(n.h3,{id:"prediction-model",children:"Prediction model"}),"\n",(0,a.jsxs)(n.p,{children:["As explained above, a prediction model is a combination of indicators and a target. System models can be viewed in ",(0,a.jsx)(n.strong,{children:"Site administration > Analytics > Analytics models"}),"."]}),"\n",(0,a.jsxs)(n.p,{children:["The relationship between indicators and targets is stored in ",(0,a.jsx)(n.em,{children:"analytics_models"})," database table."]}),"\n",(0,a.jsxs)(n.p,{children:["The class ",(0,a.jsx)(n.code,{children:"\\core_analytics\\model"})," manages all of a model's related actions. ",(0,a.jsx)(n.em,{children:"evaluate()"}),", ",(0,a.jsx)(n.em,{children:"train()"})," and ",(0,a.jsx)(n.em,{children:"predict()"})," forward the calculated indicators to the machine learning backends. ",(0,a.jsx)(n.code,{children:"\\core_analytics\\model"})," delegates all heavy processing to analysers and machine learning backends. It also manages prediction models evaluation logs."]}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"\\core_analytics\\model"})," class is not expected to be extended."]}),"\n",(0,a.jsx)(n.h4,{id:"static-models",children:"Static models"}),"\n",(0,a.jsxs)(n.p,{children:["Some prediction models do not need a powerful machine learning algorithm behind them processing large quantities of data to make accurate predictions. There are obvious events that different stakeholders may be interested in knowing that we can easily calculate. These ",(0,a.jsx)(n.em,{children:"Static model"})," predictions are directly calculated based on indicator values. They are based on the assumptions defined in the target, but they should still be based on indicators so all these indicators can still be reused across different prediction models. For this reason, static models are not editable through ",(0,a.jsx)(n.strong,{children:"Site administration > Analytics > Analytics models"})," user interface."]}),"\n",(0,a.jsx)(n.p,{children:"Some examples of possible static models:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://docs.moodle.org/en/Analytics#No_teaching",children:"Courses without teaching activity"})}),"\n",(0,a.jsx)(n.li,{children:"Courses with students submissions requiring attention and no teachers accessing the course"}),"\n",(0,a.jsx)(n.li,{children:"Courses that started 1 month ago and never accessed by anyone"}),"\n",(0,a.jsx)(n.li,{children:"Students that have never logged into the system"}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"Moodle can already generate notifications for the examples above, but there are some benefits on doing it using the Moodle analytics API:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Everything is easier and faster to code from a development point of view as the analytics subsystem provides APIs for everything"}),"\n",(0,a.jsx)(n.li,{children:"New Indicators will be part of the core indicators pool that researchers (and 3rd party developers in general) can reuse in their own models"}),"\n",(0,a.jsx)(n.li,{children:"Existing core indicators can be reused as well (the same indicators used for insights that depend on machine learning backends)"}),"\n",(0,a.jsx)(n.li,{children:"Notifications are displayed using the core insights system, which is also responsible of sending the notifications and all related actions."}),"\n",(0,a.jsx)(n.li,{children:"The Analytics API tracks user actions after viewing the predictions, so we can know if insights result in actions, which insights are not useful, etc. User responses to insights could themselves be defined as an indicator."}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"analyser",children:"Analyser"}),"\n",(0,a.jsx)(n.p,{children:"Analysers are responsible for creating the dataset files that will be sent to the machine learning processors. They are coded as PHP classes. Moodle core includes some analysers that you can use in your models."}),"\n",(0,a.jsxs)(n.p,{children:["The base class ",(0,a.jsx)(n.code,{children:"\\core_analytics\\local\\analyser\\base"})," does most of the work. It contains a key abstract method, ",(0,a.jsx)(n.em,{children:"get_all_samples()"}),". This method is what defines the sample unique identifier across the site. Analyser classes are also responsible of including all site data related to that sample id; this data will be used when indicators are calculated. e.g. A sample id ",(0,a.jsx)(n.em,{children:"user enrolment"})," would include data about the ",(0,a.jsx)(n.em,{children:"course"}),", the course ",(0,a.jsx)(n.em,{children:"context"})," and the ",(0,a.jsx)(n.em,{children:"user"}),". Samples are nothing by themselves, just a list of ids with related data. They are used in calculations once they are combined with the target and the indicator classes."]}),"\n",(0,a.jsx)(n.p,{children:"Other analyser class responsibilities:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Define the context of the predictions"}),"\n",(0,a.jsx)(n.li,{children:"Discard invalid data"}),"\n",(0,a.jsx)(n.li,{children:"Filter out already trained samples"}),"\n",(0,a.jsx)(n.li,{children:"Include the time factor (time range processors, explained below)"}),"\n",(0,a.jsx)(n.li,{children:"Forward calculations to indicators and target classes"}),"\n",(0,a.jsx)(n.li,{children:"Record all calculations in a file"}),"\n",(0,a.jsx)(n.li,{children:"Record all analysed sample ids in the database"}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:["If you are introducing a new analyser, there is an important non-obvious fact you should know about: for scalability reasons, all calculations at course level are executed in per-course basis and the resulting datasets are merged together once all site courses analysis is complete. This is for performance reasons: depending on the sites' size it could take hours to complete the analysis of the entire site. This is a good way to break the process up into pieces. When coding a new analyser you need to decide if you want to extend ",(0,a.jsx)(n.code,{children:"\\core_analytics\\local\\analyser\\by_course"})," (your analyser will process a list of courses), ",(0,a.jsx)(n.code,{children:"\\core_analytics\\local\\analyser\\site-wide"})," (your analyser will receive just one analysable element, the site) or create your own analyser for activities, categories or any other Moodle entity."]}),"\n",(0,a.jsx)(n.h3,{id:"target",children:"Target"}),"\n",(0,a.jsxs)(n.p,{children:["Targets are the key element that defines the model. As a PHP class, targets represent the event the model is attempting to predict (the ",(0,a.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Dependent_and_independent_variables",children:"dependent variable in supervised learning"}),"). They also define the actions to perform depending on the received predictions."]}),"\n",(0,a.jsx)(n.p,{children:"Targets depend on analysers, because analysers provide them with the samples they need. Analysers are separate entities from targets because analysers can be reused across different targets. Each target needs to specify which analyser it is using. Here are a few examples to clarify the difference between analysers, samples and targets:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Target"}),": 'students at risk of dropping out'. ",(0,a.jsx)(n.strong,{children:"Analyser provides sample"}),": 'course enrolments'"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Target"}),": 'spammer'. ",(0,a.jsx)(n.strong,{children:"Analyser provides sample"}),": 'site users'"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Target"}),": 'ineffective course'. ",(0,a.jsx)(n.strong,{children:"Analyser provides sample"}),": 'courses'"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Target"}),": 'difficulties to pass a specific quiz'. ",(0,a.jsx)(n.strong,{children:"Analyser provides sample"}),": 'quiz attempts in a specific quiz'"]}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"A callback defined by the target will be executed once new predictions start coming so each target have control over the prediction results."}),"\n",(0,a.jsxs)(n.p,{children:["The API supports binary classification, multi-class classification and regression, but the machine learning backends included in core do not yet support multi-class classification or regression, so only binary classifications will be initially fully supported. See ",(0,a.jsx)(n.a,{href:"https://tracker.moodle.org/browse/MDL-59044",children:"MDL-59044"})," and ",(0,a.jsx)(n.a,{href:"https://tracker.moodle.org/browse/MDL-60523",children:"MDL-60523"})," for more information."]}),"\n",(0,a.jsx)(n.p,{children:"Although there is no technical restriction against using core targets in your own models, in most cases each model will implement a new target. One possible case in which targets might be reused would be to create a new model using the same target and a different sets of indicators, for A/B testing"}),"\n",(0,a.jsx)(n.h4,{id:"insights",children:"Insights"}),"\n",(0,a.jsxs)(n.p,{children:["Another aspect controlled by targets is insight generation. Insights represent predictions made about a specific element of the sample within the context of the analyser model. This context will be used to notify users with the ",(0,a.jsx)(n.code,{children:"moodle/analytics:listinsights"})," capability (the teacher role by default) about new insights being available. These users will receive a notification with a link to the predictions page where all predictions of that context are listed."]}),"\n",(0,a.jsxs)(n.p,{children:["A set of suggested actions will be available for each prediction. In cases like ",(0,a.jsx)(n.em,{children:(0,a.jsx)(n.a,{href:"https://docs.moodle.org/en/Students_at_risk_of_dropping_out",children:"Students at risk of dropping out"})})," the actions can be things like sending a message to the student, viewing the student's course activity report, etc."]}),"\n",(0,a.jsx)(n.h3,{id:"indicator",children:"Indicator"}),"\n",(0,a.jsxs)(n.p,{children:["Indicator PHP classes are responsible for calculating indicators (predictor value or ",(0,a.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Dependent_and_independent_variables",children:"independent variable in supervised learning"}),") using the provided sample. Moodle core includes a set of indicators that can be used in your models without additional PHP coding (unless you want to extend their functionality)."]}),"\n",(0,a.jsxs)(n.p,{children:["Indicators are not limited to a single analyser like targets are. This makes indicators easier to reuse in different models. Indicators specify a minimum set of data they need to perform the calculation. The indicator developer should also make an effort to imagine how the indicator will work when different analysers are used. For example an indicator named ",(0,a.jsx)(n.em,{children:"Posts in any forum"})," could be initially coded for a ",(0,a.jsx)(n.em,{children:"Shy students in a course"})," target; this target would use ",(0,a.jsx)(n.em,{children:"course enrolments"})," analyser, so the indicator developer knows that a ",(0,a.jsx)(n.em,{children:"course"})," and an ",(0,a.jsx)(n.em,{children:"enrolment"})," will be provided by that analyser, but this indicator can be easily coded so the indicator can be reused by other analysers like ",(0,a.jsx)(n.em,{children:"courses"})," or *users'. In this case the developer can chose to require ",(0,a.jsx)(n.em,{children:"course"})," ",(0,a.jsx)(n.strong,{children:"or"})," ",(0,a.jsx)(n.em,{children:"user"}),", and the name of the indicator would change according to that. For example, ",(0,a.jsx)(n.em,{children:"User posts in any forum"})," could be used in a user-based model like ",(0,a.jsx)(n.em,{children:"Inactive users"})," and in any other model where the analyser provides ",(0,a.jsx)(n.em,{children:"user"})," data; ",(0,a.jsx)(n.em,{children:"Posts in any of the course forums"})," could be used in a course-based model like *Low participation courses.''"]}),"\n",(0,a.jsxs)(n.p,{children:['The calculated value can go from -1 (minimum) to 1 (maximum). This requirement prevents the creation of "raw number" indicators like ',(0,a.jsx)(n.em,{children:"absolute number of write actions,"}),' because we must limit the calculation to a range, e.g. -1 = 0 actions, -0.33 = some basic activity, 0.33 = activity, 1 = plenty of activity. Raw counts of an event like "posts to a forum" must be calculated in a proportion of an expected number of posts. There are several ways of doing this. One is to define a minimum desired number of events, e.g. 3 posts in a forum represents "some" activity, 6 posts represents adequate activity, and 10 or more posts represents the maximum expected activity. Another way is to compare the number of events per individual user to the mean or median value of events by all users in the same context, using statistical values. For example, a value of 0 would represent that the student posted the same number of posts as the mean of all student posts in that context; a value of -1 would indicate that the student is 2 or 3 standard deviations below the mean, and a +1 would indicate that the student is 2 or 3 standard deviations above the mean.']}),"\n",(0,a.jsx)(n.admonition,{title:"Comparative rankings",type:"danger",children:(0,a.jsx)(n.p,{children:"This kind of comparative calculation has implications to pedagogy: it suggests that there is a ranking of students from best to worst, rather than a defined standard all students can reach. Please be aware of this when considering how indicators are presented to users."})}),"\n",(0,a.jsx)(n.h3,{id:"analysis-intervals",children:"Analysis intervals"}),"\n",(0,a.jsx)(n.p,{children:"Analysis intervals define when the system will calculate predictions and the portion of activity logs that will be considered for those predictions. They are coded as PHP classes and Moodle core includes some analysis intervals you can use in your models."}),"\n",(0,a.jsx)(n.admonition,{title:"Time-splitting methods",type:"info",children:(0,a.jsx)(n.p,{children:"Analysis intervals were previously known as Time-splitting methods."})}),"\n",(0,a.jsxs)(n.p,{children:["In some cases the time factor is not important and we just want to classify a sample. This is relatively simple. Things get more complicated when we want to predict what will happen in future. For example, predictions about ",(0,a.jsx)(n.a,{href:"https://docs.moodle.org/en/Students_at_risk_of_dropping_out",children:"Students at risk of dropping out"})," are not useful once the course is over or when it is too late for any intervention."]}),"\n",(0,a.jsx)(n.p,{children:"Calculations involving time ranges can be a challenging aspect of some prediction models. Indicators need to be designed with this in mind and we need to include time-dependent indicators within the calculated indicators so machine learning algorithms are smart enough to avoid mixing calculations belonging to the beginning of the course with calculations belonging to the end of the course."}),"\n",(0,a.jsx)(n.p,{children:"There are many different ways to split up a course into time ranges: in weeks, quarters, 8 parts, ten parts (tenths), ranges with longer periods at the beginning and shorter periods at the end... And the ranges can be accumulative (each one inclusive from the beginning of the course) or only from the start of the time range."}),"\n",(0,a.jsx)(n.p,{children:"Many of the analysis intervals included in Moodle assume that there is a fixed start and end date for each course, so the course can be divided into segments of equal length. This allows courses of different lengths to be included in the same prediction model, but makes these analysis intervals useless for courses without fixed start or end dates, e.g. self-paced courses. These courses might instead use fixed time lengths such as weeks to define the boundaries of prediction calculations."}),"\n",(0,a.jsx)(n.h3,{id:"machine-learning-backends",children:"Machine learning backends"}),"\n",(0,a.jsxs)(n.p,{children:["Documentation available in ",(0,a.jsx)(n.a,{href:"/moodledevdocs/docs/4.4/apis/plugintypes/mlbackend/",children:"Machine learning backends"}),"."]}),"\n",(0,a.jsx)(n.h2,{id:"design",children:"Design"}),"\n",(0,a.jsxs)(n.p,{children:["The system is designed as a Moodle subsystem and API. It lives in ",(0,a.jsx)(n.code,{children:"analytics/"}),". All analytics base classes are located here."]}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.a,{href:"/moodledevdocs/docs/4.4/apis/plugintypes/mlbackend/",children:"Machine learning backends"})," is a new Moodle plugin type. They are stored in ",(0,a.jsx)(n.code,{children:"lib/mlbackend"}),"."]}),"\n",(0,a.jsxs)(n.p,{children:["Uses of the analytics API are located in different Moodle components, being core (",(0,a.jsx)(n.code,{children:"lib/classes/analytics"}),") the component that hosts general purpose uses of the API."]}),"\n",(0,a.jsx)(n.h3,{id:"interfaces",children:"Interfaces"}),"\n",(0,a.jsx)(n.p,{children:"This API aims to be as extendable as possible. Any moodle component, including third party plugins, is able to define indicators, targets, analysers and time splitting methods. Analytics API will be able to find them as long as they follow the namespace conventions described below."}),"\n",(0,a.jsx)(n.p,{children:"An example of a possible extension would be a plugin with indicators that fetch student academic records from the Universities' student information system; the site admin could build a new model on top of the built-in 'students at risk of drop out detection' adding the SIS indicators to improve the model accuracy or for research purposes."}),"\n",(0,a.jsx)(n.admonition,{title:"Machine learning backends",type:"note",children:(0,a.jsxs)(n.p,{children:["This section does not include Machine learning backend interfaces. See ",(0,a.jsx)(n.a,{href:"/moodledevdocs/docs/4.4/apis/plugintypes/mlbackend/#interfaces",children:"Machine learning backends"})," for more information on these."]})}),"\n",(0,a.jsx)(n.h4,{id:"analysable-core_analyticsanalysable",children:"Analysable (core_analytics\\analysable)"}),"\n",(0,a.jsxs)(n.p,{children:["Analysables are those elements in Moodle that contain samples. In most of the cases an analysable will be a course, although it can also be the site or any other Moodle element, e.g. an activity. Moodle core includes two analysers ",(0,a.jsx)(n.code,{children:"\\core_analytics\\course"})," and ",(0,a.jsx)(n.code,{children:"\\core_analytics\\site"}),"."]}),"\n",(0,a.jsx)(n.p,{children:"They list of methods that need to be implemented is quite simple and does not require much explanation."}),"\n",(0,a.jsxs)(n.admonition,{type:"danger",children:[(0,a.jsx)(n.p,{children:"Analysable elements should be lazily loaded, otherwise you may encounter PHP memory issues. The reason is that analysers load all analysable elements in the site to calculate which ones are going to be calculated next (skipping the ones processed recently and stuff like that)."}),(0,a.jsxs)(n.p,{children:["See ",(0,a.jsx)(n.code,{children:"core_analytics\\course"})," as an example of how this can be achieved."]})]}),"\n",(0,a.jsx)(n.p,{children:"Methods to implement:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"/**\n * The analysable unique identifier in the site.\n *\n * @return int.\n */\npublic function get_id();\n\n/**\n * The analysable human readable name\n *\n * @return string\n */\npublic function get_name();\n\n/**\n * The analysable context.\n *\n * @return \\context\n */\npublic function get_context();\n"})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"get_start"})," and ",(0,a.jsx)(n.code,{children:"get_end"})," define the start and end times that indicators will use for their calculations."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"/**\n * The start of the analysable if there is one.\n *\n * @return int|false\n */\npublic function get_start();\n\n/**\n * The end of the analysable if there is one.\n *\n * @return int|false\n */\npublic function get_end();\n"})}),"\n",(0,a.jsx)(n.h4,{id:"analyser-core_analyticslocalanalyserbase",children:"Analyser (core_analytics\\local\\analyser\\base)"}),"\n",(0,a.jsxs)(n.p,{children:["The get_analysables() method has been deprecated in favour of a new ",(0,a.jsx)(n.code,{children:"get_analysables_iterator()"}),"  for performance reasons. This method returns the whole list of analysable elements in the site. Each model will later be able to discard analysables that do not match their expectations. ",(0,a.jsx)(n.em,{children:"e.g. if your model is only interested in quizzes with a time close the analyser will return all quizzes, your model will exclude the ones without a time close. This approach is supposed to make analysers more reusable."})]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"/**\n * Returns the list of analysable elements available on the site.\n *\n * A relatively complex SQL query should be set so that we take into account which analysable elements\n * have already been processed and the order in which they have been processed. Helper methods are available\n * to ease to implementation of get_analysables_iterator: get_iterator_sql and order_sql.\n *\n * @param string|null $action 'prediction', 'training' or null if no specific action needed.\n * @return \\Iterator\n */\npublic function get_analysables_iterator(?string $action = null)\n"})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"get_all_samples"})," and ",(0,a.jsx)(n.code,{children:"get_samples"})," should return data associated with the sample ids they provide. This is important for 2 reasons:"]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["The data they provide alongside the sample origin is used to filter out indicators that are not related to what this analyser analyses. ''e.g. courses analysers do provide courses and information about courses, but not information about users, a ",(0,a.jsx)(n.strong,{children:"is user profile complete"})," indicator will require the user object to be available. A model using a courses analyser will not be able to use the ",(0,a.jsx)(n.strong,{children:"is user profile complete"})," indicator."]}),"\n",(0,a.jsx)(n.li,{children:"The data included here is cached in PHP static vars; on one hand this reduces the amount of db queries indicators need to perform. On the other hand, if not well balanced, it can lead to PHP memory issues."}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"/**\n * This function returns this analysable list of samples.\n *\n * @param \\core_analytics\\analysable $analysable\n * @return array array[0] = int[] (sampleids) and array[1] = array (samplesdata)\n */\nabstract public function get_all_samples(\\core_analytics\\analysable $analysable);\n"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"/**\n * This function returns the samples data from a list of sample ids.\n *\n * @param int[] $sampleids\n * @return array array[0] = int[] (sampleids) and array[1] = array (samplesdata)\n */\nabstract public function get_samples($sampleids);\n"})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"get_sample_analysable"})," method is executing during prediction:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"/**\n * Returns the analysable of a sample.\n *\n * @param int $sampleid\n * @return \\core_analytics\\analysable\n */\nabstract public function get_sample_analysable($sampleid);\n"})}),"\n",(0,a.jsx)(n.p,{children:"The sample origin is the moodle database table that uses the sample id as primary key."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"/**\n * Returns the sample's origin in moodle database.\n *\n * @return string\n */\nabstract public function get_samples_origin();\n"})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"sample_access_context"})," associates a context to a ",(0,a.jsx)(n.code,{children:"sampleid"}),". This is important because this sample predictions will only be available for users with ",(0,a.jsx)(n.code,{children:"moodle/analytics:listinsights"})," capability in that context."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"/**\n * Returns the context of a sample.\n *\n * @param int $sampleid\n * @return \\context\n */\nabstract public function sample_access_context($sampleid);\n"})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"sample_description"})," is used to display samples in ",(0,a.jsx)(n.em,{children:"Insights"})," report:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"/**\n * Describes a sample with a description summary and a \\renderable (an image for example)\n *\n * @param int $sampleid\n * @param int $contextid\n * @param array $sampledata\n * @return array array(string, \\renderable)\n */\nabstract public function sample_description($sampleid, $contextid, $sampledata);\n"})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"processes_user_data"})," and ",(0,a.jsx)(n.code,{children:"join_sample_user"})," methods are used by the analytics implementation of the privacy API. You only need to overwrite them if your analyser deals with user data. They are used to export and delete user data that is stored in analytics database tables:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"/**\n * Whether the plugin needs user data clearing or not.\n *\n * @return bool\n */\npublic function processes_user_data();\n"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"/**\n * SQL JOIN from a sample to users table.\n *\n * More info in [https://github.com/moodle/moodle/blob/master/analytics/classes/local/analyser/base.php core_analytics\\local\\analyser\\base]::join_sample_user\n *\n * @param string $sampletablealias The alias of the table with a sampleid field that will join with this SQL string\n * @return string\n */\npublic function join_sample_user($sampletablealias);\n"})}),"\n",(0,a.jsxs)(n.p,{children:["You can overwrite a ",(0,a.jsx)(n.code,{children:"new one_sample_per_analysable()"})," method if the analysables your model is using only have one sample. The insights generated by models will then include the suggested actions in the notification."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"/**\n * Just one sample per analysable.\n *\n * @return bool\n */\npublic static function one_sample_per_analysable() {\n    return true;\n}\n"})}),"\n",(0,a.jsx)(n.h4,{id:"indicator-core_analyticslocalindicatorbase",children:"Indicator (core_analytics\\local\\indicator\\base)"}),"\n",(0,a.jsxs)(n.p,{children:["Indicators should generally extend one of these 3 classes, depending on the values they can return: ",(0,a.jsx)(n.em,{children:"core_analytics\\local\\indicator\\binary"})," for ",(0,a.jsx)(n.strong,{children:"yes/no"})," indicators, ",(0,a.jsx)(n.em,{children:"core_analytics\\local\\indicator\\linear"})," for indicators that return linear values and ",(0,a.jsx)(n.em,{children:"core_analytics\\local\\indicator\\discrete"})," for categorised indicators. In case you want your activity module to implement a ",(0,a.jsx)(n.a,{href:"https://docs.moodle.org/en/Students_at_risk_of_dropping_out#Indicators",children:"community of inquiry"})," indicator you can extend ",(0,a.jsx)(n.em,{children:"core_analytics\\local\\indicator\\community_of_inquiry_indicator"})," look for examples in Moodle core."]}),"\n",(0,a.jsxs)(n.p,{children:["You can use ",(0,a.jsx)(n.code,{children:"required_sample_data"})," to specify what your indicator needs to be calculated; you may need a ",(0,a.jsx)(n.em,{children:"user"})," object, a ",(0,a.jsx)(n.em,{children:"course"}),", a ",(0,a.jsx)(n.em,{children:"grade item"}),"... The default implementation does not require anything. Models which analysers do not return the required data will not be able to use your indicator so only list here what you really need. e.g. if you need a grade_grades record mark it as required, but there is no need to require the ",(0,a.jsx)(n.em,{children:"user"})," object and the ",(0,a.jsx)(n.em,{children:"course"})," as well because you can obtain them from the grade_grades item. It is very likely that the analyser will provide them as well because the principle they follow is to include as much related data as possible but do not flag related objects as required because an analyser may, for example, chose to not include the ",(0,a.jsx)(n.em,{children:"user"})," object because it is too big and sites can have memory problems."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:'/**\n * Allows indicators to specify data they need.\n *\n * e.g. A model using courses as samples will not provide users data, but an indicator like\n * "user is hungry" needs user data.\n *\n * @return null|string[] Name of the required elements (use the database tablename)\n */\npublic static function required_sample_data() {\n    return null;\n}\n'})}),"\n",(0,a.jsxs)(n.p,{children:["A single method must be implemented, ",(0,a.jsx)(n.code,{children:"calculate_sample"}),". Most indicators make use of ",(0,a.jsx)(n.code,{children:"$starttime"})," and ",(0,a.jsx)(n.code,{children:"$endtime"})," to restrict the time period they consider for their calculations (for example read actions during ",(0,a.jsx)(n.code,{children:"$starttime - $endtime"})," period) but some indicators may not need to apply any restriction (e.g. does this user have a user picture and profile description?) ",(0,a.jsx)(n.code,{children:"self::MIN_VALUE"})," is ",(0,a.jsx)(n.code,{children:"-1"})," and ",(0,a.jsx)(n.code,{children:"self::MAX_VALUE"})," is ",(0,a.jsx)(n.code,{children:"1"}),". We do not recommend changing these values."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"/**\n * Calculates the sample.\n *\n * Return a value from self::MIN_VALUE to self::MAX_VALUE or null if the indicator can not be calculated for this sample.\n *\n * @param int $sampleid\n * @param string $sampleorigin\n * @param integer $starttime Limit the calculation to this timestart\n * @param integer $endtime Limit the calculation to this timeend\n * @return float|null\n */\nabstract protected function calculate_sample($sampleid, $sampleorigin, $starttime, $endtime);\n"})}),"\n",(0,a.jsxs)(n.admonition,{title:"Performance",type:"danger",children:[(0,a.jsx)(n.p,{children:"Performance here is critical as it runs once for each sample and for each range in the time-splitting method; some tips:"}),(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["To avoid performance issues or repeated db queries analyser classes provide information about the samples that you can use for your calculations to save some database queries. You can retrieve information about a sample with ",(0,a.jsx)(n.code,{children:"$user = $this->retrieve('user', $sampleid)"}),". ",(0,a.jsx)(n.em,{children:"retrieve()"})," will return false if the requested data is not available."]}),"\n",(0,a.jsxs)(n.li,{children:["You can also overwrite ",(0,a.jsx)(n.em,{children:"fill_per_analysable_caches"})," method if necessary (keep in mind though that PHP memory is not unlimited)."]}),"\n",(0,a.jsx)(n.li,{children:"Indicator instances are reset for each analysable and time range that is processed. This helps keeping the memory usage acceptably low and prevents hard-to-trace caching bugs."}),"\n"]})]}),"\n",(0,a.jsx)(n.h4,{id:"target-core_analyticslocaltargetbase",children:"Target (core_analytics\\local\\target\\base)"}),"\n",(0,a.jsxs)(n.p,{children:["Targets must extend ",(0,a.jsx)(n.code,{children:"\\core_analytics\\local\\target\\base"})," or its main child class ",(0,a.jsx)(n.code,{children:"\\core_analytics\\local\\target\\binary"}),". Even if Moodle core includes ",(0,a.jsx)(n.code,{children:"\\core_analytics\\local\\target\\discrete"})," and ",(0,a.jsx)(n.code,{children:"\\core_analytics\\local\\target\\linear"})," Moodle 3.4 machine learning backends only support binary classifications. So unless you are using your own machine learning backend you need to extend ",(0,a.jsx)(n.code,{children:"\\core_analytics\\local\\target\\binary"}),". Technically targets could be reused between models although it is not very recommendable and you should focus instead in having a single model with a single set of indicators that work together towards predicting accurately. The only valid use case I can think of for models in production is using different time-splitting methods for it although, again, the proper way to solve this is by using a single time-splitting method specific for your needs."]}),"\n",(0,a.jsxs)(n.p,{children:["The first thing a target must define is the analyser class that it will use. The analyser class is specified in ",(0,a.jsx)(n.code,{children:"get_analyser_class"}),"."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"/**\n * Returns the analyser class that should be used along with this target.\n *\n * @return string The full class name as a string\n */\nabstract public function get_analyser_class();\n"})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"is_valid_analysable"})," and ",(0,a.jsx)(n.code,{children:"is_valid_sample"})," are used to discard elements that are not valid for your target."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"/**\n * Allows the target to verify that the analysable is a good candidate.\n *\n * This method can be used as a quick way to discard invalid analysables.\n * e.g. Imagine that your analysable don't have students and you need them.\n *\n * @param \\core_analytics\\analysable $analysable\n * @param bool $fortraining\n * @return true|string\n */\npublic function is_valid_analysable(\\core_analytics\\analysable $analysable, $fortraining = true);\n"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"/**\n * Is this sample from the $analysable valid?\n *\n * @param int $sampleid\n * @param \\core_analytics\\analysable $analysable\n * @param bool $fortraining\n * @return bool\n */\npublic function is_valid_sample($sampleid, \\core_analytics\\analysable $analysable, $fortraining = true);\n"})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"calculate_sample"})," is the method that calculates the target value."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"/**\n * Calculates this target for the provided samples.\n *\n * In case there are no values to return or the provided sample is not applicable just return null.\n *\n * @param int $sampleid\n * @param \\core_analytics\\analysable $analysable\n * @param int|false $starttime Limit calculations to start time\n * @param int|false $endtime Limit calculations to end time\n * @return float|null\n */\nprotected function calculate_sample($sampleid, \\core_analytics\\analysable $analysable, $starttime = false, $endtime = false);\n"})}),"\n",(0,a.jsxs)(n.p,{children:["You may wish to add to the list of ",(0,a.jsx)(n.strong,{children:"actions"})," that will be offered to the recipient of an insight:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"/**\n * Suggested actions for a user.\n *\n * @param \\core_analytics\\prediction $prediction\n * @param bool $includedetailsaction\n * @param bool $isinsightuser\n * @return \\core_analytics\\prediction_action[]\n */\npublic function prediction_actions(\\core_analytics\\prediction $prediction, $includedetailsaction = false,\n        $isinsightuser = false)\n"})}),"\n",(0,a.jsxs)(n.p,{children:["You may override the users who will receive ",(0,a.jsx)(n.strong,{children:"insights notifications"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"/**\n * Returns the list of users that will receive insights notifications.\n *\n * Feel free to overwrite if you need to but keep in mind that moodle/analytics:listinsights\n * or moodle/analytics:listowninsights capability is required to access the list of insights.\n *\n * @param \\context $context\n * @return array\n */\npublic function get_insights_users(\\context $context)\n"})}),"\n",(0,a.jsxs)(n.p,{children:["You can implement a ",(0,a.jsx)(n.code,{children:"always_update_analysis_time()"})," method so analysable elements' ",(0,a.jsx)(n.code,{children:"timeanalysed"})," is only updated when analysable elements have been successfully evaluated. It is useful for lightweight targets."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"/**\n * Update the last analysis time on analysable processed or always.\n *\n * If you overwrite this method to return false the last analysis time\n * will only be recorded in DB when the element successfully analysed. You can\n * safely return false for lightweight targets.\n *\n * @return bool\n */\npublic function always_update_analysis_time()\n"})}),"\n",(0,a.jsxs)(n.p,{children:["If you choose to implement ",(0,a.jsx)(n.code,{children:"ignored_predicted_classes"}),", it must be public:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"\n/**\n * Returns the predicted classes that will be ignored.\n *\n * @return array\n */\npublic function ignored_predicted_classes()\n"})}),"\n",(0,a.jsxs)(n.p,{children:["You can override the default message provided in the insight with ",(0,a.jsx)(n.code,{children:"get_insight_subject()"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"/**\n * The insight notification subject.\n *\n * This is just a default message, you should overwrite it for a custom insight message.\n *\n * @param  int $modelid\n * @param  \\context $context\n * @return string\n */\npublic function get_insight_subject(int $modelid, \\context $context)\n"})}),"\n",(0,a.jsx)(n.p,{children:"You can also override the URL to the insight with get_insight_context_url():"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"/**\n * URL to the insight.\n *\n * @param  int $modelid\n * @param  \\context $context\n * @return \\moodle_url\n */\npublic function get_insight_context_url($modelid, $context)\n"})}),"\n",(0,a.jsx)(n.h4,{id:"analysis-interval-core_analyticslocaltime_splittingbase",children:"Analysis interval (core_analytics\\local\\time_splitting\\base)"}),"\n",(0,a.jsxs)(n.p,{children:["Analysis intervals are used to define when the analytics API will train the predictions processor and when it will generate predictions. As explained above in the ",(0,a.jsx)(n.a,{href:"/moodledevdocs/docs/4.4/apis/subsystems/analytics/#analysis-intervals",children:"Analysis intervals"})," documentation, they define time ranges based on analysable elements start and end timestamps."]}),"\n",(0,a.jsxs)(n.p,{children:["The base class is ",(0,a.jsx)(n.code,{children:"\\core_analytics\\local\\time_splitting\\base"}),"; if what you are after is to split the analysable duration in equal parts or in cumulative parts you can extend ",(0,a.jsx)(n.code,{children:"\\core_analytics\\local\\time_splitting\\equal_parts"})," or ",(0,a.jsx)(n.code,{children:"\\core_analytics\\local\\time_splitting\\accumulative_parts"})," instead."]}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"define_ranges"})," is the main method to implement and its values mostly depend on the current analysable element (available in ",(0,a.jsx)(n.code,{children:"$this->analysable"}),"). An array of time ranges should be returned, each of these ranges should contain 3 attributes: A start time ('start') and an end time ('end') that will be passed to indicators so they can limit the amount of activity logs they read; the 3rd attribute is 'time', which value will determine when the range will be executed."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"/**\n * Define the time splitting methods ranges.\n *\n * 'time' value defines when predictions are executed, their values will be compared with\n * the current time in ready_to_predict\n *\n * @return array('start' => time(), 'end' => time(), 'time' => time())\n */\nprotected function define_ranges();\n"})}),"\n",(0,a.jsx)(n.p,{children:"A name and description should also be specified:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"/**\n * Returns a lang_string object representing the name for the time splitting method.\n *\n * Used as column identificator.\n *\n * If there is a corresponding '_help' string this will be shown as well.\n *\n * @return \\lang_string\n */\npublic static function get_name() : \\lang_string;\n"})}),"\n",(0,a.jsx)(r,{version:["3.7.0"]}),"\n",(0,a.jsx)(n.p,{children:"Analysis intervals can now override the following:"}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"valid_for_evaluation()"}),".\nYou can return false if the time-splitting method can not be used to evaluate prediction models or if it does not make sense to evaluate prediction models with it, as for example upcoming_periodic children classes."]}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"include_range_info_in_training_data()"})," and ",(0,a.jsx)(n.code,{children:"get_training_ranges()"}),".\nThey can be used to create time splitting methods with a pre-defined number of ranges."]}),"\n",(0,a.jsxs)(n.p,{children:["The following cannot be overwritten:\n",(0,a.jsx)(n.code,{children:"\\core_analytics\\local\\time_splitting\\base::append_rangeindex"})," and ",(0,a.jsx)(n.code,{children:"\\core_analytics\\local\\time_splitting\\base::infer_sample_info"})," ",(0,a.jsx)(n.code,{children:"\\core_analytics\\local\\analyser\\base::get_most_recent_prediction_range"})," have been moved to ",(0,a.jsx)(n.code,{children:"\\core_analytics\\local\\time_splitting\\base::get_most_recent_prediction_range"})," and it is not overridable by time splitting methods."]}),"\n",(0,a.jsx)(n.h4,{id:"calculable-core_analyticscalculable",children:"Calculable (core_analytics\\calculable)"}),"\n",(0,a.jsxs)(n.p,{children:["Leaving this interface for the end because it is already implemented by ",(0,a.jsx)(n.code,{children:"\\core_analytics\\local\\indicator\\base"})," and ",(0,a.jsx)(n.code,{children:"\\core_analytics\\local\\target\\base"})," but you can still code targets or indicators from the ",(0,a.jsx)(n.code,{children:"\\core_analytics\\calculable"})," base if you need more control."]}),"\n",(0,a.jsx)(n.p,{children:"Both indicators and targets must implement this interface. It defines the data element to be used in calculations, whether as independent (indicator) or dependent (target) variables."}),"\n",(0,a.jsx)(n.h2,{id:"how-to-create-a-model",children:"How to create a model"}),"\n",(0,a.jsxs)(n.p,{children:["New models can be created and implemented in php, and can be packaged as a part of a Moodle plugin for distribution. An example of model components and models are provided at ",(0,a.jsx)(n.a,{href:"https://github.com/dmonllao/moodle-local_testanalytics",children:"https://github.com/dmonllao/moodle-local_testanalytics"}),"."]}),"\n",(0,a.jsx)(n.admonition,{title:"Third-party plugin developers",type:"info",children:(0,a.jsxs)(n.p,{children:["Third party plugin developers can add their new elements (for example ",(0,a.jsx)(n.a,{href:"https://docs.moodle.org/en/Learning_analytics_targets",children:"targets"}),", ",(0,a.jsx)(n.a,{href:"https://docs.moodle.org/en/Learning_analytics_indicators",children:"indicators"}),", and so on) to the documentation pages provided for those components. These documentation pages are linked from the web UI for editing models."]})}),"\n",(0,a.jsx)(n.h3,{id:"define-the-problem",children:"Define the problem"}),"\n",(0,a.jsxs)(n.p,{children:['Start by defining what you want to predict (the target) and the subjects of these predictions (the samples). You can find the descriptions of these concepts above. The API can be used for all kinds of models, though if you want to predict something like "student success," this definition should probably have some basis in pedagogy. For example, the included model ',(0,a.jsx)(n.a,{href:"https://docs.moodle.org/34/en/Students_at_risk_of_dropping_out",children:"Students at risk of dropping out"})," is based on the Community of Inquiry theoretical framework, and attempts to predict that students will complete a course based on indicators designed to represent the three components of the CoI framework (teaching presence, social presence, and cognitive presence). Start by being clear about how the target will be defined. It must be trained using known examples. This means that if, for example, you want to predict the final grade of a course per student, the courses being used to train the model must include accurate final grades."]}),"\n",(0,a.jsx)(n.h3,{id:"how-many-predictions-for-each-sample",children:"How many predictions for each sample?"}),"\n",(0,a.jsx)(n.p,{children:"The next decision should be how many predictions you want to get for each sample (e.g. just one prediction before the course starts or a prediction every week). A single prediction for each sample is simpler than multiple predictions at different points in time in terms of how deep into the API you will need to go to code it."}),"\n",(0,a.jsx)(n.p,{children:"These are not absolute statements, but in general:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["If you want a single prediction for each sample at a specific point in time you can reuse a site-wide analyser or define your own and control samples validity through your target's ",(0,a.jsx)(n.em,{children:"is_valid_sample()"})," method."]}),"\n",(0,a.jsxs)(n.li,{children:["If you want multiple predictions at different points in time for each sample reuse an analysable element or define your own (extending ",(0,a.jsx)(n.code,{children:"\\core_analytics\\analysable"}),") and reuse or define your own analyser to retrieve these analysable elements. You can control analysers validity through your target's ",(0,a.jsx)(n.em,{children:"is_valid_analysable()"})," method."]}),"\n",(0,a.jsx)(n.li,{children:'If you want predictions at activity level use a "by_course" analyser as otherwise you may have scalability problems (imagine storing in memory calculations for each grade_grades record in your site, though processing elements by courses help as we clean memory after each course is processed)'}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"This decision is important because:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["Analysis intervals are applied to analysable time start and time end (e.g. ",(0,a.jsx)(n.strong,{children:"Quarters"})," can split the duration of a course in 4 parts)."]}),"\n",(0,a.jsx)(n.li,{children:"Prediction results are grouped by analysable in the admin interface to list predictions."}),"\n",(0,a.jsxs)(n.li,{children:["By default, insights are notified to users with ",(0,a.jsx)(n.code,{children:"moodle/analytics:listinsights"})," capability at analysable level (though this is only a default behaviour you can overwrite in your target)."]}),"\n"]}),"\n",(0,a.jsxs)(n.admonition,{type:"note",children:[(0,a.jsx)(n.p,{children:"Several of the existing analysis intervals are proportional to the length of the course (for example quarters, tenths, and so on). This allows courses with different lengths to be included in the same sample, but requires courses to have defined start and end dates."}),(0,a.jsx)(n.p,{children:'Other analysis intervals such as "Upcoming 3 days" are also available, which do not depend on the defined length of the course. These would be more appropriate for self-paced courses without fixed start and end dates.'})]}),"\n",(0,a.jsx)(n.p,{children:"You do not need to require a single analysis interval at this stage, and they can be changed whenever the model is trained. You do need to define whether the model will make a single prediction or multiple predictions per analysable."}),"\n",(0,a.jsx)(n.h3,{id:"create-the-target",children:"Create the target"}),"\n",(0,a.jsxs)(n.p,{children:["As specified in the ",(0,a.jsx)(n.a,{href:"/moodledevdocs/docs/4.4/apis/subsystems/analytics/#target-core_analyticslocaltargetbase",children:"Target"})," section."]}),"\n",(0,a.jsx)(n.h3,{id:"create-the-model",children:"Create the model"}),"\n",(0,a.jsx)(n.p,{children:"To add a new model to the system, it must be defined in a PHP file. Plugins and core subsystems declare default prediction models by describing them in their db/analytics.php file. Models should not be created manually via the db/install.php file any more. (It is also possible to execute the necessary commands in a standalone PHP file that references the Moodle config.php.)"}),"\n",(0,a.jsx)(n.p,{children:"To create the model, specify at least its target and, optionally, a set of indicators and a time splitting method:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"// Instantiate the target: classify users as spammers\n$target = \\core_analytics\\manager::get_target('\\mod_yours\\analytics\\target\\spammer_users');\n\n// Instantiate indicators: two different indicators that predict that the user is a spammer\n$indicator1 = \\core_analytics\\manager::get_indicator(\n    '\\mod_yours\\analytics\\indicator\\posts_straight_after_new_account_created'\n);\n$indicator2 = \\core_analytics\\manager::get_indicator(\n    '\\mod_yours\\analytics\\indicator\\posts_contain_important_viagra'\n);\n$indicators = [\n    $indicator1->get_id() => $indicator1,\n    $indicator2->get_id() => $indicator2,\n];\n\n// Create the model.\n// Note that the 3rd and 4rd arguments (the time splitting method and the predictions processor)\n// are optional.\n// The 4th argument is available from Moodle 3.6 onwards.\n$model = \\core_analytics\\model::create(\n    $target,\n    $indicators,\n    '\\core\\analytics\\time_splitting\\single_range',\n    '\\mlbackend_python\\processor'\n);\n"})}),"\n",(0,a.jsx)(n.p,{children:"Models are disabled by default because you may be interested in evaluating how good the model is at predicting before enabling them. You can enable models using Moodle UI or the analytics API:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",children:"$model->enable();\n"})}),"\n",(0,a.jsx)(n.h3,{id:"indicators",children:"Indicators"}),"\n",(0,a.jsx)(n.p,{children:"You already know the analyser your target needs (the analyser is what provides samples) and, more or less, what time splitting method may be better for you. You can now select a list of indicators that you think will lead to accurate predictions. You may need to create your own indicators specific to the target you want to predict."}),"\n",(0,a.jsx)(n.p,{children:"You can use \"'Site administration > Analytics > Analytics models\"' to see the list of available indicators and add some of them to your model."}),"\n",(0,a.jsx)(n.h2,{id:"api-usage-examples",children:"API usage examples"}),"\n",(0,a.jsx)(n.p,{children:"This is a list of prediction models and how they could be coded using the Analytics API:"}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.a,{href:"https://docs.moodle.org/34/en/Students_at_risk_of_dropping_out",children:"Students at risk of dropping out"})," (based on student's activity, included in ",(0,a.jsx)(n.a,{href:"https://docs.moodle.org/34/en/Analytics",children:"Moodle 3.4"}),")"]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Time splitting:"})," quarters, quarters accumulative, deciles, deciles accumulative..."]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Analyser samples:"})," student enrolments (analysable elements are courses)"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"target::is_valid_analysable"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"For prediction = ongoing courses"}),"\n",(0,a.jsx)(n.li,{children:"For training = finished courses with activity"}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"target::is_valid_sample"})," = true"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Based on assumptions (static)"}),": no, predictions should be based on finished courses data"]}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"Not engaging course contents (based on the course contents)"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Time splitting:"})," single range"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Analyser samples:"})," courses (the analysable elements is the site)"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"target::is_valid_analysable"})," = true"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"target::is_valid_sample"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"For prediction = the course is close to the start date"}),"\n",(0,a.jsx)(n.li,{children:"For training = no training"}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Based on assumptions (static)"}),": yes, a simple look at the course activities should be enough (e.g. are the course activities engaging?)"]}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"No teaching (courses close to the start date without a teacher assigned, included in Moodle 3.4)"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Time splitting:"})," single range"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Analyser samples:"})," courses (the analysable elements is the site) it would also work using course as analysable"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"target::is_valid_analysable"})," = true"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"target::is_valid_sample"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"For prediction = course close to the start date"}),"\n",(0,a.jsx)(n.li,{children:"For training = no training"}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Based on assumptions (static)"}),": yes, just check if there are teachers"]}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"Late assignment submissions (based on student's activity)"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Time splitting:"})," close to the analysable end date (1 week before, X days before...)"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Analyser samples:"})," assignment submissions (analysable elements are activities)"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"target::is_valid_analysable"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"For prediction = the assignment is open for submissions"}),"\n",(0,a.jsx)(n.li,{children:"For training = past assignment due date"}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"target::is_valid_sample"})," = true"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Based on assumptions (static)"}),": no, predictions should be based on previous students activity"]}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"Spam users (based on suspicious activity)"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Time splitting:"})," 2 parts, one after 4h since user creation and another one after 2 days (just an example)"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Analyser samples:"})," users (analysable elements are users)"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"target::is_valid_analysable"})," = true"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"target::is_valid_sample"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"For prediction = 4h or 2 days passed since the user was created"}),"\n",(0,a.jsx)(n.li,{children:"For training = 2 days passed since the user was created (spammer flag somewhere recorded to calculate target = 1, otherwise no spammer)"}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Based on assumptions (static)"}),": no, predictions should be based on users activity logs, although this could also be done as a static model"]}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"Students having a bad time"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Time splitting:"})," quarters accumulative or deciles accumulative"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Analyser samples:"})," student enrolments (analysable elements are courses)"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"target::is_valid_analysable"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"For prediction = ongoing and course activity"}),"\n",(0,a.jsx)(n.li,{children:"For training = finished courses"}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"target::is_valid_sample"})," = true"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Based on assumptions (static)"}),": no, ideally it should be based on previous cases"]}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"Course not engaging for students (checking student's activity)"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Time splitting:"})," quarters, quarters accumulative, deciles..."]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Analyser samples:"})," course (analysable elements are courses)"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"target::is_valid_analysable"})," = true"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"target::is_valid_sample"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"For prediction = ongoing course"}),"\n",(0,a.jsx)(n.li,{children:"For training = finished courses"}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Based on assumptions (static)"}),": no, it should be based on activity logs"]}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"Student will fail a quiz (based on things like other students quiz attempts, the student in other activities, number of attempts to pass the quiz...)"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Time splitting:"})," single range"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Analyser samples:"})," student grade on an activity, aka grade_grades id (analysable elements are courses)"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"target::is_valid_analysable"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"For prediction = ongoing course with quizzes"}),"\n",(0,a.jsx)(n.li,{children:"For training = ongoing course with quizzes"}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"target::is_valid_sample"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"For prediction = more than the X% of the course students attempted the quiz and the sample (a student) has not attempted it yet"}),"\n",(0,a.jsx)(n.li,{children:"For training = the student has attempted the quiz at least X times (X because if after X attempts has not passed counts as failed) or the student passed the quiz"}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Based on assumptions (static)"}),": no, it is based on previous students records"]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"clustered-environments",children:"Clustered environments"}),"\n",(0,a.jsxs)(n.p,{children:["The ",(0,a.jsx)(n.code,{children:"analytics/outputdir"})," setting can be configured by Moodle sites with multiple frontend nodes to specify a directory shared across nodes. This directory can be used by machine learning backends to store trained algorithms (for example, its internal variables weights) to use them later to get predictions."]}),"\n",(0,a.jsx)(n.p,{children:"The Moodle cron lock will prevent multiple executions of the analytics tasks that train machine learning algorithms and get predictions from them."})]})}function u(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(h,{...e})}):h(e)}},40486:(e,n,s)=>{s.d(n,{A:()=>a});const a=s.p+"assets/images/Analytics_API_classes_diagram_(summary)-79d7ad9966f55e510015cc027a18608e.svg"},18489:(e,n,s)=>{s.d(n,{A:()=>a});const a=s.p+"assets/images/Inspire_API_components-e456d58a4230fca6d50f7450ceeb6ae2.png"},89335:(e,n,s)=>{s.d(n,{A:()=>a});const a=s.p+"assets/images/Inspire_data_flow-567a94675fdd615f15dac23ad11702a0.png"}}]);
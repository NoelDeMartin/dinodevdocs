"use strict";(self.webpackChunkdevdocs=self.webpackChunkdevdocs||[]).push([[17235],{6047:(e,o,n)=>{n.r(o),n.d(o,{assets:()=>m,contentTitle:()=>c,default:()=>l,frontMatter:()=>s,metadata:()=>r,toc:()=>d});var i=n(74848),t=n(28453),a=n(78924);const s={title:"Communication API",tags:["communication","provider","Communication provider","Communication room","Communication service","Chat"]},c=void 0,r={id:"apis/subsystems/communication/index",title:"Communication API",description:"Communication API provides access to the messaging system and other communication providers (such as Matrix).",source:"@site/versioned_docs/version-4.3/apis/subsystems/communication/index.md",sourceDirName:"apis/subsystems/communication",slug:"/apis/subsystems/communication/",permalink:"/moodledevdocs/docs/4.3/apis/subsystems/communication/",draft:!1,unlisted:!1,editUrl:"https://github.com/moodle/devdocs/edit/main/versioned_docs/version-4.3/apis/subsystems/communication/index.md",tags:[{label:"communication",permalink:"/moodledevdocs/docs/4.3/tags/communication"},{label:"provider",permalink:"/moodledevdocs/docs/4.3/tags/provider"},{label:"Communication provider",permalink:"/moodledevdocs/docs/4.3/tags/communication-provider"},{label:"Communication room",permalink:"/moodledevdocs/docs/4.3/tags/communication-room"},{label:"Communication service",permalink:"/moodledevdocs/docs/4.3/tags/communication-service"},{label:"Chat",permalink:"/moodledevdocs/docs/4.3/tags/chat"}],version:"4.3",lastUpdatedBy:"Safat",lastUpdatedAt:1708220496e3,frontMatter:{title:"Communication API",tags:["communication","provider","Communication provider","Communication room","Communication service","Chat"]},sidebar:"docs",previous:{title:"Check API",permalink:"/moodledevdocs/docs/4.3/apis/subsystems/check/"},next:{title:"Editor API",permalink:"/moodledevdocs/docs/4.3/apis/subsystems/editor/"}},m={},d=[{value:"Important features of the API",id:"important-features-of-the-api",level:2},{value:"Loading a communication instance",id:"loading-a-communication-instance",level:3},{value:"Create and configure a room",id:"create-and-configure-a-room",level:3},{value:"Update a room and its associated information",id:"update-a-room-and-its-associated-information",level:3},{value:"Delete a room",id:"delete-a-room",level:3},{value:"Add members to a room",id:"add-members-to-a-room",level:3},{value:"Update the membership of a room",id:"update-the-membership-of-a-room",level:3},{value:"Remove members from a room",id:"remove-members-from-a-room",level:3},{value:"Show the communication room creation status notification",id:"show-the-communication-room-creation-status-notification",level:3},{value:"Communication instance setup using form/configuration page",id:"communication-instance-setup-using-formconfiguration-page",level:3},{value:"Building a communication plugin",id:"building-a-communication-plugin",level:2}];function h(e){const o={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(a.A,{frontMatter:s,metadata:r}),"\n",(0,i.jsx)(o.p,{children:"Communication API provides access to the messaging system and other communication providers (such as Matrix).\nThis API the management of room and members to that room."}),"\n",(0,i.jsxs)(o.p,{children:["Communication API actions its tasks happens asynchronously using ad-hoc tasks. This means that the API functions will return immediately and the action will be\nexecuted in the background. Communication API has multiple interfaces which acts like a feature of the API. Each of these interface/features have one or more associated\nad-hoc tasks. These tasks are responsible to action the requested feature from the provider plugin (such as Matrix) informed by the Communication API instance. For developers\nto interact with the API, they must use the public API (",(0,i.jsx)(o.code,{children:"communication\\api"}),")."]}),"\n",(0,i.jsx)(o.p,{children:"Communication API allows to add ad-hoc tasks to the queue to perform actions on the communication providers. This API will not allow any immediate actions to be performed on the\ncommunication providers. It will only add the tasks to the queue. The exception has been made for deletion of members in case of deleting the user. This is because the user will\nnot be available for any checks (capability, role etc.) after deleted."}),"\n",(0,i.jsxs)(o.admonition,{type:"info",children:[(0,i.jsx)(o.p,{children:"This is an experimental feature. To use this feature, you must enable the experimental feature flag for Communication in the site administration.\nPlease follow the steps to enable the feature."}),(0,i.jsxs)(o.ol,{children:["\n",(0,i.jsxs)(o.li,{children:["Navigate to ",(0,i.jsx)(o.code,{children:"Site administration > Development > Experimental"})," settings."]}),"\n",(0,i.jsxs)(o.li,{children:["Tick the checkbox to enable the following feature: Enable communication providers (",(0,i.jsx)(o.code,{children:"enablecommunicationsubsystem"}),")."]}),"\n"]})]}),"\n",(0,i.jsx)(o.h2,{id:"important-features-of-the-api",children:"Important features of the API"}),"\n",(0,i.jsx)(o.p,{children:"The below are the important methods/features of the API. These methods/features are the ones which can be used to interact with the communication API."}),"\n",(0,i.jsx)(o.h3,{id:"loading-a-communication-instance",children:"Loading a communication instance"}),"\n",(0,i.jsxs)(o.p,{children:["To load a communication instance, you must use the ",(0,i.jsx)(o.code,{children:"communication\\api::load_by_instance()"})," method. This method will return a communication instance which can be\nused to interact with the communication API and its related methods. The below example shows how to load a communication instance for a course, where the\ncontext is the actual course context object, component is the component name (",(0,i.jsx)(o.code,{children:"core_course"}),"), instance type is the custom string which can change according to\nthe usage and instance id is the course id. The constructor of the public api is private and hence the only way to load an instance is through\nthe ",(0,i.jsx)(o.code,{children:"load_by_instance()"})," method. The provider is the name of the provider plugin which is used to load the instance. It's optional, if not provided, it will load\nthe enabled provider for that instance."]}),"\n",(0,i.jsx)(o.pre,{children:(0,i.jsx)(o.code,{className:"language-php",children:"$communication = \\core_communication\\api::load_by_instance(\n            context: $context,\n            component: 'core_course',\n            instancetype: 'coursecommunication',\n            instanceid: $courseid,\n            provider: 'communication_matrix',\n        );\n"})}),"\n",(0,i.jsx)(o.h3,{id:"create-and-configure-a-room",children:"Create and configure a room"}),"\n",(0,i.jsxs)(o.p,{children:[(0,i.jsx)(o.code,{children:"$communication->create_and_configure_room()"})," method is used to add an ad-hoc to create a room in the communication provider and configure it with the required settings."]}),"\n",(0,i.jsx)(o.pre,{children:(0,i.jsx)(o.code,{className:"language-php",children:"public function create_and_configure_room(\n        string $communicationroomname,\n        ?\\stored_file $avatar = null,\n        ?\\stdClass $instance = null,\n    )\n"})}),"\n",(0,i.jsx)(o.p,{children:"This method takes the following parameters:"}),"\n",(0,i.jsxs)(o.ul,{children:["\n",(0,i.jsx)(o.li,{children:"The name of the room as a string to be created."}),"\n",(0,i.jsx)(o.li,{children:"The avatar of the room to be created, this is a stored file object."}),"\n",(0,i.jsx)(o.li,{children:"The instance object of the communication API."}),"\n"]}),"\n",(0,i.jsxs)(o.p,{children:["For example, we want to create a room for a course with the course name as the room name and the course image as the avatar, we can use the below code.\nThere can be other cases where information from course instance will be used by a plugin, for example, the dynamic field from matrix plugin has a form\nfield named topic which sets the topic of the room, the instance object can be used to get the topic from the course instance and set it in the form field.\nPlease refer to ",(0,i.jsx)(o.a,{href:"/moodledevdocs/docs/4.3/apis/plugintypes/communication/",children:"Communication plugin"})," documentation for more details."]}),"\n",(0,i.jsx)(o.pre,{children:(0,i.jsx)(o.code,{className:"language-php",children:"// First initialize the communication instance, provided the context is already initialized and the selected provider is available\n// though a form or other means.\n$communication = \\core_communication\\api::load_by_instance(\n            context: $context,\n            component: 'core_course',\n            instancetype: 'coursecommunication',\n            instanceid: $course->id,\n            provider: 'communication_matrix',\n        );\n\n// Now call the create_and_configure_room() method to add an ad-hoc to create a room in the communication provider and configure it\n// with the required settings.\n$communication->create_and_configure_room(\n                communicationroomname: $course->fullname,\n                avatar: $courseimage ?: null,\n                instance: $course,\n            );\n"})}),"\n",(0,i.jsx)(o.h3,{id:"update-a-room-and-its-associated-information",children:"Update a room and its associated information"}),"\n",(0,i.jsxs)(o.p,{children:[(0,i.jsx)(o.code,{children:"$communication->update_room()"})," method is used to add an ad-hoc to update a room in the communication provider and configure it with the required settings."]}),"\n",(0,i.jsx)(o.pre,{children:(0,i.jsx)(o.code,{className:"language-php",children:"public function update_room(\n        ?int $active = null,\n        ?string $communicationroomname = null,\n        ?\\stored_file $avatar = null,\n        ?\\stdClass $instance = null,\n    )\n"})}),"\n",(0,i.jsx)(o.p,{children:"This method takes the following parameters:"}),"\n",(0,i.jsxs)(o.ul,{children:["\n",(0,i.jsx)(o.li,{children:"The active status of the room to be updated. Can be either 0 or 1."}),"\n",(0,i.jsx)(o.li,{children:"The name of the room as a string to be updated."}),"\n",(0,i.jsx)(o.li,{children:"The avatar of the room to be updated, this is a stored file object."}),"\n",(0,i.jsx)(o.li,{children:"The instance object of the communication API."}),"\n"]}),"\n",(0,i.jsx)(o.pre,{children:(0,i.jsx)(o.code,{className:"language-php",children:"// First initialize the instance.\n$communication = \\core_communication\\api::load_by_instance(\n            context: $context,\n            component: 'core_course',\n            instancetype: 'coursecommunication',\n            instanceid: $course->id,\n            provider: 'communication_matrix',\n        );\n\n// Now update the room with the required settings. The instance will be used by dynamic fields feature of the plugin to allow the plugin\n// to get the required information from the instance.\n$communication->update_room(\n                active: $active,\n                communicationroomname: $communicationroomname,\n                avatar: $courseimage ?: null,\n                instance: $course,\n            );\n"})}),"\n",(0,i.jsx)(o.h3,{id:"delete-a-room",children:"Delete a room"}),"\n",(0,i.jsxs)(o.p,{children:[(0,i.jsx)(o.code,{children:"$communication->delete_room()"})," method is used to add an ad-hoc to delete a room in the communication provider. The associated task for this also removes all the members from\nthe room before deleting the room."]}),"\n",(0,i.jsx)(o.admonition,{type:"danger",children:(0,i.jsx)(o.p,{children:"This is destructive and might remove all the messages and other data associated with the room. Usage of this should be done with caution."})}),"\n",(0,i.jsx)(o.h3,{id:"add-members-to-a-room",children:"Add members to a room"}),"\n",(0,i.jsxs)(o.p,{children:[(0,i.jsx)(o.code,{children:"$communication->add_members_to_room()"})," method is used to add an ad-hoc to add members to a room in the communication provider. The user id of each user to be added to\nthe provider room is also stored in the communication_user table for user mapping with the provider."]}),"\n",(0,i.jsx)(o.pre,{children:(0,i.jsx)(o.code,{className:"language-php",children:"public function add_members_to_room(\n        array $userids,\n        bool $queue = true,\n    )\n"})}),"\n",(0,i.jsx)(o.p,{children:"This method accepts the following parameters:"}),"\n",(0,i.jsxs)(o.ul,{children:["\n",(0,i.jsx)(o.li,{children:"An array of user ids to be added to the provider room."}),"\n",(0,i.jsx)(o.li,{children:"A boolean value to indicate if the task should be added to the queue or run immediately. This is false by default. This is added to ensure the cases where the mapping should be created but the task might not be needed at this point."}),"\n"]}),"\n",(0,i.jsx)(o.pre,{children:(0,i.jsx)(o.code,{className:"language-php",children:"// First initialize the instance, provider is not required here, it will initialize the enabled instance.\n$communication = \\core_communication\\api::load_by_instance(\n            context: $context,\n            component: 'core_course',\n            instancetype: 'coursecommunication',\n            instanceid: $course->id,\n        );\n\n// Now add the members.\n$communication->add_members_to_room(\n                userids: $enrolledusers,\n            );\n"})}),"\n",(0,i.jsx)(o.h3,{id:"update-the-membership-of-a-room",children:"Update the membership of a room"}),"\n",(0,i.jsxs)(o.p,{children:[(0,i.jsx)(o.code,{children:"$communication->update_room_membership()"})," method is used to add an ad-hoc to update the membership of a room in the communication provider.\nThe user mapping for each of the users are also reset to allow task to update the users from the task."]}),"\n",(0,i.jsx)(o.pre,{children:(0,i.jsx)(o.code,{className:"language-php",children:"public function update_room_membership(\n        array $userids,\n        bool $queue = true,\n    )\n"})}),"\n",(0,i.jsxs)(o.p,{children:["This method accepts the same parameters as the ",(0,i.jsx)(o.code,{children:"add_members_to_room()"})," method and the usage is also the same."]}),"\n",(0,i.jsx)(o.h3,{id:"remove-members-from-a-room",children:"Remove members from a room"}),"\n",(0,i.jsxs)(o.p,{children:[(0,i.jsx)(o.code,{children:"$communication->remove_members_from_room()"})," method is used to add an ad-hoc to remove members from a room in the communication provider.\nThe users are flagged as deleted in the communication_user table to allow the task to remove the users from the provider room."]}),"\n",(0,i.jsx)(o.pre,{children:(0,i.jsx)(o.code,{className:"language-php",children:"public function remove_members_from_room(\n        array $userids,\n        bool $queue = true\n    )\n"})}),"\n",(0,i.jsxs)(o.p,{children:["This method accepts the same parameters as the ",(0,i.jsx)(o.code,{children:"add_members_to_room()"})," method and the usage is also the same."]}),"\n",(0,i.jsx)(o.h3,{id:"show-the-communication-room-creation-status-notification",children:"Show the communication room creation status notification"}),"\n",(0,i.jsxs)(o.p,{children:[(0,i.jsx)(o.code,{children:"$communication->show_communication_room_status_notification()"})," is a special method to have a UI element to show the status of the room creation. If the room is ready, it will\nreturn the notification as a string. If the room is not ready, it will return pending status. Course have this implemented and shows the status after the communication instance\nis configured. Please note, the status notification relies on the creation of room, not the memberships of the room."]}),"\n",(0,i.jsx)(o.h3,{id:"communication-instance-setup-using-formconfiguration-page",children:"Communication instance setup using form/configuration page"}),"\n",(0,i.jsxs)(o.p,{children:["The communication API allows to have settings to configure the basic information like room name, selection of provider etc. ",(0,i.jsx)(o.code,{children:"$communication->form_definition()"})," method\nis used to get the form definition for the settings form. If the form elements are used in another form to include the communication form elements, ",(0,i.jsx)(o.code,{children:"form_definition()"})," method\nwill be useful. There is a configuration page (",(0,i.jsx)(o.code,{children:"communication/configure.php"}),") which can be used to configure the communication instance. Course currently uses this page to set up\ncommunication and its associated information.\nIt will also be required to use ",(0,i.jsx)(o.code,{children:"set_data()"})," method in order to set the data to the form elements while saving the data."]}),"\n",(0,i.jsx)(o.pre,{children:(0,i.jsx)(o.code,{className:"language-php",children:"public function form_definition(\n        \\MoodleQuickForm $mform,\n        string $selectdefaultcommunication = processor::PROVIDER_NONE,\n    )\n"})}),"\n",(0,i.jsx)(o.p,{children:"This method accepts the following parameters:"}),"\n",(0,i.jsxs)(o.ul,{children:["\n",(0,i.jsx)(o.li,{children:"The moodle quick form object to add the form elements to."}),"\n",(0,i.jsx)(o.li,{children:"The default provider to be selected in the form. This is set to none by default."}),"\n"]}),"\n",(0,i.jsx)(o.p,{children:"For example, we have a form where we want to have the communication settings, we can use the below code to add the form elements to the form."}),"\n",(0,i.jsx)(o.pre,{children:(0,i.jsx)(o.code,{className:"language-php",children:"class configure_form extends \\moodleform {\n    public function definition() {\n        $mform = $this->_form;\n        $communication = \\core_communication\\api::load_by_instance(\n            context: $context,\n            component: 'core_course',\n            instancetype: 'coursecommunication',\n            instanceid: $course->id,\n        );\n        $communication->form_definition(mform: $mform);\n        $this->communication->set_data(instance: $course);\n    }\n}\n"})}),"\n",(0,i.jsx)(o.h2,{id:"building-a-communication-plugin",children:"Building a communication plugin"}),"\n",(0,i.jsx)(o.p,{children:"Communication API also provides a bunch of interfaces for a communication plugin to consume. Every plugin should implement these interfaces according to the features they\nsupport."}),"\n",(0,i.jsx)(o.admonition,{type:"info",children:(0,i.jsxs)(o.p,{children:["Please refer to ",(0,i.jsx)(o.a,{href:"/moodledevdocs/docs/4.3/apis/plugintypes/communication/",children:"Communication plugin"})," documentation for more details about building a plugin."]})})]})}function l(e={}){const{wrapper:o}={...(0,t.R)(),...e.components};return o?(0,i.jsx)(o,{...e,children:(0,i.jsx)(h,{...e})}):h(e)}}}]);
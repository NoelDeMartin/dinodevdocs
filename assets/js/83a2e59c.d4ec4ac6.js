"use strict";(self.webpackChunkdevdocs=self.webpackChunkdevdocs||[]).push([[68099],{35138:(e,t,s)=>{s.r(t),s.d(t,{assets:()=>d,contentTitle:()=>o,default:()=>p,frontMatter:()=>r,metadata:()=>a,toc:()=>c});var n=s(74848),i=s(28453),l=s(78924);const r={title:"Report builder API",tags:["Report builder","reports"]},o=void 0,a={id:"apis/core/reportbuilder/index",title:"Report builder API",description:"System Reports",source:"@site/docs/apis/core/reportbuilder/index.md",sourceDirName:"apis/core/reportbuilder",slug:"/apis/core/reportbuilder/",permalink:"/moodledevdocs/docs/4.4/apis/core/reportbuilder/",draft:!1,unlisted:!1,editUrl:"https://github.com/moodle/devdocs/edit/main/docs/apis/core/reportbuilder/index.md",tags:[{label:"Report builder",permalink:"/moodledevdocs/docs/4.4/tags/report-builder"},{label:"reports",permalink:"/moodledevdocs/docs/4.4/tags/reports"}],version:"current",lastUpdatedBy:"Andrew Nicols",lastUpdatedAt:1686127286e3,frontMatter:{title:"Report builder API",tags:["Report builder","reports"]},sidebar:"docs",previous:{title:"Preference API",permalink:"/moodledevdocs/docs/4.4/apis/core/preference/"},next:{title:"User-related APIs",permalink:"/moodledevdocs/docs/4.4/apis/core/user/"}},d={},c=[{value:"System Reports",id:"system-reports",level:2},{value:"Introduction",id:"introduction",level:3},{value:"Column",id:"column",level:3},{value:"Column overview",id:"column-overview",level:4},{value:"Column types",id:"column-types",level:4},{value:"Creating columns",id:"creating-columns",level:4},{value:"Filter",id:"filter",level:3},{value:"Filter overview",id:"filter-overview",level:4},{value:"Filter types",id:"filter-types",level:4},{value:"Creating filters",id:"creating-filters",level:4},{value:"Entity",id:"entity",level:3},{value:"Entity overview",id:"entity-overview",level:4},{value:"Create an entity",id:"create-an-entity",level:4},{value:"get_default_table_aliases()",id:"get_default_table_aliases",level:5},{value:"get_default_entity_title()",id:"get_default_entity_title",level:5},{value:"initialise()",id:"initialise",level:5},{value:"Examples",id:"examples",level:4},{value:"Actions",id:"actions",level:3},{value:"System reports",id:"system-reports-1",level:3},{value:"Create a new system report using entities",id:"create-a-new-system-report-using-entities",level:4},{value:"Use an entity",id:"use-an-entity",level:4},{value:"Override display name for a column",id:"override-display-name-for-a-column",level:4},{value:"Set a default initial sort direction",id:"set-a-default-initial-sort-direction",level:4},{value:"Examples",id:"examples-1",level:4}];function h(e){const t={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",h5:"h5",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(l.A,{frontMatter:r,metadata:a}),"\n",(0,n.jsx)(t.h2,{id:"system-reports",children:"System Reports"}),"\n",(0,n.jsx)(t.h3,{id:"introduction",children:"Introduction"}),"\n",(0,n.jsx)(t.p,{children:"System reports are a consistent way of providing reporting data, with paging, filtering, exporting standardized across them. Once the groundwork is done in defining the report elements in entities, it's possible to implement them with minimal code just by adding entities to the report, and defining which elements you want to use from them."}),"\n",(0,n.jsx)(t.h3,{id:"column",children:"Column"}),"\n",(0,n.jsx)(t.h4,{id:"column-overview",children:"Column overview"}),"\n",(0,n.jsx)(t.p,{children:"Column instances define the data captured/displayed within a report column typically:"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:"How the data is retrieved, either a simple SQL table.field fragment or an expression that returns a value"}),"\n",(0,n.jsx)(t.li,{children:"They type of data that is being retrieved (int, text, datetime, etc)"}),"\n",(0,n.jsx)(t.li,{children:"How that data should be presented in a report (for instance calling userdate() on datetime types)"}),"\n"]}),"\n",(0,n.jsx)(t.h4,{id:"column-types",children:"Column types"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.code,{children:"Text"})}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"Integer"})," (Integer numbers)"]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"Float"})," (Decimal numbers)"]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"Timestamp"})," (Dates)"]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"Boolean"})," (Yes / No values)"]}),"\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.code,{children:"Longtext"})}),"\n"]}),"\n",(0,n.jsx)(t.h4,{id:"creating-columns",children:"Creating columns"}),"\n",(0,n.jsxs)(t.p,{children:["To create a new column, just create a new instance of ",(0,n.jsx)(t.a,{href:"https://github.com/moodle/moodle/blob/master/reportbuilder/classes/local/report/column.php",children:(0,n.jsx)(t.code,{children:"reportbuilder/classes/local/report/column.php"})})," class with:"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-php",children:"* string $name\n* ?lang_string $title\n* string $entityname\n"})}),"\n",(0,n.jsx)(t.p,{children:"And use:"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.strong,{children:"add_joins()"})," to add any extra SQL joins the column might need"]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.strong,{children:"set_type()"})," to add the column type (All constant types are defined within the same column class)"]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.strong,{children:"set_is_sortable()"})," to define if column can be sorted (For example we don't want to sort if the column shows just a picture)"]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.strong,{children:"add_callback()"})," to format the output of the column"]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.strong,{children:"add_field()"})," to add any db fields format callback might need"]}),"\n"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-php",metastring:'title="Example of code for creating a column"',children:"$columns[] = (new column(\n            'starttime',\n            new lang_string('task_starttime', 'admin'),\n            $this->get_entity_name()\n        ))\n            ->add_joins($this->get_joins())\n            ->set_type(column::TYPE_TIMESTAMP)\n            ->add_field(\"{$tablealias}.timestart\")\n            ->set_is_sortable(true)\n            ->add_callback([format::class, 'userdate']);\n"})}),"\n",(0,n.jsx)(t.h3,{id:"filter",children:"Filter"}),"\n",(0,n.jsx)(t.h4,{id:"filter-overview",children:"Filter overview"}),"\n",(0,n.jsx)(t.p,{children:"Report filters can be defined for a report and allow users to narrow down (filter) the data that is displayed in a report:"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:"They define the data being filtered, either a simple SQL fragment or expression."}),"\n",(0,n.jsx)(t.li,{children:"The type of filtering being performed (int, text, datetime, etc).\nFilter types are extendable, allowing for the addition of many more as suit each use case.\nWe have provided common ones that cover most use cases."}),"\n"]}),"\n",(0,n.jsx)(t.admonition,{type:"note",children:(0,n.jsx)(t.p,{children:"Filters & columns are entirely separate concepts in the report, and each can be used without a matching column/filter (that is to say, we can add a report filter for a user field without needing the column for the same field to be present in the report)."})}),"\n",(0,n.jsx)(t.h4,{id:"filter-types",children:"Filter types"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.strong,{children:"Text"})," (",(0,n.jsx)(t.a,{href:"https://github.com/moodle/moodle/blob/master/reportbuilder/classes/local/filters/text.php",children:"reportbuilder/classes/local/filters/text.php"}),")"]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.strong,{children:"Date"})," (",(0,n.jsx)(t.a,{href:"https://github.com/moodle/moodle/blob/master/reportbuilder/classes/local/filters/date.php",children:"reportbuilder/classes/local/filters/date.php"}),")"]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.strong,{children:"Number"})," (",(0,n.jsx)(t.a,{href:"https://github.com/moodle/moodle/blob/master/reportbuilder/classes/local/filters/number.php",children:"reportbuilder/classes/local/filters/number.php"}),")"]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.strong,{children:"Boolean Select"})," (",(0,n.jsx)(t.a,{href:"https://github.com/moodle/moodle/blob/master/reportbuilder/classes/local/filters/boolean_select.php",children:"reportbuilder/classes/local/filters/boolean_select.php"}),")"]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.strong,{children:"Select"})," (",(0,n.jsx)(t.a,{href:"https://github.com/moodle/moodle/blob/master/reportbuilder/classes/local/filters/select.php",children:"reportbuilder/classes/local/filters/select.php"}),")"]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.strong,{children:"Course selector"})," (",(0,n.jsx)(t.a,{href:"https://github.com/moodle/moodle/blob/master/reportbuilder/classes/local/filters/course_selector.php",children:"reportbuilder/classes/local/filters/course_selector.php"}),")"]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.strong,{children:"Duration"})," (",(0,n.jsx)(t.a,{href:"https://github.com/moodle/moodle/blob/master/reportbuilder/classes/local/filters/duration.php",children:"reportbuilder/classes/local/filters/duration.php"}),")"]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.strong,{children:"Tags"})," (",(0,n.jsx)(t.a,{href:"https://github.com/moodle/moodle/blob/master/reportbuilder/classes/local/filters/tags.php",children:"reportbuilder/classes/local/filters/tags.php"}),")"]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.strong,{children:"Autocomplete"})," (",(0,n.jsx)(t.a,{href:"https://github.com/moodle/moodle/blob/master/reportbuilder/classes/local/filters/autocomplete.php",children:"reportbuilder/classes/local/filters/autocomplete.php"}),")"]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.strong,{children:"Category"})," (",(0,n.jsx)(t.a,{href:"https://github.com/moodle/moodle/blob/master/reportbuilder/classes/local/filters/category.php",children:"reportbuilder/classes/local/filters/category.php"}),")"]}),"\n"]}),"\n",(0,n.jsx)(t.h4,{id:"creating-filters",children:"Creating filters"}),"\n",(0,n.jsxs)(t.p,{children:["To create a new filter, just create a new instance of ",(0,n.jsx)(t.strong,{children:(0,n.jsx)(t.a,{href:"https://github.com/moodle/moodle/blob/master/reportbuilder/classes/local/report/filter.php",children:"reportbuilder/classes/local/report/filter.php"})})," class with:"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-php",children:"* string $filterclass\n* string $name\n* lang_string $header\n* string $entityname\n* string $fieldsql = ''\n* array $fieldparams = []\n"})}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-php",metastring:'title="Example of code for creating a filter"',children:"$filters[] = (new filter(\n            course_selector::class,\n            'courseselector',\n            new lang_string('courses'),\n            $this->get_entity_name(),\n            \"{$tablealias}.id\"\n        ))\n            ->add_joins($this->get_joins());\n"})}),"\n",(0,n.jsx)(t.h3,{id:"entity",children:"Entity"}),"\n",(0,n.jsx)(t.h4,{id:"entity-overview",children:"Entity overview"}),"\n",(0,n.jsx)(t.p,{children:"Entities are simply collections of report elements (currently columns and filters). They allow for common elements to be defined once, and then re-used in all reports - developers can choose to use as many or as few of the elements from each entity as required. We have provided user and course entities. They can be joined to reports using standard SQL query syntax."}),"\n",(0,n.jsx)(t.p,{children:"All report elements can be defined within the reports themselves - but entities mean it's much easier to create re-usable components, and will also help in the long term with custom reports."}),"\n",(0,n.jsx)(t.h4,{id:"create-an-entity",children:"Create an entity"}),"\n",(0,n.jsxs)(t.p,{children:["To create an entity, the new entity class must extend ",(0,n.jsx)(t.strong,{children:(0,n.jsx)(t.a,{href:"https://github.com/moodle/moodle/blob/master/reportbuilder/classes/local/entities/base.php",children:"reportbuilder/classes/local/entities/base.php"})})," class and must include these methods:"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-php",children:"get_default_table_aliases()\nget_default_entity_title()\ninitialise()\n"})}),"\n",(0,n.jsx)(t.h5,{id:"get_default_table_aliases",children:"get_default_table_aliases()"}),"\n",(0,n.jsx)(t.p,{children:"Defines the SQL alias for the database tables the entity uses."}),"\n",(0,n.jsx)(t.h5,{id:"get_default_entity_title",children:"get_default_entity_title()"}),"\n",(0,n.jsx)(t.p,{children:"Defines the default title for this entity."}),"\n",(0,n.jsx)(t.h5,{id:"initialise",children:"initialise()"}),"\n",(0,n.jsxs)(t.p,{children:["This is where we ",(0,n.jsx)(t.strong,{children:"add"})," the entity columns and filters."]}),"\n",(0,n.jsx)(t.h4,{id:"examples",children:"Examples"}),"\n",(0,n.jsx)(t.p,{children:"Check out these two entities as an example to start building reports:"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.strong,{children:"User entity"}),": ",(0,n.jsx)(t.a,{href:"https://github.com/moodle/moodle/blob/master/reportbuilder/classes/local/entities/user.php",children:"reportbuilder/classes/local/entities/user.php"})]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.strong,{children:"Course entity"}),": ",(0,n.jsx)(t.a,{href:"https://github.com/moodle/moodle/blob/master/reportbuilder/classes/local/entities/course.php",children:"reportbuilder/classes/local/entities/course.php"})]}),"\n"]}),"\n",(0,n.jsx)(t.h3,{id:"actions",children:"Actions"}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.img,{alt:"Example of actions on the tasks logs system report",src:s(6460).A+"",width:"361",height:"401"})}),"\n",(0,n.jsxs)(t.p,{children:["Report actions can be defined in system reports to provide CTA links for each row in the report. Using ",(0,n.jsx)(t.code,{children:":placeholder"})," elements in the action URLs allows them to be specific to the row content. For example, to always provide a link to the current user/course of the current row"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-php",children:"  $this->add_action((new action(\n      new moodle_url('/admin/tasklogs.php', ['logid' => ':id']),\n      new pix_icon('e/search', ''),\n      [],\n      true,\n      new lang_string('viewtasklog', 'report_tasklogs')\n  )));\n"})}),"\n",(0,n.jsx)(t.h3,{id:"system-reports-1",children:"System reports"}),"\n",(0,n.jsx)(t.p,{children:"System reports are a consistent way of providing reporting data, with paging, filtering, exporting standardized across them. Once the groundwork is done in defining the report elements in entities, it's possible to implement them with minimal code just by adding entities to the report, and defining which elements you want to use from them"}),"\n",(0,n.jsx)(t.h4,{id:"create-a-new-system-report-using-entities",children:"Create a new system report using entities"}),"\n",(0,n.jsxs)(t.p,{children:["To create a new system report just create a new class extending ",(0,n.jsx)(t.a,{href:"https://github.com/moodle/moodle/blob/master/reportbuilder/classes/system_report.php",children:"reportbuilder/classes/system_report.php"}),"."]}),"\n",(0,n.jsxs)(t.p,{children:["The first method that we need is ",(0,n.jsx)(t.em,{children:(0,n.jsx)(t.strong,{children:"initialise()"})})," :"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-php",children:"/**\n* Initialise report, we need to set the main table, load our entities and set columns/filters\n*/\nprotected function initialise(): void {\n"})}),"\n",(0,n.jsx)(t.p,{children:"The initialise method needs to get the main entity, set the main table it needs to use and add the entity to the report:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-php",children:"// Our main entity, it contains all of the column definitions that we need.\n$entitymain = new task_log();\n$entitymainalias = $entitymain->get_table_alias('task_log');\n\n$this->set_main_table('task_log', $entitymainalias);\n$this->add_entity($entitymain);\n"})}),"\n",(0,n.jsx)(t.p,{children:"After that, if the report will have 'Actions', it needs to define the columns these actions will use:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-php",children:'$this->add_base_fields("{$entitymainalias}.id");\n'})}),"\n",(0,n.jsx)(t.p,{children:"Now, after adding our first entity, the report can use the columns and filters from it OR more entities can be added to the report using SQL joins:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-php",children:"$entityuser = new user();\n$entituseralias = $entityuser->get_table_alias('user');\n$this->add_entity($entityuser->add_join(\n    \"LEFT JOIN {user} {$entituseralias} ON {$entituseralias}.id = {$entitymainalias}.userid\"\n));\n"})}),"\n",(0,n.jsxs)(t.p,{children:["Once all entities have been added it needs to define which columns it needs to show ",(0,n.jsx)(t.strong,{children:"in the order we need"}),":"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-php",children:"$columns = [\n     'task_log:name',\n     'task_log:type',\n     'user:fullname',\n     'task_log:starttime',\n];\n\n$this->add_columns_from_entities($columns);\n"})}),"\n",(0,n.jsx)(t.p,{children:"After defining the columns, it needs to define all the filters (or empty array for no filters) that it will use:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-php",children:"$filters = [\n    'task_log:name',\n    'task_log:result',\n    'task_log:timestart',\n];\n\n$this->add_filters_from_entities($filters);\n"})}),"\n",(0,n.jsx)(t.p,{children:"In case it needs actions for each report row, they can be defined like:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-php",children:"// Action to download individual task log.\n$this->add_action((new action(\n    new moodle_url('/admin/tasklogs.php', ['logid' => ':id', 'download' => true]),\n    new pix_icon('t/download', ''),\n    [],\n    new lang_string('downloadtasklog', 'report_tasklogs')\n)));\n"})}),"\n",(0,n.jsx)(t.admonition,{type:"info",children:(0,n.jsxs)(t.p,{children:["Note that the placeholders used here (",":id"," in this example) have been previously added using ",(0,n.jsx)(t.strong,{children:"add_base_fields"}),"();"]})}),"\n",(0,n.jsx)(t.p,{children:"Once the whole report has been defined, is possible to set if the report will be downloadable or not:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-php",children:"$this->set_downloadable(true);\n"})}),"\n",(0,n.jsx)(t.h4,{id:"use-an-entity",children:"Use an entity"}),"\n",(0,n.jsx)(t.h4,{id:"override-display-name-for-a-column",children:"Override display name for a column"}),"\n",(0,n.jsx)(t.p,{children:"It's possible to override the display name of a column, if you don't want to use the value provided by the entity."}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-php",children:"if ($column = $this->get_column('user:fullname')) {\n   $column->set_title(new lang_string('user', 'admin'));\n}\n"})}),"\n",(0,n.jsx)(t.h4,{id:"set-a-default-initial-sort-direction",children:"Set a default initial sort direction"}),"\n",(0,n.jsx)(t.p,{children:"It's possible to set a default initial sort direction for one column."}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-php",children:"$this->set_initial_sort_column('task_log:starttime', SORT_DESC);\n"})}),"\n",(0,n.jsx)(t.h4,{id:"examples-1",children:"Examples"}),"\n",(0,n.jsx)(t.p,{children:"Check out these two system reports as an example:"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.strong,{children:"Task logs"}),": ",(0,n.jsx)(t.a,{href:"https://github.com/moodle/moodle/blob/master/admin/classes/reportbuilder/local/systemreports/task_logs.php",children:(0,n.jsx)(t.code,{children:"admin/classes/reportbuilder/local/systemreports/task_logs.php"})})]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.strong,{children:"Config changes"}),": ",(0,n.jsx)(t.a,{href:"https://github.com/moodle/moodle/blob/master/report/configlog/classes/reportbuilder/local/systemreports/config_changes.php",children:(0,n.jsx)(t.code,{children:"report/configlog/classes/reportbuilder/local/systemreports/config_changes.php"})})]}),"\n"]})]})}function p(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(h,{...e})}):h(e)}},6460:(e,t,s)=>{s.d(t,{A:()=>n});const n=s.p+"assets/images/Actions-c0c8d1edca9686c818ebf90ab9fff10c.jpg"}}]);
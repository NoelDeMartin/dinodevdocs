"use strict";(self.webpackChunkdevdocs=self.webpackChunkdevdocs||[]).push([[76123],{19218:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>r,contentTitle:()=>l,default:()=>g,frontMatter:()=>o,metadata:()=>d,toc:()=>h});var s=n(74848),i=n(28453),a=n(78924);const o={title:"Admin settings",tags:[]},l=void 0,d={id:"apis/subsystems/admin/index",title:"Admin settings",description:"Moodle's configuration is stored in a mixture of the config, config_plugins, and a few other tables. These settings are edited through the administration screens, which can be accessed by going to the .../admin/index.php URL on your moodle site, or using the Administration block that appears to administrators of the Moodle front page. This page explains how the code for displaying and editing of these settings works.",source:"@site/versioned_docs/version-4.1/apis/subsystems/admin/index.md",sourceDirName:"apis/subsystems/admin",slug:"/apis/subsystems/admin/",permalink:"/moodledevdocs/docs/4.1/apis/subsystems/admin/",draft:!1,unlisted:!1,editUrl:"https://github.com/moodle/devdocs/edit/main/versioned_docs/version-4.1/apis/subsystems/admin/index.md",tags:[],version:"4.1",lastUpdatedBy:"Andrew Nicols",lastUpdatedAt:1712757252e3,frontMatter:{title:"Admin settings",tags:[]},sidebar:"docs",previous:{title:"Access API",permalink:"/moodledevdocs/docs/4.1/apis/subsystems/access"},next:{title:"Analytics API",permalink:"/moodledevdocs/docs/4.1/apis/subsystems/analytics/"}},r={},h=[{value:"Where to find the code",id:"where-to-find-the-code",level:2},{value:"The building blocks",id:"the-building-blocks",level:2},{value:"How the tree is built",id:"how-the-tree-is-built",level:2},{value:"Settings file example",id:"settings-file-example",level:2},{value:"Individual settings",id:"individual-settings",level:2},{value:"Locked and advanced settings for activity modules",id:"locked-and-advanced-settings-for-activity-modules",level:2},{value:"Callbacks after a setting has been updated",id:"callbacks-after-a-setting-has-been-updated",level:2},{value:"External pages",id:"external-pages",level:2},{value:"When to use an admin_settings vs admin_externalpages",id:"when-to-use-an-admin_settings-vs-admin_externalpages",level:3},{value:"See also",id:"see-also",level:2}];function c(e){const t={a:"a",code:"code",em:"em",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(a.A,{frontMatter:o,metadata:d}),"\n",(0,s.jsxs)(t.p,{children:["Moodle's configuration is stored in a mixture of the config, config_plugins, and a few other tables. These settings are edited through the administration screens, which can be accessed by going to the ",(0,s.jsx)(t.code,{children:".../admin/index.php"})," URL on your moodle site, or using the Administration block that appears to administrators of the Moodle front page. This page explains how the code for displaying and editing of these settings works."]}),"\n",(0,s.jsx)(t.h2,{id:"where-to-find-the-code",children:"Where to find the code"}),"\n",(0,s.jsx)(t.p,{children:"This is explained further below, but in summary:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["The library code is all in ",(0,s.jsx)(t.code,{children:"lib/adminlib.php"}),"."]}),"\n",(0,s.jsx)(t.li,{children:"The definition of all the parts of the admin tree is in admin/settings/* some of which call out to plugins to see if they have settings they want to add."}),"\n",(0,s.jsxs)(t.li,{children:["The editing and saving of settings is managed by ",(0,s.jsx)(t.code,{children:"admin/settings.php"}),", ",(0,s.jsx)(t.code,{children:"admin/upgradesettings.php"}),", and ",(0,s.jsx)(t.code,{children:"admin/search.php"}),"."]}),"\n",(0,s.jsxs)(t.li,{children:["The administration blocks that appear on the front page and on most of the admin screens is in ",(0,s.jsx)(t.code,{children:"blocks/admin_tree"})," and ",(0,s.jsx)(t.code,{children:"blocks/admin_bookmarks"}),"."]}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"For further details refer the code."}),"\n",(0,s.jsx)(t.h2,{id:"the-building-blocks",children:"The building blocks"}),"\n",(0,s.jsx)(t.p,{children:"All the settings are arranged into a tree structure. This tree structure is represented in memory as a tree of PHP objects."}),"\n",(0,s.jsxs)(t.p,{children:["At the root of the tree is an ",(0,s.jsx)(t.strong,{children:"admin_root"})," object."]}),"\n",(0,s.jsxs)(t.p,{children:["That has children that are ",(0,s.jsx)(t.strong,{children:"admin_category"}),"s."]}),"\n",(0,s.jsxs)(t.p,{children:["Admin categories contain other categories, ",(0,s.jsx)(t.strong,{children:"admin_settingpage"}),"s, and ",(0,s.jsx)(t.strong,{children:"admin_externalpage"}),"s."]}),"\n",(0,s.jsxs)(t.p,{children:["Settings pages contain individual ",(0,s.jsx)(t.strong,{children:"admin_setting"}),"s."]}),"\n",(0,s.jsxs)(t.p,{children:["admin_setting is a base class with lots of subclasses like ",(0,s.jsx)(t.strong,{children:"admin_setting_configtext"}),", ",(0,s.jsx)(t.strong,{children:"admin_setting_configcheckbox"}),", and so on. If you need to, you can create new subclasses."]}),"\n",(0,s.jsx)(t.p,{children:"External pages are for things that do not fit into the normal settings structure. For example the global assign roles page, or the page for managing activity modules."}),"\n",(0,s.jsx)(t.h2,{id:"how-the-tree-is-built",children:"How the tree is built"}),"\n",(0,s.jsxs)(t.p,{children:["When Moodle needs the admin tree, it calls admin_get_root in ",(0,s.jsx)(t.code,{children:"lib/adminlib.php"}),", which"]}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsx)(t.li,{children:"Creates a global $ADMIN object which is an instance of admin_root."}),"\n",(0,s.jsxs)(t.li,{children:["Does ",(0,s.jsx)(t.code,{children:"require_once admin/settings/top.php"}),", which adds the top level categories to $ADMIN."]}),"\n",(0,s.jsxs)(t.li,{children:["Does ",(0,s.jsx)(t.code,{children:"require_once"})," on all the other files in ",(0,s.jsx)(t.code,{children:"admin/settings"})," to add more specific settings pages and the settings themselves. Some of these settings files additionally make calls out to various types of plugins. For example:","\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"admin/settings/plugins.php"})," gives activity modules, blocks, question types, ... a chance to add admin settings."]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(t.li,{children:"Adds the admin reports to the tree."}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"As an optimisation, before building each bit of the tree, some capability checks are performed, and bits of the tree are skipped if the current user does not have permission to access them."}),"\n",(0,s.jsx)(t.h2,{id:"settings-file-example",children:"Settings file example"}),"\n",(0,s.jsxs)(t.p,{children:["This is an example of a settings.php file provided by a ",(0,s.jsx)("tt",{children:"local_helloworld"}),' plugin. The file declares a single checkbox configuration variable called "showinnavigation".']}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-php",children:"<?php\n// This file is part of Moodle - https://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Adds admin settings for the plugin.\n *\n * @package     local_helloworld\n * @category    admin\n * @copyright   2020 Your Name <email@example.com>\n * @license     https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefined('MOODLE_INTERNAL') || die();\n\nif ($hassiteconfig) {\n    $ADMIN->add('localplugins', new admin_category('local_helloworld_settings', new lang_string('pluginname', 'local_helloworld')));\n    $settingspage = new admin_settingpage('managelocalhelloworld', new lang_string('manage', 'local_helloworld'));\n\n    if ($ADMIN->fulltree) {\n        $settingspage->add(new admin_setting_configcheckbox(\n            'local_helloworld/showinnavigation',\n            new lang_string('showinnavigation', 'local_helloworld'),\n            new lang_string('showinnavigation_desc', 'local_helloworld'),\n            1\n        ));\n    }\n\n    $ADMIN->add('localplugins', $settingspage);\n}\n"})}),"\n",(0,s.jsx)(t.p,{children:"Few things to highlight:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["Note the variable ",(0,s.jsx)("tt",{children:"$hassiteconfig"})," which can be used as a quick way to check for the ",(0,s.jsxs)("tt",{children:["moodle/site",":config"]})," permission. This variable is set by the top-level admin tree population scripts."]}),"\n",(0,s.jsxs)(t.li,{children:["We always add the custom ",(0,s.jsx)("tt",{children:"admin_settingpage"})," to the tree, but the actual settings are added to that page only when ",(0,s.jsx)("tt",{children:"$ADMIN->fulltree"})," is set. This is to improve performance when the caller does not need the actual settings but only the administration pages structure."]}),"\n",(0,s.jsxs)(t.li,{children:["The ",(0,s.jsx)("tt",{children:"lang_string"})," class instances are used as proxy objects to represent strings. This has performance benefits as there is no need to evaluate all strings in the admin settings tree unless they are actually displayed."]}),"\n"]}),"\n",(0,s.jsx)(t.h2,{id:"individual-settings",children:"Individual settings"}),"\n",(0,s.jsxs)(t.p,{children:["Let us look at a simple example: ",(0,s.jsx)(t.a,{href:"https://github.com/moodle/moodle/blob/master/mod/lesson/settings.php",children:"mod/lesson/settings.php"}),". This is included by admin/settings/plugins.php, which has already created $settings, which is an admin_settingpage that we can add to. The file contains lots of lines that look a bit like:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-php",children:"$settings->add(new admin_setting_configtext('mod_lesson/mediawidth', get_string('mediawidth', 'lesson'),\n    get_string('configmediawidth', 'lesson'), 640, PARAM_INT));\n"})}),"\n",(0,s.jsx)(t.p,{children:"What this means is that to our settings page, we are adding a text setting. To understand this in more detail, we need to know what arguments the constructor for this admin_setting_configtext takes. The signature of the constructor is:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-php",children:"public function __construct($name, $visiblename, $description, $defaultsetting, $paramtype=PARAM_RAW, $size=null)\n"})}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)("tt",{children:"$name"})," here is 'mod_lesson/mediawidth'. The slash is important here. It indicates that this setting is owned by the ",(0,s.jsx)("tt",{children:"mod_lesson"})," plugin and should be stored in the ",(0,s.jsx)("tt",{children:"config_plugins"})," table. Settings that do not have this slash would be stored in the global ",(0,s.jsx)("tt",{children:"config"})," table and also exposes them via ",(0,s.jsx)("tt",{children:"$CFG"})," properties. Plugin-scope settings can be obtained only via ",(0,s.jsx)("tt",{children:"get_config()"})," call. You may notice some older plugins such as the Forum module or many blocks, still store their settings in the global config table. That is strongly discouraged for new plugins."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)("tt",{children:"$visiblename"})," is set to a string ",(0,s.jsx)("tt",{children:"get_string('mediawidth', 'lesson')"}),", this is the label that is put in front of setting on the admin screen."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)("tt",{children:"$description"}),' is set to another string, this is a short bit of text displayed underneath the setting to explain it further. Older plugins used strings prefixed with "config" for this purpose. The current best practice is to use "_desc" prefix for them - see ',(0,s.jsx)(t.a,{href:"https://docs.moodle.org/dev/String_API#Help_strings",children:"String API#Help strings"})]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)("tt",{children:"$defaultsetting"})," is the default value for this setting. This value is used when Moodle is installed. For simple settings like checkboxes and text fields, this is a simple value. For some more complicated settings, this is an array."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)("tt",{children:"$paramtype"})," is one of the constants describing the type of the input text. The inserted value will be sanitised according to the declared type."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)("tt",{children:"$size"})," allows to specify custom size of the field in the user interface"]}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"Let us now look at a more complicated example, from mod/quiz/settingstree.php:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-php",children:" $quizsettings->add(new admin_setting_text_with_advanced('quiz/timelimit', get_string('timelimit', 'quiz'), get_string('timelimit_desc', 'quiz'),\n         ['value' => '0', 'fix' => false], PARAM_INT));\n"})}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.em,{children:"Note:"})," the naming convention used here is slightly outdated; new activity modules should use 'mod_mymodule/setting' instead of 'mymodule/setting' as identifier."]}),"\n",(0,s.jsx)(t.p,{children:"This example shows a $defaultsetting that is an array."}),"\n",(0,s.jsx)(t.p,{children:"Normally, if you want a particular sort of setting, the easiest way is to look around the admin screens of your Moodle site, and find a setting like the one you want. Then go and copy the code and edit it. Therefore, we do not include a complete list of setting types here."}),"\n",(0,s.jsx)(t.h2,{id:"locked-and-advanced-settings-for-activity-modules",children:"Locked and advanced settings for activity modules"}),"\n",(0,s.jsx)(t.p,{children:'Admin settings are often used to define the defaults for activity settings. There is a simple way to enable admins make activity settings as "locked" (cannot be changed from the default) or "advanced" (deprecated, used before the change to "short forms").'}),"\n",(0,s.jsx)(t.p,{children:"When creating the admin setting (e.g. in mod/assign/settings.php), create the setting like this:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-php",children:"$name = new lang_string('teamsubmission', 'mod_assign');\n$description = new lang_string('teamsubmission_help', 'mod_assign');\n$setting = new admin_setting_configcheckbox('assign/teamsubmission',\n                                                    $name,\n                                                    $description,\n                                                    1);\n$setting->set_advanced_flag_options(admin_setting_flag::ENABLED, false);\n$setting->set_locked_flag_options(admin_setting_flag::ENABLED, false);\n$settings->add($setting);\n"})}),"\n",(0,s.jsx)(t.p,{children:'To add "locked" and "advanced" check boxes to the admin setting.'}),"\n",(0,s.jsx)(t.p,{children:"And finally, when creating the activity form (e.g. in mod/assign/mod_form.php), call this:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-php",children:"$this->apply_admin_defaults();\n"})}),"\n",(0,s.jsx)(t.p,{children:"at the end of the constructor to automatically set the default and lock the form element if required."}),"\n",(0,s.jsxs)(t.p,{children:["Note: Locking an admin setting *",(0,s.jsx)(t.em,{children:"will not force the value on existing settings"}),". Activity settings that are locked will need to be manually updated if they differ from the locked default value."]}),"\n",(0,s.jsx)(t.h2,{id:"callbacks-after-a-setting-has-been-updated",children:"Callbacks after a setting has been updated"}),"\n",(0,s.jsx)(t.p,{children:"A typical example is purging a cache after a setting has changed:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-php",children:"$setting = new admin_setting_configcheckbox(......);\n$setting->set_updatedcallback('theme_reset_all_caches');\n"})}),"\n",(0,s.jsx)(t.h2,{id:"external-pages",children:"External pages"}),"\n",(0,s.jsx)(t.p,{children:"admin_externalpages represent screens of settings that do not fall into the standard pattern of admin_settings. The admin_externalpage object in the settings tree holds the URL of a PHP page that controls various settings."}),"\n",(0,s.jsx)(t.p,{children:"In that PHP page, near the start you need to call the function admin_externalpage_setup($pagename). Although earlier versions of Moodle required you to then use admin_externalpage_print_header() and admin_externalpage_print_footer() functions instead of the usual print_header and print_footer functions, this is no longer necessary as of Moodle 2.0 - just use $OUTPUT->header() and $OUTPUT->footer() as per usual (don't forget to echo them). This ensures that your page appears with the administration blocks and appropriate navigation."}),"\n",(0,s.jsx)(t.p,{children:"Note that if your external page relies on additional optional or required params, you may need to use the optional arguments to admin_externalpage_print_header to ensure that the Blocks editing on/off button works."}),"\n",(0,s.jsx)(t.p,{children:"Note that there are some subclasses of admin_externalpage, for example admin_page_managemods. In a lot of cases, these subclasses only exist to override the search method so this page can be found by appropriate searches."}),"\n",(0,s.jsx)(t.p,{children:"Once again, to understand this in more depth, your best approach is to look at how some of the external pages in Moodle work."}),"\n",(0,s.jsx)(t.h3,{id:"when-to-use-an-admin_settings-vs-admin_externalpages",children:"When to use an admin_settings vs admin_externalpages"}),"\n",(0,s.jsx)(t.p,{children:"The short answer is wherever possible always try to use admin settings rather than a custom page which uses formslib for anything related to admin settings. If you need something custom investigate a custom admin_setting class before a custom external page. There are a number of reasons, some around usability but mostly related to security:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Searching"})," - Admin settings can be searched for using the admin search, while only the page title of the external page is searchable. In particular it is very useful to search directly for the key name of a config item, but also the settings current value and it's help text. Also the admin settings tree is a public API and there are 3rd party plugins which leverage this for various purposes, so your settings will be invisible."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Manage from CLI"})," - All admin settings in core and plugins can be managed via admin/cli/cfg.php, you don't get this for free if you store settings manually in a custom table."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Caching"})," - All admin settings in core and plugins are cached in the MUC and you don't get this for free if you store settings manually in a custom table."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Forced settings"})," - Normal admin settings can be forced in config.php and this is shown as forced in the GUI. Unless you re-implement this forced logic admins will get the false impression they are saving a setting when they are won't and it will cause a lot of confusion."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Forced passwords"})," - Password admin settings can be forced in config.php and these are not only locked but hidden from the admin (since Moodle 3.9). You would have to, and should, re-implement this logic on top of the 'forced' logic above."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Executable paths"})," - A special case of forced settings is paths to executables which should ideally be set in config.php with $CFG->preventexecpath = true; so they cannot be set in the GUI, even if they aren't in config.php. The admin_setting_configexecutable class handles all this logic for you."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Config log"})," - When an admin setting is changed, the before and after values are appended to the config log and visible in the config changes report. If you ever called set_config on directly on behalf of a human you should call add_to_config_log as well. It is really important to have a strong audit trail of who did what. For normal actions by anyone this should be in the moodle log, for admin settings it should be in the config log."]}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"An OK rule of thumb is: You can use an external page, which might use formslib, when the settings you are changing are in a custom table and not in the config tables via set_config. But you should seriously consider if and why you need a custom table first. If you are writing custom formslib elements it is usually just as easy to write a custom admin_setting instead."}),"\n",(0,s.jsx)(t.h2,{id:"see-also",children:"See also"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.a,{href:"https://docs.moodle.org/dev/Modules",children:"adding settings for activity modules"})}),"\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.a,{href:"https://docs.moodle.org/dev/Admin_reports#How_your_report_gets_included_in_the_admin_tree",children:"adding admin reports to the tree"})}),"\n",(0,s.jsx)(t.li,{children:"configuration of repository plugins"}),"\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.a,{href:"/moodledevdocs/docs/4.1/apis/plugintypes/filter/",children:"configuration for filter"})}),"\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.a,{href:"https://docs.moodle.org/dev/Developer_documentation",children:"Other developer documentation"})}),"\n"]})]})}function g(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}}}]);
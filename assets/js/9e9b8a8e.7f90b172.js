"use strict";(self.webpackChunkdevdocs=self.webpackChunkdevdocs||[]).push([[94432],{13017:(e,s,i)=>{i.r(s),i.d(s,{assets:()=>o,contentTitle:()=>r,default:()=>u,frontMatter:()=>l,metadata:()=>a,toc:()=>d});var n=i(74848),t=i(28453),c=i(78924);const l={title:"Access API",tags:["Access"]},r=void 0,a={id:"apis/subsystems/access",title:"Access API",description:"The Access API gives you functions so you can determine what the current user is allowed to do. It also allows plugins to extend Moodle with new capabilities.",source:"@site/versioned_docs/version-4.2/apis/subsystems/access.md",sourceDirName:"apis/subsystems",slug:"/apis/subsystems/access",permalink:"/moodledevdocs/docs/4.2/apis/subsystems/access",draft:!1,unlisted:!1,editUrl:"https://github.com/moodle/devdocs/edit/main/versioned_docs/version-4.2/apis/subsystems/access.md",tags:[{label:"Access",permalink:"/moodledevdocs/docs/4.2/tags/access"}],version:"4.2",lastUpdatedBy:"Andrew Nicols",lastUpdatedAt:1713332374e3,frontMatter:{title:"Access API",tags:["Access"]},sidebar:"docs",previous:{title:"Subsystems",permalink:"/moodledevdocs/docs/4.2/category/subsystems"},next:{title:"Admin settings",permalink:"/moodledevdocs/docs/4.2/apis/subsystems/admin/"}},o={},d=[{value:"Overview",id:"overview",level:2},{value:"How to define new capabilities in plugins",id:"how-to-define-new-capabilities-in-plugins",level:2},{value:"Deprecating a capability",id:"deprecating-a-capability",level:3},{value:"Useful functions and classes",id:"useful-functions-and-classes",level:2},{value:"Context fetching",id:"context-fetching",level:3},{value:"Determining that a user has a given capability",id:"determining-that-a-user-has-a-given-capability",level:3},{value:"has_capability()",id:"has_capability",level:4},{value:"require_capability()",id:"require_capability",level:4},{value:"Enrolment functions",id:"enrolment-functions",level:3},{value:"Other related functions",id:"other-related-functions",level:3},{value:"<code>require_login()</code>",id:"require_login",level:4},{value:"<code>require_course_login()</code>",id:"require_course_login",level:4},{value:"<code>isguestuser()</code>, <code>isloggedin()</code> and <code>is_siteadmin()</code>",id:"isguestuser-isloggedin-and-is_siteadmin",level:4},{value:"<code>is_guest()</code>, <code>is_viewing()</code> and <code>is_enrolled()</code>",id:"is_guest-is_viewing-and-is_enrolled",level:4},{value:"<code>get_users_by_capability()</code>",id:"get_users_by_capability",level:4},{value:"See also",id:"see-also",level:2}];function h(e){const s={a:"a",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components},{AcademyLink:i}=s;return i||function(e,s){throw new Error("Expected "+(s?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("AcademyLink",!0),(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(c.A,{frontMatter:l,metadata:a}),"\n",(0,n.jsx)(s.p,{children:"The Access API gives you functions so you can determine what the current user is allowed to do. It also allows plugins to extend Moodle with new capabilities."}),"\n",(0,n.jsx)(s.h2,{id:"overview",children:"Overview"}),"\n",(0,n.jsx)(s.p,{children:"Moodle uses a role-based access control model. Entities are represented by contexts which are arranged into a tree-like hierarchy known as the context tree."}),"\n",(0,n.jsx)(s.p,{children:"The following context types are available:"}),"\n",(0,n.jsxs)(s.table,{children:[(0,n.jsx)(s.thead,{children:(0,n.jsxs)(s.tr,{children:[(0,n.jsx)(s.th,{children:"Context name"}),(0,n.jsx)(s.th,{children:"Represents"}),(0,n.jsx)(s.th,{children:"Immediate contents"}),(0,n.jsx)(s.th,{children:"Notes"})]})}),(0,n.jsxs)(s.tbody,{children:[(0,n.jsxs)(s.tr,{children:[(0,n.jsx)(s.td,{children:(0,n.jsx)(s.code,{children:"context_system"})}),(0,n.jsx)(s.td,{children:"The site as a whole"}),(0,n.jsx)(s.td,{children:"user, course category, module, and block"}),(0,n.jsx)(s.td,{children:"The System context is root context in the tree. There is only one System context"})]}),(0,n.jsxs)(s.tr,{children:[(0,n.jsx)(s.td,{children:(0,n.jsx)(s.code,{children:"context_user"})}),(0,n.jsx)(s.td,{children:"An individual user"}),(0,n.jsx)(s.td,{children:"block"}),(0,n.jsx)(s.td,{children:"Each user has their own, unique, context"})]}),(0,n.jsxs)(s.tr,{children:[(0,n.jsx)(s.td,{children:(0,n.jsx)(s.code,{children:"context_coursecat"})}),(0,n.jsx)(s.td,{children:"A single course category"}),(0,n.jsx)(s.td,{children:"course category, course, block"}),(0,n.jsx)(s.td,{})]}),(0,n.jsxs)(s.tr,{children:[(0,n.jsx)(s.td,{children:(0,n.jsx)(s.code,{children:"context_course"})}),(0,n.jsx)(s.td,{children:"A single course"}),(0,n.jsx)(s.td,{children:"module, block"}),(0,n.jsx)(s.td,{})]}),(0,n.jsxs)(s.tr,{children:[(0,n.jsx)(s.td,{children:(0,n.jsx)(s.code,{children:"context_module"})}),(0,n.jsx)(s.td,{children:"An activity"}),(0,n.jsx)(s.td,{children:"block"}),(0,n.jsx)(s.td,{})]}),(0,n.jsxs)(s.tr,{children:[(0,n.jsx)(s.td,{children:(0,n.jsx)(s.code,{children:"context_block"})}),(0,n.jsx)(s.td,{children:"A block"}),(0,n.jsx)(s.td,{children:"none"}),(0,n.jsx)(s.td,{})]})]})]}),"\n",(0,n.jsx)(s.p,{children:"A Role is a set of capability definitions, where each capability represents something that the user is able to do. Roles are defined at the top most\ncontext in the context tree, the System context."}),"\n",(0,n.jsx)(s.p,{children:"Roles can be overridden by contexts further down the tree."}),"\n",(0,n.jsx)(s.p,{children:"User access is calculated from the combination of roles which are assigned to each user."}),"\n",(0,n.jsxs)(s.p,{children:["All users that did not log-in yet automatically get the default role defined in ",(0,n.jsx)(s.code,{children:"$CFG->notloggedinroleid"}),", it is not possible to assign any other role to this non-existent user id. There is one special guest user account that is used when user logs in using the guest login button or when guest auto-login is enabled. Again you can not assign any roles to the guest account directly, this account gets the ",(0,n.jsx)(s.code,{children:"$CFG->guestroleid"})," automatically. All other authenticated users get the default user role specified in ",(0,n.jsx)(s.code,{children:"$CFG->defaultuserroleid"})," and in the frontpage context the role specified in ",(0,n.jsx)(s.code,{children:"$CFG->defaultfrontpageroleid"}),"."]}),"\n",(0,n.jsx)(i,{subject:"Contexts and the Roles API",courseName:"securityEssentials"}),"\n",(0,n.jsx)(s.h2,{id:"how-to-define-new-capabilities-in-plugins",children:"How to define new capabilities in plugins"}),"\n",(0,n.jsxs)(s.p,{children:["Capabilities are defined by ",(0,n.jsx)(s.code,{children:"$capabilities"})," array defined in ",(0,n.jsx)(s.code,{children:"db/access.php"})," files. The name of the capability consists of ",(0,n.jsx)(s.code,{children:"plugintype/pluginname:capabilityname"}),"."]}),"\n",(0,n.jsx)(s.p,{children:"For example:"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-php",metastring:'title="mod/folder/db/access.php"',children:"$capabilities = [\n    'mod/folder:managefiles' => [\n        'riskbitmask' => RISK_SPAM,\n        'captype' => 'write',\n        'contextlevel' => CONTEXT_MODULE,\n        'archetypes' => [\n            'editingteacher' => CAP_ALLOW,\n        ],\n    ],\n];\n"})}),"\n",(0,n.jsx)(s.p,{children:"Where the meaning of array keys is:"}),"\n",(0,n.jsxs)(s.table,{children:[(0,n.jsx)(s.thead,{children:(0,n.jsxs)(s.tr,{children:[(0,n.jsx)(s.th,{children:"Field"}),(0,n.jsx)(s.th,{children:"Description"})]})}),(0,n.jsxs)(s.tbody,{children:[(0,n.jsxs)(s.tr,{children:[(0,n.jsx)(s.td,{children:(0,n.jsx)(s.code,{children:"riskbitmask"})}),(0,n.jsxs)(s.td,{children:["associated risks. These are explained on ",(0,n.jsx)(s.a,{href:"/moodledevdocs/docs/4.2/apis/subsystems/roles",children:"Hardening new Roles system"}),"."]})]}),(0,n.jsxs)(s.tr,{children:[(0,n.jsx)(s.td,{children:(0,n.jsx)(s.code,{children:"captype"})}),(0,n.jsxs)(s.td,{children:[(0,n.jsx)(s.em,{children:"read"})," or ",(0,n.jsx)(s.em,{children:"write"})," capability type, for security reasons system prevents all write capabilities for guest account and not-logged-in users"]})]}),(0,n.jsxs)(s.tr,{children:[(0,n.jsx)(s.td,{children:(0,n.jsx)(s.code,{children:"contextlevel"})}),(0,n.jsxs)(s.td,{children:["specified as context level constant. Declares the typical context level where this capability is checked. This capability can be checked with contexts that are at a lower level (e.g. ",(0,n.jsx)(s.code,{children:"moodle/site:accessallgroups"})," could be checked with CONTEXT_MODULE)."]})]}),(0,n.jsxs)(s.tr,{children:[(0,n.jsx)(s.td,{children:(0,n.jsx)(s.code,{children:"archetypes"})}),(0,n.jsxs)(s.td,{children:["specifies defaults for roles with standard archetypes, this is used in installs, upgrades and when resetting roles (it is recommended to use only CAP_ALLOW here).  Archetypes are defined in mdl_role table.  See also ",(0,n.jsx)(s.a,{href:"https://docs.moodle.org/dev/Role_archetypes",children:"Role archetypes"}),"."]})]}),(0,n.jsxs)(s.tr,{children:[(0,n.jsx)(s.td,{children:(0,n.jsx)(s.code,{children:"clonepermissionsfrom"})}),(0,n.jsxs)(s.td,{children:["when you are adding a new capability, you can tell Moodle to copy the permissions for each role from the current settings for another capability. This may give better defaults than just using archetypes for administrators who have heavily customised their roles configuration. The full syntax is: ",(0,n.jsx)(s.code,{children:"clonepermissionsfrom"})," => ",(0,n.jsx)(s.code,{children:"moodle/quiz:attempt"})]})]})]})]}),"\n",(0,n.jsx)(s.p,{children:"It is necessary to bump up plugin version number after any change in db/access.php, so that the upgrade scripts can make the necessary changes to the database.  To run the upgrade scripts, log in to Moodle as administrator, navigate to the site home page, and follow the instructions.  (If you need to test the upgrade script without changing the plugin version, it is also possible to set back the version number in the mdl_block or mdl_modules table in the database.)"}),"\n",(0,n.jsxs)(s.p,{children:['The capability names are defined in plugin language files, the name of the string consists of "pluginname',":capabilityname",'", in the example above it would be:']}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-php",metastring:'title="mod/folder/lang/en/folder.php"',children:"$string['folder:managefiles'] = 'Manage files in folder module';\n"})}),"\n",(0,n.jsx)(s.h3,{id:"deprecating-a-capability",children:"Deprecating a capability"}),"\n",(0,n.jsxs)(s.p,{children:["When a capability is no longer needed or is replaced by another, it should be deprecated. The timeline for deprecation should follow the normal ",(0,n.jsx)(s.a,{href:"/general/development/policies/deprecation",children:"Deprecation"})," process."]}),"\n",(0,n.jsxs)(s.p,{children:["To mark a capability as deprecated, edit the access.php containing the capability, remove it from the ",(0,n.jsx)(s.code,{children:"$capabilities"})," array, and add it to the ",(0,n.jsx)(s.code,{children:"$deprecatedcapabilities"})," array in this file."]}),"\n",(0,n.jsxs)(s.p,{children:["Entries in ",(0,n.jsx)(s.code,{children:"$deprecatedcapabilities"})," can have a ",(0,n.jsx)(s.code,{children:"replacement"})," key indicating a new or existing capability that replaces the deprecated one. If this is specified, any checks to the deprecated capability will check the replacement capability instead. A debugging message will always be output at ",(0,n.jsx)(s.code,{children:"DEBUG_DEVELOPER"})," level if a deprecated capability is checked."]}),"\n",(0,n.jsxs)(s.p,{children:[(0,n.jsx)(s.code,{children:"$deprecatedcapabilities"})," can also define an optional ",(0,n.jsx)(s.code,{children:"message"})," explaining the deprecation."]}),"\n",(0,n.jsx)(s.p,{children:"The following example demonstrates an access.php file where a capability has been deprecated and replaced with another."}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-php",metastring:'title="mod/folder/db/access.php"',children:"$capabilities = [\n    'mod/folder:newmanagefiles' => [\n        'riskbitmask' => RISK_SPAM,\n        'captype' => 'write',\n        'contextlevel' => CONTEXT_MODULE,\n        'archetypes' => [\n            'editingteacher' => CAP_ALLOW,\n        ],\n    ],\n];\n\n$deprecatedcapabilities = [\n    'mod/folder:managefiles' => [\n        'replacement' => 'mod/folder:newmanagefiles',\n        'message' => 'This was replaced with another capability'\n    ],\n];\n"})}),"\n",(0,n.jsx)(s.h2,{id:"useful-functions-and-classes",children:"Useful functions and classes"}),"\n",(0,n.jsx)(s.h3,{id:"context-fetching",children:"Context fetching"}),"\n",(0,n.jsx)(s.p,{children:"In plugins context instances are usually only instantiated because they are instantiated and deleted automatically by the system."}),"\n",(0,n.jsx)(s.p,{children:"Fetching by object id:"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-php",children:"$systemcontext = context_system::instance();\n$usercontext = context_user::instance($user->id);\n$categorycontext = context_coursecat::instance($category->id);\n$coursecontext = context_course::instance($course->id);\n$contextmodule = context_module::instance($cm->id);\n$contextblock = context_block::instance($this->instance->id);\n"})}),"\n",(0,n.jsx)(s.p,{children:"Fetching by context id:"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-php",children:"$context = context::instance_by_id($contextid);\n"})}),"\n",(0,n.jsx)(s.p,{children:"Notes:"}),"\n",(0,n.jsxs)(s.ul,{children:["\n",(0,n.jsx)(s.li,{children:"by default exception is thrown if context can not be created"}),"\n",(0,n.jsx)(s.li,{children:"deleted users do not have contexts any more"}),"\n"]}),"\n",(0,n.jsx)(s.h3,{id:"determining-that-a-user-has-a-given-capability",children:"Determining that a user has a given capability"}),"\n",(0,n.jsx)(s.p,{children:'When implementing access control always ask "Does the user have capability to do something?". It is incorrect to ask "Does the user have a role somewhere?".'}),"\n",(0,n.jsx)(s.h4,{id:"has_capability",children:"has_capability()"}),"\n",(0,n.jsxs)(s.p,{children:[(0,n.jsx)(s.code,{children:"has_capability()"})," is the most important function:"]}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-php",children:"function has_capability(\n    string $capability,\n    context $context,\n    object $user = null,\n    bool $doanything = true\n): bool;\n"})}),"\n",(0,n.jsx)(s.p,{children:"Check whether a user has a particular capability in a given context. For example:"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-php",children:"$context = context_module::instance($cm->id);\nif (has_capability('mod/folder:managefiles', $context)) {\n    // Do or display something.\n}\n"})}),"\n",(0,n.jsx)(s.p,{children:"By default checks the capabilities of the current user, but you can pass a different user id. By default will return true for admin users, it is not recommended to use false here."}),"\n",(0,n.jsx)(s.h4,{id:"require_capability",children:"require_capability()"}),"\n",(0,n.jsx)(s.p,{children:"Function require_capability() is very similar, it is throwing access control exception if user does not have the capability."}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-php",children:"function require_capability($capability, context $context, $userid = null, $doanything = true, $errormessage = 'nopermissions', $stringfile = _) {\n"})}),"\n",(0,n.jsx)(s.h3,{id:"enrolment-functions",children:"Enrolment functions"}),"\n",(0,n.jsxs)(s.p,{children:["See ",(0,n.jsx)(s.a,{href:"/moodledevdocs/docs/4.2/apis/subsystems/enrol",children:"Enrolment API"}),"."]}),"\n",(0,n.jsx)(s.h3,{id:"other-related-functions",children:"Other related functions"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-php",children:"function require_login($courseorid = null, $autologinguest = true, $cm = null, $setwantsurltome = true, $preventredirect = false)\nfunction require_course_login($courseorid, $autologinguest = true, $cm = null, $setwantsurltome = true, $preventredirect = false)\nfunction get_users_by_capability(context $context, $capability, $fields = _, $sort = _, $limitfrom = _, $limitnum = _,\n                                $groups = _, $exceptions = _, $doanything_ignored = null, $view_ignored = null, $useviewallgroups = false)\nfunction isguestuser($user = null)\nfunction isloggedin()\nfunction is_siteadmin($user_or_id = null)\nfunction is_guest(context $context, $user = null)\nfunction is_viewing(context $context, $user = null, $withcapability = _)\n"})}),"\n",(0,n.jsx)(s.h4,{id:"require_login",children:(0,n.jsx)(s.code,{children:"require_login()"})}),"\n",(0,n.jsx)(s.p,{children:"Each plugin script should include require_login() or require_course_login() after setting up PAGE->url."}),"\n",(0,n.jsx)(s.p,{children:"This function does following:"}),"\n",(0,n.jsxs)(s.ul,{children:["\n",(0,n.jsx)(s.li,{children:"it verifies that user is logged in before accessing any course or activities (not-logged-in users can not enter any courses)."}),"\n",(0,n.jsx)(s.li,{children:"user is logged in as gu"}),"\n",(0,n.jsx)(s.li,{children:"verify access to hidden courses and activities"}),"\n",(0,n.jsxs)(s.li,{children:["if an activity is specified, verify any ",(0,n.jsx)(s.a,{href:"/moodledevdocs/docs/4.2/apis/subsystems/availability/",children:"availability restrictions"})," for the activity"]}),"\n",(0,n.jsxs)(s.li,{children:["verify that user is either enrolled or has capability 'moodle/course",":view","' or some enrol plugin gives them temporary guest access"]}),"\n",(0,n.jsx)(s.li,{children:"logs access to courses"}),"\n"]}),"\n",(0,n.jsx)(s.h4,{id:"require_course_login",children:(0,n.jsx)(s.code,{children:"require_course_login()"})}),"\n",(0,n.jsx)(s.p,{children:"This function is supposed to be used only in activities that want to allow read access to content on the frontpage without logging-in. For example view resource files, reading of glossary  entries, etc."}),"\n",(0,n.jsxs)(s.h4,{id:"isguestuser-isloggedin-and-is_siteadmin",children:[(0,n.jsx)(s.code,{children:"isguestuser()"}),", ",(0,n.jsx)(s.code,{children:"isloggedin()"})," and ",(0,n.jsx)(s.code,{children:"is_siteadmin()"})]}),"\n",(0,n.jsxs)(s.p,{children:["These function were previously needed for limiting of access of special accounts. It is usually not necessary any more, because any ",(0,n.jsx)(s.em,{children:"write"})," or ",(0,n.jsx)(s.em,{children:"risky"})," capabilities are now automatically prevented in has_capability()."]}),"\n",(0,n.jsx)(s.p,{children:"It is strongly discouraged to use is_siteadmin() in activity modules, please use standard capabilities and enrolment status instead."}),"\n",(0,n.jsxs)(s.h4,{id:"is_guest-is_viewing-and-is_enrolled",children:[(0,n.jsx)(s.code,{children:"is_guest()"}),", ",(0,n.jsx)(s.code,{children:"is_viewing()"})," and ",(0,n.jsx)(s.code,{children:"is_enrolled()"})]}),"\n",(0,n.jsx)(s.p,{children:"In order to access course data one of these functions must return true for user:"}),"\n",(0,n.jsxs)(s.ul,{children:["\n",(0,n.jsxs)(s.li,{children:[(0,n.jsx)(s.code,{children:"is_enrolled()"})," - user has active record in user_enrolments table"]}),"\n",(0,n.jsxs)(s.li,{children:[(0,n.jsx)(s.code,{children:"is_viewing()"})," - user has 'moodle/course",":view","' capability (may access course, but is not considered to be participant)"]}),"\n",(0,n.jsxs)(s.li,{children:[(0,n.jsx)(s.code,{children:"is_guest()"})," - user was given temporary guest access by some enrolment plugin"]}),"\n"]}),"\n",(0,n.jsx)(s.h4,{id:"get_users_by_capability",children:(0,n.jsx)(s.code,{children:"get_users_by_capability()"})}),"\n",(0,n.jsx)(s.p,{children:"This method returns list of users with given capability, it ignores enrolment status and should be used only above the course context."}),"\n",(0,n.jsx)(s.h2,{id:"see-also",children:"See also"}),"\n",(0,n.jsxs)(s.ul,{children:["\n",(0,n.jsx)(s.li,{children:(0,n.jsx)(s.a,{href:"/moodledevdocs/docs/4.2/apis",children:"API guides"})}),"\n",(0,n.jsx)(s.li,{children:(0,n.jsx)(s.a,{href:"/moodledevdocs/docs/4.2/apis/subsystems/roles",children:"Roles"})}),"\n",(0,n.jsx)(s.li,{children:(0,n.jsx)(s.a,{href:"https://docs.moodle.org/dev/Role_archetypes",children:"Role archetypes"})}),"\n",(0,n.jsx)(s.li,{children:(0,n.jsx)(s.a,{href:"/moodledevdocs/docs/4.2/apis/subsystems/roles",children:"Hardening new Roles system"})}),"\n",(0,n.jsx)(s.li,{children:(0,n.jsx)(s.a,{href:"https://docs.moodle.org/dev/Roles_and_modules",children:"Roles and modules"})}),"\n",(0,n.jsx)(s.li,{children:(0,n.jsx)(s.a,{href:"https://docs.moodle.org/dev/NEWMODULE_Adding_capabilities",children:"NEWMODULE Adding capabilities"})}),"\n",(0,n.jsx)(s.li,{children:(0,n.jsx)(s.a,{href:"https://docs.moodle.org/dev/New_permissions_evaluation_in_2.0",children:"New permissions evaluation in 2.0"})}),"\n",(0,n.jsx)(s.li,{children:(0,n.jsx)(s.a,{href:"https://moodle.org/mod/forum/discuss.php?d=257611",children:"(Forums) How to check if current user is student?"})}),"\n"]})]})}function u(e={}){const{wrapper:s}={...(0,t.R)(),...e.components};return s?(0,n.jsx)(s,{...e,children:(0,n.jsx)(h,{...e})}):h(e)}}}]);
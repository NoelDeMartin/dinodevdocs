"use strict";(self.webpackChunkdevdocs=self.webpackChunkdevdocs||[]).push([[36697],{63019:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>l,default:()=>u,frontMatter:()=>o,metadata:()=>a,toc:()=>h});var r=s(74848),t=s(28453),i=s(78924);const o={title:"Running acceptance tests",sidebar_position:1,tags:["Quality Assurance","Testing","Behaviour testing","Behat"]},l=void 0,a={id:"development/tools/behat/running",title:"Running acceptance tests",description:"Moodle uses Behat, a php framework for automated functional testing, as part of a suite of testing tools.",source:"@site/general/development/tools/behat/running.md",sourceDirName:"development/tools/behat",slug:"/development/tools/behat/running",permalink:"/moodledevdocs/general/development/tools/behat/running",draft:!1,unlisted:!1,editUrl:"https://github.com/moodle/devdocs/edit/main/general/development/tools/behat/running.md",tags:[{label:"Quality Assurance",permalink:"/moodledevdocs/general/tags/quality-assurance"},{label:"Testing",permalink:"/moodledevdocs/general/tags/testing"},{label:"Behaviour testing",permalink:"/moodledevdocs/general/tags/behaviour-testing"},{label:"Behat",permalink:"/moodledevdocs/general/tags/behat"}],version:"current",lastUpdatedBy:"Eloy Lafuente (stronk7)",lastUpdatedAt:1682061689e3,sidebarPosition:1,frontMatter:{title:"Running acceptance tests",sidebar_position:1,tags:["Quality Assurance","Testing","Behaviour testing","Behat"]},sidebar:"coding",previous:{title:"Behat",permalink:"/moodledevdocs/general/development/tools/behat/"},next:{title:"Writing acceptance tests",permalink:"/moodledevdocs/general/development/tools/behat/writing"}},d={},h=[{value:"Requirements",id:"requirements",level:2},{value:"Recommended extras",id:"recommended-extras",level:3},{value:"Pre-configured browser profiles: moodle-browser-config",id:"pre-configured-browser-profiles-moodle-browser-config",level:4},{value:"Installation",id:"installation",level:5},{value:"Provided profiles",id:"provided-profiles",level:5},{value:"chromedriver-wrapper",id:"chromedriver-wrapper",level:4},{value:"Getting started",id:"getting-started",level:2},{value:"Setting up Selenium",id:"setting-up-selenium",level:3},{value:"Setting up your browsers",id:"setting-up-your-browsers",level:3},{value:"Chrome",id:"chrome",level:4},{value:"Firefox",id:"firefox",level:4},{value:"Setting up Moodle",id:"setting-up-moodle",level:3},{value:"Configure Behat for Moodle",id:"configure-behat-for-moodle",level:3},{value:"Run Behat tests",id:"run-behat-tests",level:3},{value:"Running using a different browser",id:"running-using-a-different-browser",level:4},{value:"Advanced testing",id:"advanced-testing",level:3},{value:"Run tests without Selenium (chromedriver, geckodriver)",id:"run-tests-without-selenium-chromedriver-geckodriver",level:4},{value:"Headless browsers",id:"headless-browsers",level:4},{value:"Parallel runs",id:"parallel-runs",level:4},{value:"Installation",id:"installation-1",level:5},{value:"Running Parallel tests",id:"running-parallel-tests",level:5},{value:"Custom parameters for parallel runs",id:"custom-parameters-for-parallel-runs",level:5},{value:"Tests filters",id:"tests-filters",level:4},{value:"Output formats",id:"output-formats",level:4},{value:"Rerun failed scenarios",id:"rerun-failed-scenarios",level:4},{value:"Running behat with specified theme",id:"running-behat-with-specified-theme",level:4},{value:"Using Docker to start selenium server",id:"using-docker-to-start-selenium-server",level:4},{value:"Change config.php file",id:"change-configphp-file",level:4},{value:"Manually configuring other browsers",id:"manually-configuring-other-browsers",level:4},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Increasing timeouts",id:"increasing-timeouts",level:3},{value:"New step definitions or features are not executed",id:"new-step-definitions-or-features-are-not-executed",level:3},{value:"Tests are failing",id:"tests-are-failing",level:3},{value:"The tests are failing, and the error message is completely useless",id:"the-tests-are-failing-and-the-error-message-is-completely-useless",level:3},{value:"Errors during setup (before test are launched)",id:"errors-during-setup-before-test-are-launched",level:3},{value:"Selenium server is not running",id:"selenium-server-is-not-running",level:3},{value:"Chrome specific",id:"chrome-specific",level:4},{value:"Examples",id:"examples",level:2},{value:"Quick setup and testing using moodle-docker",id:"quick-setup-and-testing-using-moodle-docker",level:3},{value:"See also",id:"see-also",level:2}];function c(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",h5:"h5",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(i.A,{frontMatter:o,metadata:a}),"\n",(0,r.jsxs)(n.p,{children:["Moodle uses ",(0,r.jsx)(n.a,{href:"https://behat.org",children:"Behat"}),", a php framework for automated functional testing, as part of a suite of testing tools."]}),"\n",(0,r.jsx)(n.p,{children:"Behat takes a set of Features, Scenarios, and Steps, and uses these to step through actions and test results using a real web browser. This is possible thanks to a protocol implemented in most modern web browsers called Webdriver."}),"\n",(0,r.jsx)(n.p,{children:"This documentation covers how to run Behat tests within Moodle, including requirements, setup, useful tips and tricks, and basic troubleshooting."}),"\n",(0,r.jsx)(n.h2,{id:"requirements",children:"Requirements"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Any recent OS with ",(0,r.jsx)(n.a,{href:"/moodledevdocs/general/releases",children:"supported version of Moodle"})," installed"]}),"\n",(0,r.jsxs)(n.li,{children:["A recent browser (Firefox and Chrome as standard, but ",(0,r.jsx)(n.a,{href:"/moodledevdocs/general/development/tools/behat/browsers/",children:"other browsers"})," are possible)"]}),"\n",(0,r.jsx)(n.li,{children:"The WebDriver implementation for your browser"}),"\n",(0,r.jsx)(n.li,{children:"A recent version of Selenium (Optional, but recommended)"}),"\n",(0,r.jsx)(n.li,{children:"A recent Java Runtime Environment (Required if using Selenium)"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"recommended-extras",children:"Recommended extras"}),"\n",(0,r.jsx)(n.p,{children:"Some extra software is also recommended for testing with Behat."}),"\n",(0,r.jsx)(n.h4,{id:"pre-configured-browser-profiles-moodle-browser-config",children:"Pre-configured browser profiles: moodle-browser-config"}),"\n",(0,r.jsxs)(n.p,{children:["Available for ",(0,r.jsx)(n.a,{href:"/moodledevdocs/general/releases",children:"all supported versions of Moodle"}),", the ",(0,r.jsx)(n.a,{href:"https://github.com/andrewnicols/moodle-browser-config",children:"moodle-browser-config"})," is a recommended inclusion for Behat. This configuration tooling provides a range of standard browser profiles for testing."]}),"\n",(0,r.jsx)(n.admonition,{type:"note",children:(0,r.jsxs)(n.p,{children:["In future, the ",(0,r.jsx)(n.strong,{children:"moodle-browser-config"})," tool may be included as composer dependency to Moodle but this is currently not the case."]})}),"\n",(0,r.jsx)(n.h5,{id:"installation",children:"Installation"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Check out the moodle-browser-config repository:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-console",metastring:'title="Clone the moodle-browser-config repository"',children:"git clone https://github.com/andrewnicols/moodle-browser-config\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Open your Moodle installation's ",(0,r.jsx)(n.code,{children:"config.php"})," in your preferred editor, and require the tool's ",(0,r.jsx)(n.code,{children:"init.php"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"require_once('/path/to/your/git/dir/moodle-browser-config/init.php');\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h5,{id:"provided-profiles",children:"Provided profiles"}),"\n",(0,r.jsxs)(n.p,{children:["The full list of profiles which are included with ",(0,r.jsx)(n.code,{children:"moodle-browser-config"})," are provided in its ",(0,r.jsx)(n.a,{href:"https://github.com/andrewnicols/moodle-browser-config",children:"own documentation"}),"."]}),"\n",(0,r.jsx)(n.p,{children:"The following is a summary of the profiles that most users may be interested in."}),"\n",(0,r.jsx)(n.p,{children:"You can also provide your own custom profiles, including for remote services such as Browserstack, and Saucelabs, as\nwell as for other browsers supporting the W3C Webdriver specification."}),"\n",(0,r.jsxs)(n.p,{children:["Please note that ",(0,r.jsx)(n.code,{children:"Safari"})," and ",(0,r.jsx)(n.code,{children:"Safaridriver"})," are not currently supported as they do not meet the W3C WebDriver specification."]}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Profile name"}),(0,r.jsx)(n.th,{children:"Description"}),(0,r.jsx)(n.th,{children:"Uses Selenium?"}),(0,r.jsx)(n.th,{children:"Displays GUI?"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"firefox"}),(0,r.jsx)(n.td,{children:"Use Firefox via Selenium"}),(0,r.jsx)(n.td,{children:"Yes"}),(0,r.jsx)(n.td,{children:"Yes"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"headlessfirefox"}),(0,r.jsx)(n.td,{children:"Use Firefox via Selenium, without displaying the GUI"}),(0,r.jsx)(n.td,{children:"Yes"}),(0,r.jsx)(n.td,{children:"No"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"geckodriver"}),(0,r.jsx)(n.td,{children:"Use Firefox with Geckodriver directly"}),(0,r.jsx)(n.td,{children:"No"}),(0,r.jsx)(n.td,{children:"Yes"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"headlessgeckodriver"}),(0,r.jsx)(n.td,{children:"Use Firefox with Geckodriver directly, without displaying the GUI"}),(0,r.jsx)(n.td,{children:"No"}),(0,r.jsx)(n.td,{children:"No"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"chrome"}),(0,r.jsx)(n.td,{children:"Use Chrome via Selenium"}),(0,r.jsx)(n.td,{children:"Yes"}),(0,r.jsx)(n.td,{children:"Yes"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"headlesschrome"}),(0,r.jsx)(n.td,{children:"Use Chrome via Selenium, without displaying the GUI"}),(0,r.jsx)(n.td,{children:"Yes"}),(0,r.jsx)(n.td,{children:"No"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"chromedriver"}),(0,r.jsx)(n.td,{children:"Use Chrome with Chromedriver directly"}),(0,r.jsx)(n.td,{children:"No"}),(0,r.jsx)(n.td,{children:"Yes"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"headlesschromedriver"}),(0,r.jsx)(n.td,{children:"Use Chrome with Chromedriver directly, without displaying the GUI"}),(0,r.jsx)(n.td,{children:"No"}),(0,r.jsx)(n.td,{children:"No"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"edge"}),(0,r.jsx)(n.td,{children:"Use Edge via Selenium"}),(0,r.jsx)(n.td,{children:"Yes"}),(0,r.jsx)(n.td,{children:"Yes"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"headlessedge"}),(0,r.jsx)(n.td,{children:"Use Edge via Selenium, without displaying the GUI"}),(0,r.jsx)(n.td,{children:"Yes"}),(0,r.jsx)(n.td,{children:"No"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"edgedriver"}),(0,r.jsx)(n.td,{children:"Use Edge with Edgedriver directly"}),(0,r.jsx)(n.td,{children:"No"}),(0,r.jsx)(n.td,{children:"Yes"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"headlessedgedriver"}),(0,r.jsx)(n.td,{children:"Use Edge with Edgedriver directly, without displaying the GUI"}),(0,r.jsx)(n.td,{children:"No"}),(0,r.jsx)(n.td,{children:"No"})]})]})]}),"\n",(0,r.jsx)(n.h4,{id:"chromedriver-wrapper",children:"chromedriver-wrapper"}),"\n",(0,r.jsxs)(n.p,{children:["When using Google Chrome, you must use the correct version of the ",(0,r.jsx)(n.code,{children:"chromedriver"})," browser driver for the version of Chrome that you use."]}),"\n",(0,r.jsx)(n.p,{children:"Since Google Chrome automatically updates on a regular basis, you will need to regularly upgrade your driver to match the version of Chrome that you are using."}),"\n",(0,r.jsxs)(n.p,{children:["To make this easier, a ",(0,r.jsx)(n.code,{children:"chromedriver-wrapper"})," utility has been written. This inspects the version of Chrome that is in your path, and downloads the correct version of ",(0,r.jsx)(n.code,{children:"chromedriver"})," for that version, before starting it."]}),"\n",(0,r.jsxs)(n.p,{children:["Installation instructions can be found at ",(0,r.jsx)(n.a,{href:"https://github.com/andrewnicols/chromedriver-wrapper",children:"https://github.com/andrewnicols/chromedriver-wrapper"}),"."]}),"\n",(0,r.jsx)(n.h2,{id:"getting-started",children:"Getting started"}),"\n",(0,r.jsx)(n.admonition,{title:"Environment",type:"tip",children:(0,r.jsxs)(n.p,{children:["These notes assume that you have already installed a supported Java Runtime Environment, and the ",(0,r.jsx)(n.a,{href:"/moodledevdocs/general/development/tools/behat/running#pre-configured-browser-profiles-moodle-browser-config",children:"moodle-browser-config"})," tool."]})}),"\n",(0,r.jsx)(n.h3,{id:"setting-up-selenium",children:"Setting up Selenium"}),"\n",(0,r.jsx)(n.p,{children:"Generally we recommend use of Selenium, though this is not a fixed requirement. You can use the browser's driver implementation directly but this is harder to setup for the first time."}),"\n",(0,r.jsx)(n.p,{children:"Selenium is written in Java, and requires a recent version of the JRE to run. Please ensure that you have this installed prior to starting."}),"\n",(0,r.jsxs)(n.p,{children:["Since Moodle 3.9.5 / 3.10.2 / 3.11.0 Moodle will work with any modern version of Selenium. At time of writing that is ",(0,r.jsx)(n.code,{children:"3.141.59"}),", and 4.1.0."]}),"\n",(0,r.jsx)(n.admonition,{type:"warning",children:(0,r.jsxs)(n.p,{children:["There appears to be an issue with the version 4 jars - particularly in 4.1.0 that generates a ",(0,r.jsx)(n.strong,{children:'"Could not open connection: Capability value must be set"'})," error which appears to be an issue between Selenium and the MInkExtension for JavaScript tests - see ",(0,r.jsx)(n.a,{href:"https://githubmemory.com/repo/Behat/MinkExtension/activity",children:"https://githubmemory.com/repo/Behat/MinkExtension/activity"})," for more information. The quick work around is to use the earlier version (3.141.59)."]})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Download the Selenium Server (Grid) from ",(0,r.jsx)(n.a,{href:"https://www.selenium.dev/downloads/",children:"https://www.selenium.dev/downloads/"}),". This is a single JAR file, put it anywhere handy."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Start Selenium"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-console",metastring:'title="Version 3.141.59"',children:"java -jar selenium-server-standalone-3.141.59.jar\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-console",metastring:'title="Version 4.0.0 and later"',children:"java -jar selenium-server-4.0.0-beta-3.jar standalone\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.admonition,{type:"tip",children:(0,r.jsx)(n.p,{children:"You can optionally specify a number of settings, depending on the version of Selenium that you are using, including the port to run on.\nSee the help for the version of Selenium that you are using."})}),"\n",(0,r.jsx)(n.h3,{id:"setting-up-your-browsers",children:"Setting up your browsers"}),"\n",(0,r.jsx)(n.p,{children:"Selenium is just an intelligent wrapper to start, and manage your browser sessions. It doesn't actually include any web browsers itself."}),"\n",(0,r.jsx)(n.p,{children:"Moodle HQ run all behat tests against both Firefox and Chrome multiple times per day. Other combinations, including Microsoft Edge, are also supported."}),"\n",(0,r.jsxs)(n.p,{children:["To use Behat, you will need a recent version of your preferred browser, as well as a ",(0,r.jsx)(n.code,{children:"driver"})," for that browser. The driver is responsible for communication between Selenium (or Moodle directly) and the browser."]}),"\n",(0,r.jsxs)(n.p,{children:["Both the browser, and its driver, must be placed inside your ",(0,r.jsx)(n.code,{children:"$PATH"})," - this may be somewhere like ",(0,r.jsx)(n.code,{children:"/usr/bin"}),", ",(0,r.jsx)(n.code,{children:"/usr/local/bin"}),", or perhaps a user bin directory like ",(0,r.jsx)(n.code,{children:"~/bin"})," which is present in your ",(0,r.jsx)(n.code,{children:"$PATH"})]}),"\n",(0,r.jsx)(n.h4,{id:"chrome",children:"Chrome"}),"\n",(0,r.jsxs)(n.p,{children:["You can download Google Chrome from ",(0,r.jsx)(n.a,{href:"https://www.google.com.au/chrome",children:"https://www.google.com.au/chrome"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:["You will need the ",(0,r.jsx)(n.a,{href:"https://chromedriver.chromium.org/downloads",children:"correct version of the chromedriver"})," as per the\ndocumentation. Alternatively you can make use of the ",(0,r.jsx)(n.a,{href:"/moodledevdocs/general/development/tools/behat/running#chromedriver-wrapper",children:"chromedriver-wrapper utility"})," noted in the Recommended extras sections."]}),"\n",(0,r.jsxs)(n.p,{children:["Either the ",(0,r.jsx)(n.code,{children:"chromedriver"})," binary must be in a directory in your ",(0,r.jsx)(n.code,{children:"$PATH"}),", or the ",(0,r.jsx)(n.code,{children:"chromedriver-wrapper/bin"})," folder must be in your ",(0,r.jsx)(n.code,{children:"$PATH"}),"."]}),"\n",(0,r.jsx)(n.h4,{id:"firefox",children:"Firefox"}),"\n",(0,r.jsxs)(n.p,{children:["You can download Mozilla Firefox from ",(0,r.jsx)(n.a,{href:"https://www.mozilla.org/en-US/firefox/new/",children:"https://www.mozilla.org/en-US/firefox/new/"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:["You will need the ",(0,r.jsx)(n.a,{href:"https://github.com/mozilla/geckodriver/releases",children:"correct version of geckodriver"})," as per the ",(0,r.jsx)(n.a,{href:"https://firefox-source-docs.mozilla.org/testing/geckodriver/Support.html",children:"documentation"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"geckodriver"})," binary must be in a directory in your ",(0,r.jsx)(n.code,{children:"$PATH"}),"."]}),"\n",(0,r.jsx)(n.h3,{id:"setting-up-moodle",children:"Setting up Moodle"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Create a new ",(0,r.jsx)(n.code,{children:"dataroot"})," area for files especially for behat"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Set the following in your Moodle ",(0,r.jsx)(n.code,{children:"config.php"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"$CFG->behat_dataroot = '/path/to/the/dataroot/you/created';\n$CFG->behat_wwwroot = 'http://127.0.0.1/path/to/your/site';\n$CFG->behat_prefix = 'beh_';\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["We recommend that you also include the ",(0,r.jsx)(n.code,{children:"behat-browser-config"})," if you have not done so already."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"require_once('/path/to/moodle-browser-config/init.php');\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.admonition,{title:"About the behat_wwwroot",type:"note",children:[(0,r.jsxs)(n.p,{children:["You will need to set the ",(0,r.jsx)(n.code,{children:"behat_wwwroot"})," to your Moodle site, but it ",(0,r.jsx)(n.strong,{children:"must"})," use a different value to your ",(0,r.jsx)(n.code,{children:"$CFG->wwwroot"}),"."]}),(0,r.jsxs)(n.p,{children:["One common way to do this is to use ",(0,r.jsx)(n.code,{children:"127.0.0.1"})," for behat, but ",(0,r.jsx)(n.code,{children:"localhost"})," for standard use. Alternatively you can add an additional hostname in your ",(0,r.jsx)(n.code,{children:"/etc/hosts"})," file and use this instead."]}),(0,r.jsxs)(n.p,{children:["If you use Docker, then you may be able to use ",(0,r.jsx)(n.code,{children:"host.docker.internal"})," where your site is hosted on the docker host"]})]}),"\n",(0,r.jsx)(n.h3,{id:"configure-behat-for-moodle",children:"Configure Behat for Moodle"}),"\n",(0,r.jsx)(n.p,{children:"After setting your configuration, you can simply initialise behat:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-console",children:"php admin/tool/behat/cli/init.php\n"})}),"\n",(0,r.jsx)(n.p,{children:"This will install all required Composer dependencies, install a new Moodle site, and put configuration in place"}),"\n",(0,r.jsx)(n.p,{children:"When it finishes it will give advice on how to run Behat."}),"\n",(0,r.jsx)(n.h3,{id:"run-behat-tests",children:"Run Behat tests"}),"\n",(0,r.jsxs)(n.admonition,{type:"warning",children:[(0,r.jsx)(n.p,{children:"Before running behat, ensure that your Selenium server is running."}),(0,r.jsx)(n.p,{children:"The easiest way to run behat, and test that everything works is by simply running it using the command provided when you\ninitialised Behat. If you didn't make a note of it, you can just run the initialisation again."})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-console",children:"php admin/tool/behat/cli/init.php\n"})}),"\n",(0,r.jsx)(n.p,{children:"This will give you a command which you can then run. This command will run every behat scenario, which will take a considerable amount of time. This command will look a bit like this:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-console",children:"vendor/bin/behat --config /Users/nicols/Sites/moodles/sm/moodledata_behat/behatrun/behat/behat.yml\n"})}),"\n",(0,r.jsxs)(n.p,{children:["To make this more useful you an combine it with flags, for example to only run certain ",(0,r.jsx)(n.code,{children:"tags"})," or for a specific Behat Feature file, or Scenario."]}),"\n",(0,r.jsxs)(n.p,{children:["To run all features/scenarios which are tagged with ",(0,r.jsx)(n.code,{children:"mod_forum"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-console",children:"vendor/bin/behat --config /Users/nicols/Sites/moodles/sm/moodledata_behat/behatrun/behat/behat.yml --tags=@mod_forum\n"})}),"\n",(0,r.jsx)(n.p,{children:"To run one specific feature file:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-console",children:"vendor/bin/behat --config /Users/nicols/Sites/moodles/sm/moodledata_behat/behatrun/behat/behat.yml `pwd`/mod/forum/tests/behat/private_replies.feature\n"})}),"\n",(0,r.jsx)(n.p,{children:"To run one specific scenario within a feature file:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-console",metastring:'title="To run the Scenario on line 38 of the file"',children:"vendor/bin/behat --config /Users/nicols/Sites/moodles/sm/moodledata_behat/behatrun/behat/behat.yml `pwd`/mod/forum/tests/behat/private_replies.feature:38\n"})}),"\n",(0,r.jsx)(n.p,{children:"To run one specific scenario by name:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-console",children:'vendor/bin/behat --config /Users/nicols/Sites/moodles/sm/moodledata_behat/behatrun/behat/behat.yml --name="As a teacher I can see my own response"\n'})}),"\n",(0,r.jsx)(n.p,{children:"See the upstream documentation on Behat, and Gherkin filters for more information."}),"\n",(0,r.jsx)(n.h4,{id:"running-using-a-different-browser",children:"Running using a different browser"}),"\n",(0,r.jsxs)(n.p,{children:["The default browser in Behat is ",(0,r.jsx)(n.strong,{children:"Firefox"}),". To specify a different browser profile, you can add the ",(0,r.jsx)(n.code,{children:"--profile"})," argument. For example, to use Chrome in Headless mode:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-console",children:"vendor/bin/behat --config /Users/nicols/Sites/moodles/sm/moodledata_behat/behatrun/behat/behat.yml --profile=headlesschrome\n"})}),"\n",(0,r.jsx)(n.admonition,{type:"tip",children:(0,r.jsxs)(n.p,{children:["If you are using the ",(0,r.jsx)(n.code,{children:"moodle-browser-config"})," utility, then you can use any profile listed in ",(0,r.jsx)(n.a,{href:"/moodledevdocs/general/development/tools/behat/running#pre-configured-browser-profiles-moodle-browser-config",children:"moodle-browser-config"}),". Otherwise you can write your own browser profile configuration."]})}),"\n",(0,r.jsx)(n.h3,{id:"advanced-testing",children:"Advanced testing"}),"\n",(0,r.jsx)(n.h4,{id:"run-tests-without-selenium-chromedriver-geckodriver",children:"Run tests without Selenium (chromedriver, geckodriver)"}),"\n",(0,r.jsxs)(n.p,{children:["Historically, Behat required Selenium server, however browsers now make use of their own automation layer. For example, Firefox uses ",(0,r.jsx)(n.code,{children:"Geckodriver"})," and Chrome uses ",(0,r.jsx)(n.code,{children:"Chromedriver"}),". As a result the use of Selenium itself is now optional."]}),"\n",(0,r.jsx)(n.p,{children:"The moodle-browser-config tool includes standard profiles to use these drivers directly and without the use of Selenium."}),"\n",(0,r.jsxs)(n.p,{children:["To use the drivers directly, you must run the driver itself, for example to run ",(0,r.jsx)(n.code,{children:"chromedriver"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-console",children:"chromedriver\n"})}),"\n",(0,r.jsxs)(n.p,{children:["To run ",(0,r.jsx)(n.code,{children:"geckodriver"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-console",children:"geckodriver\n"})}),"\n",(0,r.jsx)(n.admonition,{type:"note",children:(0,r.jsx)(n.p,{children:"geckodriver runs on port 4444 by default. You cannot geckodriver at the same time as selenium."})}),"\n",(0,r.jsx)(n.p,{children:"After starting your preferred browser, you can then run behat and specify an alternative profile, for example:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-console",children:"vendor/bin/behat --config /Users/nicols/Sites/moodles/sm/moodledata_behat/behatrun/behat/behat.yml --profile=geckodriver\n"})}),"\n",(0,r.jsx)(n.h4,{id:"headless-browsers",children:"Headless browsers"}),"\n",(0,r.jsx)(n.p,{children:"There are a number of reasons that you may prefer to use a headless browser. It can be particularly helpful if you are running the tests on a remote system, for example over SSH, or if you do not want to be interrupted by browsers popping up on your machine."}),"\n",(0,r.jsx)(n.p,{children:"The following headless profiles are some of those provided in the moodle-browser-config tool as standard:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"headlessfirefox"})," Use Firefox via Selenium, without displaying the GUI"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"headlessgeckodriver"})," Use Firefox with Geckodriver directly, without displaying the GUI"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"headlesschrome"})," Use Chrome via Selenium, without displaying the GUI"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"headlesschromedriver"})," Use Chrome with Chromedriver directly, without displaying the GUI\nThese can be provided to the ",(0,r.jsx)(n.code,{children:"--profile"})," argument to behat:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-console",children:"vendor/bin/behat --config /Users/nicols/Sites/moodles/sm/moodledata_behat/behatrun/behat/behat.yml --profile=headlesschrome\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"parallel-runs",children:"Parallel runs"}),"\n",(0,r.jsx)(n.p,{children:"Out-of-the-box, Moodle will configure Behat to run a single Moodle installation with all tests run in series. This is great for developer use where you are running a single test. or a small suite of tests. However this can be quite slow. A lot of time is spent waiting in Behat for things to happen. This may be for a page to load, for additional content to load, or even explicit waits because some interactions must be deliberately slowed down. As a result, a system running behat will not have a particularly high load most of the time."}),"\n",(0,r.jsxs)(n.p,{children:["If you want to run a large suite of tests then it is possible to take advantage of the relatively low resource consumption by running several behat runners in parallel. This is commonly referred to as a ",(0,r.jsx)(n.strong,{children:"Parallel run"}),"."]}),"\n",(0,r.jsx)(n.p,{children:"A parallel run of behat takes the same codebase and creates several installations rather than just a single Moodle installation. The behat Feature files are then grouped and allocated between each of the separate installations."}),"\n",(0,r.jsx)(n.p,{children:"To support this, each of the parallels runs needs its own:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"behat_wwwroot"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"behat_dataroot"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"database"})}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["Rather than using an entirely separate database, the same database is actually used, but a different ",(0,r.jsx)(n.code,{children:"behat_prefix"})," is used to prefix the table names in the database differently."]}),"\n",(0,r.jsx)(n.h5,{id:"installation-1",children:"Installation"}),"\n",(0,r.jsx)(n.p,{children:"The Behat initialisation command is responsible for preparing Moodle to run a standard run. You'll have used this before when installing for a standard run:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-console",children:"php admin/tool/behat/cli/init.php\n"})}),"\n",(0,r.jsxs)(n.p,{children:["The same command can be used to prepare Moodle for a parallel run by specifying the ",(0,r.jsx)(n.code,{children:"--parallel"})," or ",(0,r.jsx)(n.code,{children:"-j"})," parameter:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-console",metastring:'title="Below command will initialise moodle to run 3 parallel tests."',children:"php admin/tool/behat/cli/init.php --parallel=3\n"})}),"\n",(0,r.jsxs)(n.p,{children:["This can be combined with the ",(0,r.jsx)(n.code,{children:"--add-core-features-to-theme"})," or ",(0,r.jsx)(n.code,{children:"-a"})," flag to prepare Behat to run with all installed themes."]}),"\n",(0,r.jsx)(n.p,{children:"A number of advanced options are also available but you are unlikely to need these:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"-m=<number>"})," or ",(0,r.jsx)(n.code,{children:"--maxruns=<number>"})," Max parallel site which should be initialised at one time. If your system is slow, then you can initialise sites in chucks."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"--fromrun=<number>"})," Initialise site to run specified run from. Used for running acceptance tests on different vms"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"--torun=<number>"})," Initialise site to run specified run till. Used for running acceptance tests on different vms"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"-o"})," or ",(0,r.jsx)(n.code,{children:"--optimize-runs"})," This option will split features with specified tags in all parallel runs, so they are executed first when parallel run gets executed.\nYou can view details of all of these using the ",(0,r.jsx)(n.code,{children:"--help"})," flag to ",(0,r.jsx)(n.code,{children:"admin/tool/behat/cli/init.php"})]}),"\n"]}),"\n",(0,r.jsx)(n.h5,{id:"running-parallel-tests",children:"Running Parallel tests"}),"\n",(0,r.jsxs)(n.p,{children:["You can use the Moodle behat runner to run all tests, including Standard runs. It is an intelligent wrapper around the standard ",(0,r.jsx)(n.code,{children:"./vendor/bin/behat"})," command which specifies the configuration file, and other required features."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-console",children:"php admin/tool/behat/cli/run.php\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Many of the standard options and parameters that can be passed to ",(0,r.jsx)(n.code,{children:"./vendor/bin/behat"})," can also be passed to the Moodle runner, for example:"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"--tags"})," Run tests which match the specified tags"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:'--name="Scenario name"'})," Run a test matching the supplied scenario name"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:'--feature="/path/to/test.feature"'})," Run a specific feature file."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"--suite"})," Features for specified theme will be executed.\nThe runner also includes a number of custom parameters relating to parallel runs:"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"--replace"})," Replace args string with run process number, useful for output and reruns."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"--fromrun"})," Execute run starting from (Used for parallel runs on different vms)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"--torun"})," Execute run till (Used for parallel runs on different vms)\nThe ",(0,r.jsx)(n.code,{children:"--replace"})," feature is particularly useful and can be used to replace a string in the command with the run number. This is useful when specifying output formats, and rerun files as noted below."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"The following example demonstrates how Behat might be initialised with three parallel runs, to run on all themes:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-console",children:"php admin/tool/behat/cli/init.php --parallel=3 --add-core-features-to-theme\n"})}),"\n",(0,r.jsxs)(n.p,{children:["And then to run all tests matching the ",(0,r.jsx)(n.code,{children:"@tool_myplugin"})," tag, against the ",(0,r.jsx)(n.code,{children:"classic"})," theme:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-console",children:'php admin/tool/behat/cli/run.php --tags="@tool_myplugin" --suite="classic"\n'})}),"\n",(0,r.jsx)(n.h5,{id:"custom-parameters-for-parallel-runs",children:"Custom parameters for parallel runs"}),"\n",(0,r.jsx)(n.p,{children:"You can set following custom config options for parallel runs via $CFG->behat_parallel_run. It's an array of options where 1st array is for 1st run and so on."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"$CFG->behat_parallel_run = [\n        [\n           'dbtype' => 'mysqli',\n           'dblibrary' => 'native',\n           'dbhost' => 'localhost',\n           'dbname' => 'moodletest',\n           'dbuser' => 'moodle',\n           'dbpass' => 'moodle',\n           'behat_prefix' => 'mdl_',\n           'wd_host' => 'http://127.0.0.1:4444/wd/hub',\n           'behat_wwwroot' => 'http://127.0.0.1/moodle',\n           'behat_dataroot' => '/home/example/bht_moodledata'\n       ],\n       // ...\n],\n"})}),"\n",(0,r.jsx)(n.p,{children:"To set different selenium servers for parallel runs, you can use following."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"$CFG->behat_parallel_run = [\n        [=> 'http://127.0.0.1:4444/wd/hub']('wd_host'),\n        [=> 'http://127.0.0.1:4445/wd/hub']('wd_host'),\n        [=> 'http://127.0.0.1:4446/wd/hub']('wd_host'),\n];\n"})}),"\n",(0,r.jsx)(n.admonition,{type:"tip",children:(0,r.jsx)(n.p,{children:"Running parallel (headless) runs on different selenium servers avoid random focus failures."})}),"\n",(0,r.jsx)(n.h4,{id:"tests-filters",children:"Tests filters"}),"\n",(0,r.jsxs)(n.p,{children:["With the ",(0,r.jsx)(n.code,{children:"--tags"})," or the ",(0,r.jsx)(n.code,{children:"-name"})," Behat options you can filter which tests are going to run or which ones are going to be skipped. There are a few tags that you might be interested in:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"@javascript"}),": All the tests that runs in a browser using JavaScript; they require Selenium or the browser's own automation layer, as per ",(0,r.jsx)(n.a,{href:"/moodledevdocs/general/development/tools/behat/running#run-tests-without-selenium-chromedriver-geckodriver",children:"Run tests without Selenium"})," to be running, otherwise an exception will be thrown."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"@_file_upload"}),": All the tests that involves file uploading or any OS feature that is not 100% part of the browser. They should only be executed when Selenium is running in the same machine where the tests are running."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"@_alert"}),": All the tests that involves JavaScript dialogs (alerts, confirms...) are using a feature that is OS-dependant and out of the browser scope, so they should be tag appropriately as not all browsers manage them properly."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"@_switch_window"}),": All the tests that are using the ",(0,r.jsx)(n.code,{children:'I switch to "NAME" window'})," step should be tagged as not all browsers manage them properly."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"@_switch_iframe"}),": All the tests that are using the ",(0,r.jsx)(n.code,{children:'I switch to "NAME" iframe'})," steps should be tagged as it is an advanced feature and some browsers may have problems dealing with them"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"@_cross_browser"}),": All the tests that should run against multiple combinations of browsers + OS in a regular basis. The features that are sensitive to different combinations of OS and browsers should be tagged as @_cross_browser."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"@componentname"}),": Moodle features uses the ",(0,r.jsx)(n.a,{href:"/moodledevdocs/general/development/policies/codingstyle/frankenstyle",children:"Frankenstyle"})," component name to tag the features according to the Moodle subsystem they belong to."]}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"output-formats",children:"Output formats"}),"\n",(0,r.jsx)(n.p,{children:"Behat is able to output in a number of different formats, and to different locations as required."}),"\n",(0,r.jsxs)(n.p,{children:["This can be achieved by specifying the ",(0,r.jsx)(n.code,{children:"--format"}),", and ",(0,r.jsx)(n.code,{children:"--out"})," parameters when running behat, for example:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-console",metastring:"title=\"Run behat, using the 'pretty' format and outputting the value to /tmp/pretty.txt\"",children:"vendor/bin/behat --config /Users/nicols/Sites/moodles/sm/moodledata_behat/behatrun/behat/behat.yml \\\n        --format=pretty --out=/tmp/pretty.txt\n"})}),"\n",(0,r.jsx)(n.p,{children:"It is also possible to output to multiple formats simultaneously by repeating the arguments, for example:"}),"\n",(0,r.jsx)(n.p,{children:"Since Moodle 3.1 option for output is:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-console",children:"vendor/bin/behat --config /Users/nicols/Sites/moodles/sm/moodledata_behat/behatrun/behat/behat.yml \\\n        --format=pretty --out=/tmp/pretty.txt \\\n        --format=moodle_progress --out=std\n"})}),"\n",(0,r.jsx)(n.p,{children:"The following output formats are supported:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"progress"}),": Prints one character per step."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"pretty"}),": Prints the feature as is."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"junit"}),": Outputs the failures in JUnit compatible files."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"moodle_progress"}),": Prints Moodle branch information and dots for each step."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"moodle_list"}),": List all scenarios."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"moodle_stepcount"}),": List all features with total steps in each feature file. Used for parallel run."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"moodle_screenshot"}),": Take screenshot and core dump of each step. With following options you can dump either or both."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:'--format-settings \'{"formats": "image"}\''}),": will dump image only"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:'--format-settings \'{"formats": "html"}\''}),": will dump html only."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:'--format-settings \'{"formats": "html,image"}\''}),": will dump both."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:'--format-settings \'{"formats": "html", "dir_permissions": "0777"}\''}),"\nNote: If you want to see the failures immediately (rather than waiting ~3 hours for all the tests to finish) then either use the ",(0,r.jsx)(n.code,{children:"-v"})," option to output a bit more information, or change the output format using ",(0,r.jsx)(n.code,{children:"--format"}),". Format ",(0,r.jsx)(n.code,{children:"pretty"})," (",(0,r.jsx)(n.strong,{children:"-f pretty"}),") is sufficient for most cases, as it outputs each step outcomes in the command line making easier to see the progress."]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["When working with parallel runs, you may wish to have an output for each run. If you were to specify a standard path for this then each of the parallel runs would overwrite the others file. The ",(0,r.jsx)(n.code,{children:"--replace"})," option allows this to be handled:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-console",children:'admin/tool/behat/cli/run.php \\\n        --replace="{runprocess}" \\\n        --format=pretty --out=/tmp/pretty_{runprocess}.txt \\\n        --format=moodle_progress --out=std\n'})}),"\n",(0,r.jsxs)(n.p,{children:["In this example, the ",(0,r.jsx)(n.code,{children:"--replace"})," argument is provided with a value of ",(0,r.jsx)(n.code,{children:"{runprocess}"}),". Anywhere that ",(0,r.jsx)(n.code,{children:"{runprocess}"})," appears in the command it will be replaced with the run number. The above command will generate a set of commands like:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-console",children:"vendor/bin/behat --config /Users/nicols/Sites/moodles/sm/moodledata_behat/behatrun1/behat/behat.yml \\\n        --format=pretty --out=/tmp/pretty_1.txt \\\n        --format=moodle_progress --out=std\n\nvendor/bin/behat --config /Users/nicols/Sites/moodles/sm/moodledata_behat/behatrun2/behat/behat.yml \\\n        --format=pretty --out=/tmp/pretty_2.txt \\\n        --format=moodle_progress --out=std\n\nvendor/bin/behat --config /Users/nicols/Sites/moodles/sm/moodledata_behat/behatrun3/behat/behat.yml \\\n        --format=pretty --out=/tmp/pretty_3.txt \\\n        --format=moodle_progress --out=std\n"})}),"\n",(0,r.jsx)(n.h4,{id:"rerun-failed-scenarios",children:"Rerun failed scenarios"}),"\n",(0,r.jsx)(n.p,{children:"With slow systems or parallel run you may experience see some random failures. These may happen when your system is too slow, when it is too fast, or where a page depends on external dependencies."}),"\n",(0,r.jsxs)(n.p,{children:["To help with this it is possible to rerun any failed scenarios using the ",(0,r.jsx)(n.code,{children:"--rerun"})," option to Behat."]}),"\n",(0,r.jsx)(n.p,{children:"The following example runs Behat with the rerun option:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-console",children:"vendor/bin/behat --config /Users/nicols/Sites/moodles/sm/moodledata_behat/behatrun/behat/behat.yml \\\n        --format=pretty --out=/tmp/pretty.txt \\\n        --format=moodle_progress --out=std \\\n        --rerun\n"})}),"\n",(0,r.jsx)(n.p,{children:"If any single test fails then the command will return a non-zero exit code. Running the same command again will mean that only failed scenarios are run."}),"\n",(0,r.jsx)(n.p,{children:"For a parallel run it can be called as follows:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-console",children:'admin/tool/behat/cli/run.php \\\n        --replace="{runprocess}" \\\n        --format=pretty --out=/tmp/pretty_{runprocess}.txt \\\n        --format=moodle_progress --out=std \\\n        --rerun\n'})}),"\n",(0,r.jsx)(n.admonition,{type:"tip",children:(0,r.jsxs)(n.p,{children:["The Moodle behat runner also includes an ",(0,r.jsx)(n.code,{children:"--auto-rerun"})," option which will automatically rerun failed scenarios exactly once."]})}),"\n",(0,r.jsx)(n.h4,{id:"running-behat-with-specified-theme",children:"Running behat with specified theme"}),"\n",(0,r.jsxs)(n.p,{children:["Behat can be run with any installed theme, but it must be initialised with the ",(0,r.jsx)(n.code,{children:"-a"})," or ",(0,r.jsx)(n.code,{children:"--add-core-features-to-theme"})," option first."]}),"\n",(0,r.jsxs)(n.p,{children:["After configuring the theme can be specified using the ",(0,r.jsx)(n.code,{children:"--suite"})," parameter."]}),"\n",(0,r.jsxs)(n.admonition,{type:"note",children:[(0,r.jsxs)(n.p,{children:["The default theme in Moodle (boost) has the suite name ",(0,r.jsx)(n.code,{children:"default"}),"."]}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-console",metastring:'title="Initialise Behat for all themes"',children:"php admin/tool/behat/cli/init.php --add-core-features-to-theme\n"})}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-console",metastring:'title="Run Behat against all initalised themes"',children:"vendor/bin/behat --config /Users/nicols/Sites/moodles/sm/moodledata_behat/behatrun/behat/behat.yml\n"})}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-console",metastring:'title="Run Behat against just the default theme when all themes were initialised"',children:"vendor/bin/behat --config /Users/nicols/Sites/moodles/sm/moodledata_behat/behatrun/behat/behat.yml --suite=default\n"})}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-console",metastring:"title=\"Run Behat against just the 'classic' theme when all themes were initialised\"",children:"vendor/bin/behat --config /Users/nicols/Sites/moodles/sm/moodledata_behat/behatrun/behat/behat.yml --suite=classic\n"})})]}),"\n",(0,r.jsx)(n.h4,{id:"using-docker-to-start-selenium-server",children:"Using Docker to start selenium server"}),"\n",(0,r.jsx)(n.p,{children:"There are a wide range of docker images available which contain a browser with Selenium. You will probably be using the official SeleniumHQ images unless you have a specific reason not to."}),"\n",(0,r.jsxs)(n.p,{children:["The complete list of available SeleniumHQ images is available at ",(0,r.jsx)(n.a,{href:"https://hub.docker.com/u/selenium/",children:"https://hub.docker.com/u/selenium/"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:["Moodle uses the ",(0,r.jsx)(n.em,{children:"standalone"})," version and any recent version with version 3.141.59 or higher is supported."]}),"\n",(0,r.jsx)(n.p,{children:"For any test which uploads files, for example when interacting with the filepicker, you must also ensure that the Moodle directory is mounted as on your local filesystem."}),"\n",(0,r.jsx)(n.p,{children:"An example usage is:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-console",children:"docker run -d -p 4444:4444 -v `pwd`:`pwd` selenium/standalone-firefox:latest\n"})}),"\n",(0,r.jsx)(n.h4,{id:"change-configphp-file",children:"Change config.php file"}),"\n",(0,r.jsxs)(n.p,{children:["In the Moodle ",(0,r.jsx)(n.code,{children:"config.php"})," file you must change the ",(0,r.jsx)(n.code,{children:"$CFG->behat_wwwroot"})," to an address that can be reached from within the docker image."]}),"\n",(0,r.jsxs)(n.p,{children:["You cannot use ",(0,r.jsx)(n.code,{children:"localhost"})," or ",(0,r.jsx)(n.code,{children:"127.0.0.1"})," as this will be the IP address of the docker container itself."]}),"\n",(0,r.jsxs)(n.p,{children:["On some more recent versions of Docker you can use ",(0,r.jsx)(n.code,{children:"http://host.docker.internal/"}),", for example if my site is located at ",(0,r.jsx)(n.code,{children:"/sm"})," on my development machine, I can set the following:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"$CFG->behat_wwwroot = 'http://host.docker.internal/sm';\n"})}),"\n",(0,r.jsx)(n.h4,{id:"manually-configuring-other-browsers",children:"Manually configuring other browsers"}),"\n",(0,r.jsxs)(n.p,{children:["If you would prefer not to use the ",(0,r.jsx)(n.code,{children:"moodle-browser-config"})," tool but still wish to specify different browsers then you can do so using the ",(0,r.jsx)(n.code,{children:"$CFG->behat_profiles"})," array. Each key/value pair contains a profile name, and the configuration for that profile. For example:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"$CFG->behat_profiles = [\n        'chrome' => [\n            'browser' => 'chrome',\n            'tags' => '@javascript',\n        ],\n];\n"})}),"\n",(0,r.jsxs)(n.p,{children:["See ",(0,r.jsx)(n.a,{href:"/moodledevdocs/general/development/tools/behat/browsers/",children:"alternative browsers"})," for more details."]}),"\n",(0,r.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,r.jsx)(n.h3,{id:"increasing-timeouts",children:"Increasing timeouts"}),"\n",(0,r.jsx)(n.p,{children:"You may see errors such as:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"   Javascript code and/or AJAX requests are not ready after 10 seconds.\n   There is a Javascript error or the code is extremely slow.\n"})}),"\n",(0,r.jsx)(n.p,{children:"Sometimes this indicates a genuine problem with the code, but if you are using a slow computer, it may just mean that your browser did not finish generating parts of the UI before behat tried was finished."}),"\n",(0,r.jsx)(n.p,{children:"If you find that this happens regularly on different scenarios then you may want to increase the timeout:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"$CFG->behat_increasetimeout = 2;\n"})}),"\n",(0,r.jsx)(n.p,{children:"This will increase all the timeouts by a factor of 2; if that isn't sufficient, you could use 3."}),"\n",(0,r.jsx)(n.p,{children:"Increasing timeouts will make tests run a bit slower (because there are points where Behat waits up to a timeout to make sure something doesn't happen) so don't do this unless you need to."}),"\n",(0,r.jsx)(n.admonition,{type:"note",children:(0,r.jsx)(n.p,{children:"This is usually an indicator that your development machine is not well tuned. A better option would be to find out where the bottleneck is. This is usually the database configuration."})}),"\n",(0,r.jsx)(n.h3,{id:"new-step-definitions-or-features-are-not-executed",children:"New step definitions or features are not executed"}),"\n",(0,r.jsx)(n.p,{children:"If you are adding new tests or steps definitions update the tests list"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-console",children:"php admin/tool/behat/cli/util.php --enable\n"})}),"\n",(0,r.jsx)(n.admonition,{type:"tip",children:(0,r.jsx)(n.p,{children:"For parallel runs, all options for initialising parallel runs are valid"})}),"\n",(0,r.jsx)(n.h3,{id:"tests-are-failing",children:"Tests are failing"}),"\n",(0,r.jsxs)(n.p,{children:["If you followed all the steps and you receive an unknown weird error probably your browser version is not compatible with the Selenium version you are running. Please refer to ",(0,r.jsx)(n.a,{href:"/moodledevdocs/general/development/tools/behat/browsers/#compatibility",children:"Working combinations"})," to run the acceptance test."]}),"\n",(0,r.jsx)(n.h3,{id:"the-tests-are-failing-and-the-error-message-is-completely-useless",children:"The tests are failing, and the error message is completely useless"}),"\n",(0,r.jsx)(n.p,{children:'For example, it just says "Error writing to database" with no stack trace.'}),"\n",(0,r.jsxs)(n.p,{children:["Add ",(0,r.jsx)(n.code,{children:"-vv"})," command-line option to get very verbose output."]}),"\n",(0,r.jsx)(n.h3,{id:"errors-during-setup-before-test-are-launched",children:"Errors during setup (before test are launched)"}),"\n",(0,r.jsx)(n.p,{children:"Typical errors are:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Behat requirement not satisfied: ",(0,r.jsx)(n.a,{href:"http://127.0.0.1/m/stable_master",children:"http://127.0.0.1/m/stable_master"})," is not available, ensure you specified correct url and that the server is set up and started."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"init.php"})," or ",(0,r.jsx)(n.code,{children:"util.php"})," complain that ",(0,r.jsx)(n.code,{children:'"Unknown error 1 This is not a behat test site!"'}),".  Delete the behat ",(0,r.jsx)(n.code,{children:"wwwroot"})," (look in ",(0,r.jsx)(n.code,{children:"config.php"})," for ",(0,r.jsx)(n.code,{children:"$CFG->behat_dataroot"}),") and drop the behat DB tables (look in ",(0,r.jsx)(n.code,{children:"config.php"})," for ",(0,r.jsx)(n.code,{children:"$CFG->behat_prefix"}),").  Then try again."]}),"\n",(0,r.jsxs)(n.li,{children:["Behat is configured but not enabled on this test site.\nIn order to fix those errors please check that: the ",(0,r.jsx)(n.code,{children:"behat_dataroot"})," has correct write permissions and that the ",(0,r.jsx)(n.code,{children:"$CFG->behat*"})," variables are placed before the ",(0,r.jsx)(n.code,{children:"lib/setup.php"})," include:"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-php",children:"require_once(__DIR__ . '/lib/setup.php');\n"})}),"\n",(0,r.jsx)(n.h3,{id:"selenium-server-is-not-running",children:"Selenium server is not running"}),"\n",(0,r.jsx)(n.h4,{id:"chrome-specific",children:"Chrome specific"}),"\n",(0,r.jsxs)(n.p,{children:["If you are using chrome, you need to ensure that the driver matches the version of the installed chrome browser \u2013 which may change on OS updates/upgrades. Moodle or Selenium will not give the appropriate message \u2013 see ",(0,r.jsx)(n.a,{href:"https://tracker.moodle.org/browse/MDL-67659/",children:"MDL-67659"}),". One solution is the one suggested in the issue and use Andrew Nicols' ",(0,r.jsx)(n.a,{href:"https://github.com/andrewnicols/chromedriver-wrapper/",children:"Chromedriver Wrapper"})," which will ensure you have the appropriate driver before running the tests."]}),"\n",(0,r.jsx)(n.h2,{id:"examples",children:"Examples"}),"\n",(0,r.jsx)(n.h3,{id:"quick-setup-and-testing-using-moodle-docker",children:"Quick setup and testing using moodle-docker"}),"\n",(0,r.jsx)(n.p,{children:"This is a quick guide to help locally pass tests for your developments, before submitting them:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Set up a default Moodle install using ",(0,r.jsx)(n.a,{href:"https://github.com/moodlehq/moodle-docker",children:"moodle-docker"}),", with the database and Moodle version of your choice. See its README for more details. This will start some docker containers."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Initialize behat to start testing with this command, from the webserver container:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-console",children:"php admin/tool/behat/cli/init.php\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Run the behat test of your choice, from the webserver container. For instance:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-console",children:"vendor/bin/behat --config /var/www/behatdata/behatrun/behat/behat.yml --tags tool_task\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"And you'll see something like:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'Moodle 4.0dev (Build: 20210507), 0b47ea0a44a092f9000729ca7b15fff23111538b\nPhp: 7.3.26, mysqli: 5.7.21, OS: Linux 5.4.0-66-generic x86_64\nRun optional tests:\n\nAccessibility: No\nServer OS "Linux", Browser: "firefox"\nStarted at 09-05-2021, 06:00\n...................................................................... 70\n...............................\n12 scenarios (12 passed)\n101 steps (101 passed)\n2m53.27s (47.61Mb)\n'})}),"\n",(0,r.jsx)(n.h2,{id:"see-also",children:"See also"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/moodledevdocs/general/app/development/testing/acceptance-testing",children:"Acceptance testing for the mobile app"})}),"\n",(0,r.jsxs)(n.li,{children:["Vagrant profile with Moodle and Behat preconfigured: ",(0,r.jsx)(n.a,{href:"https://github.com/mackensen/moodle-hat",children:"https://github.com/mackensen/moodle-hat"})]}),"\n",(0,r.jsxs)(n.li,{children:["Docker containers for Moodle Developers and Behat: ",(0,r.jsx)(n.a,{href:"https://github.com/moodlehq/moodle-docker",children:"https://github.com/moodlehq/moodle-docker"})]}),"\n",(0,r.jsxs)(n.li,{children:["Docker environment with Behat preconfigured : ",(0,r.jsx)(n.a,{href:"https://github.com/tobiga/docker_moodle_environment",children:"https://github.com/tobiga/docker_moodle_environment"})]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}}}]);
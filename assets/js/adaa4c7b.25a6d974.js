"use strict";(self.webpackChunkdevdocs=self.webpackChunkdevdocs||[]).push([[53442],{42067:(e,i,s)=>{s.r(i),s.d(i,{assets:()=>r,contentTitle:()=>t,default:()=>u,frontMatter:()=>l,metadata:()=>a,toc:()=>c});var o=s(74848),n=s(28453),d=s(78924);const l={title:"SQL injection",sidebar_position:5,tags:["Coding guidelines","Policies","Security"]},t=void 0,a={id:"development/policies/security/sql-injection",title:"SQL injection",description:"This page forms part of the Moodle security guidelines.",source:"@site/general/development/policies/security/sql-injection.md",sourceDirName:"development/policies/security",slug:"/development/policies/security/sql-injection",permalink:"/moodledevdocs/general/development/policies/security/sql-injection",draft:!1,unlisted:!1,editUrl:"https://github.com/moodle/devdocs/edit/main/general/development/policies/security/sql-injection.md",tags:[{label:"Coding guidelines",permalink:"/moodledevdocs/general/tags/coding-guidelines"},{label:"Policies",permalink:"/moodledevdocs/general/tags/policies"},{label:"Security",permalink:"/moodledevdocs/general/tags/security"}],version:"current",lastUpdatedBy:"Andrew Nicols",lastUpdatedAt:171272905e4,sidebarPosition:5,frontMatter:{title:"SQL injection",sidebar_position:5,tags:["Coding guidelines","Policies","Security"]},sidebar:"coding",previous:{title:"Cross-site scripting",permalink:"/moodledevdocs/general/development/policies/security/crosssite-scripting"},next:{title:"Command-line injection",permalink:"/moodledevdocs/general/development/policies/security/commandline-injection"}},r={},c=[{value:"What is the danger?",id:"what-is-the-danger",level:2},{value:"How Moodle avoids this problem",id:"how-moodle-avoids-this-problem",level:2},{value:"What you need to do in your code",id:"what-you-need-to-do-in-your-code",level:2},{value:"What you need to do as an administrator",id:"what-you-need-to-do-as-an-administrator",level:2},{value:"See also",id:"see-also",level:2}];function h(e){const i={a:"a",admonition:"admonition",code:"code",h2:"h2",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,n.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(d.A,{frontMatter:l,metadata:a}),"\n",(0,o.jsx)(i.admonition,{type:"note",children:(0,o.jsxs)(i.p,{children:["This page forms part of the ",(0,o.jsx)(i.a,{href:"../security",children:"Moodle security guidelines"}),"."]})}),"\n",(0,o.jsx)(i.h2,{id:"what-is-the-danger",children:"What is the danger?"}),"\n",(0,o.jsxs)(i.p,{children:["Suppose your code in ",(0,o.jsx)(i.code,{children:"/course/view.php?id=123"})," does something like:"]}),"\n",(0,o.jsx)(i.pre,{children:(0,o.jsx)(i.code,{className:"language-sql",children:"SELECT FROM mdl_course WHERE id = $id;\n"})}),"\n",(0,o.jsxs)(i.p,{children:["where the ",(0,o.jsx)(i.code,{children:"$id = 123"})," has come from the URL. Suppose that your code does not bother to clean that parameter properly."]}),"\n",(0,o.jsxs)(i.p,{children:["Along comes Evil Hacker, and edits the URL to be ",(0,o.jsx)(i.code,{children:"/course/view.php?id=123;DELETE+FROM+mdl_user"}),"\nI will let you work out why that is a very, very bad thing."]}),"\n",(0,o.jsx)(i.p,{children:"Of course, depending on exactly what the database query is, the malicious input needs to be constructed appropriately, but that is just a matter of trial and error for Evil Hacker."}),"\n",(0,o.jsx)(i.h2,{id:"how-moodle-avoids-this-problem",children:"How Moodle avoids this problem"}),"\n",(0,o.jsxs)(i.p,{children:["Once again, it is a case of being very suspicious of any input that came from outside Moodle. In the example above, ",(0,o.jsx)(i.code,{children:"$id"})," should clearly have been cleaned by passing ",(0,o.jsx)(i.code,{children:"PARAM_INT"})," to ",(0,o.jsx)(i.code,{children:"required_param"}),"."]}),"\n",(0,o.jsx)(i.p,{children:"It is more tricky with a query like"}),"\n",(0,o.jsx)(i.pre,{children:(0,o.jsx)(i.code,{className:"language-sql",children:"UPDATE mdl_user SET lastname = '$lastname' WHERE id = $id;\n"})}),"\n",(0,o.jsxs)(i.p,{children:["What happens when ",(0,o.jsx)(i.code,{children:"$lastname"})," is ",(0,o.jsx)(i.code,{children:"O'Brian"}),"? Well, you have to escape the ' like this: ",(0,o.jsx)(i.code,{children:"O\\\\'Brian"}),"."]}),"\n",(0,o.jsxs)(i.ul,{children:["\n",(0,o.jsxs)(i.li,{children:["In Moodle 1.9, ",(0,o.jsx)(i.code,{children:"addslashes"})," is applied automatically to all input you get via ",(0,o.jsx)(i.code,{children:"required_param"})," or ",(0,o.jsx)(i.code,{children:"optional_param"}),"."]}),"\n",(0,o.jsx)(i.li,{children:"Moodle 2.0 onwards, completely avoid the dangerous process of building SQL by concatenating strings. In Moodle 2.0 the SQL would look like"}),"\n"]}),"\n",(0,o.jsx)(i.pre,{children:(0,o.jsx)(i.code,{className:"language-sql",children:"UPDATE mdl_user SET lastname = ? WHERE id = ?;\n"})}),"\n",(0,o.jsxs)(i.p,{children:["and then we would pass an array of values ",(0,o.jsx)(i.code,{children:"[$lastname, $id]"})," to the database along with the SQL."]}),"\n",(0,o.jsx)(i.h2,{id:"what-you-need-to-do-in-your-code",children:"What you need to do in your code"}),"\n",(0,o.jsxs)(i.ul,{children:["\n",(0,o.jsxs)(i.li,{children:["Use higher level ",(0,o.jsx)(i.code,{children:"dmllib"})," methods, like ",(0,o.jsx)(i.code,{children:"get_record"}),", whenever possible, so you do not have to create SQL yourself."]}),"\n",(0,o.jsxs)(i.li,{children:["When you have to insert values into SQL statements, ",(0,o.jsx)(i.strong,{children:"use place-holders"})," to insert the values safely."]}),"\n",(0,o.jsxs)(i.li,{children:["Test your code by using a tool like ",(0,o.jsx)(i.a,{href:"https://sqlmap.org/",children:"sqlmap"}),", or by manually trying tricky inputs like:",(0,o.jsx)("br",{}),"\n",(0,o.jsx)(i.code,{children:"< > & \\&lt; \\&gt; \\&amp; ' \\\\' \u7881 \\ \\\\"})]}),"\n"]}),"\n",(0,o.jsx)(i.p,{children:"In Moodle 1.9 or earlier:"}),"\n",(0,o.jsxs)(i.ul,{children:["\n",(0,o.jsxs)(i.li,{children:["Data from ",(0,o.jsx)(i.code,{children:"required_param"})," and ",(0,o.jsx)(i.code,{children:"optional_param"})," have already had ",(0,o.jsx)(i.code,{children:"addslashes"})," applied, ready to be used in database queries, but make sure you put single quotes round each value."]}),"\n",(0,o.jsxs)(i.li,{children:["If you have loaded some data from the database, and then want to re-insert it, then apply ",(0,o.jsx)(i.code,{children:"addslashes"})," or ",(0,o.jsx)(i.code,{children:"addslashes_object"})," to it first."]}),"\n"]}),"\n",(0,o.jsx)(i.h2,{id:"what-you-need-to-do-as-an-administrator",children:"What you need to do as an administrator"}),"\n",(0,o.jsxs)(i.ul,{children:["\n",(0,o.jsx)(i.li,{children:"This is not something that administrators can do anything about (other than keeping your Moodle up-to-date)."}),"\n"]}),"\n",(0,o.jsx)(i.h2,{id:"see-also",children:"See also"}),"\n",(0,o.jsxs)(i.ul,{children:["\n",(0,o.jsx)(i.li,{children:(0,o.jsx)(i.a,{href:"../security",children:"Security"})}),"\n",(0,o.jsx)(i.li,{children:(0,o.jsx)(i.a,{href:"/moodledevdocs/general/development/policies",children:"Coding"})}),"\n",(0,o.jsxs)(i.li,{children:[(0,o.jsx)(i.a,{href:"https://sqlmap.org",children:"https://sqlmap.org"})," - A tool for automatically finding SQL injection vulnerabilities."]}),"\n"]})]})}function u(e={}){const{wrapper:i}={...(0,n.R)(),...e.components};return i?(0,o.jsx)(i,{...e,children:(0,o.jsx)(h,{...e})}):h(e)}}}]);
"use strict";(self.webpackChunkdevdocs=self.webpackChunkdevdocs||[]).push([[20142],{49358:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>r,default:()=>h,frontMatter:()=>l,metadata:()=>a,toc:()=>c});var t=s(74848),o=s(28453),i=s(78924);const l={title:"NodeJS and Grunt"},r=void 0,a={id:"development/tools/nodejs",title:"NodeJS and Grunt",description:"Moodle uses a NodeJS toolchain to perform a number of development actions, including linting, transpilation of JavaScript, compilation of the Component Library, and a number of other routine tasks.",source:"@site/general/development/tools/nodejs.md",sourceDirName:"development/tools",slug:"/development/tools/nodejs",permalink:"/moodledevdocs/general/development/tools/nodejs",draft:!1,unlisted:!1,editUrl:"https://github.com/moodle/devdocs/edit/main/general/development/tools/nodejs.md",tags:[],version:"current",lastUpdatedBy:"Andrew Nicols",lastUpdatedAt:1712757252e3,frontMatter:{title:"NodeJS and Grunt"},sidebar:"coding",previous:{title:"Metadata",permalink:"/moodledevdocs/general/development/tools/metadata/"},next:{title:"PHP CodeSniffer",permalink:"/moodledevdocs/general/development/tools/phpcs"}},d={},c=[{value:"Setup and installation",id:"setup-and-installation",level:2},{value:"Install NVM and Node",id:"install-nvm-and-node",level:3},{value:"Install local development dependencies",id:"install-local-development-dependencies",level:3},{value:"Grunt",id:"grunt",level:2},{value:"Install grunt",id:"install-grunt",level:3},{value:"Running grunt",id:"running-grunt",level:3},{value:"Install watchman",id:"install-watchman",level:3},{value:"Using Grunt in additional plugins",id:"using-grunt-in-additional-plugins",level:3},{value:"Common issues",id:"common-issues",level:2},{value:"MacOS issues",id:"macos-issues",level:3},{value:"Issues install node-sass",id:"issues-install-node-sass",level:4}];function u(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(i.A,{frontMatter:l,metadata:a}),"\n",(0,t.jsxs)(n.p,{children:["Moodle uses a ",(0,t.jsx)(n.a,{href:"https://nodejs.org/en/",children:"NodeJS"})," toolchain to perform a number of development actions, including linting, transpilation of JavaScript, compilation of the Component Library, and a number of other routine tasks."]}),"\n",(0,t.jsxs)(n.p,{children:["Use of ",(0,t.jsx)(n.a,{href:"#install-nvm-and-node",children:"NVM"})," for installation of NodeJS is highly recommended over direct installation."]}),"\n",(0,t.jsx)(n.h2,{id:"setup-and-installation",children:"Setup and installation"}),"\n",(0,t.jsx)(n.h3,{id:"install-nvm-and-node",children:"Install NVM and Node"}),"\n",(0,t.jsxs)(n.p,{children:["The recommended way of installing NodeJS is via the ",(0,t.jsx)(n.a,{href:"https://github.com/nvm-sh/nvm",children:"Node Version Manager"}),", or NVM. NVM allows you to have several different versions of NodeJS installed and in-use at once on your computer."]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["For Linux and Mac, follow ",(0,t.jsx)(n.a,{href:"https://github.com/nvm-sh/nvm#installing-and-updating",children:"https://github.com/nvm-sh/nvm#installing-and-updating"})]}),"\n",(0,t.jsxs)(n.li,{children:["For Windows, use ",(0,t.jsx)(n.a,{href:"https://github.com/coreybutler/nvm-windows/releases",children:"https://github.com/coreybutler/nvm-windows/releases"})," -- Note! NVM 1.1.7 for Windows has bugs. You should upgrade to at least 1.1.9.)"]}),"\n"]}),"\n",(0,t.jsxs)(n.admonition,{title:"Checking that NVM is working",type:"tip",children:[(0,t.jsx)(n.p,{children:"You can confirm that NVM is working by checking the version, for example:"}),(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"$ nvm --version\n 0.35.3\n"})})]}),"\n",(0,t.jsxs)(n.p,{children:["Moodle provides a ",(0,t.jsx)(n.code,{children:".nvmrc"})," file which can be used to automatically install the correct version of NodeJS for the current directory."]}),"\n",(0,t.jsxs)(n.p,{children:["After you have installed ",(0,t.jsx)(n.em,{children:"NVM"}),", you can install the correct version of NodeJS by running the following commands from your Moodle directory:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:'title="Installing the version of NodeJS for the current directory"',children:"nvm install\nnvm use\n"})}),"\n",(0,t.jsxs)(n.admonition,{title:"Using the correct NodeJS version for your current directory",type:"tip",children:[(0,t.jsxs)(n.p,{children:["Rather than remembering to update the system version of NodeJS, you can instead have your environment install and use the correct version when you change into a directory containing a ",(0,t.jsx)(n.code,{children:".nvmrc"}),"."]}),(0,t.jsxs)(n.p,{children:["The approach for this will depend on your environment and ",(0,t.jsx)(n.a,{href:"https://github.com/nvm-sh/nvm#deeper-shell-integration",children:"advice is available for a range of environments from the NVM project"}),"."]})]}),"\n",(0,t.jsx)(n.h3,{id:"install-local-development-dependencies",children:"Install local development dependencies"}),"\n",(0,t.jsxs)(n.p,{children:["The Moodle JavaScript toolchain currently uses the Grunt build tool, along with other common tooling including eslint. To install these build dependencies, you should use the ",(0,t.jsx)(n.a,{href:"https://www.npmjs.com/",children:"Node Package Manager"}),", or NPM."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:'title="Installing all dependencies"',children:"npm install\n"})}),"\n",(0,t.jsx)(n.admonition,{type:"note",children:(0,t.jsx)(n.p,{children:"You may see mention of various vulnerabilities here. Moodle only uses these tools during development for activities including transpilation and to check code. These dependencies are not used in client code where these vulnerabilities are typically reported."})}),"\n",(0,t.jsx)(n.h2,{id:"grunt",children:"Grunt"}),"\n",(0,t.jsxs)(n.p,{children:["As part of its build stack, Moodle uses the ",(0,t.jsx)(n.a,{href:"https://gruntjs.com",children:"Grunt"})," task runner."]}),"\n",(0,t.jsxs)(n.admonition,{type:"info",children:[(0,t.jsx)(n.p,{children:"Grunt is a command line tool used to prepare our JavaScript and CSS for production usage. After making any change to JavaScript or CSS files in Moodle, you must run grunt to lint, minify and package the JavaScript/CSS properly so that it can be served by Moodle."}),(0,t.jsxs)(n.p,{children:["Grunt is composed of a set of tasks, defined within the Moodle code repository in the ",(0,t.jsx)(n.code,{children:"Gruntfile.js"})," file, and a grunt CLI tool which must also be installed."]})]}),"\n",(0,t.jsxs)(n.p,{children:["Once you have installed the local development dependencies, you can simply run grunt using ",(0,t.jsx)(n.code,{children:"npx"}),", for example:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"$ npx grunt stylelin\n"})}),"\n",(0,t.jsx)(n.h3,{id:"install-grunt",children:"Install grunt"}),"\n",(0,t.jsxs)(n.p,{children:["JavaScript and CSS in Moodle must be processed by some build tools before they will be visible to the web browser. Grunt is a build tool written in JavaScript that runs in the ",(0,t.jsx)(n.a,{href:"http://nodejs.org/",children:"nodejs"})," environment. You will need to install NodeJS and the Grunt tools:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:'title="Installing grunt"',children:"nvm install && nvm use\nnpm install\nnpm install -g grunt-cli\n"})}),"\n",(0,t.jsx)(n.h3,{id:"running-grunt",children:"Running grunt"}),"\n",(0,t.jsx)(n.p,{children:"Typical commands:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'grunt amd                               # Alias for "ignorefiles", "eslint:amd", "rollup"\ngrunt js                                # Alias for "amd", "yui" tasks.\ngrunt css                               # Alias for "scss", "rawcss" tasks.\ngrunt shifter                           # Run Shifter\ngrunt componentlibrary                  # Build the component library\ngrunt eslint --show-lint-warnings       # Show pedantic lint warnings for JS\ngrunt                                   # Try to do the right thing:\n                                        # * If you are in a folder called amd, do grunt amd\n                                        # * If you are in a folder called yui/src/something, do grunt shifter\n                                        # * Otherwise build everything (grunt css js).\ngrunt watch                             # Run tasks on file changes\n'})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"On Linux/Mac it will build everything in the current folder and below."}),"\n",(0,t.jsxs)(n.li,{children:["You need to cd into the amd folder of your module root, for example ",(0,t.jsx)(n.code,{children:"dirroot/blocks/foo/amd"}),", before running ",(0,t.jsx)(n.code,{children:"grunt amd"})," (this will compile only your plugins AMD source files)."]}),"\n",(0,t.jsxs)(n.li,{children:["You can make output more verbose by adding ",(0,t.jsx)(n.code,{children:"-v"})," parameter."]}),"\n",(0,t.jsxs)(n.li,{children:["If used with ",(0,t.jsx)(n.code,{children:"grunt shifter"})," you will have to ",(0,t.jsx)(n.code,{children:"cd"})," into the ",(0,t.jsx)(n.code,{children:"module/yui/src"})," folder, and to show what your lint errors are you can also use the ",(0,t.jsx)(n.code,{children:"-v"})," parameter."]}),"\n",(0,t.jsxs)(n.li,{children:["On Windows, you need to specify the path on the command line like ",(0,t.jsx)(n.code,{children:"--root=admin/tool/templatelibrary"}),"."]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"install-watchman",children:"Install watchman"}),"\n",(0,t.jsxs)(n.p,{children:['If you get an error when running "grunt watch" complaining about ',(0,t.jsx)(n.code,{children:"watchman"}),", you most likely need to install it. Check out the ",(0,t.jsx)(n.a,{href:"https://facebook.github.io/watchman/docs/install.html",children:"watchman installation"})," page."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:'title="Installing watchman from source in Linux/Mac"',children:"$ git clone https://github.com/facebook/watchman.git -b v4.9.0 --depth 1\n$ cd watchman\n$ ./autogen.sh\n$ ./configure\n$ make\n$ sudo make install\n"})}),"\n",(0,t.jsxs)(n.p,{children:["If you're on Linux, you may also want to make sure that ",(0,t.jsx)(n.code,{children:"fs.inotify.max_user_watches"})," is set in ",(0,t.jsx)(n.code,{children:"/etc/sysctl.conf"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"fs.inotify.max_user_watches = 524288\n"})}),"\n",(0,t.jsxs)(n.p,{children:["And then reload running ",(0,t.jsx)(n.code,{children:"sudo sysctl -p"}),"."]}),"\n",(0,t.jsx)(n.h3,{id:"using-grunt-in-additional-plugins",children:"Using Grunt in additional plugins"}),"\n",(0,t.jsxs)(n.p,{children:["You may want to use Grunt for performing tasks in your custom Moodle plugins. For building AMD and YUI modules in a plugin, the standard configuration ",(0,t.jsx)(n.code,{children:"Gruntfile.js"})," located in the Moodle root should work well. For building CSS files, you will have to set up a separate Grunt installation in the root of your plugin."]}),"\n",(0,t.jsxs)(n.p,{children:["If you do not have it yet, create the ",(0,t.jsx)(n.code,{children:"package.json"})," file in the root of your plugin:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",metastring:'title="package.json"',children:'    {\n        "name": "moodle-plugintype_pluginname"\n    }\n'})}),"\n",(0,t.jsxs)(n.p,{children:["Install grunt, grunt sass and grunt watch modules. Note that you should put the folder ",(0,t.jsx)(n.code,{children:"node_modules"})," into your plugin's ",(0,t.jsx)(n.code,{children:".gitignore"})," file, too."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:'title="Installing grunt and grunt modules"',children:"    $ cd /path/to/your/plugin/root\n    $ npm install --save-dev grunt grunt-contrib-sass grunt-contrib-watch grunt-load-gruntfile grunt-contrib-clean\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Create a ",(0,t.jsx)(n.code,{children:"Gruntfile.js"})," in the root of your plugin and configure the task for building CSS files from SCSS files:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:'"use strict";\n\nmodule.exports = function (grunt) {\n\n    // We need to include the core Moodle grunt file too, otherwise we can\'t run tasks like "amd".\n    require("grunt-load-gruntfile")(grunt);\n    grunt.loadGruntfile("../../Gruntfile.js");\n\n    // Load all grunt tasks.\n    grunt.loadNpmTasks("grunt-contrib-sass");\n    grunt.loadNpmTasks("grunt-contrib-watch");\n    grunt.loadNpmTasks("grunt-contrib-clean");\n\n    grunt.initConfig({\n        watch: {\n            // If any .scss file changes in directory "scss" then run the "sass" task.\n            files: "scss/*.scss",\n            tasks: ["sass"]\n        },\n        sass: {\n            // Production config is also available.\n            development: {\n                options: {\n                    // Saas output style.\n                     style: "expanded",\n                    // Specifies directories to scan for @import directives when parsing.\n                    // Default value is the directory of the source, which is probably what you want.\n                    loadPath: ["myOtherImports/"]\n                },\n                files: {\n                    "styles.css": "scss/styles.scss"\n                }\n            },\n            prod:{\n                options: {\n                    // Saas output style.\n                    style: "compressed",\n                    // Specifies directories to scan for @import directives when parsing.\n                    // Default value is the directory of the source, which is probably what you want.\n                    loadPath: ["myOtherImports/"]\n                },\n                files: {\n                    "styles-prod.css": "scss/styles.scss"\n                }\n            }\n        }\n    });\n    // The default task (running "grunt" in console).\n    grunt.registerTask("default", ["sass:development"]);\n    // The production task (running "grunt prod" in console).\n    grunt.registerTask("prod", ["sass:prod"]);\n};\n\n'})}),"\n",(0,t.jsxs)(n.p,{children:["Now running ",(0,t.jsx)(n.code,{children:"grunt"})," or ",(0,t.jsx)(n.code,{children:"grunt css"})," in your plugin root folder will compile the file and saves it as ",(0,t.jsx)(n.code,{children:"styles.css"}),'. Running "grunt watch" will watch the scss/*.scss files and if some is changed, it will immediately rebuild the CSS file.']}),"\n",(0,t.jsxs)(n.p,{children:["If you are working on a custom theme, you may have multiple ",(0,t.jsx)(n.code,{children:"scss/*.scss"})," files that you want to compile to their ",(0,t.jsx)(n.code,{children:"style/*.css"})," counterparts. You can either define an explicit list all such file pairs, or let that list be created for you by making use of ",(0,t.jsxs)(n.a,{href:"http://gruntjs.com/configuring-tasks#building-the-files-object-dynamically",children:["expand",":true"," feature"]})," of ",(0,t.jsx)(n.code,{children:"Gruntfile.js"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:'// This dynamically creates the list of files to be processed.\nfiles: [\n    {\n        expand: true,\n        cwd: "scss/",\n        src: "*.scss",\n        dest: "style/",\n        ext: ".css"\n    }\n]\n'})}),"\n",(0,t.jsx)(n.h2,{id:"common-issues",children:"Common issues"}),"\n",(0,t.jsx)(n.p,{children:"A number of commons issues may be encountered depending on your environment."}),"\n",(0,t.jsx)(n.h3,{id:"macos-issues",children:"MacOS issues"}),"\n",(0,t.jsx)(n.p,{children:"If you are using MacOS, you may need to ensure that xcode is up-to-date."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:'title="Resetting xcode"',children:"sudo xcode-select --reset\n"})}),"\n",(0,t.jsx)(n.h4,{id:"issues-install-node-sass",children:"Issues install node-sass"}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"node-sass"})," module must be compiled from C. In some instances MacOS setup is incomplete or out-of-date and must be updated."]}),"\n",(0,t.jsx)(n.p,{children:"The following is a typical error that may be reported in this situation:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:'title="Example error installing node-sass on MacOS"',children:"npm ERR! code 1\nnpm ERR! path /Users/jun/Work/moodles/integration_master/moodle/node_modules/node-sass\nnpm ERR! command failed\nnpm ERR! command sh /var/folders/87/fnlrch612m5d40trk64lrd480000gn/T/postinstall-a2316f45.sh\nnpm ERR! Building: /Users/jun/.nvm/versions/node/v16.17.0/bin/node /Users/jun/Work/moodles/integration_master/moodle/node_modules/node-gyp/bin/node-gyp.js rebuild --verbose --libsass_ext= --libsass_cflags= --libsass_ldflags= --libsass_library=\nnpm ERR! make: Entering directory '/Users/jun/Work/moodles/integration_master/moodle/node_modules/node-sass/build'\n"})}),"\n",(0,t.jsx)(n.p,{children:"To address this issue, you can run the following command to ensure that the xcode build system is fully configured:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:'title="Configuring xcodebuild"',children:"xcodebuild -runFirstLaunch\n"})})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(u,{...e})}):u(e)}}}]);
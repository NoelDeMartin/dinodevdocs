"use strict";(self.webpackChunkdevdocs=self.webpackChunkdevdocs||[]).push([[44401],{30459:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>h,frontMatter:()=>o,metadata:()=>d,toc:()=>c});var n=a(74848),s=a(28453),i=a(78924);const o={title:"Tag API",tags:["API","Sub System","Tag","Tags"]},r=void 0,d={id:"apis/subsystems/tag/index",title:"Tag API",description:"The Tag API allows you to assign labels to information in Moodle. This makes finding this information easier and also facilitates the grouping of similar information. The Tag API allows you to create, modify, delete and search tags in the Moodle system. The main tag related functions can be found in the tag/classes/tag.php file. For a thorough overview of all of the functions available for working with Tags please see methods in coretagtag, coretagcollection and coretagarea classes, however, the following examples should give you a general understanding of how to get started with tags.",source:"@site/versioned_docs/version-4.3/apis/subsystems/tag/index.md",sourceDirName:"apis/subsystems/tag",slug:"/apis/subsystems/tag/",permalink:"/moodledevdocs/docs/4.3/apis/subsystems/tag/",draft:!1,unlisted:!1,editUrl:"https://github.com/moodle/devdocs/edit/main/versioned_docs/version-4.3/apis/subsystems/tag/index.md",tags:[{label:"API",permalink:"/moodledevdocs/docs/4.3/tags/api"},{label:"Sub System",permalink:"/moodledevdocs/docs/4.3/tags/sub-system"},{label:"Tag",permalink:"/moodledevdocs/docs/4.3/tags/tag"},{label:"Tags",permalink:"/moodledevdocs/docs/4.3/tags/tags"}],version:"4.3",lastUpdatedBy:"Sara Arjona",lastUpdatedAt:1697795601e3,frontMatter:{title:"Tag API",tags:["API","Sub System","Tag","Tags"]},sidebar:"docs",previous:{title:"Roles API",permalink:"/moodledevdocs/docs/4.3/apis/subsystems/roles"},next:{title:"Task API",permalink:"/moodledevdocs/docs/4.3/apis/subsystems/task/"}},l={},c=[{value:"Tag API usage",id:"tag-api-usage",level:2},{value:"Defining a tag area",id:"defining-a-tag-area",level:3},{value:"Adding tags element to the editing form",id:"adding-tags-element-to-the-editing-form",level:3},{value:"Displaying tags next to the item",id:"displaying-tags-next-to-the-item",level:3},{value:"Deleting and clearing tags",id:"deleting-and-clearing-tags",level:3},{value:"Example",id:"example",level:4},{value:"Backup and restore",id:"backup-and-restore",level:3},{value:"Search callback",id:"search-callback",level:3},{value:"User-specific tags",id:"user-specific-tags",level:3},{value:"Advanced usages",id:"advanced-usages",level:3},{value:"See also",id:"see-also",level:2}];function g(e){const t={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(i.A,{frontMatter:o,metadata:d}),"\n",(0,n.jsxs)(t.p,{children:["The Tag API allows you to assign labels to information in Moodle. This makes finding this information easier and also facilitates the grouping of similar information. The Tag API allows you to create, modify, delete and search tags in the Moodle system. The main tag related functions can be found in the ",(0,n.jsx)(t.code,{children:"tag/classes/tag.php file"}),". For a thorough overview of all of the functions available for working with Tags please see methods in ",(0,n.jsx)(t.code,{children:"core_tag_tag"}),", ",(0,n.jsx)(t.code,{children:"core_tag_collection"})," and ",(0,n.jsx)(t.code,{children:"core_tag_area classes"}),", however, the following examples should give you a general understanding of how to get started with tags."]}),"\n",(0,n.jsx)(t.h2,{id:"tag-api-usage",children:"Tag API usage"}),"\n",(0,n.jsxs)(t.p,{children:["When a user tags something a ",(0,n.jsx)(t.strong,{children:"tag instance"})," is created in the database linking the item to the actual ",(0,n.jsx)(t.strong,{children:"tag"}),". If the tag did not exist before it is created automatically. Do not confuse these two entities - deleting the tag instance does not normally delete tag, however deleting tag deletes all tag instances associated with it."]}),"\n",(0,n.jsxs)(t.p,{children:["Developers define ",(0,n.jsx)(t.strong,{children:"tag areas"})," the areas that can be tagged, examples are:"]}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:"blog posts"}),"\n",(0,n.jsx)(t.li,{children:"courses"}),"\n",(0,n.jsx)(t.li,{children:"users (tags represent user interests)"}),"\n",(0,n.jsx)(t.li,{children:"activity modules"}),"\n",(0,n.jsx)(t.li,{children:"questions"}),"\n",(0,n.jsx)(t.li,{children:"wiki pages"}),"\n"]}),"\n",(0,n.jsxs)(t.p,{children:["Each tag area is identified by two attributes - component and itemtype. ",(0,n.jsx)(t.em,{children:"Itemtype must be a name of a table in the database."})," Component is the core component or plugin responsible for the tagging. This way the same DB table (for example 'user' or 'course') may be independently tagged by several components. Administrator or manager is able to manage the tag areas, collections and tags inside them on the ",(0,n.jsx)(t.a,{href:"https://docs.moodle.org/en/Managing_tags",children:"Managing tags"})," page. Users are able to search tags and view all items tagged with them that they have access to."]}),"\n",(0,n.jsx)(t.h3,{id:"defining-a-tag-area",children:"Defining a tag area"}),"\n",(0,n.jsxs)(t.p,{children:["First, developer must define the tag areas in the file ",(0,n.jsx)(t.strong,{children:"db/tag.php"}),". This will usually look like:"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-php",children:"$tagareas = [\n    [\n        // The name of the database table (without prefix).\n        'itemtype' => 'wiki_pages',\n        // The full frankenstyle name of the plugin.\n        // Note: This can be omitted for plugins.\n        'component' => 'mod_wiki',\n        'callback' => 'mod_wiki_get_tagged_pages',\n        'callbackfile' => '/mod/wiki/locallib.php',\n    ],\n];\n"})}),"\n",(0,n.jsxs)(t.p,{children:["You will also need to add language string, for the example above it will be ",(0,n.jsx)(t.code,{children:"$string['tagarea_wiki_pages'] = 'Wiki pages';"})]}),"\n",(0,n.jsx)(t.admonition,{type:"note",children:(0,n.jsxs)(t.p,{children:['There are more options such as specifying the default value for "Standard tags", having a fixed collection or excluding from search. They can be found in comments in ',(0,n.jsx)(t.a,{href:"/moodledevdocs/docs/4.3/apis/commonfiles/tag.php/",children:"Core library tag.php"})]})}),"\n",(0,n.jsx)(t.admonition,{type:"important",children:(0,n.jsxs)(t.p,{children:["After making changes to ",(0,n.jsx)(t.code,{children:"db/tag.php"}),", you must bump the plugin version in ",(0,n.jsx)(t.strong,{children:"version.php"})," and perform a Moodle upgrade."]})}),"\n",(0,n.jsx)(t.h3,{id:"adding-tags-element-to-the-editing-form",children:"Adding tags element to the editing form"}),"\n",(0,n.jsx)(t.p,{children:'After the tag area is defined it should appear on the "Manage tags" page. Now it is time to allow users to add/change tags when editing the item. Here is an example from Wiki module:'}),"\n",(0,n.jsxs)(t.ol,{children:["\n",(0,n.jsx)(t.li,{children:"Add a 'tags' form element to the editing form:"}),"\n"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-php",children:"$mform->addElement(\n    'tags',\n    'tags',\n    get_string('tags'),\n    [\n        'itemtype' => 'wiki_pages',\n        'component' => 'mod_wiki',\n    ]\n);\n"})}),"\n",(0,n.jsx)(t.p,{children:"This element will automatically check if the tag area is disabled by the manager and will not display anything in this case. However if you want to add a header you need to check if tag area is enabled add this:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-php",children:"if (core_tag_tag::is_enabled('mod_wiki', 'wiki_pages')) {\n    $mform->addElement('header', 'tagshdr', get_string('tags', 'tag'));\n}\n"})}),"\n",(0,n.jsx)(t.p,{children:"Given the above you can move to the next step."}),"\n",(0,n.jsxs)(t.ol,{children:["\n",(0,n.jsx)(t.li,{children:"Save the form data"}),"\n"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-php",children:"if ($data = $form->get_data()) {\n   // Do some other processing here,\n   // if this is a new page (item) you need to insert it in the DB and obtain id.\n   // $pageid = $data->id;\n   core_tag_tag::set_item_tags(\n       'mod_wiki',\n       'wiki_pages',\n       $pageid,\n       $modulecontext,\n       $data->tags\n   );\n}\n"})}),"\n",(0,n.jsxs)(t.p,{children:["It is important to specify the correct context in this function. Note that ",(0,n.jsx)(t.code,{children:"$data->tags"})," will always be returned by the form, even if the area is disabled, however, ",(0,n.jsx)(t.code,{children:"core_tag_tag::set_item_tags()"})," will not change or reset tags if the tag area is disabled."]}),"\n",(0,n.jsxs)(t.ol,{children:["\n",(0,n.jsx)(t.li,{children:"Populate the form with existing tags before calling $form->set_data($data):"}),"\n"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-php",children:"$data = $DB->get_record('wiki_pages', ['id' => $this->page->id]); // Well, it's more complicated than that of course....\n$data->tags = core_tag_tag::get_item_tags_array('mod_wiki', 'wiki_pages', $this->page->id);\n$form->set_data($data);\n"})}),"\n",(0,n.jsx)(t.admonition,{type:"tip",children:(0,n.jsx)(t.p,{children:"Always test the code with tag area enabled and disabled."})}),"\n",(0,n.jsx)(t.h3,{id:"displaying-tags-next-to-the-item",children:"Displaying tags next to the item"}),"\n",(0,n.jsx)(t.p,{children:"Example of displaying of the tags are user interests on the user profile page. User can see the list of interests, each of them is a link that leads to the page that shows all items tagged with this tag."}),"\n",(0,n.jsx)(t.p,{children:"Here is the code used by Wiki module to display tags the page is tagged with:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-php",children:"echo $OUTPUT->tag_list(\n    core_tag_tag::get_item_tags(\n        'mod_wiki',\n        'wiki_pages',\n        $page->id\n    ),\n    null,\n    'wiki-tags'\n);\n"})}),"\n",(0,n.jsx)(t.admonition,{type:"important",children:(0,n.jsxs)(t.p,{children:["To prevent an performance regression, Use ",(0,n.jsx)(t.code,{children:"core_tag_tag::get_items_tags()"})," to fetch tags against multiple item ids."]})}),"\n",(0,n.jsx)(t.h3,{id:"deleting-and-clearing-tags",children:"Deleting and clearing tags"}),"\n",(0,n.jsx)(t.p,{children:"Cron will automatically remove tag instances that point to non existing items, however it is a good habit to delete tags when the record is deleted."}),"\n",(0,n.jsx)(t.admonition,{type:"note",children:(0,n.jsx)(t.p,{children:"If you have created a course activity that uses tags you should also remember to delete the tags during a course reset by adding code to the reset course callbacks. First you want to add a checkbox that a user can check if they wish to delete the tags, then code that handles the case when the checkbox has been checked."})}),"\n",(0,n.jsx)(t.h4,{id:"example",children:"Example"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-php",metastring:'title="What does this example do, and why is it in the "Deleting and clearing tags" section?',children:"/**\n * The elements to add the course reset form.\n *\n * @param moodleform $mform\n */\nfunction book_reset_course_form_definition(&$mform) {\n    $mform->addElement('header', 'bookheader', get_string('modulenameplural', 'book'));\n    $mform->addElement('checkbox', 'reset_book_tags', get_string('removeallbooktags', 'book'));\n}\n\n/**\n * This function is used by the reset_course_userdata function in moodlelib.\n * @param $data the data submitted from the reset course.\n * @return array status array\n */\nfunction book_reset_userdata($data) {\n    global $DB;\n\n    $status = [];\n\n    if (!empty($data->reset_book_tags)) {\n        // Loop through the books and remove the tags from the chapters.\n        if ($books = $DB->get_records('book', ['course' => $data->courseid])) {\n            foreach ($books as $book) {\n                if (!$cm = get_coursemodule_from_instance('book', $book->id)) {\n                    continue;\n                }\n\n                $context = context_module::instance($cm->id);\n                core_tag_tag::delete_instances('mod_book', null, $context->id);\n            }\n        }\n\n        $status[] = [\n            'component' => get_string('modulenameplural', 'book'),\n            'item' => get_string('tagsdeleted', 'book'),\n            'error' => false\n        ];\n    }\n\n    return $status;\n}\n"})}),"\n",(0,n.jsx)(t.p,{children:"The functions used to delete the tags are:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-php",children:"// Removes all tag instances associated with an item.\ncore_tag_tag::remove_all_item_tags($component, $itemtype, $itemid, $tiuserid = 0);\n // Removes tag instances in bulk. Here $component is mandatory in this method,\n // either itemtype or contextid or neither or both can be specified.\ncore_tag_tag::delete_instances($component, $itemtype = null, $contextid = null);\n"})}),"\n",(0,n.jsx)(t.h3,{id:"backup-and-restore",children:"Backup and restore"}),"\n",(0,n.jsx)(t.p,{children:"When you tag contents inside the course the plugin has to hook into backup and restore and process necessary tags. This is especially important for the contents inside activity modules, such as wiki pages or forum posts. Questions in the course question bank also backup and restore their tags."}),"\n",(0,n.jsxs)(t.p,{children:["You can choose to backup and restore tags for each item individually (as it is done in mod_wiki) OR backup all tags in the context at once (as it is done in mod_glossary or mod_forum). Second option is preferable for performance reasons. Make sure to take into account ",(0,n.jsx)(t.code,{children:"$userinfo"})," (whether user information is backed up / restored), for example wiki pages is not user information but glossary entries are, tags on them follow the same rule."]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-php",metastring:'title="mod/glossary/backup_glossary_stepslib.php"',children:"protected function define_structure() {\n    // ...\n    $tags = new backup_nested_element('entriestags');\n    $tag = new backup_nested_element('tag', ['id'], ['itemid', 'rawname']);\n    // ...\n    // Note that parent node is the glossary, not glossary entry, however the individual entries are tagged.\n    $glossary->add_child($tags);\n    $tags->add_child($tag);\n    // ...\n    if ($userinfo && core_tag_tag::is_enabled('mod_glossary', 'glossary_entries')) {\n        $tag->set_source_sql('SELECT t.id, ti.itemid, t.rawname\n                                FROM {tag} t\n                                JOIN {tag_instance} ti ON ti.tagid = t.id\n                               WHERE ti.itemtype = ?\n                                 AND ti.component = ?\n                                 AND ti.contextid = ?', [\n            backup_helper::is_sqlparam('glossary_entries'),\n            backup_helper::is_sqlparam('mod_glossary'),\n            backup::VAR_CONTEXTID]);\n    }\n    // ...\n}\n"})}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-php",metastring:'title="mod/glossary/restore_glossary_stepslib.php"',children:"protected function define_structure() {\n    // ...\n    if ($userinfo) {\n        $paths[] = new restore_path_element('glossary_entry_tag', '/activity/glossary/entriestags/tag');\n    }\n    // ...\n}\n\nprotected function process_glossary_entry_tag($data) {\n    $data = (object)$data;\n\n    if (!core_tag_tag::is_enabled('mod_glossary', 'glossary_entries')) { // Tags disabled on this site, nothing to process.\n        return;\n    }\n\n    $tag = $data->rawname;\n    if (!$itemid = $this->get_mappingid('glossary_entry', $data->itemid)) {\n        // Orphaned tag, we could not find the glossary entry for it - ignore.\n        return;\n    }\n\n    $context = context_module::instance($this->task->get_moduleid());\n    core_tag_tag::add_item_tag('mod_glossary', 'glossary_entries', $itemid, $context, $tag);\n}\n"})}),"\n",(0,n.jsx)(t.h3,{id:"search-callback",children:"Search callback"}),"\n",(0,n.jsx)(t.p,{children:"Given a user searches for any items tagged with a specified tag, only the items that the user has access to must be returned."}),"\n",(0,n.jsxs)(t.p,{children:["To limit the performance impact of checking user access against items the following class ",(0,n.jsx)(t.code,{children:"core_tag_index_builder()"})," can assist with the retrieval and caching of records, especially within both course and activity modules."]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-php",children:"function mod_wiki_get_tagged_pages($tag, $exclusivemode = false, $fromctx = 0, $ctx = 0, $rec = 1, $page = 0) {\n    // Find items.\n    // Please refer to existing callbacks in core for examples.\n\n    // ...\n\n    // Use core_tag_index_builder to build and filter the list of items.\n    // Notice how we search for 6 items when we need to display 5 - this way we will know that we need to display a link to the next page.\n    $builder = new core_tag_index_builder('mod_wiki', 'wiki_pages', $query, $params, $page * $perpage, $perpage + 1);\n\n    // ...\n\n    $items = $builder->get_items();\n    if (count($items) > $perpage) {\n        // We don't need exact page count, just indicate that the next page exists.\n        $totalpages = $page + 2;\n        array_pop($items);\n    }\n\n    // Build the display contents.\n    if ($items) {\n        $tagfeed = new core_tag\\output\\tagfeed();\n        foreach ($items as $item) {\n            $tagfeed->add(...);\n        }\n\n        $content = $OUTPUT->render_from_template('core_tag/tagfeed', $tagfeed->export_for_template($OUTPUT));\n\n        return new core_tag\\output\\tagindex($tag, 'mod_wiki', 'wiki_pages', $content,\n                $exclusivemode, $fromctx, $ctx, $rec, $page, $totalpages);\n    }\n}\n"})}),"\n",(0,n.jsx)(t.h3,{id:"user-specific-tags",children:"User-specific tags"}),"\n",(0,n.jsxs)(t.p,{children:["It is possible that each tagged item can be tagged by each user independently. Before Moodle 3.0 this was how courses were tagged however from 3.0 tagging courses became more standard. The functionality remains in the API (argument ",(0,n.jsx)(t.code,{children:"$tiuser"})," to the tagging functions).  In this case both tag list and tag cloud will display all tag instances added by all users but each user will be able to edit only their own."]}),"\n",(0,n.jsx)(t.p,{children:'If developer chooses to implement it in the plugin, they need to also implement the UI when admin or other privileged user can remove or edit the instances of another user. Otherwise if teacher has tagged the course and later resigned there will be no way to change their tags. Also such tag instances need special treatment during backup and restore - they are now considered "user data" and user id mapping should be performed.'}),"\n",(0,n.jsx)(t.h3,{id:"advanced-usages",children:"Advanced usages"}),"\n",(0,n.jsxs)(t.p,{children:['Custom plugins may go beyond the standard tags handling and use them without mixing with regular course/user/wiki/blogs tags, hide them from the "Tag search" page and "Tags" block but instead have their own interface to search/categorise using tags. This can be achieved by defining tag collection, make it not searchable and specify a custom URL to link to when the tag is actually displayed. This all can be defined in db/tag.php, see the comments in ',(0,n.jsx)(t.a,{href:"/moodledevdocs/docs/4.3/apis/commonfiles/tag.php/",children:"Core library tag.php"})]}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.strong,{children:"tag_area::get_collection($component, $itemtype)"})," - will return you the collection that your tag area is in"]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.strong,{children:"tag_collection::get_tag_cloud()"})," - will return all tags in the collection. There are no API methods to get the tags used in the tag area - this is actually the purpose of tag collections."]}),"\n"]}),"\n",(0,n.jsx)(t.h2,{id:"see-also",children:"See also"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"/moodledevdocs/docs/4.3/apis",children:"Core APIs"})}),"\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"/moodledevdocs/docs/4.3/apis/commonfiles/tag.php/",children:"Core library tag.php"})}),"\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"https://docs.moodle.org/dev/Tag_API_before_3.1",children:"Tag API before 3.1"})}),"\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"https://docs.moodle.org/en/Managing_tags",children:"Managing tags"})}),"\n"]})]})}function h(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(g,{...e})}):g(e)}}}]);
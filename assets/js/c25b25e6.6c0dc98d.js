"use strict";(self.webpackChunkdevdocs=self.webpackChunkdevdocs||[]).push([[56511],{98445:(e,n,o)=>{o.r(n),o.d(n,{assets:()=>d,contentTitle:()=>s,default:()=>m,frontMatter:()=>l,metadata:()=>r,toc:()=>c});var a=o(74848),i=o(28453),t=o(78924);const l={title:"Modules",tags:["AJAX","Javascript","AMD","ESM"]},s=void 0,r={id:"guides/javascript/modules",title:"Modules",description:"A JavaScript module is a package of code that can be reliably used and shared with other code in a reusable format.",source:"@site/docs/guides/javascript/modules.md",sourceDirName:"guides/javascript",slug:"/guides/javascript/modules",permalink:"/moodledevdocs/docs/4.4/guides/javascript/modules",draft:!1,unlisted:!1,editUrl:"https://github.com/moodle/devdocs/edit/main/docs/guides/javascript/modules.md",tags:[{label:"AJAX",permalink:"/moodledevdocs/docs/4.4/tags/ajax"},{label:"Javascript",permalink:"/moodledevdocs/docs/4.4/tags/javascript"},{label:"AMD",permalink:"/moodledevdocs/docs/4.4/tags/amd"},{label:"ESM",permalink:"/moodledevdocs/docs/4.4/tags/esm"}],version:"current",lastUpdatedBy:"Andrew Nicols",lastUpdatedAt:1713332374e3,frontMatter:{title:"Modules",tags:["AJAX","Javascript","AMD","ESM"]},sidebar:"docs",previous:{title:"Modal Dialogues",permalink:"/moodledevdocs/docs/4.4/guides/javascript/modal/"},next:{title:"Creating a reactive UI",permalink:"/moodledevdocs/docs/4.4/guides/javascript/reactive/"}},d={},c=[{value:"Development mode",id:"development-mode",level:3},{value:"Transpiling Modules",id:"transpiling-modules",level:3},{value:"ES Modules",id:"es-modules",level:2},{value:"Export default",id:"export-default",level:3},{value:"Inline JavaScript",id:"inline-javascript",level:3},{value:"First module for your plugin",id:"first-module-for-your-plugin",level:2},{value:"&quot;Hello World&quot; I am a JavaScript Module",id:"hello-world-i-am-a-javascript-module",level:2},{value:"Advanced examples",id:"advanced-examples",level:2},{value:"Loading modules dynamically",id:"loading-modules-dynamically",level:3},{value:"Calling modules from a page",id:"calling-modules-from-a-page",level:2},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"npm-shrinkwrap.json sha1 / sha512 changes",id:"npm-shrinkwrapjson-sha1--sha512-changes",level:3},{value:"But I have a mega JS file I don&#39;t want loaded on every page?",id:"but-i-have-a-mega-js-file-i-dont-want-loaded-on-every-page",level:2}];function h(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components},{Since:o}=n;return o||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Since",!0),(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(t.A,{frontMatter:l,metadata:r}),"\n",(0,a.jsx)(n.p,{children:"A JavaScript module is a package of code that can be reliably used and shared with other code in a reusable format."}),"\n",(0,a.jsx)(n.p,{children:"By packaging your code as a module you break your code up into smaller reusable pieces. This is good because:"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsx)(n.li,{children:"Each smaller piece is simpler to understand, and debug"}),"\n",(0,a.jsx)(n.li,{children:"Each smaller piece is simpler to test"}),"\n",(0,a.jsx)(n.li,{children:"You can re-use common code instead of duplicating it"}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:["Since Moodle 3.10, any new JavaScript code written for Moodle core ",(0,a.jsx)(n.strong,{children:"must"})," be written in the ",(0,a.jsx)(n.a,{href:"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Modules",children:"ESM"})," format (commonly referred to as ES6). See  ",(0,a.jsx)(n.a,{href:"https://tracker.moodle.org/browse/MDLSITE-6130",children:"MDLSITE-6130"})," for further information."]}),"\n",(0,a.jsx)(n.p,{children:"For community code, we strongly recommend the use of ESMs, which have been supported since Moodle 3.8."}),"\n",(0,a.jsx)(n.admonition,{type:"note",children:(0,a.jsxs)(n.p,{children:["From Moodle versions 2.9 to 3.8, Moodle supported JavaScript modules written using the ",(0,a.jsx)(n.a,{href:"https://github.com/amdjs/amdjs-api/wiki/AMD",children:"AMD"})," API. This is a standard API for creating JavaScript modules and you will find many useful third party libraries that are already using this format. This format is still widely used within Moodle, but is no longer accepted for new code."]})}),"\n",(0,a.jsxs)(n.p,{children:["For information on the development toolchain, see our ",(0,a.jsx)(n.a,{href:"/general/development/tools/nodejs#grunt",children:"documentation on how to install and use NodeJS and Grunt"}),"."]}),"\n",(0,a.jsx)(n.h3,{id:"development-mode",children:"Development mode"}),"\n",(0,a.jsx)(o,{version:"3.8"}),"\n",(0,a.jsx)(n.p,{children:"All JavaScript code is now transpiled using Babel which means Moodle will only ever serve minified JavaScript to the browser, even in development mode."}),"\n",(0,a.jsx)(n.p,{children:"In development mode Moodle will also send the browser the corresponding source map files for each of the JavaScript modules. The source map files will tell the browser how to map the minified source code back to the un-minified original source code so that the original source files will be displayed in the sources section of the browser's development tools."}),"\n",(0,a.jsxs)(n.p,{children:["To enable development mode set the ",(0,a.jsx)(n.code,{children:"cachejs"})," config value to ",(0,a.jsx)(n.code,{children:"false"})," in the admin settings or directly in your ",(0,a.jsx)(n.code,{children:"config.php"})," file:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",metastring:'title="Disabling JavaScript caching"',children:"// Prevent JS caching\n$CFG->cachejs = false;\n"})}),"\n",(0,a.jsx)(n.admonition,{type:"note",children:(0,a.jsxs)(n.p,{children:["If you use ",(0,a.jsx)(n.code,{children:"mdk"}),", this is also applied from the ",(0,a.jsx)(n.code,{children:"mdk run dev"})," script."]})}),"\n",(0,a.jsx)(n.h3,{id:"transpiling-modules",children:"Transpiling Modules"}),"\n",(0,a.jsxs)(n.p,{children:["Since all JavaScript must now be transpiled you must use the ",(0,a.jsx)(n.a,{href:"/general/development/tools/nodejs#grunt",children:"Grunt"})," in order for you changes to appear in the browser."]}),"\n",(0,a.jsxs)(n.p,{children:["You can build all modules in Moodle by using the ",(0,a.jsx)(n.code,{children:"grunt amd"})," command, for example:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",metastring:'title="Build all modules"',children:"npx grunt amd\n"})}),"\n",(0,a.jsxs)(n.p,{children:["This can be very slow, and therefore during development we recommend having ",(0,a.jsx)(n.code,{children:"grunt"})," watch for changes using the ",(0,a.jsx)(n.code,{children:"grunt watch"})," command, for example:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",metastring:'title="Watching for changes"',children:"npx grunt watch\n"})}),"\n",(0,a.jsx)(n.h2,{id:"es-modules",children:"ES Modules"}),"\n",(0,a.jsx)(o,{version:"3.8"}),"\n",(0,a.jsx)(n.p,{children:"Moodle's preferred module format is the ESM format, with the older AMD format also supported. All modules (defined using either syntax) are compatible with one another. Behind the scenes the ESM format is transpiled into an AMD module by Babel."}),"\n",(0,a.jsxs)(n.p,{children:["Note that, for Moodle 3.10 and up (see ",(0,a.jsx)(n.a,{href:"https://tracker.moodle.org/browse/MDLSITE-6130",children:"MDLSITE-6130"}),"), any new JavaScript intended for Moodle core ",(0,a.jsx)(n.strong,{children:"must"})," be written in the ESM format."]}),"\n",(0,a.jsx)(n.p,{children:"The call from a PHP file might look like:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",metastring:"title=\"Call the 'init' function on myplugin/myfile\"",children:"$PAGE->requires->js_call_amd('mod_myplugin/myfile', 'init');\n"})}),"\n",(0,a.jsx)(n.p,{children:"And a minimal ESM file will work with:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",metastring:'title="mod/myplugin/amd/src/myfile.js"',children:"export const init = () => {\n    window.console.log('we have been started');\n};\n"})}),"\n",(0,a.jsx)(n.h3,{id:"export-default",children:"Export default"}),"\n",(0,a.jsx)(n.p,{children:"There is one slight difference between the ESM definition for exporting modules and the RequireJS (AMD) definition."}),"\n",(0,a.jsx)(n.p,{children:'The ESM format allows you to export both "named" items, and a "default" value. Unfortunately the RequireJS loader can only support either of these formats in the same file, and not both together.'}),"\n",(0,a.jsx)(n.p,{children:"That is to say that you can either use a named export, such as:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-js",metastring:'title="Example of a named export"',children:"export const init = () => {\n    window.console.log('The init function was called');\n};\n"})}),"\n",(0,a.jsx)(n.p,{children:'Or you can use a "default" export, for example:'}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-js",metastring:'title="Example of a default export"',children:"export default () => {\n    window.console.log('The default was called');\n};\n"})}),"\n",(0,a.jsxs)(n.p,{children:["If both are used, then the ",(0,a.jsx)(n.em,{children:"default"})," export will override all ",(0,a.jsx)(n.em,{children:"named"})," exports."]}),"\n",(0,a.jsx)(n.h3,{id:"inline-javascript",children:"Inline JavaScript"}),"\n",(0,a.jsx)(n.p,{children:"Moodle's minimum browser version requirements means that ESM usage is now supported in all supported browsers. Whilst this is true, we do recommend that inline code be kept to a minimum and that inline code should call code in a module instead."}),"\n",(0,a.jsx)(n.p,{children:"This has benefits including being easier to maintain, and debug, and the availability of linting and performance tooling."}),"\n",(0,a.jsx)(n.h2,{id:"first-module-for-your-plugin",children:"First module for your plugin"}),"\n",(0,a.jsx)(n.p,{children:"This shows the absolute minimum module you need to get started adding modules to your plugins."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-js",metastring:'title="path/to/plugin/amd/src/somefile.js"',children:'export const init = () => {\n    window.alert("The init function was called");\n};\n'})}),"\n",(0,a.jsx)(n.p,{children:"The idea here is that we will call the 'init' function from either PHP, or a Mustache Template as follows:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",metastring:'title="Calling init from PHP"',children:"$PAGE->requires->js_call_amd('plugintype_pluginname/somefile', 'init');\n"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-mustache",metastring:'title="Calling init from a Mustache template"',children:"{{#js}}\nrequire(['plugintype_pluginname/somefile'], (module) => module.init());\n{{/js}}\n"})}),"\n",(0,a.jsx)(n.admonition,{type:"note",children:(0,a.jsxs)(n.p,{children:["You must use the complete '",(0,a.jsx)(n.a,{href:"/general/development/policies/codingstyle/frankenstyle",children:"Frankenstyle"}),"' plugin name, but you do not need to supply the ",(0,a.jsx)(n.code,{children:".js"})," extension."]})}),"\n",(0,a.jsxs)(n.p,{children:["The ",(0,a.jsx)(n.code,{children:"js_call_amd"})," function takes a third parameter which is an ",(0,a.jsx)(n.em,{children:"array"})," of parameters. These will translate to individual parameters in the 'init' function call. For example:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",metastring:'title="Initialising a Module from PHP with argument"',children:"$PAGE->requires->js_call_amd('plugintype_pluginname/somefile', 'init', [\n    $first,\n    $last,\n]);\n"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",metastring:'title="Consuming these variables in the init function"',children:"export const init = (first, last) {\n    window.console.log(`The first name was '${first}' and the last name was '${last}'`);\n};\n"})}),"\n",(0,a.jsx)(n.h2,{id:"hello-world-i-am-a-javascript-module",children:'"Hello World" I am a JavaScript Module'}),"\n",(0,a.jsxs)(n.p,{children:["Each JavaScript module is contained in a single source file in the ",(0,a.jsx)(n.code,{children:"<componentdir>/amd/src"})," folder. The final name of the module is taken from the file name and the component name - for example, ",(0,a.jsx)(n.code,{children:"block_overview/amd/src/helloworld.js"})," would create a module named ",(0,a.jsx)(n.code,{children:"block_overview/helloworld"}),". the name of the module is important when you want to call it from somewhere else in the code."]}),"\n",(0,a.jsxs)(n.p,{children:["After running grunt - the minified JavaScript files are stored in the ",(0,a.jsx)(n.code,{children:"<componentdir>/amd/build"})," folder. The JavaScript files are renamed to show that they are minified (",(0,a.jsx)(n.code,{children:"helloworld.js"})," becomes ",(0,a.jsx)(n.code,{children:"helloworld.min.js"}),")."]}),"\n",(0,a.jsx)(n.admonition,{type:"tip",children:(0,a.jsx)(n.p,{children:"Don't forget to add the built files (the ones in amd/build) to your git commits, or in production no-one will see your changes."})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",metastring:'title="blocks/overview/amd/src/helloworld.js"',children:"// Standard license block omitted.\n/**\n * @module     block_overview/helloworld\n * @copyright  2022 Someone cool\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport * as Str from 'core/str';\n\n/**\n * Reveal all of the hidden notes.\n */\nconst showAllNotes = () => {\n    document.querySelectorAll('.note.hidden').map(note => note.removeClass('hidden'));\n};\n\n/**\n * Hide all of the notes.\n */\nconst hideAllNotes = () => document.querySelectorAll('.note').map(note => note.addClass('hidden'));\n\n/**\n * Return a personalised, formal, greeting.\n *\n * @param   {String} name The name of the person to greet\n * @returns {Promise}\n */\nexport const formal = (name) => Str.get_string('formallygreet', 'block_overview', name);\n\n/**\n * Return a personalised, informal, greeting.\n *\n * @param   {String} name The name of the person to greet\n * @returns {Promise}\n */\nexport const informal = (name) => {\n    return Str.get_string('informallygreet', 'block_overview', name);\n};\n"})}),"\n",(0,a.jsx)(n.p,{children:"It's important to note that only functions which are exported will be callable from outside the module. These are part of the public API."}),"\n",(0,a.jsx)(n.h2,{id:"advanced-examples",children:"Advanced examples"}),"\n",(0,a.jsx)(n.h3,{id:"loading-modules-dynamically",children:"Loading modules dynamically"}),"\n",(0,a.jsx)(n.p,{children:"In some cases you may not know which modules you need to load in advance. In these situations you can make use of dynamic imports to import them when you know what they are."}),"\n",(0,a.jsx)(n.admonition,{type:"caution",children:(0,a.jsx)(n.p,{children:"This is not the recommended approach in most cases, but is available for advanced cases."})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-javascript",children:"export const showTheThing = (thingToShow) => {\n    // Load the module for this thing.\n    import(`local_examples/local/types/type_${thingToShow.modname}`)\n    .then((thingModule) => {\n        window.console.log(`The ${thingToShow.modname} is now available under thingModule within this scope`);\n\n        return thingModule;\n    });\n};\n"})}),"\n",(0,a.jsx)(n.h2,{id:"calling-modules-from-a-page",children:"Calling modules from a page"}),"\n",(0,a.jsx)(n.p,{children:"After you have created your JavaScript modules, then next area to consider is how you should call them."}),"\n",(0,a.jsxs)(n.p,{children:["Any JavaScript code that calls a JavaScript module must execute ",(0,a.jsx)(n.em,{children:"after"})," the requirejs module loader has finished loading. Moodle provides a function ",(0,a.jsx)(n.code,{children:"js_call_amd"})," that will call a single function from the module with the specified parameters."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-php",metastring:'title="js_call_amd usage"',children:"$PAGE->requires->js_call_amd($modulename, $functionname, $params);\n"})}),"\n",(0,a.jsx)(n.p,{children:"Please note that:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["the ",(0,a.jsx)(n.code,{children:"$modulename"})," is the ",(0,a.jsx)(n.code,{children:"componentname/modulename"})," discussed above"]}),"\n",(0,a.jsxs)(n.li,{children:["the ",(0,a.jsx)(n.code,{children:"$functionname"})," is the name of a public function exposed by the amd module."]}),"\n",(0,a.jsxs)(n.li,{children:["the ",(0,a.jsx)(n.code,{children:"$params"})," is an array of parameters passed as arguments to the function. These should be simple types that can be handled by ",(0,a.jsx)(n.code,{children:"json_encode"})," (no recursive arrays, or complex classes please)."]}),"\n",(0,a.jsxs)(n.li,{children:["if the size of the params array is too large (> 1Kb), this will produce a developer warning. Do not attempt to pass large amounts of data through this function, it will pollute the page size. A preferred approach is to pass css selectors for DOM elements that contain data-attributes for any required data, or fetch data via ajax in the background.\nAMD / JS code can also be embedded on a page via mustache templates\nsee here: ",(0,a.jsx)(n.a,{href:"https://docs.moodle.org/dev/Templates#What_if_a_template_contains_JavaScript.3F",children:"https://docs.moodle.org/dev/Templates#What_if_a_template_contains_JavaScript.3F"})]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,a.jsx)(n.h3,{id:"npm-shrinkwrapjson-sha1--sha512-changes",children:"npm-shrinkwrap.json sha1 / sha512 changes"}),"\n",(0,a.jsxs)(n.p,{children:["If you have installed additional dependencies at some point into your ",(0,a.jsx)(n.code,{children:"node_modules"})," folder then you may find that this can cause changes to the ",(0,a.jsx)(n.code,{children:"npm-shrinkwrap.json"})," file. The easiest way to rectify this is:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"git checkout npm-shrinkwrap.json\nnpm ci\n"})}),"\n",(0,a.jsx)(n.h2,{id:"but-i-have-a-mega-js-file-i-dont-want-loaded-on-every-page",children:"But I have a mega JS file I don't want loaded on every page?"}),"\n",(0,a.jsx)(n.p,{children:'Loading all JS files at once and stuffing them in the browser cache is the right choice for MOST js files, there are probably some exceptions. For these files, you can rename the JavaScript file to end with the suffix "-lazy.js" which indicates that the module will not be loaded by default, it will be requested the first time it is used. There is no difference in usage for lazy loaded modules, the require() call looks exactly the same, it\'s just that the module name will also have the "-lazy" suffix.'})]})}function m(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(h,{...e})}):h(e)}}}]);
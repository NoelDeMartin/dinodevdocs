"use strict";(self.webpackChunkdevdocs=self.webpackChunkdevdocs||[]).push([[71087],{52256:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>r,default:()=>u,frontMatter:()=>a,metadata:()=>l,toc:()=>h});var s=t(74848),i=t(28453),o=t(78924);const a={title:"Behat",sidebar_position:1,tags:["Quality Assurance","Testing","Behaviour testing","Behat"]},r=void 0,l={id:"development/tools/behat/index",title:"Behat",description:"This page describes the internals of Behat and the integration with Moodle.",source:"@site/general/development/tools/behat/index.md",sourceDirName:"development/tools/behat",slug:"/development/tools/behat/",permalink:"/moodledevdocs/general/development/tools/behat/",draft:!1,unlisted:!1,editUrl:"https://github.com/moodle/devdocs/edit/main/general/development/tools/behat/index.md",tags:[{label:"Quality Assurance",permalink:"/moodledevdocs/general/tags/quality-assurance"},{label:"Testing",permalink:"/moodledevdocs/general/tags/testing"},{label:"Behaviour testing",permalink:"/moodledevdocs/general/tags/behaviour-testing"},{label:"Behat",permalink:"/moodledevdocs/general/tags/behat"}],version:"current",lastUpdatedBy:"Eloy Lafuente (stronk7)",lastUpdatedAt:1679651807e3,sidebarPosition:1,frontMatter:{title:"Behat",sidebar_position:1,tags:["Quality Assurance","Testing","Behaviour testing","Behat"]},sidebar:"coding",previous:{title:"Development tools",permalink:"/moodledevdocs/general/development/tools"},next:{title:"Running acceptance tests",permalink:"/moodledevdocs/general/development/tools/behat/running"}},d={},h=[{value:"Objective",id:"objective",level:2},{value:"How Behat works",id:"how-behat-works",level:2},{value:"Quick view of the whole process",id:"quick-view-of-the-whole-process",level:3},{value:"Moodle integration",id:"moodle-integration",level:2},{value:"Alternative environment",id:"alternative-environment",level:3},{value:"JavaScript",id:"javascript",level:3},{value:"Admin tool &quot;Acceptance testing&quot;",id:"admin-tool-acceptance-testing",level:3},{value:"Available steps to create tests",id:"available-steps-to-create-tests",level:3},{value:"Behat extension",id:"behat-extension",level:3},{value:"Translations",id:"translations",level:2}];function c(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(o.A,{frontMatter:a,metadata:l}),"\n",(0,s.jsx)(n.p,{children:"This page describes the internals of Behat and the integration with Moodle."}),"\n",(0,s.jsx)(n.p,{children:"Behat is a framework for behavior driven development (BDD) which allows us to specify Moodle functionalities (aka features) as a human-readable list of steps. It parses these steps to executable actions to simulate user interaction against headless browsers (without JavaScript support, only curl-kind requests) or user simulation tools like Selenium, which interacts with browsers and allows JavaScript events simulation."}),"\n",(0,s.jsx)(n.h2,{id:"objective",children:"Objective"}),"\n",(0,s.jsx)(n.p,{children:"The aim of this integration is to allow Moodle components to have its own set of features and step definitions. This allows us to periodically execute sets of tests to detect regressions and Moodle features in different environments (browsers, DBs engines, web servers...).\xa0The Moodle QA tests will be progressively rewritten according to this format to run automatically."}),"\n",(0,s.jsx)(n.h2,{id:"how-behat-works",children:"How Behat works"}),"\n",(0,s.jsx)(n.p,{children:"This section aims to explain the basics about BDD and Behat and a quick view of how Behat internally works from the CLI command execution to the results output."}),"\n",(0,s.jsx)(n.admonition,{type:"note",children:(0,s.jsxs)(n.p,{children:["Note that all those examples are not necessarily real nor part of the suite, they are meant to help understand the concepts, see ",(0,s.jsx)(n.a,{href:"/moodledevdocs/general/development/tools/behat/running",children:"Acceptance testing"})," for real examples"]})}),"\n",(0,s.jsx)(n.p,{children:"Some terms used:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Features"}),": Human-readable list of scenarios that describes a feature"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-gherkin",children:'@auth\nFeature: Login\n  In order to login\n  As a moodle user\n  I need to be able to validate the username and password against moodle\n\nScenario: Login as an existing user\n  Given I am on "login/index.php"\n  When I fill in "username" with "admin"\n  And I fill in "password" with "admin"\n  And I press "loginbtn"\n  Then I should see "Moodle 101: Course Name"\n\nScenario: Login as an non-existing user\n  Given I am on "login/index.php"\n  When I fill in "username" with "admin"\n  And I fill in "password" with "admin"\n  And I press "loginbtn"\n  Then I should see "Invalid login"\n'})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Scenario"}),": Human-readable list of steps to describe an expected behaviour"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-gherkin",children:'Scenario: Login as an existing user\n  Given I am on "login/index.php"\n  When I fill in "username" with "admin"\n  And I fill in "password" with "admin"\n  And I press "loginbtn"\n  Then I should see "Moodle 101: Course Name"\n'})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Steps"}),": Human-readable sentences that describe an action. There are 3 types of steps, ",(0,s.jsx)(n.code,{children:"Given"})," describing the initial context, ",(0,s.jsx)(n.code,{children:"When"})," the event that provokes a change and ",(0,s.jsx)(n.code,{children:"Then"})," where the outcomes should be asserted."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-gherkin",children:'I click on the "Add user" button\n'})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Steps definitions"}),": PHP methods referenced by steps when matching its regular expression. The ",(0,s.jsx)(n.code,{children:"@Given"}),", ",(0,s.jsx)(n.code,{children:"@When"})," and ",(0,s.jsx)(n.code,{children:"@Then"})," tags are descriptive and they are not taken into account when matching steps with steps definitions. The regular expressions placeholders are returned to the PHP method as arguments so methods can use them to tell the browser which button (for example) they want to click."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:'/**\n- @When /^I click on the "(.*)" button$/\n */\npublic function i_click_on_the_button($button) {\n  // Simulates the user interaction (see Mink description below for more info)\n  $this->getSession()->getPage()->pressButton($button);\n}\n'})}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Behat"}),": PHP framework and CLI application that wraps the whole process of features files loading + features files parsing + execution of actions in the browser + results output (",(0,s.jsx)(n.a,{href:"http://behat.org/",children:"http://behat.org/"}),")"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Gherkin"}),": Human-readable language used to define features that can be parsed and translated into PHP methods. For more info, it's the same language used by Cucumber, the BDD Ruby framework (",(0,s.jsx)(n.a,{href:"https://github.com/cucumber/cucumber/wiki/Gherkin",children:"https://github.com/cucumber/cucumber/wiki/Gherkin"}),")"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Context"}),": In Behat scope a context is a PHP class that groups steps definitions (as methods)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Mink"}),": Is the component which interacts with browsers, simulating a real user interaction. It allows us to write PHP code (or use the available PHP methods) to send requests to the different browsers APIs through a common interface or extend it to allow browser-specific actions. The supported browsers includes Selenium, Selenium2, Sahi... ",(0,s.jsx)(n.a,{href:"http://mink.behat.org/",children:"http://mink.behat.org/"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Selenium 2"}),": Web browser automation tool, applications like Mink can communicate with it through a RESTful API (",(0,s.jsx)(n.a,{href:"http://code.google.com/p/selenium/wiki/JsonWireProtocol",children:"http://code.google.com/p/selenium/wiki/JsonWireProtocol"}),") to execute actions simulating user interaction."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Selector type"}),": Related with ",(0,s.jsx)(n.strong,{children:"locator"}),", is a way to select a node inside the page DOM"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Locator"}),": Is what we are looking for inside the page DOM, it completely depends on the associated selector type, a few examples of it:","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Selector type = ",(0,s.jsx)(n.code,{children:'"link"'}),", Locator = ",(0,s.jsx)(n.code,{children:'"Link text"'})]}),"\n",(0,s.jsxs)(n.li,{children:["Selector type = ",(0,s.jsx)(n.code,{children:'"field"'}),", Locator = ",(0,s.jsx)(n.code,{children:'"Field legend text"'})]}),"\n",(0,s.jsxs)(n.li,{children:["Selector type = ",(0,s.jsx)(n.code,{children:'"css"'}),", Locator = ",(0,s.jsx)(n.code,{children:'".css-class #id"'})]}),"\n",(0,s.jsxs)(n.li,{children:["Selector type = ",(0,s.jsx)(n.code,{children:'"xpath"'}),", Locator = ",(0,s.jsx)(n.code,{children:"\"//input[](@id='id-value')\""}),"\nAll these components are written in PHP, open sourced and packaged in a single and extensible framework."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"quick-view-of-the-whole-process",children:"Quick view of the whole process"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Behat CLI execution","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Behat application initialization and loading of arguments (features files to execute, output format...)"}),"\n",(0,s.jsx)(n.li,{children:"Reads the Behat config file (browser servers are specified here)"}),"\n",(0,s.jsx)(n.li,{children:"Extensions overrides management"}),"\n",(0,s.jsx)(n.li,{children:"Gherkin initialization"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["Features files selection","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["According to the arguments Gherkin looks for .features files","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"It can use different features loaders (single file, a directory, the default directory...)"}),"\n",(0,s.jsx)(n.li,{children:"The framework can be extended to allow multiple folders loading"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["Features parsing (Gherkin)","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Loops through the loaded features files looking for scenarios"}),"\n",(0,s.jsx)(n.li,{children:"Gets the list of steps of each scenario"}),"\n",(0,s.jsxs)(n.li,{children:["There are hooks at different levels (",(0,s.jsx)(n.a,{href:"https://docs.behat.org/en/latest/user_guide/context/hooks.html",children:"https://docs.behat.org/en/latest/user_guide/context/hooks.html"}),")"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["Steps parsing (Gherkin)","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Gherkin looks in the available steps definitions for a regular expression that matches the step text"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["Step definition execution","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"The step definition code is executed"}),"\n",(0,s.jsx)(n.li,{children:'Steps definitions most of the time uses the Mink component to communicate with the browser API sending requests like "click on that button" or "go to XXX page"'}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["Scenario outcomes","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"The scenario counts as failed if an exception is thrown when executing a step definition (for example trying to click a non-existing button)"}),"\n",(0,s.jsx)(n.li,{children:"The scenario counts as passed if no exception is thrown during it's steps execution"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["Finishing CLI execution","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"A summary with all the scenario results is displayed"}),"\n",(0,s.jsxs)(n.li,{children:["It accepts different output formats (like JUnitXML) to it's execution in continuous integration systems (",(0,s.jsx)(n.a,{href:"http://docs.behat.org/guides/6.cli.html#format-options",children:"http://docs.behat.org/guides/6.cli.html#format-options"}),")"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"moodle-integration",children:"Moodle integration"}),"\n",(0,s.jsx)(n.p,{children:"It follows the approach chosen with PHPUnit:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"It comes disabled by default, Behat is not included within Moodle and it has to be installed separately with the composer installer"}),"\n",(0,s.jsx)(n.li,{children:"Moodle components (subsystems and plugins) can have a tests/behat/ folder"}),"\n",(0,s.jsx)(n.li,{children:"The scenarios are executed in a test environment, the production database and dataroot are not affected by the tests modifications"}),"\n",(0,s.jsx)(n.li,{children:"The scenarios specifies their own fixtures and it's execution is isolated from other scenarios and features, resetting the test database and the test dataroot before each scenario"}),"\n",(0,s.jsx)(n.li,{children:"Moodle lists the features files and steps definitions of it's components in a behat.yml file, similar to the phpunit.xml manifest"}),"\n",(0,s.jsx)(n.li,{children:"A basic behat.yml.dist config file has been included"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"alternative-environment",children:"Alternative environment"}),"\n",(0,s.jsxs)(n.p,{children:["Acceptance testing implies interaction with the browser like real users does, so it requires the site to be accessible via URL. The Moodle integration creates a new moodle site installation in parallel to the production one to run the tests in a sandbox without affecting the production environment, switching the regular ",(0,s.jsx)(n.code,{children:"$CFG->wwwroot"}),", ",(0,s.jsx)(n.code,{children:"$CFG->dataroot"})," and ",(0,s.jsx)(n.code,{children:"$CFG->prefix"})," to alternatives, which should be only accessible from localhost or internal networks. Info about how to run the tests in ",(0,s.jsx)(n.a,{href:"/moodledevdocs/general/development/tools/behat/running",children:"Running acceptance test"}),"."]}),"\n",(0,s.jsx)(n.p,{children:"This default configuration is useful when developing in a local host, but to run the tests automatically with Jenkins, GHA, Saucelabs... or other CI systems we provide a few extra settings."}),"\n",(0,s.jsxs)(n.p,{children:["All the behat CLI utilities we provide within the Moodle codebase (admin/tool/behat/cli/*) are using ",(0,s.jsx)(n.code,{children:"$CFG->behat_wwwroot"}),", ",(0,s.jsx)(n.code,{children:"$CFG->behat_prefix"})," and ",(0,s.jsx)(n.code,{children:"$CFG->behat_dataroot"})," instead of ",(0,s.jsx)(n.code,{children:"$CFG->wwwroot"}),", ",(0,s.jsx)(n.code,{children:"$CFG->prefix"})," and ",(0,s.jsx)(n.code,{children:"$CFG->dataroot"}),", this scripts are self-contained, but as we are accessing through a browser, we also need to switch the whole Moodle instance to test mode. For this there are two requirements:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Test mode is enabled if","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"php admin/tool/behat/cli/init.php"})," or ",(0,s.jsx)(n.strong,{children:"php admin/tool/behat/cli/util.php --enable"})," has been executed"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["Test mode is requested if","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["The vendor/bin/behat command is running, we know it because we hook the Behat process before the tests begins to run, and we require moodle ",(0,s.jsx)(n.code,{children:"config.php"})," after it"]}),"\n",(0,s.jsxs)(n.li,{children:["We set ",(0,s.jsx)(n.code,{children:"$CFG->behat_wwwroot"})," in ",(0,s.jsx)(n.code,{children:"config.php"})," and we are accessing the moodle instance through it\nThe unique ",(0,s.jsx)(n.code,{children:"$CFG->behat_wwwroot"})," prevents unintended execution of acceptance tests on production sites."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"javascript",children:"JavaScript"}),"\n",(0,s.jsx)(n.p,{children:"There are two types of tests depending on if their scenario needs a real browser capable of execute JavaScript or if they can run in a headless browser."}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Tests with JavaScript requires interaction with a browser through a user simulation tool like Selenium or ZombieJS to be executed; see ",(0,s.jsx)(n.a,{href:"http://mink.behat.org/#different-browsers-drivers",children:"http://mink.behat.org/#different-browsers-drivers"})," for all available drivers"]}),"\n",(0,s.jsx)(n.li,{children:"Test that does not requires JavaScript are faster to run but can not test rich applications like Moodle"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"In most of the cases a JavaScript test would be more appropriate because most of the users uses JavaScript-capable browsers, non-JavaScript tests can be useful to ensure that Moodle maintains its functionality without JavaScript enabled and to ensure there are no big issues, regressions or exceptions in general."}),"\n",(0,s.jsx)(n.h3,{id:"admin-tool-acceptance-testing",children:'Admin tool "Acceptance testing"'}),"\n",(0,s.jsx)(n.p,{children:"There is an admin tool to run and ease the creation of acceptance tests."}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Web interface: The web interface allows you to list and filter the available steps definitions, a non-technical user can use this interface to write new features (",(0,s.jsx)(n.code,{children:"admin/tool/behat/index.php"}),")"]}),"\n",(0,s.jsxs)(n.li,{children:["CLI: Command to enable and disable the test environment and to update the ",(0,s.jsx)(n.code,{children:"behat.yml"})," file with the system tests and steps definitions (",(0,s.jsx)(n.code,{children:"admin/tool/behat/cli/util.php"})," and ",(0,s.jsx)(n.code,{children:"admin/tool/behat/cli/init.php"})," for a quick start)\n",(0,s.jsx)(n.img,{alt:"Acceptance_testing_UI_4.0.png",src:t(18183).A+"",width:"1707",height:"831"})]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"available-steps-to-create-tests",children:"Available steps to create tests"}),"\n",(0,s.jsxs)(n.p,{children:["There are behat libraries with tons of steps definitions to run all sort of processes and interactions with the browser, some of them overlaps Moodle-specific libraries and tests writers can be confused not only by this also by the amount of steps and vague or too technical steps descriptions. Moodle provides a set of steps definitions written in a common format to make tests writers life easier. New steps definitions must follow these ",(0,s.jsx)(n.a,{href:"/moodledevdocs/general/development/tools/behat/writing#writing-new-acceptance-test-step-definitions",children:"guidelines"})]}),"\n",(0,s.jsx)(n.h3,{id:"behat-extension",children:"Behat extension"}),"\n",(0,s.jsxs)(n.p,{children:["A new Behat extension (",(0,s.jsx)(n.a,{href:"https://github.com/moodlehq/moodle-behat-extension",children:"https://github.com/moodlehq/moodle-behat-extension"}),") has been created to maintain Behat and its dependencies as they comes from upstream."]}),"\n",(0,s.jsx)(n.p,{children:"The aim of this extension is:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Load features from multiple folders (Moodle subsystems and plugins)"}),"\n",(0,s.jsx)(n.li,{children:"Load steps definitions from multiple folders and add them as subcontexts (Moodle subsystems and plugins)"}),"\n",(0,s.jsx)(n.li,{children:"Return the available steps definitions in a more human-readable format without regexps"}),"\n",(0,s.jsx)(n.li,{children:"Look for exceptions, debugging() calls, PHP error messages and other backtraces in Moodle's output"}),"\n",(0,s.jsx)(n.li,{children:"Extend the Selenium2 behat driver to allow extra Selenium capabilities"}),"\n",(0,s.jsx)(n.li,{children:"Add a new formatter method based on progress (the moodle default one) to display info about the moodle site being tested\nAll the other particularities of this integration can managed playing with different Behat config parameters."}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"translations",children:"Translations"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://docs.moodle.org/es/Behat",children:"es - Behat"})}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},18183:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/Acceptance_testing_UI_4.0-74cb2dfd5732e2cd32e20b0026c827e0.png"}}]);
"use strict";(self.webpackChunkdevdocs=self.webpackChunkdevdocs||[]).push([[8350],{65041:(e,s,t)=>{t.r(s),t.d(s,{assets:()=>d,contentTitle:()=>r,default:()=>u,frontMatter:()=>o,metadata:()=>l,toc:()=>c});var n=t(74848),a=t(28453),i=t(78924);const o={title:"Task API",tags:["API","Tasks","Subsystem"]},r=void 0,l={id:"apis/subsystems/task/index",title:"Task API",description:"The Moodle Tasks API is a comprehensive API to support the scheduling and running of tasks. Tasks are individual activities which are to be performed, and come in two primary forms:",source:"@site/versioned_docs/version-4.2/apis/subsystems/task/index.md",sourceDirName:"apis/subsystems/task",slug:"/apis/subsystems/task/",permalink:"/moodledevdocs/docs/4.2/apis/subsystems/task/",draft:!1,unlisted:!1,editUrl:"https://github.com/moodle/devdocs/edit/main/versioned_docs/version-4.2/apis/subsystems/task/index.md",tags:[{label:"API",permalink:"/moodledevdocs/docs/4.2/tags/api"},{label:"Tasks",permalink:"/moodledevdocs/docs/4.2/tags/tasks"},{label:"Subsystem",permalink:"/moodledevdocs/docs/4.2/tags/subsystem"}],version:"4.2",lastUpdatedBy:"Andrew Nicols",lastUpdatedAt:168325581e4,frontMatter:{title:"Task API",tags:["API","Tasks","Subsystem"]},sidebar:"docs",previous:{title:"Tag API",permalink:"/moodledevdocs/docs/4.2/apis/subsystems/tag/"},next:{title:"Adhoc tasks",permalink:"/moodledevdocs/docs/4.2/apis/subsystems/task/adhoc"}},d={},c=[{value:"Benefits",id:"benefits",level:2},{value:"Types of task",id:"types-of-task",level:2},{value:"Scheduled tasks",id:"scheduled-tasks",level:3},{value:"Adhoc tasks",id:"adhoc-tasks",level:3},{value:"Usage",id:"usage",level:2},{value:"Failures and error handling",id:"failures-and-error-handling",level:3},{value:"Caches",id:"caches",level:3},{value:"Security",id:"security",level:3},{value:"Legacy cron",id:"legacy-cron",level:3},{value:"Generating output",id:"generating-output",level:3},{value:"For Administrators",id:"for-administrators",level:2}];function h(e){const s={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(i.A,{frontMatter:o,metadata:l}),"\n",(0,n.jsx)(s.p,{children:"The Moodle Tasks API is a comprehensive API to support the scheduling and running of tasks. Tasks are individual activities which are to be performed, and come in two primary forms:"}),"\n",(0,n.jsxs)(s.ul,{children:["\n",(0,n.jsx)(s.li,{children:"Scheduled tasks - tasks which run regularly and according to a schedule set by the administrator, with the same configuration each time; and"}),"\n",(0,n.jsx)(s.li,{children:"Adhoc tasks - tasks which are queued by developers, capable of having multiple concurrent executions, and with individual configuration."}),"\n"]}),"\n",(0,n.jsx)(s.p,{children:"Good uses for tasks include:"}),"\n",(0,n.jsxs)(s.ul,{children:["\n",(0,n.jsx)(s.li,{children:"running a slow operation in the background"}),"\n",(0,n.jsx)(s.li,{children:"running a maintenance task on a regular schedule"}),"\n"]}),"\n",(0,n.jsx)(s.p,{children:"In general any operation that takes more than a few seconds might be a candidate for a task."}),"\n",(0,n.jsx)(s.h2,{id:"benefits",children:"Benefits"}),"\n",(0,n.jsxs)(s.ul,{children:["\n",(0,n.jsx)(s.li,{children:"Better user experience (give the user feedback immediately, that their task has been queued)"}),"\n",(0,n.jsx)(s.li,{children:"Prevent browser timeouts"}),"\n",(0,n.jsx)(s.li,{children:"Better performance for clusters (tasks can be run on separate, non-user-facing cluster nodes, tasks can run in parallel)"}),"\n",(0,n.jsx)(s.li,{children:"Failed tasks will be retried"}),"\n",(0,n.jsx)(s.li,{children:'A better user interface will prevent users queuing multiple tasks, because they thought it had "got stuck".'}),"\n"]}),"\n",(0,n.jsx)(s.admonition,{type:"note",children:(0,n.jsx)(s.p,{children:"Tasks will only run as often as cron is run in Moodle. It is recommended that cron be run at least once per minute to get the most benefit from the task scheduling."})}),"\n",(0,n.jsx)(s.h2,{id:"types-of-task",children:"Types of task"}),"\n",(0,n.jsx)(s.h3,{id:"scheduled-tasks",children:"Scheduled tasks"}),"\n",(0,n.jsx)(s.p,{children:"Scheduled tasks are tasks that will run on a regular schedule. A default schedule can be set, but administrators have the ability to change the default schedule if required."}),"\n",(0,n.jsxs)(s.p,{children:["See the ",(0,n.jsx)(s.a,{href:"/moodledevdocs/docs/4.2/apis/subsystems/task/scheduled",children:"scheduled tasks"})," page for more information on creating scheduled tasks."]}),"\n",(0,n.jsx)(s.h3,{id:"adhoc-tasks",children:"Adhoc tasks"}),"\n",(0,n.jsx)(s.p,{children:"Adhoc tasks are typically used when you need to queue something to run in the background either immediately, where they would be executed as soon as possible, or as a one-off task at some future point in time."}),"\n",(0,n.jsx)(s.p,{children:"Each adhoc task can be called multiple times, with each having its own custom data, and the ability to run as a different user."}),"\n",(0,n.jsx)(s.p,{children:"Adhoc tasks are great for situations such as:"}),"\n",(0,n.jsxs)(s.ul,{children:["\n",(0,n.jsx)(s.li,{children:"perform a pre-configured backup"}),"\n",(0,n.jsx)(s.li,{children:"migrate large quantities of data between different formats"}),"\n",(0,n.jsx)(s.li,{children:"send forum posts as an e-mail"}),"\n"]}),"\n",(0,n.jsx)(s.h2,{id:"usage",children:"Usage"}),"\n",(0,n.jsx)(s.h3,{id:"failures-and-error-handling",children:"Failures and error handling"}),"\n",(0,n.jsx)(s.p,{children:"A task, either scheduled or adhoc, can sometimes fail. An example would be updating an RSS field when the network is temporarily down. This is handled by the task system automatically - all the failing task needs to do is throw an exception. The task will be retried after 1 minute. If the task keeps failing, the retry algorithm will add more time between each successive attempts up to a max of 24 hours.\nTherefore, if the task fails, it is OK for your code to just throw an exception. The task system will catch it an log it for you, and schedule the retry."}),"\n",(0,n.jsxs)(s.p,{children:["However, sometimes it is a good idea to catch exceptions. For example, if your task loops over courses, doing some processing for each one,\nthen it is better if an exception triggered in one course does not block processing of other courses. This requires some manual exception handling.\nIf you catch an exception, then you become responsible for things that the task system normally handles.\nFor example, it is important to log all the details of the error, so problems can be investigated and fixed. The helper function\n",(0,n.jsx)(s.code,{children:"mtrace_exception"})," makes this easier. Also, you need to consider: if something has gone wrong with part of the processing, but other parts succeeded,\nshould the overall state of the task run be success or failure? It will depend on how the task works, but you may need to ensure that the task\nends by throwing an exception if any part failed. There is a an example of all this in the ",(0,n.jsx)(s.a,{href:"https://github.com/moodle/moodle/blob/master/mod/quiz/report/statistics/classes/task/recalculate.php",children:(0,n.jsx)(s.code,{children:"\\quiz_statistics\\task\\recalculate"})}),"."]}),"\n",(0,n.jsx)(s.h3,{id:"caches",children:"Caches"}),"\n",(0,n.jsxs)(s.p,{children:["Historically many Moodle APIs have used static caches. Whilst many of these have been replaced by the ",(0,n.jsx)(s.a,{href:"https://docs.moodle.org/dev/Cache_API",children:"Moodle Universal Cache"}),", which can be cleared between runs, it is not possible to guarantee that this is always the case."]}),"\n",(0,n.jsx)(s.p,{children:"When working with long-running tasks, you may need to consider caching - this applies to both scheduled, and adhoc, tasks. This is particularly true for tasks related to enrolment."}),"\n",(0,n.jsx)(s.p,{children:"After a long-running task completes, the next task in the queue may suffer because various API's in moodle use static caching to speed up requests, but assume that the data will not change much between the start and end of the request. In this case, you can force the task runner to exit after completing a task that has performed many changes. The next task run will take place shortly after, and will have all static caches cleared because it takes place in a new process."}),"\n",(0,n.jsxs)(s.p,{children:["You can enable this behaviour by making a call to ",(0,n.jsx)(s.code,{children:"\\core\\task\\manager::clear_static_caches()"})," at the end of your task."]}),"\n",(0,n.jsx)(s.h3,{id:"security",children:"Security"}),"\n",(0,n.jsxs)(s.p,{children:["When scheduling a task to run in the background, or creating a scheduled task, the task will run as the cron user (see ",(0,n.jsx)(s.code,{children:"cron_setup_user()"}),"). If you need to perform access checks in your background task, you should do so as the user that the checks relate to."]}),"\n",(0,n.jsxs)(s.p,{children:["In the case of an adhoc task, you can call the ",(0,n.jsx)(s.a,{href:"/moodledevdocs/docs/4.2/apis/subsystems/task/adhoc#running-as-a-specific-user",children:(0,n.jsx)(s.code,{children:"set_userid"})})," function when queueing the task."]}),"\n",(0,n.jsxs)(s.p,{children:["For scheduled tasks you should either pass the ID of the user to the ",(0,n.jsx)(s.code,{children:"require_capability()"})," function, or use the ",(0,n.jsx)(s.code,{children:"cron_setup_user()"})," function to switch to that user."]}),"\n",(0,n.jsx)(s.h3,{id:"legacy-cron",children:"Legacy cron"}),"\n",(0,n.jsx)(s.p,{children:"The older syntax of cron.php or modname_cron() is still supported, and will be removed in the near future. This is because:"}),"\n",(0,n.jsxs)(s.ul,{children:["\n",(0,n.jsx)(s.li,{children:"the legacy cron functions run serially - a long running cron in one plugin will hold up the other plugins crons"}),"\n",(0,n.jsx)(s.li,{children:"the legacy cron functions are fragile - a failure in one cron in one plugin will prevent the cron in other functions from running at all"}),"\n",(0,n.jsx)(s.li,{children:"the scheduling cannot be changed by administrators"}),"\n"]}),"\n",(0,n.jsx)(s.h3,{id:"generating-output",children:"Generating output"}),"\n",(0,n.jsxs)(s.p,{children:["Since Moodle 3.5 it is safe to use the ",(0,n.jsx)(s.a,{href:"/moodledevdocs/docs/4.2/apis/subsystems/output",children:"Output API"})," in cron tasks. Prior to this there may be cases where the Output API has not been initialised."]}),"\n",(0,n.jsxs)(s.p,{children:["In order to improve debugging information, it is good practice to call ",(0,n.jsx)(s.code,{children:"mtrace"})," to log what's going on within a task execution:"]}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-php",children:'class my_task extends \\core\\task\\scheduled_task {\n    public function execute() {\n         mtrace("My task started");\n\n         // Do some work.\n\n         mtrace("My task finished");\n    }\n}\n'})}),"\n",(0,n.jsx)(s.h2,{id:"for-administrators",children:"For Administrators"}),"\n",(0,n.jsx)(s.p,{children:"Several tools exist for administrators:"}),"\n",(0,n.jsxs)(s.ul,{children:["\n",(0,n.jsx)(s.li,{children:"The task log viewer allows administrators to view logs from both adhoc and scheduled task runs"}),"\n",(0,n.jsx)(s.li,{children:"The scheduled task manager allows administrators to configure the time schedule for tasks"}),"\n",(0,n.jsx)(s.li,{children:"The 'Tasks running now' tool allows administrators to view key details of any task currently running"}),"\n"]})]})}function u(e={}){const{wrapper:s}={...(0,a.R)(),...e.components};return s?(0,n.jsx)(s,{...e,children:(0,n.jsx)(h,{...e})}):h(e)}}}]);